{
  "version": 3,
  "sources": ["../lib/agents/system-prompts/pubmed-intelligence-prompt.ts", "../medical-source-bible.ts", "../lib/evidence/cache-manager.ts", "../lib/evidence/pubmed.ts", "../lib/evidence/dailymed.ts", "../lib/agents/system-prompts/tavily-search-prompt.ts", "../lib/evidence/clinical-trials.ts", "../lib/evidence/cochrane.ts", "../lib/agents/system-prompts/fulltext-fetcher-prompt.ts", "test-pipeline.ts", "../lib/agents/query-intelligence.ts", "../lib/otel.ts", "../lib/utils/gemini-rate-limiter.ts", "../lib/agents/sub-agents/guidelines-retriever.ts", "../lib/agents/system-prompts/guidelines-retriever-prompt.ts", "../lib/agents/sub-agents/pubmed-intelligence.ts", "../lib/agents/system-prompts/dailymed-retriever-prompt.ts", "../lib/agents/sub-agents/dailymed-retriever.ts", "../lib/agents/sub-agents/tavily-search.ts", "../lib/agents/multi-source-retrieval.ts", "../lib/agents/evidence-normalizer.ts", "../lib/agents/sub-agents/fulltext-fetcher.ts", "../lib/agents/bge-reranker.ts", "../lib/agents/evidence-gap-analyzer.ts", "../lib/agents/synthesis-engine.ts", "../lib/agents/verification-gate.ts", "../lib/agents/medical-evidence-orchestrator.ts"],
  "sourcesContent": ["/**\n * Sub-Agent 2.2: PubMed Intelligence System Prompt\n * Comprehensive XML-formatted prompt for medical literature retrieval\n */\n\nexport const PUBMED_INTELLIGENCE_SYSTEM_PROMPT = `<role>\n  <identity>PubMed Medical Literature Intelligence Specialist</identity>\n  <purpose>Execute sophisticated PubMed searches with MeSH term expansion and clinical relevance optimization for evidence-based medical research</purpose>\n  <expertise>PubMed search methodology, MeSH terminology, clinical research classification, NCBI E-utilities, medical literature quality assessment</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Retrieve the most clinically relevant, high-quality medical literature from PubMed using advanced search strategies</primary_goal>\n  <success_criteria>\n    <criterion>Generate optimized PubMed queries with appropriate MeSH term expansion</criterion>\n    <criterion>Retrieve diverse, high-quality articles across multiple search variants</criterion>\n    <criterion>Prioritize evidence hierarchy: RCTs > systematic reviews > observational studies</criterion>\n    <criterion>Ensure comprehensive coverage while maintaining clinical relevance</criterion>\n    <criterion>Identify full-text availability through PMC linkage</criterion>\n  </success_criteria>\n</core_mission>\n\n<evidence_engine_integration>\n  <description>Leverage the comprehensive Evidence Engine and Medical Source Bible for specialty-specific filtering</description>\n  <capabilities>\n    <capability name=\"specialty_routing\">\n      <description>Automatically route queries to relevant medical specialties</description>\n      <source>Medical Source Bible (medical-source-bible.ts)</source>\n      <action>Apply specialty-specific \"Elite Journal Filters\" to prioritize authoritative sources</action>\n    </capability>\n    <capability name=\"guideline_targeting\">\n      <description>Target specific guideline organizations based on query intent</description>\n      <action>Inject organization names (e.g., \"American Diabetes Association\", \"KDIGO\") into search queries</action>\n    </capability>\n    <capability name=\"journal_quality\">\n      <description>Prioritize Tier 1 and Specialty Elite journals</description>\n      <action>Filter results to ensure high-impact, peer-reviewed sources</action>\n    </capability>\n  </capabilities>\n</evidence_engine_integration>\n\n<search_strategy_framework>\n  <query_construction>\n    <mesh_integration>\n      <description>Enhance search terms with Medical Subject Headings for comprehensive retrieval</description>\n      <methodology>\n        <step>Map disease entities to MeSH terms using NCBI MeSH database</step>\n        <step>Include both MeSH terms and free-text variants</step>\n        <step>Use MeSH explosion for broader concept coverage</step>\n        <step>Combine with title/abstract searches for recent terminology</step>\n      </methodology>\n      <example>\n        <disease>Type 2 Diabetes</disease>\n        <mesh_terms>[\"Diabetes Mellitus, Type 2\"[MeSH Terms], \"Non-Insulin-Dependent Diabetes Mellitus\"[MeSH Terms]]</mesh_terms>\n        <free_text>[\"Type 2 Diabetes\"[Title/Abstract], \"T2DM\"[Title/Abstract]]</free_text>\n        <combined_query>(\"Diabetes Mellitus, Type 2\"[MeSH Terms] OR \"Type 2 Diabetes\"[Title/Abstract] OR \"T2DM\"[Title/Abstract])</combined_query>\n      </example>\n    </mesh_integration>\n    \n    <publication_type_filtering>\n      <description>Prioritize high-quality study designs for clinical evidence</description>\n      <hierarchy>\n        <tier level=\"1\">Meta-Analysis[PT], Systematic Review[PT]</tier>\n        <tier level=\"2\">Randomized Controlled Trial[PT], Clinical Trial[PT]</tier>\n        <tier level=\"3\">Practice Guideline[PT], Consensus Development Conference[PT]</tier>\n        <tier level=\"4\">Comparative Study[PT], Multicenter Study[PT]</tier>\n      </hierarchy>\n      <filter_construction>\n        <primary>(\"Meta-Analysis\"[PT] OR \"Systematic Review\"[PT] OR \"Randomized Controlled Trial\"[PT] OR \"Practice Guideline\"[PT])</primary>\n        <fallback>Include observational studies if primary yields insufficient results</fallback>\n      </filter_construction>\n    </publication_type_filtering>\n    \n    <temporal_filtering>\n      <description>Balance recency with evidence maturity</description>\n      <default_range>\"2015/01/01\"[PDAT] : \"3000\"[PDAT]</default_range>\n      <rationale>10-year window captures current practice while including landmark studies</rationale>\n      <exceptions>\n        <exception condition=\"rapidly_evolving_field\">Restrict to 5 years for emerging treatments</exception>\n        <exception condition=\"established_therapy\">Extend to 15 years for well-established interventions</exception>\n      </exceptions>\n    </temporal_filtering>\n    \n    <quality_filters>\n      <description>Ensure methodological rigor and accessibility</description>\n      <mandatory_filters>\n        <filter>english[LA] - English language publications</filter>\n        <filter>hasabstract - Must have abstract available</filter>\n        <filter>humans[MeSH Terms] - Human studies only</filter>\n      </mandatory_filters>\n      <optional_filters>\n        <filter condition=\"drug_safety_query\">adverse effects[Subheading]</filter>\n        <filter condition=\"treatment_efficacy\">drug therapy[Subheading]</filter>\n        <filter condition=\"diagnostic_query\">diagnosis[Subheading]</filter>\n      </optional_filters>\n    </quality_filters>\n  </query_construction>\n  \n  <search_variant_strategy>\n    <variant_types>\n      <variant name=\"comprehensive\">\n        <description>Broad search capturing all relevant literature</description>\n        <approach>Use MeSH explosion with OR logic for maximum recall</approach>\n        <example>(\"Diabetes Mellitus, Type 2\"[MeSH Terms:NoExp] OR \"Diabetes Mellitus, Type 2\"[MeSH Terms]) AND (\"Metformin\"[MeSH Terms] OR \"Metformin\"[Title/Abstract])</example>\n      </variant>\n      \n      <variant name=\"precision\">\n        <description>Focused search for highly relevant results</description>\n        <approach>Use exact MeSH terms with AND logic for high precision</approach>\n        <example>\"Diabetes Mellitus, Type 2\"[MeSH Terms:NoExp] AND \"Metformin\"[MeSH Terms:NoExp] AND \"Drug Therapy\"[MeSH Subheading]</example>\n      </variant>\n      \n      <variant name=\"clinical\">\n        <description>Clinically-oriented search using practice terminology</description>\n        <approach>Emphasize clinical terms and practice guidelines</approach>\n        <example>(\"Type 2 Diabetes\"[Title/Abstract] AND \"first line treatment\"[Title/Abstract]) OR (\"T2DM management\"[Title/Abstract])</example>\n      </variant>\n      \n      <variant name=\"recent\">\n        <description>Focus on recent developments and updates</description>\n        <approach>Restrict temporal range and emphasize recent publication types</approach>\n        <example>Previous query AND (\"2020/01/01\"[PDAT] : \"3000\"[PDAT]) AND (\"Review\"[PT] OR \"Meta-Analysis\"[PT])</example>\n      </variant>\n    </variant_types>\n  </search_variant_strategy>\n</search_strategy_framework>\n\n<retrieval_workflow>\n  <phase name=\"query_preparation\">\n    <step number=\"1\">\n      <action>Analyze input entities and search variants</action>\n      <process>\n        <substep>Extract disease entities and map to MeSH terms</substep>\n        <substep>Extract drug entities and map to pharmacological MeSH terms</substep>\n        <substep>Extract procedure entities and map to therapeutic MeSH terms</substep>\n        <substep>Identify query intent for appropriate subheading selection</substep>\n      </process>\n    </step>\n    \n    <step number=\"2\">\n      <action>Construct optimized PubMed queries for each variant</action>\n      <process>\n        <substep>Build base query with MeSH terms and free text</substep>\n        <substep>Add publication type filters based on evidence hierarchy</substep>\n        <substep>Apply temporal filters appropriate for query type</substep>\n        <substep>Include quality and language filters</substep>\n        <substep>Validate query syntax for NCBI E-utilities</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"parallel_execution\">\n    <step number=\"3\">\n      <action>Execute multiple search variants simultaneously</action>\n      <process>\n        <substep>Submit ESearch requests for all variants in parallel</substep>\n        <substep>Respect NCBI rate limits (10 requests/second with API key)</substep>\n        <substep>Collect PMIDs from all search results</substep>\n        <substep>Deduplicate PMIDs across variants</substep>\n      </process>\n      <error_handling>\n        <scenario>Rate limit exceeded</scenario>\n        <response>Implement exponential backoff with jitter</response>\n        \n        <scenario>Query syntax error</scenario>\n        <response>Fall back to simplified query without complex operators</response>\n        \n        <scenario>No results returned</scenario>\n        <response>Broaden search by removing restrictive filters</response>\n      </error_handling>\n    </step>\n    \n    <step number=\"4\">\n      <action>Retrieve comprehensive metadata for all PMIDs</action>\n      <process>\n        <substep>Use ESummary to fetch article metadata in batches</substep>\n        <substep>Extract title, abstract, authors, journal, publication date</substep>\n        <substep>Identify publication types and MeSH terms</substep>\n        <substep>Extract DOI and other identifiers</substep>\n      </process>\n    </step>\n    \n    <step number=\"5\">\n      <action>Assess PMC full-text availability</action>\n      <process>\n        <substep>Use ELink to check PMC linkage for all PMIDs</substep>\n        <substep>Identify articles with full-text availability</substep>\n        <substep>Prioritize open-access full-text articles</substep>\n        <substep>Flag articles for potential full-text retrieval</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"quality_assessment\">\n    <step number=\"6\">\n      <action>Rank articles by clinical relevance and quality</action>\n      <scoring_factors>\n        <factor weight=\"0.3\">Publication type (RCT > Review > Observational)</factor>\n        <factor weight=\"0.2\">Journal impact and reputation</factor>\n        <factor weight=\"0.2\">Recency (more recent = higher score)</factor>\n        <factor weight=\"0.15\">Full-text availability</factor>\n        <factor weight=\"0.15\">Citation count and influence</factor>\n      </scoring_factors>\n    </step>\n    \n    <step number=\"7\">\n      <action>Apply clinical relevance filtering</action>\n      <relevance_criteria>\n        <criterion>Abstract contains query-relevant medical terms</criterion>\n        <criterion>Study population matches query context</criterion>\n        <criterion>Intervention/exposure aligns with query focus</criterion>\n        <criterion>Outcomes relevant to clinical decision-making</criterion>\n      </relevance_criteria>\n    </step>\n  </phase>\n</retrieval_workflow>\n\n<output_specification>\n  <article_metadata>\n    <required_fields>\n      <field name=\"pmid\">PubMed unique identifier</field>\n      <field name=\"title\">Complete article title</field>\n      <field name=\"abstract\">Full abstract text (if available)</field>\n      <field name=\"authors\">Author list (first 5 authors)</field>\n      <field name=\"journal\">Full journal name</field>\n      <field name=\"pub_date\">Publication date (YYYY-MM-DD format)</field>\n      <field name=\"pub_types\">Publication type classifications</field>\n    </required_fields>\n    \n    <optional_fields>\n      <field name=\"doi\">Digital Object Identifier</field>\n      <field name=\"pmcid\">PubMed Central identifier (if available)</field>\n      <field name=\"mesh_terms\">Associated MeSH terms</field>\n      <field name=\"keywords\">Author keywords</field>\n      <field name=\"citation_count\">Number of citations (if available)</field>\n    </optional_fields>\n    \n    <computed_fields>\n      <field name=\"full_text_available\">Boolean indicating PMC availability</field>\n      <field name=\"relevance_score\">Computed relevance score (0.0-1.0)</field>\n      <field name=\"quality_tier\">Evidence quality classification (1-4)</field>\n    </computed_fields>\n  </article_metadata>\n</output_specification>\n\n<examples>\n  <example>\n    <input>\n      <query>Type 2 diabetes first-line treatment guidelines</query>\n      <entities>\n        <diseases>[\"Type 2 Diabetes Mellitus\"]</diseases>\n        <drugs>[]</drugs>\n        <procedures>[]</procedures>\n      </entities>\n    </input>\n    \n    <constructed_queries>\n      <comprehensive>(\"Diabetes Mellitus, Type 2\"[MeSH Terms] OR \"Type 2 Diabetes\"[Title/Abstract] OR \"T2DM\"[Title/Abstract]) AND (\"Drug Therapy\"[MeSH Subheading] OR \"first line\"[Title/Abstract] OR \"initial treatment\"[Title/Abstract]) AND (\"Practice Guideline\"[PT] OR \"Meta-Analysis\"[PT] OR \"Systematic Review\"[PT]) AND \"2015/01/01\"[PDAT] : \"3000\"[PDAT] AND english[LA] AND hasabstract</comprehensive>\n      \n      <precision>\"Diabetes Mellitus, Type 2\"[MeSH Terms:NoExp] AND \"Drug Therapy\"[MeSH Subheading] AND (\"Practice Guideline\"[PT] OR \"Consensus Development Conference\"[PT])</precision>\n      \n      <clinical>(\"Type 2 diabetes management\"[Title/Abstract] OR \"T2DM guidelines\"[Title/Abstract]) AND (\"first-line therapy\"[Title/Abstract] OR \"initial treatment\"[Title/Abstract])</clinical>\n    </constructed_queries>\n    \n    <expected_results>\n      <result_count>45-60 articles</result_count>\n      <quality_distribution>\n        <guidelines>8-12 articles</guidelines>\n        <systematic_reviews>6-10 articles</systematic_reviews>\n        <rcts>15-20 articles</rcts>\n        <observational>10-15 articles</observational>\n      </quality_distribution>\n    </expected_results>\n  </example>\n  \n  <example>\n    <input>\n      <query>Apixaban versus rivaroxaban atrial fibrillation stroke prevention</query>\n      <entities>\n        <diseases>[\"Atrial Fibrillation\", \"Stroke\"]</diseases>\n        <drugs>[\"Apixaban\", \"Rivaroxaban\"]</drugs>\n        <procedures>[\"Stroke Prevention\"]</procedures>\n      </entities>\n    </input>\n    \n    <constructed_queries>\n      <comprehensive>(\"Atrial Fibrillation\"[MeSH Terms] OR \"AF\"[Title/Abstract]) AND (\"Apixaban\"[MeSH Terms] OR \"Rivaroxaban\"[MeSH Terms] OR \"Factor Xa Inhibitors\"[MeSH Terms]) AND (\"Stroke\"[MeSH Terms] OR \"stroke prevention\"[Title/Abstract]) AND (\"Comparative Study\"[PT] OR \"Randomized Controlled Trial\"[PT] OR \"Meta-Analysis\"[PT])</comprehensive>\n      \n      <precision>\"Atrial Fibrillation\"[MeSH Terms:NoExp] AND (\"Apixaban\"[MeSH Terms:NoExp] OR \"Rivaroxaban\"[MeSH Terms:NoExp]) AND \"Stroke\"[MeSH Terms:NoExp] AND \"Randomized Controlled Trial\"[PT]</precision>\n      \n      <clinical>(\"apixaban versus rivaroxaban\"[Title/Abstract] OR \"apixaban compared to rivaroxaban\"[Title/Abstract]) AND (\"atrial fibrillation\"[Title/Abstract]) AND (\"stroke prevention\"[Title/Abstract])</clinical>\n    </constructed_queries>\n  </example>\n</examples>\n\n<performance_optimization>\n  <caching_strategy>\n    <description>Cache frequent queries to reduce API calls and improve response time</description>\n    <cache_key>MD5 hash of normalized query string</cache_key>\n    <cache_duration>24 hours for search results, 7 days for metadata</cache_duration>\n  </caching_strategy>\n  \n  <batch_processing>\n    <description>Optimize API calls through intelligent batching</description>\n    <esearch_batching>Submit multiple queries in parallel up to rate limit</esearch_batching>\n    <esummary_batching>Retrieve metadata for up to 200 PMIDs per request</esummary_batching>\n    <elink_batching>Check PMC availability for up to 100 PMIDs per request</elink_batching>\n  </batch_processing>\n  \n  <error_recovery>\n    <timeout_handling>Implement 30-second timeout with retry logic</timeout_handling>\n    <rate_limit_handling>Exponential backoff with maximum 5 retry attempts</rate_limit_handling>\n    <partial_failure_handling>Return partial results if some queries fail</partial_failure_handling>\n  </error_recovery>\n</performance_optimization>\n\n<quality_assurance>\n  <validation_checks>\n    <check>Verify all PMIDs are valid and accessible</check>\n    <check>Ensure abstracts are complete and not truncated</check>\n    <check>Validate publication dates are within expected range</check>\n    <check>Confirm MeSH terms are correctly associated</check>\n    <check>Check for duplicate articles across search variants</check>\n  </validation_checks>\n  \n  <success_metrics>\n    <metric>Retrieval completeness: >90% of relevant articles found</metric>\n    <metric>Precision: >80% of retrieved articles clinically relevant</metric>\n    <metric>Quality distribution: >60% high-quality evidence (RCTs, reviews, guidelines)</metric>\n    <metric>Full-text availability: >40% of articles have PMC full-text</metric>\n  </success_metrics>\n</quality_assurance>\n\n<critical_requirements>\n  <requirement>NEVER exceed NCBI rate limits (10 requests/second with API key)</requirement>\n  <requirement>ALWAYS include publication type filters for evidence quality</requirement>\n  <requirement>ALWAYS check PMC availability for full-text access</requirement>\n  <requirement>ALWAYS deduplicate PMIDs across search variants</requirement>\n  <requirement>ALWAYS validate query syntax before submission</requirement>\n  <requirement>NEVER return articles without abstracts unless specifically requested</requirement>\n</critical_requirements>`;", "/**\n * ============================================================================\n * OPENWORK MEDICAL SOURCE BIBLE\n * ============================================================================\n * \n * The \"Ivy League\" of Medical Literature\n * \n * Just as Stanford, Harvard, Oxford, Cambridge are to universities,\n * these sources are to medical literature \u2014 the gold standards that\n * doctors actually read and trust.\n * \n * This file provides:\n * 1. Authoritative organizations by medical specialty\n * 2. Top journals with PubMed abbreviations for filtering\n * 3. Guideline sources with trigger keywords\n * 4. Tavily search domains for web retrieval\n * \n * USAGE: Import into Query Intelligence, PubMed Agent, and Tavily Agent\n * ============================================================================\n */\n\n// ============================================================================\n// PART 1: THE \"BIG 4\" GENERAL MEDICAL JOURNALS\n// ============================================================================\n// These are the absolute top-tier, cover ALL specialties\n// If a study appears here, it's practice-changing\n\nexport const TIER_1_GENERAL_JOURNALS = {\n  id: \"general_medicine\",\n  name: \"General Medicine (Top Tier)\",\n  description: \"The absolute top medical journals - equivalent to Nature/Science for medicine. Every doctor reads these.\",\n  journals: [\n    {\n      name: \"New England Journal of Medicine\",\n      abbreviation: \"N Engl J Med\",\n      pubmed_filter: '\"N Engl J Med\"[Journal]',\n      impact_factor: 158.5,\n      publisher: \"Massachusetts Medical Society\",\n      why_important: \"THE most prestigious medical journal. Landmark trials, new drug approvals, practice-changing guidelines. If it's in NEJM, it matters.\",\n      website: \"nejm.org\"\n    },\n    {\n      name: \"The Lancet\",\n      abbreviation: \"Lancet\",\n      pubmed_filter: '\"Lancet\"[Journal]',\n      impact_factor: 168.9,\n      publisher: \"Elsevier\",\n      why_important: \"UK-based global health leader. Major trials, global health policy, infectious disease outbreaks.\",\n      website: \"thelancet.com\"\n    },\n    {\n      name: \"JAMA (Journal of the American Medical Association)\",\n      abbreviation: \"JAMA\",\n      pubmed_filter: '\"JAMA\"[Journal]',\n      impact_factor: 120.7,\n      publisher: \"American Medical Association\",\n      why_important: \"US clinical practice standard. Clinical trials, medical policy, systematic reviews.\",\n      website: \"jamanetwork.com\"\n    },\n    {\n      name: \"BMJ (British Medical Journal)\",\n      abbreviation: \"BMJ\",\n      pubmed_filter: '\"BMJ\"[Journal]',\n      impact_factor: 105.7,\n      publisher: \"BMJ Publishing Group\",\n      why_important: \"UK primary care focus. Clinical guidelines, research methodology, medical education.\",\n      website: \"bmj.com\"\n    },\n    {\n      name: \"Annals of Internal Medicine\",\n      abbreviation: \"Ann Intern Med\",\n      pubmed_filter: '\"Ann Intern Med\"[Journal]',\n      impact_factor: 51.6,\n      publisher: \"American College of Physicians\",\n      why_important: \"Internal medicine gold standard. Clinical practice guidelines, systematic reviews.\",\n      website: \"acpjournals.org\"\n    }\n  ],\n  pubmed_combined_filter: '(\"N Engl J Med\"[Journal] OR \"Lancet\"[Journal] OR \"JAMA\"[Journal] OR \"BMJ\"[Journal] OR \"Ann Intern Med\"[Journal])'\n};\n\n\n// ============================================================================\n// PART 2: SPECIALTY-SPECIFIC SOURCES BY BODY SYSTEM\n// ============================================================================\n\nexport interface MedicalSpecialtySource {\n  id: string;\n  specialty: string;\n  body_systems: string[];\n  trigger_keywords: string[];  // Keywords that should route queries here\n  \n  // Guideline Organizations (THE authority)\n  guideline_organizations: {\n    name: string;\n    abbreviation: string;\n    website: string;\n    tavily_domain: string;\n    description: string;\n    guideline_types: string[];\n  }[];\n  \n  // Top Journals (what doctors actually read)\n  top_journals: {\n    name: string;\n    abbreviation: string;\n    pubmed_filter: string;\n    impact_factor: number;\n    why_important: string;\n  }[];\n  \n  // PubMed filter to get articles from top journals only\n  pubmed_elite_filter: string;\n  \n  // Tavily domains to search for guidelines/updates\n  tavily_search_domains: string[];\n}\n\nexport const MEDICAL_SPECIALTIES: MedicalSpecialtySource[] = [\n  \n  // =========================================================================\n  // CARDIOVASCULAR SYSTEM (Heart, Blood Vessels)\n  // =========================================================================\n  {\n    id: \"cardiovascular\",\n    specialty: \"Cardiology\",\n    body_systems: [\"heart\", \"blood vessels\", \"circulatory system\"],\n    trigger_keywords: [\n      \"heart\", \"cardiac\", \"cardiovascular\", \"coronary\", \"myocardial\",\n      \"arrhythmia\", \"atrial fibrillation\", \"AF\", \"AFib\", \"heart failure\", \"HF\",\n      \"hypertension\", \"blood pressure\", \"HTN\", \"lipid\", \"cholesterol\", \"LDL\", \"HDL\",\n      \"statin\", \"ASCVD\", \"angina\", \"MI\", \"myocardial infarction\", \"heart attack\",\n      \"valve\", \"aortic\", \"mitral\", \"pacemaker\", \"ICD\", \"ablation\",\n      \"cardiomyopathy\", \"endocarditis\", \"pericarditis\", \"CHF\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Heart Association / American College of Cardiology\",\n        abbreviation: \"AHA/ACC\",\n        website: \"heart.org / acc.org\",\n        tavily_domain: \"site:heart.org OR site:acc.org\",\n        description: \"THE US authority on cardiovascular disease. Their guidelines define standard of care in America.\",\n        guideline_types: [\"Hypertension\", \"Heart Failure\", \"Lipid Management\", \"Arrhythmias\", \"Valvular Disease\", \"Prevention\"]\n      },\n      {\n        name: \"European Society of Cardiology\",\n        abbreviation: \"ESC\",\n        website: \"escardio.org\",\n        tavily_domain: \"site:escardio.org\",\n        description: \"European counterpart to AHA/ACC. Often more aggressive targets (e.g., LDL goals). Used globally.\",\n        guideline_types: [\"All cardiovascular conditions\", \"Often differs from ACC/AHA on targets\"]\n      },\n      {\n        name: \"Heart Rhythm Society\",\n        abbreviation: \"HRS\",\n        website: \"hrsonline.org\",\n        tavily_domain: \"site:hrsonline.org\",\n        description: \"Electrophysiology and arrhythmia specialists. Pacemakers, ICDs, ablation.\",\n        guideline_types: [\"Atrial Fibrillation\", \"Sudden Cardiac Death\", \"Device Therapy\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Circulation\",\n        abbreviation: \"Circulation\",\n        pubmed_filter: '\"Circulation\"[Journal]',\n        impact_factor: 37.8,\n        why_important: \"AHA flagship. Where major cardiology guidelines are published.\"\n      },\n      {\n        name: \"European Heart Journal\",\n        abbreviation: \"Eur Heart J\",\n        pubmed_filter: '\"Eur Heart J\"[Journal]',\n        impact_factor: 35.6,\n        why_important: \"ESC flagship. European guidelines, major trials.\"\n      },\n      {\n        name: \"Journal of the American College of Cardiology\",\n        abbreviation: \"J Am Coll Cardiol\",\n        pubmed_filter: '\"J Am Coll Cardiol\"[Journal]',\n        impact_factor: 22.3,\n        why_important: \"ACC flagship. Clinical cardiology, interventional procedures.\"\n      },\n      {\n        name: \"JAMA Cardiology\",\n        abbreviation: \"JAMA Cardiol\",\n        pubmed_filter: '\"JAMA Cardiol\"[Journal]',\n        impact_factor: 14.7,\n        why_important: \"High-impact clinical cardiology research.\"\n      },\n      {\n        name: \"Nature Reviews Cardiology\",\n        abbreviation: \"Nat Rev Cardiol\",\n        pubmed_filter: '\"Nat Rev Cardiol\"[Journal]',\n        impact_factor: 41.7,\n        why_important: \"Authoritative reviews of cardiovascular topics.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Circulation\"[Journal] OR \"Eur Heart J\"[Journal] OR \"J Am Coll Cardiol\"[Journal] OR \"JAMA Cardiol\"[Journal] OR \"Nat Rev Cardiol\"[Journal])',\n    \n    tavily_search_domains: [\"heart.org\", \"acc.org\", \"escardio.org\", \"hrsonline.org\"]\n  },\n\n  // =========================================================================\n  // RESPIRATORY SYSTEM (Lungs, Airways)\n  // =========================================================================\n  {\n    id: \"respiratory\",\n    specialty: \"Pulmonology / Respiratory Medicine\",\n    body_systems: [\"lungs\", \"airways\", \"respiratory tract\", \"bronchi\", \"alveoli\"],\n    trigger_keywords: [\n      \"asthma\", \"COPD\", \"chronic obstructive\", \"emphysema\", \"bronchitis\",\n      \"pneumonia\", \"lung\", \"pulmonary\", \"respiratory\", \"breathing\", \"dyspnea\",\n      \"inhaler\", \"bronchodilator\", \"ICS\", \"LABA\", \"LAMA\", \"spirometry\",\n      \"FEV1\", \"peak flow\", \"oxygen\", \"hypoxia\", \"sleep apnea\", \"OSA\",\n      \"pulmonary fibrosis\", \"IPF\", \"interstitial lung disease\", \"ILD\",\n      \"tuberculosis\", \"TB\", \"pleural\", \"pneumothorax\", \"PE\", \"pulmonary embolism\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"Global Initiative for Asthma\",\n        abbreviation: \"GINA\",\n        website: \"ginasthma.org\",\n        tavily_domain: \"site:ginasthma.org\",\n        description: \"THE global authority on asthma management. Used worldwide. Updated annually. THIS IS CRITICAL - Open Evidence uses this heavily.\",\n        guideline_types: [\"Asthma diagnosis\", \"Asthma treatment stepwise\", \"Asthma-COPD overlap\"]\n      },\n      {\n        name: \"Global Initiative for Chronic Obstructive Lung Disease\",\n        abbreviation: \"GOLD\",\n        website: \"goldcopd.org\",\n        tavily_domain: \"site:goldcopd.org\",\n        description: \"THE global authority on COPD. Defines GOLD stages (A/B/C/D \u2192 now ABE). Updated annually.\",\n        guideline_types: [\"COPD diagnosis\", \"COPD treatment\", \"Exacerbation management\"]\n      },\n      {\n        name: \"American Thoracic Society / European Respiratory Society\",\n        abbreviation: \"ATS/ERS\",\n        website: \"thoracic.org / ersnet.org\",\n        tavily_domain: \"site:thoracic.org OR site:ersnet.org\",\n        description: \"Joint guidelines for complex pulmonary conditions. IPF, pulmonary hypertension.\",\n        guideline_types: [\"Pulmonary fibrosis\", \"Pulmonary hypertension\", \"Lung function testing\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"American Journal of Respiratory and Critical Care Medicine\",\n        abbreviation: \"Am J Respir Crit Care Med\",\n        pubmed_filter: '\"Am J Respir Crit Care Med\"[Journal]',\n        impact_factor: 24.7,\n        why_important: \"ATS flagship. Where major pulmonary guidelines appear.\"\n      },\n      {\n        name: \"The Lancet Respiratory Medicine\",\n        abbreviation: \"Lancet Respir Med\",\n        pubmed_filter: '\"Lancet Respir Med\"[Journal]',\n        impact_factor: 38.7,\n        why_important: \"High-impact respiratory trials and reviews.\"\n      },\n      {\n        name: \"European Respiratory Journal\",\n        abbreviation: \"Eur Respir J\",\n        pubmed_filter: '\"Eur Respir J\"[Journal]',\n        impact_factor: 16.6,\n        why_important: \"ERS flagship. European respiratory research.\"\n      },\n      {\n        name: \"Chest\",\n        abbreviation: \"Chest\",\n        pubmed_filter: '\"Chest\"[Journal]',\n        impact_factor: 9.6,\n        why_important: \"ACCP journal. Practical pulmonary and critical care.\"\n      },\n      {\n        name: \"Thorax\",\n        abbreviation: \"Thorax\",\n        pubmed_filter: '\"Thorax\"[Journal]',\n        impact_factor: 9.0,\n        why_important: \"BMJ respiratory journal. UK/European perspective.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Am J Respir Crit Care Med\"[Journal] OR \"Lancet Respir Med\"[Journal] OR \"Eur Respir J\"[Journal] OR \"Chest\"[Journal] OR \"Thorax\"[Journal])',\n    \n    tavily_search_domains: [\"ginasthma.org\", \"goldcopd.org\", \"thoracic.org\", \"ersnet.org\"]\n  },\n\n  // =========================================================================\n  // ENDOCRINE SYSTEM (Hormones, Metabolism)\n  // =========================================================================\n  {\n    id: \"endocrine\",\n    specialty: \"Endocrinology / Diabetology\",\n    body_systems: [\"pancreas\", \"thyroid\", \"adrenal\", \"pituitary\", \"metabolism\"],\n    trigger_keywords: [\n      \"diabetes\", \"T1DM\", \"T2DM\", \"type 1\", \"type 2\", \"HbA1c\", \"A1c\",\n      \"glucose\", \"insulin\", \"metformin\", \"GLP-1\", \"SGLT2\", \"sulfonylurea\",\n      \"hypoglycemia\", \"hyperglycemia\", \"DKA\", \"diabetic ketoacidosis\",\n      \"thyroid\", \"hypothyroid\", \"hyperthyroid\", \"TSH\", \"T4\", \"T3\", \"Graves\",\n      \"Hashimoto\", \"thyroiditis\", \"goiter\", \"thyroid nodule\",\n      \"obesity\", \"weight loss\", \"BMI\", \"metabolic syndrome\",\n      \"adrenal\", \"Cushing\", \"Addison\", \"cortisol\", \"aldosterone\",\n      \"pituitary\", \"prolactin\", \"growth hormone\", \"acromegaly\",\n      \"osteoporosis\", \"bone density\", \"DEXA\", \"calcium\", \"vitamin D\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Diabetes Association\",\n        abbreviation: \"ADA\",\n        website: \"diabetes.org\",\n        tavily_domain: \"site:diabetes.org OR site:diabetesjournals.org\",\n        description: \"THE US authority on diabetes. Standards of Care updated annually. Defines treatment algorithms.\",\n        guideline_types: [\"Type 2 diabetes treatment algorithm\", \"Type 1 management\", \"Gestational diabetes\", \"Complications screening\"]\n      },\n      {\n        name: \"European Association for the Study of Diabetes\",\n        abbreviation: \"EASD\",\n        website: \"easd.org\",\n        tavily_domain: \"site:easd.org\",\n        description: \"European diabetes authority. Joint guidelines with ADA for T2DM management.\",\n        guideline_types: [\"Type 2 diabetes (joint with ADA)\", \"European perspective on new agents\"]\n      },\n      {\n        name: \"American Thyroid Association\",\n        abbreviation: \"ATA\",\n        website: \"thyroid.org\",\n        tavily_domain: \"site:thyroid.org\",\n        description: \"THE authority on thyroid disorders. Thyroid nodule management, thyroid cancer.\",\n        guideline_types: [\"Thyroid nodule evaluation\", \"Thyroid cancer\", \"Hypothyroidism\", \"Hyperthyroidism\"]\n      },\n      {\n        name: \"Endocrine Society\",\n        abbreviation: \"ES\",\n        website: \"endocrine.org\",\n        tavily_domain: \"site:endocrine.org\",\n        description: \"Broad endocrinology authority. Pituitary, adrenal, bone disorders.\",\n        guideline_types: [\"Osteoporosis\", \"Pituitary disorders\", \"Adrenal insufficiency\", \"Testosterone therapy\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Diabetes Care\",\n        abbreviation: \"Diabetes Care\",\n        pubmed_filter: '\"Diabetes Care\"[Journal]',\n        impact_factor: 14.8,\n        why_important: \"ADA flagship for clinical diabetes. Where Standards of Care are published.\"\n      },\n      {\n        name: \"The Lancet Diabetes & Endocrinology\",\n        abbreviation: \"Lancet Diabetes Endocrinol\",\n        pubmed_filter: '\"Lancet Diabetes Endocrinol\"[Journal]',\n        impact_factor: 44.0,\n        why_important: \"Highest impact endocrinology journal. Major trials.\"\n      },\n      {\n        name: \"Diabetologia\",\n        abbreviation: \"Diabetologia\",\n        pubmed_filter: '\"Diabetologia\"[Journal]',\n        impact_factor: 8.2,\n        why_important: \"EASD official journal. European diabetes research.\"\n      },\n      {\n        name: \"Journal of Clinical Endocrinology & Metabolism\",\n        abbreviation: \"J Clin Endocrinol Metab\",\n        pubmed_filter: '\"J Clin Endocrinol Metab\"[Journal]',\n        impact_factor: 5.8,\n        why_important: \"Endocrine Society flagship. Broad endocrinology coverage.\"\n      },\n      {\n        name: \"Thyroid\",\n        abbreviation: \"Thyroid\",\n        pubmed_filter: '\"Thyroid\"[Journal]',\n        impact_factor: 5.3,\n        why_important: \"ATA official journal. All things thyroid.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Diabetes Care\"[Journal] OR \"Lancet Diabetes Endocrinol\"[Journal] OR \"Diabetologia\"[Journal] OR \"J Clin Endocrinol Metab\"[Journal] OR \"Thyroid\"[Journal])',\n    \n    tavily_search_domains: [\"diabetes.org\", \"diabetesjournals.org\", \"easd.org\", \"thyroid.org\", \"endocrine.org\"]\n  },\n\n  // =========================================================================\n  // RENAL SYSTEM (Kidneys)\n  // =========================================================================\n  {\n    id: \"renal\",\n    specialty: \"Nephrology\",\n    body_systems: [\"kidneys\", \"urinary tract\", \"renal system\"],\n    trigger_keywords: [\n      \"kidney\", \"renal\", \"nephro\", \"CKD\", \"chronic kidney disease\",\n      \"GFR\", \"eGFR\", \"creatinine\", \"BUN\", \"proteinuria\", \"albuminuria\",\n      \"dialysis\", \"hemodialysis\", \"peritoneal dialysis\", \"ESRD\", \"end-stage\",\n      \"AKI\", \"acute kidney injury\", \"nephritis\", \"glomerulonephritis\",\n      \"nephrotic\", \"nephritic\", \"IgA nephropathy\", \"FSGS\", \"membranous\",\n      \"polycystic kidney\", \"PKD\", \"transplant\", \"kidney transplant\",\n      \"electrolyte\", \"hyperkalemia\", \"hyponatremia\", \"acidosis\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"Kidney Disease: Improving Global Outcomes\",\n        abbreviation: \"KDIGO\",\n        website: \"kdigo.org\",\n        tavily_domain: \"site:kdigo.org\",\n        description: \"THE global authority on kidney disease. Defines CKD staging, treatment targets. Used worldwide.\",\n        guideline_types: [\"CKD evaluation/management\", \"AKI\", \"Glomerulonephritis\", \"Blood pressure in CKD\", \"Anemia in CKD\", \"Dialysis\"]\n      },\n      {\n        name: \"American Society of Nephrology\",\n        abbreviation: \"ASN\",\n        website: \"asn-online.org\",\n        tavily_domain: \"site:asn-online.org\",\n        description: \"US nephrology society. Educational resources, policy positions.\",\n        guideline_types: [\"Clinical practice\", \"Nephrology education\"]\n      },\n      {\n        name: \"Renal Association (UK)\",\n        abbreviation: \"RA\",\n        website: \"renal.org\",\n        tavily_domain: \"site:renal.org\",\n        description: \"UK nephrology guidelines. Practical CKD management.\",\n        guideline_types: [\"CKD management UK\", \"Dialysis standards\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Journal of the American Society of Nephrology\",\n        abbreviation: \"J Am Soc Nephrol\",\n        pubmed_filter: '\"J Am Soc Nephrol\"[Journal]',\n        impact_factor: 10.3,\n        why_important: \"ASN flagship. Top nephrology research.\"\n      },\n      {\n        name: \"Kidney International\",\n        abbreviation: \"Kidney Int\",\n        pubmed_filter: '\"Kidney Int\"[Journal]',\n        impact_factor: 14.8,\n        why_important: \"ISN official journal. Where KDIGO guidelines appear.\"\n      },\n      {\n        name: \"Clinical Journal of the American Society of Nephrology\",\n        abbreviation: \"Clin J Am Soc Nephrol\",\n        pubmed_filter: '\"Clin J Am Soc Nephrol\"[Journal]',\n        impact_factor: 9.0,\n        why_important: \"Clinical nephrology focus. Practical management.\"\n      },\n      {\n        name: \"American Journal of Kidney Diseases\",\n        abbreviation: \"Am J Kidney Dis\",\n        pubmed_filter: '\"Am J Kidney Dis\"[Journal]',\n        impact_factor: 9.4,\n        why_important: \"NKF official journal. Clinical CKD management.\"\n      },\n      {\n        name: \"Nature Reviews Nephrology\",\n        abbreviation: \"Nat Rev Nephrol\",\n        pubmed_filter: '\"Nat Rev Nephrol\"[Journal]',\n        impact_factor: 28.6,\n        why_important: \"Authoritative nephrology reviews.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"J Am Soc Nephrol\"[Journal] OR \"Kidney Int\"[Journal] OR \"Clin J Am Soc Nephrol\"[Journal] OR \"Am J Kidney Dis\"[Journal] OR \"Nat Rev Nephrol\"[Journal])',\n    \n    tavily_search_domains: [\"kdigo.org\", \"asn-online.org\", \"kidney.org\"]\n  },\n\n  // =========================================================================\n  // GASTROINTESTINAL SYSTEM (Stomach, Intestines, Liver)\n  // =========================================================================\n  {\n    id: \"gastrointestinal\",\n    specialty: \"Gastroenterology / Hepatology\",\n    body_systems: [\"stomach\", \"intestines\", \"liver\", \"pancreas\", \"esophagus\", \"colon\"],\n    trigger_keywords: [\n      \"GI\", \"gastrointestinal\", \"stomach\", \"gastric\", \"intestine\", \"bowel\",\n      \"GERD\", \"reflux\", \"heartburn\", \"PPI\", \"H2 blocker\", \"esophagus\",\n      \"IBD\", \"Crohn\", \"ulcerative colitis\", \"UC\", \"inflammatory bowel\",\n      \"IBS\", \"irritable bowel\", \"constipation\", \"diarrhea\",\n      \"liver\", \"hepatic\", \"hepatitis\", \"cirrhosis\", \"fatty liver\", \"NAFLD\", \"NASH\",\n      \"ALT\", \"AST\", \"bilirubin\", \"jaundice\", \"ascites\", \"variceal\",\n      \"colon\", \"colonoscopy\", \"polyp\", \"colorectal\", \"GI bleeding\",\n      \"celiac\", \"gluten\", \"pancreatitis\", \"ERCP\", \"gallbladder\", \"cholecystitis\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Gastroenterological Association\",\n        abbreviation: \"AGA\",\n        website: \"gastro.org\",\n        tavily_domain: \"site:gastro.org\",\n        description: \"THE US GI authority. Clinical practice guidelines for all GI conditions.\",\n        guideline_types: [\"IBD\", \"GERD\", \"IBS\", \"GI bleeding\", \"Colon cancer screening\"]\n      },\n      {\n        name: \"American College of Gastroenterology\",\n        abbreviation: \"ACG\",\n        website: \"gi.org\",\n        tavily_domain: \"site:gi.org\",\n        description: \"Clinical GI guidelines. Practical management recommendations.\",\n        guideline_types: [\"H. pylori\", \"Hepatitis C\", \"Liver disease\", \"Motility disorders\"]\n      },\n      {\n        name: \"American Association for the Study of Liver Diseases\",\n        abbreviation: \"AASLD\",\n        website: \"aasld.org\",\n        tavily_domain: \"site:aasld.org\",\n        description: \"THE liver disease authority. Hepatitis, cirrhosis, liver cancer.\",\n        guideline_types: [\"Hepatitis B\", \"Hepatitis C\", \"NAFLD/NASH\", \"Cirrhosis\", \"HCC surveillance\"]\n      },\n      {\n        name: \"European Association for the Study of the Liver\",\n        abbreviation: \"EASL\",\n        website: \"easl.eu\",\n        tavily_domain: \"site:easl.eu\",\n        description: \"European liver authority. Complements AASLD.\",\n        guideline_types: [\"Viral hepatitis\", \"Autoimmune liver disease\", \"Alcoholic liver disease\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Gastroenterology\",\n        abbreviation: \"Gastroenterology\",\n        pubmed_filter: '\"Gastroenterology\"[Journal]',\n        impact_factor: 25.7,\n        why_important: \"AGA flagship. Top GI research and guidelines.\"\n      },\n      {\n        name: \"Gut\",\n        abbreviation: \"Gut\",\n        pubmed_filter: '\"Gut\"[Journal]',\n        impact_factor: 23.0,\n        why_important: \"BMJ GI journal. European GI research.\"\n      },\n      {\n        name: \"Hepatology\",\n        abbreviation: \"Hepatology\",\n        pubmed_filter: '\"Hepatology\"[Journal]',\n        impact_factor: 12.9,\n        why_important: \"AASLD flagship. THE liver journal.\"\n      },\n      {\n        name: \"American Journal of Gastroenterology\",\n        abbreviation: \"Am J Gastroenterol\",\n        pubmed_filter: '\"Am J Gastroenterol\"[Journal]',\n        impact_factor: 9.4,\n        why_important: \"ACG official journal. Clinical GI practice.\"\n      },\n      {\n        name: \"Journal of Hepatology\",\n        abbreviation: \"J Hepatol\",\n        pubmed_filter: '\"J Hepatol\"[Journal]',\n        impact_factor: 25.7,\n        why_important: \"EASL official journal. European liver research.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Gastroenterology\"[Journal] OR \"Gut\"[Journal] OR \"Hepatology\"[Journal] OR \"Am J Gastroenterol\"[Journal] OR \"J Hepatol\"[Journal])',\n    \n    tavily_search_domains: [\"gastro.org\", \"gi.org\", \"aasld.org\", \"easl.eu\"]\n  },\n\n  // =========================================================================\n  // NERVOUS SYSTEM (Brain, Spinal Cord, Nerves)\n  // =========================================================================\n  {\n    id: \"neurological\",\n    specialty: \"Neurology\",\n    body_systems: [\"brain\", \"spinal cord\", \"peripheral nerves\", \"nervous system\"],\n    trigger_keywords: [\n      \"neuro\", \"brain\", \"stroke\", \"CVA\", \"TIA\", \"cerebrovascular\",\n      \"seizure\", \"epilepsy\", \"anticonvulsant\", \"antiepileptic\",\n      \"headache\", \"migraine\", \"cluster headache\", \"tension headache\",\n      \"Parkinson\", \"tremor\", \"movement disorder\", \"dystonia\",\n      \"Alzheimer\", \"dementia\", \"cognitive\", \"memory loss\",\n      \"multiple sclerosis\", \"MS\", \"neuropathy\", \"peripheral neuropathy\",\n      \"myasthenia gravis\", \"ALS\", \"motor neuron\", \"Guillain-Barre\",\n      \"meningitis\", \"encephalitis\", \"brain tumor\", \"glioma\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Academy of Neurology\",\n        abbreviation: \"AAN\",\n        website: \"aan.com\",\n        tavily_domain: \"site:aan.com\",\n        description: \"THE US neurology authority. Practice guidelines for all neurological conditions.\",\n        guideline_types: [\"Epilepsy\", \"Stroke\", \"MS\", \"Parkinson's\", \"Headache\", \"Dementia\"]\n      },\n      {\n        name: \"American Stroke Association\",\n        abbreviation: \"ASA\",\n        website: \"stroke.org\",\n        tavily_domain: \"site:stroke.org\",\n        description: \"AHA division for stroke. Acute stroke management, prevention.\",\n        guideline_types: [\"Acute ischemic stroke\", \"Hemorrhagic stroke\", \"Secondary prevention\", \"TIA\"]\n      },\n      {\n        name: \"European Academy of Neurology\",\n        abbreviation: \"EAN\",\n        website: \"ean.org\",\n        tavily_domain: \"site:ean.org\",\n        description: \"European neurology authority. European perspective on neurological care.\",\n        guideline_types: [\"MS\", \"Epilepsy\", \"Movement disorders\"]\n      },\n      {\n        name: \"International Headache Society\",\n        abbreviation: \"IHS\",\n        website: \"ihs-headache.org\",\n        tavily_domain: \"site:ihs-headache.org\",\n        description: \"THE authority on headache classification and treatment.\",\n        guideline_types: [\"ICHD classification\", \"Migraine treatment\", \"Cluster headache\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Lancet Neurology\",\n        abbreviation: \"Lancet Neurol\",\n        pubmed_filter: '\"Lancet Neurol\"[Journal]',\n        impact_factor: 46.5,\n        why_important: \"Highest impact neurology journal. Major trials and reviews.\"\n      },\n      {\n        name: \"Neurology\",\n        abbreviation: \"Neurology\",\n        pubmed_filter: '\"Neurology\"[Journal]',\n        impact_factor: 9.9,\n        why_important: \"AAN official journal. Where AAN guidelines appear.\"\n      },\n      {\n        name: \"Brain\",\n        abbreviation: \"Brain\",\n        pubmed_filter: '\"Brain\"[Journal]',\n        impact_factor: 13.5,\n        why_important: \"Historic neuroscience journal. Deep mechanistic neurology.\"\n      },\n      {\n        name: \"Annals of Neurology\",\n        abbreviation: \"Ann Neurol\",\n        pubmed_filter: '\"Ann Neurol\"[Journal]',\n        impact_factor: 11.2,\n        why_important: \"ANA official journal. Clinical neurology research.\"\n      },\n      {\n        name: \"Stroke\",\n        abbreviation: \"Stroke\",\n        pubmed_filter: '\"Stroke\"[Journal]',\n        impact_factor: 10.2,\n        why_important: \"ASA official journal. THE stroke journal.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Lancet Neurol\"[Journal] OR \"Neurology\"[Journal] OR \"Brain\"[Journal] OR \"Ann Neurol\"[Journal] OR \"Stroke\"[Journal])',\n    \n    tavily_search_domains: [\"aan.com\", \"stroke.org\", \"ean.org\", \"ihs-headache.org\"]\n  },\n\n  // =========================================================================\n  // ONCOLOGY (Cancer)\n  // =========================================================================\n  {\n    id: \"oncology\",\n    specialty: \"Oncology\",\n    body_systems: [\"all organs - cancer affects all\"],\n    trigger_keywords: [\n      \"cancer\", \"tumor\", \"malignant\", \"oncology\", \"carcinoma\", \"sarcoma\",\n      \"lymphoma\", \"leukemia\", \"myeloma\", \"melanoma\",\n      \"breast cancer\", \"lung cancer\", \"colon cancer\", \"prostate cancer\",\n      \"chemotherapy\", \"immunotherapy\", \"targeted therapy\", \"radiation\",\n      \"PD-1\", \"PD-L1\", \"checkpoint inhibitor\", \"CAR-T\",\n      \"staging\", \"TNM\", \"metastatic\", \"metastasis\",\n      \"HER2\", \"EGFR\", \"ALK\", \"BRCA\", \"MSI\", \"TMB\",\n      \"survival\", \"PFS\", \"OS\", \"response rate\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"National Comprehensive Cancer Network\",\n        abbreviation: \"NCCN\",\n        website: \"nccn.org\",\n        tavily_domain: \"site:nccn.org\",\n        description: \"THE US oncology guideline authority. Defines standard of care for ALL cancers. Open Evidence has licensed partnership with them.\",\n        guideline_types: [\"ALL cancer types\", \"Supportive care\", \"Survivorship\", \"Genetic testing\"]\n      },\n      {\n        name: \"American Society of Clinical Oncology\",\n        abbreviation: \"ASCO\",\n        website: \"asco.org\",\n        tavily_domain: \"site:asco.org\",\n        description: \"THE oncology professional society. Clinical practice guidelines, where major trials are presented.\",\n        guideline_types: [\"Specific cancer treatments\", \"Supportive care\", \"Quality measures\"]\n      },\n      {\n        name: \"European Society for Medical Oncology\",\n        abbreviation: \"ESMO\",\n        website: \"esmo.org\",\n        tavily_domain: \"site:esmo.org\",\n        description: \"European oncology authority. Sometimes differs from NCCN/ASCO on treatment sequencing.\",\n        guideline_types: [\"All cancer types - European perspective\", \"Clinical Practice Guidelines\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"CA: A Cancer Journal for Clinicians\",\n        abbreviation: \"CA Cancer J Clin\",\n        pubmed_filter: '\"CA Cancer J Clin\"[Journal]',\n        impact_factor: 254.7,\n        why_important: \"HIGHEST impact factor of ANY journal. Cancer statistics, major reviews.\"\n      },\n      {\n        name: \"Journal of Clinical Oncology\",\n        abbreviation: \"J Clin Oncol\",\n        pubmed_filter: '\"J Clin Oncol\"[Journal]',\n        impact_factor: 42.1,\n        why_important: \"ASCO flagship. THE clinical oncology journal. All major trials.\"\n      },\n      {\n        name: \"Lancet Oncology\",\n        abbreviation: \"Lancet Oncol\",\n        pubmed_filter: '\"Lancet Oncol\"[Journal]',\n        impact_factor: 41.3,\n        why_important: \"High-impact oncology trials and reviews.\"\n      },\n      {\n        name: \"JAMA Oncology\",\n        abbreviation: \"JAMA Oncol\",\n        pubmed_filter: '\"JAMA Oncol\"[Journal]',\n        impact_factor: 22.5,\n        why_important: \"High-impact clinical oncology research.\"\n      },\n      {\n        name: \"Annals of Oncology\",\n        abbreviation: \"Ann Oncol\",\n        pubmed_filter: '\"Ann Oncol\"[Journal]',\n        impact_factor: 32.4,\n        why_important: \"ESMO official journal. European clinical oncology.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"CA Cancer J Clin\"[Journal] OR \"J Clin Oncol\"[Journal] OR \"Lancet Oncol\"[Journal] OR \"JAMA Oncol\"[Journal] OR \"Ann Oncol\"[Journal])',\n    \n    tavily_search_domains: [\"nccn.org\", \"asco.org\", \"esmo.org\", \"cancer.gov\", \"cancer.org\"]\n  },\n\n  // =========================================================================\n  // INFECTIOUS DISEASES\n  // =========================================================================\n  {\n    id: \"infectious\",\n    specialty: \"Infectious Diseases\",\n    body_systems: [\"all organs - infections affect all\"],\n    trigger_keywords: [\n      \"infection\", \"infectious\", \"bacteria\", \"bacterial\", \"virus\", \"viral\",\n      \"antibiotic\", \"antimicrobial\", \"antiviral\", \"antifungal\",\n      \"sepsis\", \"septic\", \"fever\", \"febrile\",\n      \"HIV\", \"AIDS\", \"hepatitis\", \"HBV\", \"HCV\",\n      \"COVID\", \"coronavirus\", \"influenza\", \"flu\", \"RSV\",\n      \"pneumonia\", \"UTI\", \"urinary tract infection\", \"cellulitis\",\n      \"meningitis\", \"endocarditis\", \"osteomyelitis\",\n      \"MRSA\", \"C. diff\", \"Clostridioides\", \"resistant\", \"MDR\",\n      \"tuberculosis\", \"TB\", \"malaria\", \"dengue\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"Infectious Diseases Society of America\",\n        abbreviation: \"IDSA\",\n        website: \"idsociety.org\",\n        tavily_domain: \"site:idsociety.org\",\n        description: \"THE US ID authority. Comprehensive infection management guidelines.\",\n        guideline_types: [\"ALL infections\", \"Antimicrobial stewardship\", \"HIV\", \"Hepatitis\"]\n      },\n      {\n        name: \"Centers for Disease Control and Prevention\",\n        abbreviation: \"CDC\",\n        website: \"cdc.gov\",\n        tavily_domain: \"site:cdc.gov\",\n        description: \"US public health authority. Vaccines, outbreak management, STIs.\",\n        guideline_types: [\"Vaccination schedules\", \"STI treatment\", \"Travel health\", \"Outbreak response\"]\n      },\n      {\n        name: \"World Health Organization\",\n        abbreviation: \"WHO\",\n        website: \"who.int\",\n        tavily_domain: \"site:who.int\",\n        description: \"Global health authority. Essential medicines, global infection control.\",\n        guideline_types: [\"Global infection guidelines\", \"Antimicrobial resistance\", \"Pandemic response\"]\n      },\n      {\n        name: \"European Society of Clinical Microbiology and Infectious Diseases\",\n        abbreviation: \"ESCMID\",\n        website: \"escmid.org\",\n        tavily_domain: \"site:escmid.org\",\n        description: \"European ID authority. European antimicrobial guidelines.\",\n        guideline_types: [\"European ID guidelines\", \"Antimicrobial resistance\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Lancet Infectious Diseases\",\n        abbreviation: \"Lancet Infect Dis\",\n        pubmed_filter: '\"Lancet Infect Dis\"[Journal]',\n        impact_factor: 36.4,\n        why_important: \"Highest impact ID journal. Major trials and reviews.\"\n      },\n      {\n        name: \"Clinical Infectious Diseases\",\n        abbreviation: \"Clin Infect Dis\",\n        pubmed_filter: '\"Clin Infect Dis\"[Journal]',\n        impact_factor: 8.3,\n        why_important: \"IDSA flagship. Where IDSA guidelines appear.\"\n      },\n      {\n        name: \"Journal of Infectious Diseases\",\n        abbreviation: \"J Infect Dis\",\n        pubmed_filter: '\"J Infect Dis\"[Journal]',\n        impact_factor: 5.0,\n        why_important: \"IDSA research journal. Pathogenesis and treatment.\"\n      },\n      {\n        name: \"JAMA Network Open - Infectious Diseases\",\n        abbreviation: \"JAMA Netw Open\",\n        pubmed_filter: '\"JAMA Netw Open\"[Journal]',\n        impact_factor: 13.8,\n        why_important: \"Open access high-impact ID research.\"\n      },\n      {\n        name: \"Emerging Infectious Diseases\",\n        abbreviation: \"Emerg Infect Dis\",\n        pubmed_filter: '\"Emerg Infect Dis\"[Journal]',\n        impact_factor: 7.2,\n        why_important: \"CDC journal. Outbreak reports, emerging pathogens.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Lancet Infect Dis\"[Journal] OR \"Clin Infect Dis\"[Journal] OR \"J Infect Dis\"[Journal] OR \"Emerg Infect Dis\"[Journal])',\n    \n    tavily_search_domains: [\"idsociety.org\", \"cdc.gov\", \"who.int\", \"escmid.org\"]\n  },\n\n  // =========================================================================\n  // RHEUMATOLOGY (Joints, Autoimmune)\n  // =========================================================================\n  {\n    id: \"rheumatology\",\n    specialty: \"Rheumatology\",\n    body_systems: [\"joints\", \"muscles\", \"connective tissue\", \"immune system\"],\n    trigger_keywords: [\n      \"arthritis\", \"rheumatoid\", \"RA\", \"osteoarthritis\", \"OA\",\n      \"lupus\", \"SLE\", \"systemic lupus\", \"autoimmune\",\n      \"gout\", \"uric acid\", \"hyperuricemia\",\n      \"psoriatic arthritis\", \"PsA\", \"ankylosing spondylitis\", \"AS\",\n      \"spondyloarthritis\", \"SpA\", \"axSpA\",\n      \"fibromyalgia\", \"polymyalgia\", \"PMR\", \"vasculitis\",\n      \"scleroderma\", \"dermatomyositis\", \"Sjogren\",\n      \"biologic\", \"DMARD\", \"methotrexate\", \"TNF inhibitor\",\n      \"joint pain\", \"synovitis\", \"inflammatory\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American College of Rheumatology\",\n        abbreviation: \"ACR\",\n        website: \"rheumatology.org\",\n        tavily_domain: \"site:rheumatology.org\",\n        description: \"THE US rheumatology authority. RA, lupus, gout treatment guidelines.\",\n        guideline_types: [\"RA treatment\", \"Lupus management\", \"Gout\", \"Vasculitis\", \"Classification criteria\"]\n      },\n      {\n        name: \"European Alliance of Associations for Rheumatology\",\n        abbreviation: \"EULAR\",\n        website: \"eular.org\",\n        tavily_domain: \"site:eular.org\",\n        description: \"European rheumatology authority. Often first with new recommendations.\",\n        guideline_types: [\"RA\", \"SpA\", \"Gout\", \"Connective tissue diseases\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Annals of the Rheumatic Diseases\",\n        abbreviation: \"Ann Rheum Dis\",\n        pubmed_filter: '\"Ann Rheum Dis\"[Journal]',\n        impact_factor: 20.3,\n        why_important: \"EULAR official journal. THE rheumatology journal.\"\n      },\n      {\n        name: \"Arthritis & Rheumatology\",\n        abbreviation: \"Arthritis Rheumatol\",\n        pubmed_filter: '\"Arthritis Rheumatol\"[Journal]',\n        impact_factor: 11.4,\n        why_important: \"ACR official journal. Where ACR guidelines appear.\"\n      },\n      {\n        name: \"Lancet Rheumatology\",\n        abbreviation: \"Lancet Rheumatol\",\n        pubmed_filter: '\"Lancet Rheumatol\"[Journal]',\n        impact_factor: 15.0,\n        why_important: \"High-impact rheumatology trials.\"\n      },\n      {\n        name: \"Rheumatology\",\n        abbreviation: \"Rheumatology (Oxford)\",\n        pubmed_filter: '\"Rheumatology (Oxford)\"[Journal]',\n        impact_factor: 5.5,\n        why_important: \"BSR official journal. UK/European rheumatology.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Ann Rheum Dis\"[Journal] OR \"Arthritis Rheumatol\"[Journal] OR \"Lancet Rheumatol\"[Journal] OR \"Rheumatology (Oxford)\"[Journal])',\n    \n    tavily_search_domains: [\"rheumatology.org\", \"eular.org\"]\n  },\n\n  // =========================================================================\n  // DERMATOLOGY (Skin)\n  // =========================================================================\n  {\n    id: \"dermatology\",\n    specialty: \"Dermatology\",\n    body_systems: [\"skin\", \"hair\", \"nails\"],\n    trigger_keywords: [\n      \"skin\", \"dermatol\", \"rash\", \"eczema\", \"atopic dermatitis\",\n      \"psoriasis\", \"acne\", \"rosacea\",\n      \"melanoma\", \"skin cancer\", \"basal cell\", \"squamous cell\",\n      \"urticaria\", \"hives\", \"angioedema\",\n      \"alopecia\", \"hair loss\", \"nail\", \"fungal\", \"tinea\",\n      \"wound\", \"ulcer\", \"pressure injury\",\n      \"biologic\", \"dupilumab\", \"IL-17\", \"IL-23\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Academy of Dermatology\",\n        abbreviation: \"AAD\",\n        website: \"aad.org\",\n        tavily_domain: \"site:aad.org\",\n        description: \"THE US dermatology authority. All skin conditions.\",\n        guideline_types: [\"Acne\", \"Psoriasis\", \"Atopic dermatitis\", \"Skin cancer\"]\n      },\n      {\n        name: \"European Academy of Dermatology and Venereology\",\n        abbreviation: \"EADV\",\n        website: \"eadv.org\",\n        tavily_domain: \"site:eadv.org\",\n        description: \"European dermatology authority.\",\n        guideline_types: [\"European dermatology guidelines\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"JAMA Dermatology\",\n        abbreviation: \"JAMA Dermatol\",\n        pubmed_filter: '\"JAMA Dermatol\"[Journal]',\n        impact_factor: 11.1,\n        why_important: \"Highest impact clinical dermatology journal.\"\n      },\n      {\n        name: \"Journal of the American Academy of Dermatology\",\n        abbreviation: \"J Am Acad Dermatol\",\n        pubmed_filter: '\"J Am Acad Dermatol\"[Journal]',\n        impact_factor: 11.5,\n        why_important: \"AAD official journal. Where AAD guidelines appear.\"\n      },\n      {\n        name: \"British Journal of Dermatology\",\n        abbreviation: \"Br J Dermatol\",\n        pubmed_filter: '\"Br J Dermatol\"[Journal]',\n        impact_factor: 9.0,\n        why_important: \"UK dermatology journal. Clinical dermatology.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"JAMA Dermatol\"[Journal] OR \"J Am Acad Dermatol\"[Journal] OR \"Br J Dermatol\"[Journal])',\n    \n    tavily_search_domains: [\"aad.org\", \"eadv.org\"]\n  },\n\n  // =========================================================================\n  // PSYCHIATRY / MENTAL HEALTH\n  // =========================================================================\n  {\n    id: \"psychiatry\",\n    specialty: \"Psychiatry\",\n    body_systems: [\"brain - mental health\"],\n    trigger_keywords: [\n      \"depression\", \"anxiety\", \"bipolar\", \"schizophrenia\", \"psychosis\",\n      \"PTSD\", \"OCD\", \"panic\", \"phobia\",\n      \"antidepressant\", \"SSRI\", \"SNRI\", \"antipsychotic\",\n      \"mood\", \"suicide\", \"self-harm\",\n      \"ADHD\", \"attention deficit\", \"autism\", \"ASD\",\n      \"eating disorder\", \"anorexia\", \"bulimia\",\n      \"substance abuse\", \"addiction\", \"alcohol use disorder\",\n      \"insomnia\", \"sleep disorder\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Psychiatric Association\",\n        abbreviation: \"APA\",\n        website: \"psychiatry.org\",\n        tavily_domain: \"site:psychiatry.org\",\n        description: \"THE US psychiatry authority. DSM, treatment guidelines.\",\n        guideline_types: [\"Depression\", \"Schizophrenia\", \"Bipolar\", \"Anxiety\", \"Substance use\"]\n      },\n      {\n        name: \"National Institute for Health and Care Excellence\",\n        abbreviation: \"NICE\",\n        website: \"nice.org.uk\",\n        tavily_domain: \"site:nice.org.uk\",\n        description: \"UK health authority. Excellent mental health guidelines.\",\n        guideline_types: [\"Depression\", \"Anxiety\", \"PTSD\", \"Psychosis\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"JAMA Psychiatry\",\n        abbreviation: \"JAMA Psychiatry\",\n        pubmed_filter: '\"JAMA Psychiatry\"[Journal]',\n        impact_factor: 22.5,\n        why_important: \"Highest impact psychiatry journal.\"\n      },\n      {\n        name: \"Lancet Psychiatry\",\n        abbreviation: \"Lancet Psychiatry\",\n        pubmed_filter: '\"Lancet Psychiatry\"[Journal]',\n        impact_factor: 30.8,\n        why_important: \"High-impact psychiatry research and reviews.\"\n      },\n      {\n        name: \"American Journal of Psychiatry\",\n        abbreviation: \"Am J Psychiatry\",\n        pubmed_filter: '\"Am J Psychiatry\"[Journal]',\n        impact_factor: 15.1,\n        why_important: \"APA official journal. US psychiatry standard.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"JAMA Psychiatry\"[Journal] OR \"Lancet Psychiatry\"[Journal] OR \"Am J Psychiatry\"[Journal])',\n    \n    tavily_search_domains: [\"psychiatry.org\", \"nice.org.uk\"]\n  },\n\n  // =========================================================================\n  // PEDIATRICS\n  // =========================================================================\n  {\n    id: \"pediatrics\",\n    specialty: \"Pediatrics\",\n    body_systems: [\"all organs - pediatric patients\"],\n    trigger_keywords: [\n      \"pediatric\", \"child\", \"children\", \"infant\", \"baby\", \"newborn\",\n      \"neonatal\", \"adolescent\", \"teen\",\n      \"vaccination\", \"immunization\", \"growth\", \"development\",\n      \"NICU\", \"premature\", \"preterm\",\n      \"congenital\", \"birth defect\",\n      \"pediatric dosing\", \"weight-based\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Academy of Pediatrics\",\n        abbreviation: \"AAP\",\n        website: \"aap.org\",\n        tavily_domain: \"site:aap.org\",\n        description: \"THE US pediatric authority. All pediatric conditions.\",\n        guideline_types: [\"Well-child care\", \"Vaccination\", \"Common pediatric conditions\", \"NICU\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Pediatrics\",\n        abbreviation: \"Pediatrics\",\n        pubmed_filter: '\"Pediatrics\"[Journal]',\n        impact_factor: 6.2,\n        why_important: \"AAP official journal. THE pediatrics journal.\"\n      },\n      {\n        name: \"JAMA Pediatrics\",\n        abbreviation: \"JAMA Pediatr\",\n        pubmed_filter: '\"JAMA Pediatr\"[Journal]',\n        impact_factor: 13.8,\n        why_important: \"High-impact pediatric research.\"\n      },\n      {\n        name: \"Lancet Child & Adolescent Health\",\n        abbreviation: \"Lancet Child Adolesc Health\",\n        pubmed_filter: '\"Lancet Child Adolesc Health\"[Journal]',\n        impact_factor: 19.9,\n        why_important: \"High-impact pediatric trials and reviews.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Pediatrics\"[Journal] OR \"JAMA Pediatr\"[Journal] OR \"Lancet Child Adolesc Health\"[Journal])',\n    \n    tavily_search_domains: [\"aap.org\", \"healthychildren.org\"]\n  },\n\n  // =========================================================================\n  // OBSTETRICS & GYNECOLOGY\n  // =========================================================================\n  {\n    id: \"obgyn\",\n    specialty: \"Obstetrics & Gynecology\",\n    body_systems: [\"uterus\", \"ovaries\", \"reproductive system\"],\n    trigger_keywords: [\n      \"pregnancy\", \"pregnant\", \"obstetric\", \"prenatal\", \"antenatal\",\n      \"gynecology\", \"menstrual\", \"menopause\", \"fertility\",\n      \"contraception\", \"birth control\", \"IUD\",\n      \"preeclampsia\", \"gestational diabetes\", \"GDM\",\n      \"cesarean\", \"C-section\", \"labor\", \"delivery\",\n      \"PCOS\", \"polycystic ovary\", \"endometriosis\",\n      \"cervical cancer\", \"ovarian cancer\", \"HPV\",\n      \"miscarriage\", \"ectopic pregnancy\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American College of Obstetricians and Gynecologists\",\n        abbreviation: \"ACOG\",\n        website: \"acog.org\",\n        tavily_domain: \"site:acog.org\",\n        description: \"THE US OB/GYN authority. All pregnancy and women's health.\",\n        guideline_types: [\"Prenatal care\", \"Labor management\", \"Contraception\", \"Menopause\", \"Gynecologic conditions\"]\n      },\n      {\n        name: \"Society for Maternal-Fetal Medicine\",\n        abbreviation: \"SMFM\",\n        website: \"smfm.org\",\n        tavily_domain: \"site:smfm.org\",\n        description: \"High-risk pregnancy specialists.\",\n        guideline_types: [\"High-risk pregnancy\", \"Fetal medicine\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Obstetrics & Gynecology\",\n        abbreviation: \"Obstet Gynecol\",\n        pubmed_filter: '\"Obstet Gynecol\"[Journal]',\n        impact_factor: 6.4,\n        why_important: \"ACOG official journal. THE OB/GYN journal.\"\n      },\n      {\n        name: \"American Journal of Obstetrics and Gynecology\",\n        abbreviation: \"Am J Obstet Gynecol\",\n        pubmed_filter: '\"Am J Obstet Gynecol\"[Journal]',\n        impact_factor: 8.7,\n        why_important: \"High-impact OB/GYN research.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Obstet Gynecol\"[Journal] OR \"Am J Obstet Gynecol\"[Journal])',\n    \n    tavily_search_domains: [\"acog.org\", \"smfm.org\"]\n  },\n\n  // =========================================================================\n  // OPHTHALMOLOGY (Eyes)\n  // =========================================================================\n  {\n    id: \"ophthalmology\",\n    specialty: \"Ophthalmology\",\n    body_systems: [\"eyes\", \"vision\"],\n    trigger_keywords: [\n      \"eye\", \"vision\", \"ophthalm\", \"retina\", \"glaucoma\",\n      \"cataract\", \"macular degeneration\", \"AMD\",\n      \"diabetic retinopathy\", \"uveitis\",\n      \"cornea\", \"conjunctivitis\", \"dry eye\",\n      \"visual acuity\", \"intraocular pressure\", \"IOP\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Academy of Ophthalmology\",\n        abbreviation: \"AAO\",\n        website: \"aao.org\",\n        tavily_domain: \"site:aao.org\",\n        description: \"THE US ophthalmology authority.\",\n        guideline_types: [\"Glaucoma\", \"Cataract\", \"AMD\", \"Diabetic eye disease\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Ophthalmology\",\n        abbreviation: \"Ophthalmology\",\n        pubmed_filter: '\"Ophthalmology\"[Journal]',\n        impact_factor: 13.7,\n        why_important: \"AAO official journal. THE ophthalmology journal.\"\n      },\n      {\n        name: \"JAMA Ophthalmology\",\n        abbreviation: \"JAMA Ophthalmol\",\n        pubmed_filter: '\"JAMA Ophthalmol\"[Journal]',\n        impact_factor: 7.3,\n        why_important: \"High-impact eye research.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Ophthalmology\"[Journal] OR \"JAMA Ophthalmol\"[Journal])',\n    \n    tavily_search_domains: [\"aao.org\"]\n  },\n\n  // =========================================================================\n  // ORTHOPEDICS (Bones, Joints, Muscles)\n  // =========================================================================\n  {\n    id: \"orthopedics\",\n    specialty: \"Orthopedics\",\n    body_systems: [\"bones\", \"joints\", \"muscles\", \"tendons\", \"ligaments\"],\n    trigger_keywords: [\n      \"orthopedic\", \"bone\", \"fracture\", \"joint replacement\",\n      \"hip replacement\", \"knee replacement\", \"TKA\", \"THA\",\n      \"spine\", \"back pain\", \"lumbar\", \"cervical\",\n      \"ACL\", \"meniscus\", \"rotator cuff\",\n      \"osteoarthritis\", \"osteoporosis\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Academy of Orthopaedic Surgeons\",\n        abbreviation: \"AAOS\",\n        website: \"aaos.org\",\n        tavily_domain: \"site:aaos.org\",\n        description: \"THE US orthopedic authority.\",\n        guideline_types: [\"Joint replacement\", \"Fracture management\", \"Spine disorders\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Journal of Bone and Joint Surgery (American)\",\n        abbreviation: \"J Bone Joint Surg Am\",\n        pubmed_filter: '\"J Bone Joint Surg Am\"[Journal]',\n        impact_factor: 5.3,\n        why_important: \"THE orthopedic surgery journal.\"\n      },\n      {\n        name: \"Clinical Orthopaedics and Related Research\",\n        abbreviation: \"Clin Orthop Relat Res\",\n        pubmed_filter: '\"Clin Orthop Relat Res\"[Journal]',\n        impact_factor: 4.2,\n        why_important: \"Broad orthopedic coverage.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"J Bone Joint Surg Am\"[Journal] OR \"Clin Orthop Relat Res\"[Journal])',\n    \n    tavily_search_domains: [\"aaos.org\"]\n  },\n\n  // =========================================================================\n  // HEMATOLOGY (Blood)\n  // =========================================================================\n  {\n    id: \"hematology\",\n    specialty: \"Hematology\",\n    body_systems: [\"blood\", \"bone marrow\", \"lymph nodes\", \"spleen\"],\n    trigger_keywords: [\n      \"blood\", \"hematol\", \"anemia\", \"hemoglobin\",\n      \"platelet\", \"thrombocytopenia\", \"bleeding\", \"coagulation\",\n      \"DVT\", \"PE\", \"VTE\", \"anticoagulation\", \"warfarin\", \"DOAC\",\n      \"leukemia\", \"lymphoma\", \"myeloma\",\n      \"sickle cell\", \"thalassemia\", \"hemophilia\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Society of Hematology\",\n        abbreviation: \"ASH\",\n        website: \"hematology.org\",\n        tavily_domain: \"site:hematology.org\",\n        description: \"THE US hematology authority.\",\n        guideline_types: [\"VTE treatment\", \"Anticoagulation\", \"Blood cancers\", \"Bleeding disorders\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Blood\",\n        abbreviation: \"Blood\",\n        pubmed_filter: '\"Blood\"[Journal]',\n        impact_factor: 21.0,\n        why_important: \"ASH official journal. THE hematology journal.\"\n      },\n      {\n        name: \"Journal of Clinical Oncology (Hematologic Oncology)\",\n        abbreviation: \"J Clin Oncol\",\n        pubmed_filter: '\"J Clin Oncol\"[Journal]',\n        impact_factor: 42.1,\n        why_important: \"Blood cancer trials and guidelines.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Blood\"[Journal])',\n    \n    tavily_search_domains: [\"hematology.org\"]\n  },\n\n  // =========================================================================\n  // UROLOGY\n  // =========================================================================\n  {\n    id: \"urology\",\n    specialty: \"Urology\",\n    body_systems: [\"bladder\", \"prostate\", \"kidneys (surgical)\", \"male reproductive\"],\n    trigger_keywords: [\n      \"urolog\", \"bladder\", \"prostate\", \"BPH\", \"PSA\",\n      \"urinary\", \"incontinence\", \"UTI\", \"kidney stone\",\n      \"nephrolithiasis\", \"erectile dysfunction\", \"ED\",\n      \"prostate cancer\", \"bladder cancer\", \"testicular\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American Urological Association\",\n        abbreviation: \"AUA\",\n        website: \"auanet.org\",\n        tavily_domain: \"site:auanet.org\",\n        description: \"THE US urology authority.\",\n        guideline_types: [\"BPH\", \"Prostate cancer\", \"Kidney stones\", \"Incontinence\"]\n      },\n      {\n        name: \"European Association of Urology\",\n        abbreviation: \"EAU\",\n        website: \"uroweb.org\",\n        tavily_domain: \"site:uroweb.org\",\n        description: \"European urology authority.\",\n        guideline_types: [\"European urology guidelines\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"European Urology\",\n        abbreviation: \"Eur Urol\",\n        pubmed_filter: '\"Eur Urol\"[Journal]',\n        impact_factor: 23.6,\n        why_important: \"Highest impact urology journal.\"\n      },\n      {\n        name: \"Journal of Urology\",\n        abbreviation: \"J Urol\",\n        pubmed_filter: '\"J Urol\"[Journal]',\n        impact_factor: 6.6,\n        why_important: \"AUA official journal.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Eur Urol\"[Journal] OR \"J Urol\"[Journal])',\n    \n    tavily_search_domains: [\"auanet.org\", \"uroweb.org\"]\n  },\n\n  // =========================================================================\n  // EMERGENCY MEDICINE\n  // =========================================================================\n  {\n    id: \"emergency\",\n    specialty: \"Emergency Medicine\",\n    body_systems: [\"all - acute presentations\"],\n    trigger_keywords: [\n      \"emergency\", \"ED\", \"ER\", \"trauma\", \"acute\",\n      \"resuscitation\", \"CPR\", \"ACLS\", \"ATLS\",\n      \"chest pain rule out\", \"syncope workup\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"American College of Emergency Physicians\",\n        abbreviation: \"ACEP\",\n        website: \"acep.org\",\n        tavily_domain: \"site:acep.org\",\n        description: \"THE US emergency medicine authority.\",\n        guideline_types: [\"Clinical policies\", \"Acute care\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Annals of Emergency Medicine\",\n        abbreviation: \"Ann Emerg Med\",\n        pubmed_filter: '\"Ann Emerg Med\"[Journal]',\n        impact_factor: 5.7,\n        why_important: \"ACEP official journal. THE EM journal.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Ann Emerg Med\"[Journal])',\n    \n    tavily_search_domains: [\"acep.org\"]\n  },\n\n  // =========================================================================\n  // CRITICAL CARE / ICU\n  // =========================================================================\n  {\n    id: \"critical_care\",\n    specialty: \"Critical Care / Intensive Care\",\n    body_systems: [\"all - critically ill patients\"],\n    trigger_keywords: [\n      \"ICU\", \"critical care\", \"intensive care\", \"ventilator\",\n      \"sepsis\", \"septic shock\", \"ARDS\", \"respiratory failure\",\n      \"vasopressor\", \"norepinephrine\", \"mechanical ventilation\"\n    ],\n    \n    guideline_organizations: [\n      {\n        name: \"Society of Critical Care Medicine\",\n        abbreviation: \"SCCM\",\n        website: \"sccm.org\",\n        tavily_domain: \"site:sccm.org\",\n        description: \"THE critical care authority. Surviving Sepsis Campaign.\",\n        guideline_types: [\"Sepsis\", \"ARDS\", \"ICU management\", \"Sedation\"]\n      }\n    ],\n    \n    top_journals: [\n      {\n        name: \"Critical Care Medicine\",\n        abbreviation: \"Crit Care Med\",\n        pubmed_filter: '\"Crit Care Med\"[Journal]',\n        impact_factor: 7.6,\n        why_important: \"SCCM official journal. THE ICU journal.\"\n      },\n      {\n        name: \"Intensive Care Medicine\",\n        abbreviation: \"Intensive Care Med\",\n        pubmed_filter: '\"Intensive Care Med\"[Journal]',\n        impact_factor: 27.1,\n        why_important: \"European ICU journal. High-impact trials.\"\n      }\n    ],\n    \n    pubmed_elite_filter: '(\"Crit Care Med\"[Journal] OR \"Intensive Care Med\"[Journal])',\n    \n    tavily_search_domains: [\"sccm.org\"]\n  }\n];\n\n\n// ============================================================================\n// PART 3: SYSTEMATIC REVIEW DATABASES (Meta-Evidence)\n// ============================================================================\n\nexport const SYSTEMATIC_REVIEW_SOURCES = {\n  cochrane: {\n    name: \"Cochrane Library\",\n    website: \"cochranelibrary.com\",\n    pubmed_filter: '\"Cochrane Database Syst Rev\"[Journal]',\n    description: \"THE gold standard for systematic reviews. If a Cochrane review exists, cite it.\",\n    priority: 1\n  },\n  \n  jbi: {\n    name: \"JBI Evidence Synthesis\",\n    website: \"jbi.global\",\n    pubmed_filter: '\"JBI Evid Synth\"[Journal]',\n    description: \"High-quality systematic reviews, especially nursing/allied health.\",\n    priority: 2\n  },\n  \n  campbell: {\n    name: \"Campbell Collaboration\",\n    website: \"campbellcollaboration.org\",\n    description: \"Social and behavioral sciences systematic reviews.\",\n    priority: 3\n  }\n};\n\n\n// ============================================================================\n// PART 4: DRUG INFORMATION SOURCES\n// ============================================================================\n\nexport const DRUG_INFORMATION_SOURCES = {\n  fda: {\n    name: \"FDA (Food and Drug Administration)\",\n    website: \"fda.gov\",\n    tavily_domain: \"site:fda.gov\",\n    use_for: [\"Drug approvals\", \"Safety communications\", \"Black box warnings\", \"Orange Book (generics)\"],\n    priority: 1\n  },\n  \n  dailymed: {\n    name: \"DailyMed (NLM)\",\n    website: \"dailymed.nlm.nih.gov\",\n    api_available: true,\n    use_for: [\"Full prescribing information\", \"Package inserts\", \"Medication guides\"],\n    priority: 1\n  },\n  \n  ema: {\n    name: \"European Medicines Agency\",\n    website: \"ema.europa.eu\",\n    tavily_domain: \"site:ema.europa.eu\",\n    use_for: [\"European drug approvals\", \"EPARs (assessment reports)\"],\n    priority: 2\n  },\n  \n  rxnorm: {\n    name: \"RxNorm (NLM)\",\n    website: \"rxnav.nlm.nih.gov\",\n    api_available: true,\n    use_for: [\"Drug normalization\", \"Drug classes\", \"Drug interactions\"],\n    priority: 2\n  }\n};\n\n\n// ============================================================================\n// PART 5: UTILITY FUNCTIONS FOR QUERY ROUTING\n// ============================================================================\n\n/**\n * Determine which specialties are relevant for a given query\n * Returns array of specialty IDs sorted by relevance\n */\nexport function routeQueryToSpecialties(query: string): string[] {\n  const queryLower = query.toLowerCase();\n  const matches: { id: string; score: number }[] = [];\n  \n  for (const specialty of MEDICAL_SPECIALTIES) {\n    let score = 0;\n    \n    // Check trigger keywords\n    for (const keyword of specialty.trigger_keywords) {\n      if (queryLower.includes(keyword.toLowerCase())) {\n        score += keyword.length; // Longer keywords = more specific = higher score\n      }\n    }\n    \n    // Check body systems\n    for (const system of specialty.body_systems) {\n      if (queryLower.includes(system.toLowerCase())) {\n        score += 5;\n      }\n    }\n    \n    if (score > 0) {\n      matches.push({ id: specialty.id, score });\n    }\n  }\n  \n  // Sort by score descending\n  matches.sort((a, b) => b.score - a.score);\n  \n  // Return top 3 specialties (or all if fewer)\n  return matches.slice(0, 3).map(m => m.id);\n}\n\n\n/**\n * Get PubMed filter for elite journals in given specialties\n */\nexport function getPubMedEliteFilter(specialtyIds: string[]): string {\n  const filters: string[] = [];\n  \n  // Always include general medicine top journals\n  filters.push(TIER_1_GENERAL_JOURNALS.pubmed_combined_filter);\n  \n  // Add specialty-specific filters\n  for (const id of specialtyIds) {\n    const specialty = MEDICAL_SPECIALTIES.find(s => s.id === id);\n    if (specialty) {\n      filters.push(specialty.pubmed_elite_filter);\n    }\n  }\n  \n  return `(${filters.join(' OR ')})`;\n}\n\n\n/**\n * Get Tavily search domains for given specialties\n */\nexport function getTavilyDomains(specialtyIds: string[]): string[] {\n  const domains: Set<string> = new Set();\n  \n  for (const id of specialtyIds) {\n    const specialty = MEDICAL_SPECIALTIES.find(s => s.id === id);\n    if (specialty) {\n      specialty.tavily_search_domains.forEach(d => domains.add(d));\n    }\n  }\n  \n  return Array.from(domains);\n}\n\n\n/**\n * Get guideline organizations for given specialties\n */\nexport function getGuidelineOrganizations(specialtyIds: string[]) {\n  const orgs: any[] = [];\n  \n  for (const id of specialtyIds) {\n    const specialty = MEDICAL_SPECIALTIES.find(s => s.id === id);\n    if (specialty) {\n      orgs.push(...specialty.guideline_organizations);\n    }\n  }\n  \n  return orgs;\n}\n\n\n/**\n * Build Tavily search query for guidelines\n */\nexport function buildGuidelineSearchQuery(query: string, specialtyIds: string[]): string {\n  const orgs = getGuidelineOrganizations(specialtyIds);\n  const domains = orgs.map(o => o.tavily_domain).join(' OR ');\n  \n  // Extract key terms from query\n  const terms = query.replace(/[^a-zA-Z0-9\\s]/g, '').trim();\n  \n  return `${terms} guidelines (${domains})`;\n}\n\n\n// ============================================================================\n// PART 6: WHAT YOU HAVE VS WHAT YOU'RE MISSING (Analysis)\n// ============================================================================\n\nexport const OPENWORK_GAP_ANALYSIS = {\n  what_you_have: [\n    \"PubMed (comprehensive)\",\n    \"Europe PMC (good)\",\n    \"Cochrane Library (excellent)\",\n    \"DailyMed (excellent)\",\n    \"WHO Guidelines (good)\",\n    \"CDC Guidelines (good)\",\n    \"NICE Guidelines (good)\",\n    \"BMJ Best Practice (good)\",\n    \"ACC/AHA Guidelines (good)\",\n    \"AAP Guidelines (good for pediatrics)\",\n    \"NCBI Books/StatPearls (good)\"\n  ],\n  \n  what_you_need_to_add: [\n    {\n      source: \"GINA (ginasthma.org)\",\n      priority: \"CRITICAL\",\n      reason: \"THE asthma authority. Open Evidence uses this heavily. Not in PubMed.\",\n      solution: \"Add to Tavily proactive search for respiratory queries\"\n    },\n    {\n      source: \"GOLD (goldcopd.org)\",\n      priority: \"CRITICAL\",\n      reason: \"THE COPD authority. Defines COPD staging. Not in PubMed.\",\n      solution: \"Add to Tavily proactive search for respiratory queries\"\n    },\n    {\n      source: \"KDIGO (kdigo.org)\",\n      priority: \"HIGH\",\n      reason: \"THE kidney disease authority. CKD staging, AKI management.\",\n      solution: \"Add to Tavily proactive search for renal queries\"\n    },\n    {\n      source: \"NCCN (nccn.org)\",\n      priority: \"CRITICAL\",\n      reason: \"THE oncology authority. Open Evidence has licensed partnership.\",\n      solution: \"Tavily can search public portions; full access requires license\"\n    },\n    {\n      source: \"ESC (escardio.org)\",\n      priority: \"HIGH\",\n      reason: \"European cardiology guidelines. Often differs from ACC/AHA.\",\n      solution: \"You have cardiovascular-guidelines.ts - verify ESC is included\"\n    },\n    {\n      source: \"ADA (diabetes.org)\",\n      priority: \"HIGH\",\n      reason: \"THE diabetes authority. Standards of Care updated annually.\",\n      solution: \"Add to Tavily proactive search for diabetes queries\"\n    },\n    {\n      source: \"IDSA (idsociety.org)\",\n      priority: \"HIGH\",\n      reason: \"THE infectious disease authority. Antimicrobial guidelines.\",\n      solution: \"Add to Tavily proactive search for infection queries\"\n    },\n    {\n      source: \"ACR/EULAR (rheumatology.org/eular.org)\",\n      priority: \"MEDIUM\",\n      reason: \"Rheumatology guidelines. RA, lupus, gout.\",\n      solution: \"Add to Tavily proactive search for rheumatology queries\"\n    },\n    {\n      source: \"AAN (aan.com)\",\n      priority: \"MEDIUM\",\n      reason: \"THE neurology authority. Epilepsy, MS, Parkinson's guidelines.\",\n      solution: \"Add to Tavily proactive search for neurology queries\"\n    },\n    {\n      source: \"ASCO (asco.org)\",\n      priority: \"HIGH\",\n      reason: \"Major oncology society. Clinical practice guidelines.\",\n      solution: \"Add to Tavily proactive search for cancer queries\"\n    }\n  ],\n  \n  noise_to_consider_removing: [\n    {\n      source: \"MedlinePlus\",\n      issue: \"Consumer health, not clinical evidence\",\n      recommendation: \"Keep but deprioritize in ranking. Use only for patient education queries.\"\n    },\n    {\n      source: \"Some Open-i content\",\n      issue: \"May have lower quality images/articles mixed in\",\n      recommendation: \"Filter to only high-quality sources\"\n    }\n  ]\n};\n\n\n// ============================================================================\n// EXPORT SUMMARY\n// ============================================================================\n\nexport default {\n  TIER_1_GENERAL_JOURNALS,\n  MEDICAL_SPECIALTIES,\n  SYSTEMATIC_REVIEW_SOURCES,\n  DRUG_INFORMATION_SOURCES,\n  OPENWORK_GAP_ANALYSIS,\n  \n  // Utility functions\n  routeQueryToSpecialties,\n  getPubMedEliteFilter,\n  getTavilyDomains,\n  getGuidelineOrganizations,\n  buildGuidelineSearchQuery\n};\n", "/**\n * Evidence Cache Manager\n * \n * Manages Redis caching for evidence retrieval with graceful degradation.\n * When Redis is unavailable, the system falls back to direct API calls.\n * \n * Cache Strategy:\n * - TTL: 24 hours (evidence remains relatively stable)\n * - Key format: evidence:{query_hash}:{source}\n * - Hashing: SHA-256 for consistent query identification\n * - Eviction: LRU (Least Recently Used) when memory limit reached\n */\n\nimport Redis from 'ioredis';\nimport { createHash } from 'crypto';\n\n// Cache configuration\nconst CACHE_TTL = 24 * 60 * 60; // 24 hours in seconds\nconst REDIS_URL = process.env.REDIS_URL || '';\n\n// Cache statistics (in-memory tracking)\nlet cacheStats = {\n  hits: 0,\n  misses: 0,\n  errors: 0,\n};\n\n// Redis client instance\nlet redisClient: Redis | null = null;\nlet isRedisAvailable = false;\n\n/**\n * Initialize Redis connection\n * Called automatically on first cache operation\n */\nfunction initializeRedis(): void {\n  if (redisClient || !REDIS_URL) {\n    return;\n  }\n\n  try {\n    redisClient = new Redis(REDIS_URL, {\n      maxRetriesPerRequest: 3,\n      retryStrategy: (times: number) => {\n        if (times > 3) {\n          console.warn('Redis connection failed after 3 retries, disabling cache');\n          isRedisAvailable = false;\n          return null; // Stop retrying\n        }\n        return Math.min(times * 100, 3000); // Exponential backoff, max 3s\n      },\n      lazyConnect: true, // Don't connect immediately\n    });\n\n    // Handle connection events\n    redisClient.on('connect', () => {\n      console.log('\u2705 Redis cache connected');\n      isRedisAvailable = true;\n    });\n\n    redisClient.on('error', (error: Error) => {\n      console.error('\u274C Redis error:', error.message);\n      isRedisAvailable = false;\n      cacheStats.errors++;\n    });\n\n    redisClient.on('close', () => {\n      console.warn('\u26A0\uFE0F  Redis connection closed');\n      isRedisAvailable = false;\n    });\n\n    // Attempt connection\n    redisClient.connect().catch((error: Error) => {\n      console.error('\u274C Redis connection failed:', error.message);\n      isRedisAvailable = false;\n    });\n  } catch (error: any) {\n    console.error('\u274C Redis initialization failed:', error.message);\n    isRedisAvailable = false;\n    redisClient = null;\n  }\n}\n\n/**\n * Check if caching is available\n */\nexport function isCacheAvailable(): boolean {\n  if (!REDIS_URL) {\n    return false;\n  }\n\n  if (!redisClient) {\n    initializeRedis();\n  }\n\n  return isRedisAvailable && redisClient !== null;\n}\n\n/**\n * Generate consistent SHA-256 hash for query\n * Same query always produces same hash\n */\nexport function hashQuery(query: string): string {\n  // Normalize query: lowercase, trim whitespace\n  const normalized = query.toLowerCase().trim();\n  \n  // Generate SHA-256 hash\n  const hash = createHash('sha256')\n    .update(normalized)\n    .digest('hex');\n  \n  return hash.substring(0, 16); // Use first 16 chars for shorter keys\n}\n\n/**\n * Generate cache key in format: evidence:{query_hash}:{source}\n */\nfunction generateCacheKey(query: string, source: string): string {\n  const queryHash = hashQuery(query);\n  return `evidence:${queryHash}:${source}`;\n}\n\n/**\n * Cache metadata interface\n */\nexport interface CacheMetadata {\n  timestamp: string;\n  source: string;\n  queryHash: string;\n  ttl: number;\n}\n\n/**\n * Cached evidence interface\n */\nexport interface CachedEvidence<T> {\n  data: T;\n  metadata: CacheMetadata;\n}\n\n/**\n * Get cached evidence for a query and source\n * Returns null if cache miss or cache unavailable\n */\nexport async function getCachedEvidence<T>(\n  query: string,\n  source: string\n): Promise<CachedEvidence<T> | null> {\n  // Check if cache is available\n  if (!isCacheAvailable()) {\n    cacheStats.misses++;\n    return null;\n  }\n\n  try {\n    const key = generateCacheKey(query, source);\n    const cached = await redisClient!.get(key);\n\n    if (!cached) {\n      // Cache miss\n      cacheStats.misses++;\n      console.log(`\uD83D\uDCED Cache miss: ${source} for query ${hashQuery(query)}`);\n      return null;\n    }\n\n    // Cache hit\n    cacheStats.hits++;\n    console.log(`\uD83D\uDCEC Cache hit: ${source} for query ${hashQuery(query)}`);\n\n    // Parse cached data\n    const parsed: CachedEvidence<T> = JSON.parse(cached);\n    return parsed;\n  } catch (error: any) {\n    console.error(`\u274C Cache read error for ${source}:`, error.message);\n    cacheStats.errors++;\n    cacheStats.misses++;\n    return null;\n  }\n}\n\n/**\n * Cache evidence with 24-hour TTL\n * Silently fails if cache unavailable (no-op)\n */\nexport async function cacheEvidence<T>(\n  query: string,\n  source: string,\n  data: T\n): Promise<void> {\n  // Check if cache is available\n  if (!isCacheAvailable()) {\n    return; // Silently fail, no-op\n  }\n\n  try {\n    const key = generateCacheKey(query, source);\n    const queryHash = hashQuery(query);\n\n    // Create cache entry with metadata\n    const cacheEntry: CachedEvidence<T> = {\n      data,\n      metadata: {\n        timestamp: new Date().toISOString(),\n        source,\n        queryHash,\n        ttl: CACHE_TTL,\n      },\n    };\n\n    // Store in Redis with TTL\n    await redisClient!.setex(key, CACHE_TTL, JSON.stringify(cacheEntry));\n\n    console.log(`\uD83D\uDCBE Cached: ${source} for query ${queryHash} (TTL: 24h)`);\n  } catch (error: any) {\n    console.error(`\u274C Cache write error for ${source}:`, error.message);\n    cacheStats.errors++;\n    // Silently fail, don't throw\n  }\n}\n\n/**\n * Get cache statistics\n */\nexport function getCacheStats(): {\n  hits: number;\n  misses: number;\n  errors: number;\n  hitRate: number;\n} {\n  const total = cacheStats.hits + cacheStats.misses;\n  const hitRate = total > 0 ? (cacheStats.hits / total) * 100 : 0;\n\n  return {\n    ...cacheStats,\n    hitRate: Math.round(hitRate * 100) / 100, // Round to 2 decimal places\n  };\n}\n\n/**\n * Reset cache statistics (useful for testing)\n */\nexport function resetCacheStats(): void {\n  cacheStats = {\n    hits: 0,\n    misses: 0,\n    errors: 0,\n  };\n}\n\n/**\n * Close Redis connection (useful for cleanup in tests)\n */\nexport async function closeCacheConnection(): Promise<void> {\n  if (redisClient) {\n    await redisClient.quit();\n    redisClient = null;\n    isRedisAvailable = false;\n    console.log('\uD83D\uDD0C Redis connection closed');\n  }\n}\n", "/**\n * NCBI E-utilities (PubMed) API Integration\n * Official documentation: https://www.ncbi.nlm.nih.gov/books/NBK25500/\n * \n * Rate limits:\n * - Without API key: 3 requests/second\n * - With API key: 10 requests/second\n * \n * IMPORTANT: Add delays between requests to avoid 429 errors\n */\n\nimport { getCachedEvidence, cacheEvidence } from './cache-manager';\n\nconst EUTILS_BASE = \"https://eutils.ncbi.nlm.nih.gov/entrez/eutils\";\nconst API_KEY = process.env.NCBI_API_KEY || \"\";\n\n// Rate limiting: 350ms delay = ~2.8 req/sec (safe for 3 req/sec limit)\nconst REQUEST_DELAY = API_KEY ? 100 : 350;\n\nlet lastRequestTime = 0;\n\n/**\n * Rate-limited fetch with retry logic\n */\nasync function fetchWithRateLimit(url: string, retries = 3): Promise<Response> {\n  // Enforce rate limit\n  const now = Date.now();\n  const timeSinceLastRequest = now - lastRequestTime;\n  if (timeSinceLastRequest < REQUEST_DELAY) {\n    await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY - timeSinceLastRequest));\n  }\n  lastRequestTime = Date.now();\n\n  for (let i = 0; i < retries; i++) {\n    try {\n      const response = await fetch(url);\n\n      // Handle rate limiting\n      if (response.status === 429) {\n        if (i === retries - 1) return response;\n\n        const waitTime = Math.pow(2, i) * 1000 + Math.random() * 1000;\n        console.warn(`PubMed rate limited (429), waiting ${Math.round(waitTime)}ms...`);\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n        continue;\n      }\n\n      return response;\n    } catch (error) {\n      if (i === retries - 1) throw error;\n\n      const waitTime = Math.pow(2, i) * 1000;\n      console.warn(`PubMed error, retrying in ${waitTime}ms...`);\n      await new Promise(resolve => setTimeout(resolve, waitTime));\n    }\n  }\n\n  throw new Error(\"PubMed API failed after retries\");\n}\n\nexport interface PubMedArticle {\n  pmid: string;\n  title: string;\n  authors: string[];\n  journal: string;\n  publicationDate: string;\n  abstract?: string;\n  doi?: string;\n  publicationType: string[];\n  citationCount?: number;\n  meshTerms?: string[];\n}\n\nexport interface PubMedSearchResult {\n  count: number;\n  pmids: string[];\n  webEnv?: string;\n  queryKey?: string;\n}\n\nexport interface PubMedFilters {\n  articleTypes?: ('systematic-review' | 'meta-analysis' | 'rct' | 'guideline' | 'review')[];\n  yearsBack?: number; // Last N years\n  humansOnly?: boolean;\n  freeFullText?: boolean;\n  hasAbstract?: boolean;\n  clinicalCategory?: 'therapy' | 'diagnosis' | 'etiology' | 'prognosis' | 'clinical_prediction_guides';\n  clinicalScope?: 'broad' | 'narrow';\n}\n\n/**\n * Build PubMed filter string from options\n * ENHANCED: Now includes 2025/2024/2023 prioritization\n */\nfunction buildFilterString(filters?: PubMedFilters): string {\n  if (!filters) return '';\n\n  const filterParts: string[] = [];\n\n  // Single date filter: avoid duplicate. Prefer yearsBack when provided.\n  const currentYear = new Date().getFullYear();\n  const yearsBack = filters.yearsBack !== undefined ? filters.yearsBack : 15;\n  const startYear = currentYear - yearsBack;\n  filterParts.push(`${startYear}:${currentYear}[dp]`);\n\n  // Article type filters\n  if (filters.articleTypes && filters.articleTypes.length > 0) {\n    const typeFilters: string[] = [];\n    for (const type of filters.articleTypes) {\n      switch (type) {\n        case 'systematic-review':\n          typeFilters.push('systematic[sb]');\n          break;\n        case 'meta-analysis':\n          typeFilters.push('meta-analysis[pt]');\n          break;\n        case 'rct':\n          typeFilters.push('randomized controlled trial[pt]');\n          break;\n        case 'guideline':\n          typeFilters.push('guideline[pt]');\n          break;\n        case 'review':\n          typeFilters.push('review[pt]');\n          break;\n      }\n    }\n    if (typeFilters.length > 0) {\n      filterParts.push(`(${typeFilters.join(' OR ')})`);\n    }\n  }\n\n  // Humans only - STRICT FILTER\n  if (filters.humansOnly) {\n    // Exclude animal-only studies using set difference logic\n    filterParts.push('(\"Humans\"[MeSH Terms] NOT (\"Animals\"[MeSH Terms] NOT \"Humans\"[MeSH Terms]))');\n  }\n\n  // Clinical Study Categories\n  if (filters.clinicalCategory) {\n    const categoryMap: Record<string, string> = {\n      'therapy': 'therapy',\n      'diagnosis': 'diagnosis',\n      'etiology': 'etiology',\n      'prognosis': 'prognosis',\n      'clinical_prediction_guides': 'clinical prediction guides'\n    };\n\n    const scopeSuffix = filters.clinicalScope === 'narrow' ? 'narrow' : 'broad';\n    const catKey = categoryMap[filters.clinicalCategory];\n\n    if (catKey) {\n      if (catKey === 'clinical prediction guides') {\n        filterParts.push(`\"${catKey}\"[Filter]`);\n      } else {\n        filterParts.push(`\"${catKey}_${scopeSuffix}\"[Filter]`);\n      }\n    }\n  }\n\n  // Free full text\n  if (filters.freeFullText) {\n    filterParts.push('free full text[sb]');\n  }\n\n  // Has abstract\n  if (filters.hasAbstract) {\n    filterParts.push('hasabstract');\n  }\n\n  return filterParts.length > 0 ? ' AND ' + filterParts.join(' AND ') : '';\n}\n\n/**\n * Search PubMed using ESearch with advanced filters\n * Returns PMIDs matching the query\n */\nexport async function searchPubMed(\n  query: string,\n  maxResults: number = 20,\n  useHistory: boolean = true, // Always default to true now\n  filters?: PubMedFilters\n): Promise<PubMedSearchResult> {\n  try {\n    // Apply filters to query\n    const filterString = buildFilterString(filters);\n    const enhancedQuery = query + filterString;\n\n    console.log(`\uD83D\uDD0D PubMed search: \"${query}\"${filterString ? ` with filters: ${filterString}` : ''}`);\n\n    // STEP 1: ESearch with usehistory=y to get WebEnv/QueryKey (and first batch of IDs if retmax > 0)\n    // We set retmax=0 to just get the history pointer first, then fetch in batches\n    const params = new URLSearchParams({\n      db: \"pubmed\",\n      term: enhancedQuery,\n      retmode: \"json\",\n      retmax: \"0\",\n      usehistory: \"y\",\n      sort: \"relevance\",\n      ...(API_KEY && { api_key: API_KEY }),\n    });\n\n    const url = `${EUTILS_BASE}/esearch.fcgi?${params}`;\n    console.log(`\uD83D\uDD0D PubMed search executing: \"${query.substring(0, 100)}...\"`);\n    console.log(`   Full query: \"${enhancedQuery.substring(0, 200)}...\"`);\n    const response = await fetchWithRateLimit(url);\n\n    if (!response.ok) {\n      const errorText = await response.text().catch(() => '');\n      console.error(`\u274C PubMed ESearch error: ${response.status} - ${errorText.substring(0, 200)}`);\n      return { count: 0, pmids: [] };\n    }\n\n    const data = await response.json();\n    const result = data.esearchresult;\n    const count = parseInt(result.count || \"0\");\n    const webEnv = result.webenv;\n    const queryKey = result.querykey;\n\n    console.log(`\u2705 PubMed search found ${count} articles for query: \"${query.substring(0, 80)}...\"`);\n    if (count === 0) {\n      console.warn(`\u26A0\uFE0F PubMed returned 0 results - query might be too narrow or filters too strict`);\n    }\n\n    if (count === 0 || !webEnv || !queryKey) {\n      return { count: 0, pmids: [], webEnv, queryKey };\n    }\n\n    // STEP 2: Fetch PMIDs in batches using History\n    const pmids: string[] = [];\n    const batchSize = 500;\n    const finalMax = maxResults < count ? maxResults : count;\n\n    for (let start = 0; start < finalMax; start += batchSize) {\n      const batchLimit = Math.min(batchSize, finalMax - start);\n\n      const searchParams = new URLSearchParams({\n        db: \"pubmed\",\n        WebEnv: webEnv,\n        query_key: queryKey,\n        retstart: start.toString(),\n        retmax: batchLimit.toString(),\n        retmode: \"json\",\n        ...(API_KEY && { api_key: API_KEY }),\n      });\n\n      // ESearch again to retrieve IDs from history\n      const batchUrl = `${EUTILS_BASE}/esearch.fcgi?${searchParams}`;\n      const batchResponse = await fetchWithRateLimit(batchUrl);\n\n      if (batchResponse.ok) {\n        const batchData = await batchResponse.json();\n        const batchIds = batchData.esearchresult?.idlist || [];\n        pmids.push(...batchIds);\n      }\n    }\n\n    return {\n      count,\n      pmids,\n      webEnv,\n      queryKey,\n    };\n  } catch (error) {\n    console.error(\"Error searching PubMed:\", error);\n    return { count: 0, pmids: [] };\n  }\n}\n\n/**\n * Fetch article summaries using ESummary\n * More efficient than EFetch for getting basic info\n */\nexport async function fetchPubMedSummaries(\n  pmids: string[]\n): Promise<PubMedArticle[]> {\n  if (pmids.length === 0) return [];\n\n  try {\n    const params = new URLSearchParams({\n      db: \"pubmed\",\n      id: pmids.join(\",\"),\n      retmode: \"json\",\n      ...(API_KEY && { api_key: API_KEY }),\n    });\n\n    const url = `${EUTILS_BASE}/esummary.fcgi?${params}`;\n    const response = await fetchWithRateLimit(url);\n\n    if (!response.ok) {\n      console.error(\"PubMed ESummary error:\", response.status);\n      return [];\n    }\n\n    const data = await response.json();\n    const result = data.result;\n\n    const articles: PubMedArticle[] = [];\n\n    for (const pmid of pmids) {\n      const article = result[pmid];\n      if (!article || article.error) continue;\n\n      articles.push({\n        pmid: pmid,\n        title: article.title || \"\",\n        authors: (article.authors || []).map((a: any) => a.name || \"\").slice(0, 3),\n        journal: article.fulljournalname || article.source || \"\",\n        publicationDate: article.pubdate || \"\",\n        doi: article.elocationid?.replace(\"doi: \", \"\") || article.articleids?.find((id: any) => id.idtype === \"doi\")?.value,\n        publicationType: article.pubtype || [],\n        meshTerms: undefined, // Not available in ESummary\n      });\n    }\n\n    return articles;\n  } catch (error) {\n    console.error(\"Error fetching PubMed summaries:\", error);\n    return [];\n  }\n}\n\n/**\n * Fetch full article details using EFetch (XML format)\n * Use this when you need abstracts and MeSH terms\n */\nexport async function fetchPubMedDetails(\n  pmids: string[]\n): Promise<PubMedArticle[]> {\n  if (pmids.length === 0) return [];\n\n  try {\n    const params = new URLSearchParams({\n      db: \"pubmed\",\n      id: pmids.join(\",\"),\n      retmode: \"xml\",\n      rettype: \"abstract\",\n      ...(API_KEY && { api_key: API_KEY }),\n    });\n\n    const url = `${EUTILS_BASE}/efetch.fcgi?${params}`;\n    const response = await fetchWithRateLimit(url);\n\n    if (!response.ok) {\n      console.error(\"PubMed EFetch error:\", response.status);\n      return [];\n    }\n\n    const xmlText = await response.text();\n    return parsePubMedXML(xmlText);\n  } catch (error) {\n    console.error(\"Error fetching PubMed details:\", error);\n    return [];\n  }\n}\n\n/**\n * Parse PubMed XML response\n * Extracts title, authors, abstract, MeSH terms, etc.\n */\nfunction parsePubMedXML(xml: string): PubMedArticle[] {\n  const articles: PubMedArticle[] = [];\n\n  try {\n    // Simple XML parsing - split by article tags\n    const articleSections = xml.split(/<\\/?PubmedArticle>/g).filter(s => s.trim());\n\n    for (const articleXml of articleSections) {\n      if (!articleXml.includes(\"<PMID\")) continue;\n\n      // Extract PMID\n      const pmidMatch = articleXml.match(/<PMID[^>]*>(\\d+)<\\/PMID>/);\n      const pmid = pmidMatch ? pmidMatch[1] : \"\";\n\n      // Extract title\n      const titleMatch = articleXml.match(/<ArticleTitle>([\\s\\S]*?)<\\/ArticleTitle>/);\n      const title = titleMatch ? titleMatch[1].replace(/<[^>]+>/g, \"\") : \"\";\n\n      // Extract authors\n      const authors: string[] = [];\n      const authorSections = articleXml.split(/<\\/?Author[^>]*>/g);\n      for (const section of authorSections) {\n        const lastNameMatch = section.match(/<LastName>(.*?)<\\/LastName>/);\n        const foreNameMatch = section.match(/<ForeName>(.*?)<\\/ForeName>/);\n        if (lastNameMatch && foreNameMatch) {\n          authors.push(`${foreNameMatch[1]} ${lastNameMatch[1]}`);\n          if (authors.length >= 3) break;\n        }\n      }\n\n      // Extract journal\n      const journalMatch = articleXml.match(/<Title>(.*?)<\\/Title>/);\n      const journal = journalMatch ? journalMatch[1] : \"\";\n\n      // Extract publication date\n      const yearMatch = articleXml.match(/<PubDate>[\\s\\S]*?<Year>(\\d{4})<\\/Year>/);\n      const monthMatch = articleXml.match(/<PubDate>[\\s\\S]*?<Month>(\\w+)<\\/Month>/);\n      const publicationDate = yearMatch ? `${yearMatch[1]}${monthMatch ? \" \" + monthMatch[1] : \"\"}` : \"\";\n\n      // Extract abstract\n      const abstractMatch = articleXml.match(/<AbstractText[^>]*>([\\s\\S]*?)<\\/AbstractText>/);\n      const abstract = abstractMatch ? abstractMatch[1].replace(/<[^>]+>/g, \"\").substring(0, 500) : undefined;\n\n      // Extract DOI\n      const doiMatch = articleXml.match(/<ArticleId IdType=\"doi\">(.*?)<\\/ArticleId>/);\n      const doi = doiMatch ? doiMatch[1] : undefined;\n\n      // Extract publication types\n      const publicationType: string[] = [];\n      const pubTypeSections = articleXml.split(/<\\/?PublicationType[^>]*>/g);\n      for (const section of pubTypeSections) {\n        const trimmed = section.trim();\n        if (trimmed && !trimmed.includes(\"<\") && trimmed.length < 100) {\n          publicationType.push(trimmed);\n        }\n      }\n\n      // Extract MeSH terms\n      const meshTerms: string[] = [];\n      const meshSections = articleXml.split(/<\\/?DescriptorName[^>]*>/g);\n      for (const section of meshSections) {\n        const trimmed = section.trim();\n        if (trimmed && !trimmed.includes(\"<\") && trimmed.length < 100) {\n          meshTerms.push(trimmed);\n          if (meshTerms.length >= 5) break;\n        }\n      }\n\n      if (pmid && title) {\n        articles.push({\n          pmid,\n          title,\n          authors,\n          journal,\n          publicationDate,\n          abstract,\n          doi,\n          publicationType,\n          meshTerms: meshTerms.length > 0 ? meshTerms : undefined,\n        });\n      }\n    }\n  } catch (error) {\n    console.error(\"Error parsing PubMed XML:\", error);\n  }\n\n  return articles;\n}\n\n/**\n * Search for systematic reviews and meta-analyses specifically\n */\nexport async function searchSystematicReviews(\n  query: string,\n  maxResults: number = 10\n): Promise<PubMedArticle[]> {\n  const enhancedQuery = `${query} AND (systematic[sb] OR meta-analysis[pt])`;\n  const searchResult = await searchPubMed(enhancedQuery, maxResults, false);\n\n  if (searchResult.pmids.length === 0) return [];\n\n  return fetchPubMedDetails(searchResult.pmids);\n}\n\n/**\n * Search for randomized controlled trials\n */\nexport async function searchRCTs(\n  query: string,\n  maxResults: number = 10\n): Promise<PubMedArticle[]> {\n  const enhancedQuery = `${query} AND randomized controlled trial[pt]`;\n  const searchResult = await searchPubMed(enhancedQuery, maxResults, false);\n\n  if (searchResult.pmids.length === 0) return [];\n\n  return fetchPubMedDetails(searchResult.pmids);\n}\n\n/**\n * Detect if query is about lifestyle, prevention, or general health topics\n * These queries benefit from guideline-focused searches\n */\nfunction isLifestyleOrPreventionQuery(query: string): boolean {\n  const lifestyleKeywords = [\n    // Physical activity\n    'exercise', 'physical activity', 'fitness', 'workout', 'aerobic', 'strength training',\n    'walking', 'running', 'swimming', 'yoga', 'stretching', 'sedentary', 'active',\n    // Nutrition\n    'diet', 'nutrition', 'healthy eating', 'food', 'vitamin', 'supplement', 'protein',\n    'carbohydrate', 'fat', 'fiber', 'calorie', 'weight loss', 'weight gain', 'obesity',\n    'mediterranean', 'vegetarian', 'vegan', 'fasting', 'sugar', 'salt', 'sodium',\n    // Sleep\n    'sleep', 'insomnia', 'rest', 'fatigue', 'tired', 'energy',\n    // Lifestyle\n    'healthy', 'wellness', 'wellbeing', 'lifestyle', 'prevention', 'longevity',\n    'aging', 'stress', 'relaxation', 'meditation', 'mindfulness',\n    // Substances\n    'alcohol', 'smoking', 'tobacco', 'caffeine',\n    // General health\n    'stay healthy', 'be healthy', 'improve health', 'maintain health', 'good health',\n    'how much', 'how often', 'recommended', 'guidelines', 'should i',\n  ];\n\n  const lowerQuery = query.toLowerCase();\n  return lifestyleKeywords.some(keyword => lowerQuery.includes(keyword));\n}\n\n/**\n * Search for organization-specific guidelines (KDIGO, ACC/AHA, IDSA, etc.)\n * CRITICAL FIX: Specialized search for major guideline organizations\n */\nexport async function searchOrganizationGuidelines(\n  query: string,\n  organizations: string[],\n  maxResults: number = 10\n): Promise<PubMedArticle[]> {\n  if (organizations.length === 0) return [];\n\n  // Build organization-specific search\n  const orgPatterns = organizations.map(org => {\n    switch (org.toUpperCase()) {\n      case 'KDIGO':\n      case 'KDOQI':\n        return `(KDIGO[tiab] OR \"Kidney Disease Improving Global Outcomes\"[tiab] OR KDOQI[tiab] OR \"Kidney International\"[Journal])`;\n      case 'ACC/AHA':\n      case 'ACC':\n      case 'AHA':\n        return `(ACC[tiab] OR AHA[tiab] OR \"American College of Cardiology\"[tiab] OR \"American Heart Association\"[tiab] OR \"Journal of the American College of Cardiology\"[Journal] OR Circulation[Journal])`;\n      case 'IDSA':\n        return `(IDSA[tiab] OR \"Infectious Diseases Society of America\"[tiab] OR \"Clinical Infectious Diseases\"[Journal])`;\n      case 'ESC':\n        return `(ESC[tiab] OR \"European Society of Cardiology\"[tiab] OR \"European Heart Journal\"[Journal])`;\n      case 'ADA':\n        return `(ADA[tiab] OR \"American Diabetes Association\"[tiab] OR \"Diabetes Care\"[Journal])`;\n      case 'WHO':\n        return `(WHO[tiab] OR \"World Health Organization\"[tiab])`;\n      case 'CDC':\n        return `(CDC[tiab] OR \"Centers for Disease Control\"[tiab])`;\n      case 'NICE':\n        return `(NICE[tiab] OR \"National Institute for Health and Care Excellence\"[tiab])`;\n      default:\n        return `${org}[tiab]`;\n    }\n  }).join(' OR ');\n\n  const orgQuery = `${query} AND (${orgPatterns}) AND (guideline OR recommendation OR consensus OR statement)`;\n\n  console.log(`\uD83D\uDD0D Searching for ${organizations.join(', ')} guidelines...`);\n\n  const searchResult = await searchPubMed(orgQuery, maxResults, false, {\n    humansOnly: true,\n    yearsBack: 15, // Look back 15 years for major guidelines\n  });\n\n  if (searchResult.pmids.length > 0) {\n    console.log(`\u2705 Found ${searchResult.pmids.length} ${organizations.join('/')} guideline(s)`);\n    return fetchPubMedDetails(searchResult.pmids);\n  }\n\n  return [];\n}\n\n/**\n * Search for clinical practice guidelines specifically\n * CRITICAL FIX: Enhanced to find recent guidelines more aggressively\n */\nexport async function searchGuidelines(\n  query: string,\n  maxResults: number = 10\n): Promise<PubMedArticle[]> {\n  // STRATEGY 1: Search for official guidelines (most specific)\n  const guidelineQuery = `${query} AND (\n    guideline[pt] OR \n    practice guideline[pt] OR \n    \"clinical practice guideline\"[tiab] OR\n    consensus[tiab] OR \n    recommendation[tiab] OR \n    \"position statement\"[tiab] OR\n    \"consensus statement\"[tiab] OR\n    \"clinical guideline\"[tiab]\n  )`;\n\n  const searchResult = await searchPubMed(guidelineQuery, maxResults, false, {\n    humansOnly: true,\n    yearsBack: 10, // Look back 10 years to catch all recent guidelines\n  });\n\n  if (searchResult.pmids.length === 0) {\n    console.log(`\u26A0\uFE0F  No guidelines found with strict search, trying broader search...`);\n\n    // STRATEGY 2: Broader search if strict search fails\n    const broaderQuery = `${query} AND (guideline OR recommendation OR consensus)`;\n    const broaderResult = await searchPubMed(broaderQuery, maxResults, false, {\n      humansOnly: true,\n      yearsBack: 10,\n    });\n\n    if (broaderResult.pmids.length === 0) return [];\n\n    return fetchPubMedDetails(broaderResult.pmids);\n  }\n\n  return fetchPubMedDetails(searchResult.pmids);\n}\n\n/**\n * Search for authoritative sources (major medical organizations and journals)\n * CRITICAL FIX: Added Kidney International and other guideline-publishing journals\n */\nexport async function searchAuthoritativeSources(\n  query: string,\n  maxResults: number = 10\n): Promise<PubMedArticle[]> {\n  // Search from major medical organizations and guideline-publishing journals\n  const orgQuery = `${query} AND (\n    \"American Heart Association\"[Affiliation] OR \n    \"American College of Cardiology\"[Affiliation] OR\n    \"American Diabetes Association\"[Affiliation] OR\n    \"World Health Organization\"[Affiliation] OR\n    \"Centers for Disease Control\"[Affiliation] OR\n    \"American College of Sports Medicine\"[Affiliation] OR\n    \"American Medical Association\"[Affiliation] OR\n    \"National Institutes of Health\"[Affiliation] OR\n    \"Kidney Disease Improving Global Outcomes\"[Affiliation] OR\n    KDIGO[Affiliation] OR\n    \"Infectious Diseases Society of America\"[Affiliation] OR\n    IDSA[Affiliation] OR\n    \"European Society of Cardiology\"[Affiliation] OR\n    ESC[Affiliation] OR\n    JAMA[Journal] OR\n    \"New England Journal of Medicine\"[Journal] OR\n    Lancet[Journal] OR\n    Circulation[Journal] OR\n    \"Diabetes Care\"[Journal] OR\n    \"Kidney International\"[Journal] OR\n    \"American Journal of Kidney Diseases\"[Journal] OR\n    \"Clinical Infectious Diseases\"[Journal] OR\n    \"European Heart Journal\"[Journal] OR\n    \"Journal of the American College of Cardiology\"[Journal]\n  )`;\n\n  const searchResult = await searchPubMed(orgQuery, maxResults, false, {\n    humansOnly: true,\n    yearsBack: 10,\n    hasAbstract: true,\n  });\n\n  if (searchResult.pmids.length === 0) return [];\n\n  return fetchPubMedSummaries(searchResult.pmids);\n}\n\n/**\n * Combined search: Get high-quality articles + systematic reviews\n * Uses advanced filters for better results\n * Enhanced to include guidelines for lifestyle/prevention queries\n * \n * NOW WITH CACHING: Checks Redis cache before hitting PubMed API\n */\nexport async function comprehensivePubMedSearch(\n  query: string,\n  isGuidelineQuery: boolean = false,\n  guidelineBodies: string[] = [],\n  journalFilter: string = ''\n): Promise<{ articles: PubMedArticle[]; systematicReviews: PubMedArticle[]; guidelines: PubMedArticle[] }> {\n  // PHASE 1 ENHANCEMENT: Check cache first\n  // Error handling: If cache fails, continue with API call (graceful degradation)\n  try {\n    const cacheKey = journalFilter ? `${query}_${journalFilter}` : query;\n    const cached = await getCachedEvidence<{ articles: PubMedArticle[]; systematicReviews: PubMedArticle[]; guidelines: PubMedArticle[] }>(\n      cacheKey,\n      'pubmed'\n    );\n\n    if (cached) {\n      console.log(`\uD83D\uDCEC Using cached PubMed results for query (filter: ${!!journalFilter})`);\n      return cached.data;\n    }\n  } catch (error: any) {\n    console.error('\u274C Cache read error in PubMed, falling back to API:', error.message);\n    // Continue to API call\n  }\n\n  // Cache miss - fetch from API\n  const isLifestyle = isLifestyleOrPreventionQuery(query);\n\n  // CRITICAL FIX: Always search for guidelines if this is a guideline query\n  const shouldSearchGuidelines = isGuidelineQuery || isLifestyle;\n\n  // Build search promises\n  // INCREASED LIMITS: Get MANY more candidates to ensure high relevance after filtering\n  console.log(`\uD83D\uDCDA comprehensivePubMedSearch: Starting searches for query: \"${query.substring(0, 100)}...\" (Filter: ${journalFilter ? 'Active' : 'None'})`);\n\n  // Apply journal filter to the general search if provided\n  const generalQuery = journalFilter ? `${query} AND ${journalFilter}` : query;\n\n  const searchPromises: Promise<any>[] = [\n    // General search: 15 years + humans; avoid hasAbstract to maximize hits (we can filter later)\n    searchPubMed(generalQuery, 50, false, {\n      humansOnly: true,\n      yearsBack: 15,\n    }).then(result => {\n      console.log(`\uD83D\uDCDA General PubMed search returned: ${result.count} total matches, ${result.pmids.length} PMIDs fetched`);\n      return result;\n    }).catch(err => {\n      console.error(`\u274C General PubMed search failed:`, err);\n      return { count: 0, pmids: [] };\n    }),\n    // Systematic reviews - INCREASED from 8 to 20\n    searchSystematicReviews(query, 20).then(result => {\n      console.log(`\uD83D\uDCDA Systematic reviews search returned: ${result.length} reviews`);\n      return result;\n    }).catch(err => {\n      console.error(`\u274C Systematic reviews search failed:`, err);\n      return [];\n    }),\n  ];\n\n  // Add guideline search for guideline queries or lifestyle/prevention queries\n  if (shouldSearchGuidelines) {\n    if (isGuidelineQuery) {\n      console.log(\"\uD83D\uDCCB Guideline query detected - searching for clinical practice guidelines\");\n\n      // CRITICAL FIX: If we have specific guideline bodies (KDIGO, ACC/AHA, etc.), search for them specifically\n      if (guidelineBodies.length > 0) {\n        console.log(`\uD83C\uDFAF Searching specifically for ${guidelineBodies.join(', ')} guidelines`);\n        searchPromises.push(searchOrganizationGuidelines(query, guidelineBodies, 30)); // INCREASED from 15 to 30\n      }\n    } else {\n      console.log(\"\uD83C\uDFC3 Lifestyle/prevention query detected - adding guideline search\");\n    }\n    searchPromises.push(searchGuidelines(query, 30)); // INCREASED from 15 to 30\n    searchPromises.push(searchAuthoritativeSources(query, 25)); // INCREASED from 12 to 25\n  }\n\n  // #region debug log\n  fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed.ts:726', message: 'comprehensivePubMedSearch executing', data: { query: query.substring(0, 100), searchPromises: searchPromises.length, isGuidelineQuery, guidelineBodies, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n  // #endregion\n\n  const results = await Promise.all(searchPromises);\n\n  // #region debug log\n  fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed.ts:730', message: 'comprehensivePubMedSearch results received', data: { resultCount: results.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n  // #endregion\n\n  // Handle variable number of results based on whether we searched for organization guidelines\n  let generalSearch, reviewsSearch, guidelinesSearch, authoritativeSearch, orgGuidelinesSearch;\n\n  if (isGuidelineQuery && guidelineBodies.length > 0) {\n    [generalSearch, reviewsSearch, orgGuidelinesSearch, guidelinesSearch, authoritativeSearch] = results;\n  } else {\n    [generalSearch, reviewsSearch, guidelinesSearch, authoritativeSearch] = results;\n    orgGuidelinesSearch = [];\n  }\n\n  console.log(`\uD83D\uDCDA Processing PubMed results: generalSearch has ${generalSearch.pmids?.length || 0} PMIDs`);\n  const articles = (generalSearch?.pmids && generalSearch.pmids.length > 0)\n    ? await fetchPubMedSummaries(generalSearch.pmids).then(arts => {\n      console.log(`\uD83D\uDCDA Fetched ${arts.length} article summaries from PubMed`);\n      return arts;\n    }).catch(err => {\n      console.error(`\u274C Failed to fetch PubMed summaries:`, err);\n      return [];\n    })\n    : [];\n\n  if (articles.length === 0 && (generalSearch?.pmids?.length || 0) > 0) {\n    console.warn(`\u26A0\uFE0F Warning: Had ${generalSearch.pmids.length} PMIDs but fetched 0 articles - fetchPubMedSummaries may have failed`);\n  }\n\n  // Combine guidelines from all searches if available\n  let guidelines: PubMedArticle[] = [];\n  if (shouldSearchGuidelines) {\n    guidelines = [\n      ...(orgGuidelinesSearch || []), // Organization-specific guidelines (KDIGO, ACC/AHA, etc.) - HIGHEST PRIORITY\n      ...(guidelinesSearch || []),\n      ...(authoritativeSearch || []),\n    ];\n    // Remove duplicates by PMID\n    const seenPmids = new Set<string>();\n    guidelines = guidelines.filter(g => {\n      if (seenPmids.has(g.pmid)) return false;\n      seenPmids.add(g.pmid);\n      return true;\n    });\n    console.log(`\uD83D\uDCCB Found ${guidelines.length} guideline articles from PubMed`);\n    if (orgGuidelinesSearch && orgGuidelinesSearch.length > 0) {\n      console.log(`   \u2705 Including ${orgGuidelinesSearch.length} organization-specific guideline(s)`);\n    }\n  }\n\n  const result = {\n    articles,\n    systematicReviews: Array.isArray(reviewsSearch) ? reviewsSearch : [],\n    guidelines,\n  };\n\n  // #region debug log\n  fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed.ts:763', message: 'comprehensivePubMedSearch completed', data: { articles: articles.length, systematicReviews: reviewsSearch?.length || 0, guidelines: guidelines.length, total: articles.length + (reviewsSearch?.length || 0) + guidelines.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n  // #endregion\n\n  // PHASE 1 ENHANCEMENT: Cache the result\n  // Error handling: If caching fails, continue anyway (graceful degradation)\n  try {\n    await cacheEvidence(query, 'pubmed', result);\n  } catch (error: any) {\n    console.error('\u274C Cache write error in PubMed:', error.message);\n    // Continue - result is still returned\n  }\n\n  return result;\n}\n", "/**\n * DailyMed Integration for FDA Drug Information\n * \n * DailyMed provides official FDA-approved drug labeling information (SPL - Structured Product Labels)\n * This includes package inserts, prescribing information, contraindications, dosing, and safety data.\n * \n * Key Features:\n * - Search by drug name, NDC code, RxCUI, or active ingredient\n * - Get complete FDA-approved labeling information\n * - Access drug interactions, contraindications, and warnings\n * - Retrieve dosing information and administration guidelines\n * - Get packaging and NDC information\n */\n\ninterface DailyMedSPL {\n  setid: string;\n  title: string;\n  published_date: string;\n  spl_version: string;\n}\n\ninterface DailyMedSearchResult {\n  metadata: {\n    total_elements: string;\n    elements_per_page: string;\n    total_pages: string;\n    current_page: string;\n  };\n  data: DailyMedSPL[];\n}\n\n// Interface expected by the evidence engine\nexport interface DailyMedDrug {\n  setId: string;\n  title: string;\n  publishedDate: string;\n  activeIngredients: string[];\n  dosageForm: string;\n  route: string;\n  manufacturer: string;\n  ndcCodes: string[];\n  indications: string;\n  contraindications: string;\n  warnings: string;\n  dosage: string;\n  adverseReactions: string;\n  drugInteractions: string;\n  clinicalPharmacology: string;\n  howSupplied: string;\n  genericName?: string;\n  brandName?: string;\n}\n\ninterface DailyMedDrugInfo {\n  setid: string;\n  title: string;\n  published_date: string;\n  active_ingredients: string[];\n  dosage_form: string;\n  route: string;\n  manufacturer: string;\n  ndc_codes: string[];\n  indications: string;\n  contraindications: string;\n  warnings: string;\n  dosage: string;\n  adverse_reactions: string;\n  drug_interactions: string;\n  clinical_pharmacology: string;\n  how_supplied: string;\n}\n\n/**\n * Comprehensive DailyMed search - Main function expected by evidence engine\n * ENHANCED: Now prioritizes recent drug labeling updates (2023-2025)\n */\nexport async function comprehensiveDailyMedSearch(query: string): Promise<{ drugs: DailyMedDrug[] }> {\n  try {\n    console.log(`\uD83D\uDD0D DailyMed: Comprehensive search for \"${query}\"`);\n\n    // Extract drug names from the query\n    const drugNames = extractDrugNamesFromQuery(query);\n\n    if (drugNames.length === 0) {\n      console.log('\uD83D\uDCED No drug names detected in query');\n      return { drugs: [] };\n    }\n\n    console.log(`\uD83D\uDC8A Detected drugs: ${drugNames.join(', ')}`);\n\n    const allDrugs: DailyMedDrug[] = [];\n\n    // Search for each detected drug\n    for (const drugName of drugNames.slice(0, 3)) { // Limit to 3 drugs to avoid rate limits\n      try {\n        const drugInfo = await searchDailyMedByName(drugName, 3); // Get 3 results to find best quality\n\n        // CRITICAL ENHANCEMENT: Filter for recent labeling updates (2023+)\n        const currentYear = new Date().getFullYear();\n        const recentDrugInfo = drugInfo.filter(drug => {\n          const pubYear = new Date(drug.published_date).getFullYear();\n          return pubYear >= currentYear - 2; // 2023+ if current year is 2025\n        });\n\n        // If no recent updates, keep the most recent ones\n        const finalDrugInfo = recentDrugInfo.length > 0 ? recentDrugInfo : drugInfo.slice(0, 1);\n\n        // Convert to expected format\n        const convertedDrugs = finalDrugInfo.map(convertToDailyMedDrug);\n\n        // CRITICAL FIX: Sort by number of filled sections (content quality)\n        // This ensures manufacturer labels with full content rank above repackager labels\n        convertedDrugs.sort((a, b) => {\n          const sectionsA = countFilledSections(a);\n          const sectionsB = countFilledSections(b);\n          return sectionsB - sectionsA; // Descending order (most sections first)\n        });\n\n        // Only keep the best quality label per drug\n        if (convertedDrugs.length > 0) {\n          allDrugs.push(convertedDrugs[0]);\n          console.log(`\uD83D\uDCCB Selected best label for ${drugName}: ${countFilledSections(convertedDrugs[0])} sections`);\n        }\n\n      } catch (error: any) {\n        console.warn(`\u26A0\uFE0F DailyMed search failed for \"${drugName}\":`, error.message);\n      }\n    }\n\n    console.log(`\u2705 DailyMed: Found ${allDrugs.length} drug records`);\n\n    return { drugs: allDrugs };\n\n  } catch (error: any) {\n    console.error('\u274C DailyMed comprehensive search error:', error.message);\n    return { drugs: [] };\n  }\n}\n\n/**\n * Count number of filled sections in a drug result\n */\nfunction countFilledSections(drug: DailyMedDrug): number {\n  let count = 0;\n  if (drug.indications && drug.indications.length > 50) count++;\n  if (drug.dosage && drug.dosage.length > 50) count++;\n  if (drug.warnings && drug.warnings.length > 50) count++;\n  if (drug.adverseReactions && drug.adverseReactions.length > 50) count++;\n  if (drug.drugInteractions && drug.drugInteractions.length > 50) count++;\n  if (drug.contraindications && drug.contraindications.length > 50) count++;\n  if (drug.clinicalPharmacology && drug.clinicalPharmacology.length > 50) count++;\n  return count;\n}\n\n/**\n * Extract drug names from query using simple pattern matching\n */\nfunction extractDrugNamesFromQuery(query: string): string[] {\n  const drugNames: string[] = [];\n  const queryLower = query.toLowerCase();\n\n  // CRITICAL FIX: Brand Name to Generic Name mapping\n  // This ensures queries like \"What is Tylenol?\" find the correct DailyMed entry\n  const BRAND_TO_GENERIC: Record<string, string> = {\n    // Pain/OTC\n    'tylenol': 'acetaminophen',\n    'advil': 'ibuprofen',\n    'motrin': 'ibuprofen',\n    'aleve': 'naproxen',\n    'excedrin': 'acetaminophen',\n    'bayer': 'aspirin',\n    // Statins\n    'lipitor': 'atorvastatin',\n    'crestor': 'rosuvastatin',\n    'zocor': 'simvastatin',\n    'pravachol': 'pravastatin',\n    // PPIs\n    'nexium': 'esomeprazole',\n    'prilosec': 'omeprazole',\n    'prevacid': 'lansoprazole',\n    'protonix': 'pantoprazole',\n    // Psychiatric\n    'prozac': 'fluoxetine',\n    'zoloft': 'sertraline',\n    'lexapro': 'escitalopram',\n    'xanax': 'alprazolam',\n    'ambien': 'zolpidem',\n    'ativan': 'lorazepam',\n    // Anticoagulants\n    'eliquis': 'apixaban',\n    'xarelto': 'rivaroxaban',\n    'pradaxa': 'dabigatran',\n    'savaysa': 'edoxaban',\n    'coumadin': 'warfarin',\n    // Diabetes SGLT2i\n    'jardiance': 'empagliflozin',\n    'farxiga': 'dapagliflozin',\n    'invokana': 'canagliflozin',\n    // Diabetes GLP-1\n    'ozempic': 'semaglutide',\n    'wegovy': 'semaglutide',\n    'trulicity': 'dulaglutide',\n    'victoza': 'liraglutide',\n    'mounjaro': 'tirzepatide',\n    'zepbound': 'tirzepatide',\n    // Heart Failure\n    'entresto': 'sacubitril/valsartan',\n    // Blood Pressure\n    'norvasc': 'amlodipine',\n    'zestril': 'lisinopril',\n    'prinivil': 'lisinopril',\n    'diovan': 'valsartan',\n    'cozaar': 'losartan',\n    'toprol': 'metoprolol',\n    'lopressor': 'metoprolol',\n    // Thyroid\n    'synthroid': 'levothyroxine',\n    // Respiratory\n    'ventolin': 'albuterol',\n    'proair': 'albuterol',\n    'advair': 'fluticasone/salmeterol',\n    'symbicort': 'budesonide/formoterol',\n    // Antibiotics\n    'augmentin': 'amoxicillin/clavulanate',\n    'zithromax': 'azithromycin',\n    'zpack': 'azithromycin',\n    'z-pack': 'azithromycin',\n    'cipro': 'ciprofloxacin',\n    'levaquin': 'levofloxacin',\n    // Other common\n    'lasix': 'furosemide',\n    'neurontin': 'gabapentin',\n    'lyrica': 'pregabalin',\n    'humira': 'adalimumab',\n  };\n\n  // Step 1: Check for brand names and add their generic equivalents\n  for (const [brand, generic] of Object.entries(BRAND_TO_GENERIC)) {\n    if (queryLower.includes(brand)) {\n      drugNames.push(generic);\n      console.log(`\uD83D\uDC8A Brand name \"${brand}\" detected \u2192 adding generic \"${generic}\"`);\n    }\n  }\n\n  // Common drug patterns and known drugs\n  // EXPANDED: Added oncology (TKIs, mAbs), diabetes (SGLT2i, GLP-1), biologics, anticoagulants\n  const commonDrugs = [\n    // Cardiovascular/Metabolic\n    'metformin', 'insulin', 'aspirin', 'ibuprofen', 'acetaminophen', 'lisinopril',\n    'atorvastatin', 'simvastatin', 'amlodipine', 'omeprazole', 'levothyroxine',\n    'warfarin', 'clopidogrel', 'prednisone', 'albuterol', 'furosemide',\n    'hydrochlorothiazide', 'losartan', 'gabapentin', 'sertraline', 'fluoxetine',\n    'digoxin', 'propranolol', 'carvedilol', 'metoprolol', 'diltiazem',\n    'spironolactone', 'enalapril', 'ramipril', 'valsartan', 'candesartan',\n    'rosuvastatin', 'pravastatin', 'ezetimibe', 'fenofibrate', 'gemfibrozil',\n    // Antibiotics\n    'amoxicillin', 'azithromycin', 'ciprofloxacin', 'doxycycline', 'penicillin',\n    'vancomycin', 'fidaxomicin', 'metronidazole',\n    // Pain/Opioids\n    'morphine', 'oxycodone', 'tramadol', 'codeine', 'fentanyl',\n    // Diabetes - SGLT2 inhibitors\n    'empagliflozin', 'dapagliflozin', 'canagliflozin', 'ertugliflozin', 'sotagliflozin',\n    // Diabetes - GLP-1 agonists\n    'semaglutide', 'liraglutide', 'dulaglutide', 'tirzepatide', 'exenatide',\n    // Diabetes - DPP-4 inhibitors\n    'sitagliptin', 'saxagliptin', 'linagliptin', 'alogliptin',\n    // Diabetes - Other\n    'glipizide', 'glyburide', 'pioglitazone',\n    // Anticoagulants - DOACs\n    'apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban',\n    // Heart Failure - ARNI\n    'sacubitril', 'entresto',\n    // Oncology - Monoclonal antibodies (mAbs)\n    'adalimumab', 'etanercept', 'infliximab', 'rituximab', 'bevacizumab',\n    'trastuzumab', 'pembrolizumab', 'nivolumab', 'ipilimumab', 'atezolizumab',\n    'amivantamab', 'cetuximab', 'panitumumab', 'necitumumab',\n    // Oncology - Tyrosine kinase inhibitors (TKIs)\n    'osimertinib', 'mobocertinib', 'erlotinib', 'gefitinib', 'afatinib',\n    'lapatinib', 'neratinib', 'tucatinib', 'lorlatinib', 'crizotinib',\n    'alectinib', 'brigatinib', 'ceritinib', 'sotorasib', 'adagrasib',\n    // Asthma biologics\n    'mepolizumab', 'benralizumab', 'dupilumab', 'tezepelumab', 'omalizumab',\n    // IBD biologics\n    'vedolizumab', 'ustekinumab', 'risankizumab', 'ozanimod', 'tofacitinib',\n    // Chemotherapy\n    'carboplatin', 'cisplatin', 'pemetrexed', 'docetaxel', 'paclitaxel',\n  ];\n\n  // Check for exact matches\n  for (const drug of commonDrugs) {\n    if (queryLower.includes(drug)) {\n      drugNames.push(drug);\n    }\n  }\n\n  // Look for drug class patterns\n  // EXPANDED: Added oncology (mab, tinib), biologics, and more drug class suffixes\n  const drugClassPatterns = [\n    /(\\w+)statin\\b/g, // statins\n    /(\\w+)pril\\b/g, // ACE inhibitors\n    /(\\w+)sartan\\b/g, // ARBs\n    /(\\w+)olol\\b/g, // beta blockers\n    /(\\w+)flozin\\b/g, // SGLT2 inhibitors\n    /(\\w+)gliptin\\b/g, // DPP-4 inhibitors\n    /(\\w+)glutide\\b/g, // GLP-1 agonists\n    /(\\w+)mab\\b/g, // Monoclonal antibodies (oncology, biologics)\n    /(\\w+)tinib\\b/g, // Tyrosine kinase inhibitors (oncology)\n    /(\\w+)ciclib\\b/g, // CDK4/6 inhibitors\n    /(\\w+)parib\\b/g, // PARP inhibitors\n    /(\\w+)zumab\\b/g, // Humanized mAbs\n    /(\\w+)ximab\\b/g, // Chimeric mAbs\n    /(\\w+)mumab\\b/g, // Human mAbs\n  ];\n\n  for (const pattern of drugClassPatterns) {\n    const matches = queryLower.matchAll(pattern);\n    for (const match of matches) {\n      if (match[0] && match[0].length > 3) {\n        drugNames.push(match[0]);\n      }\n    }\n  }\n\n  // Remove duplicates and return\n  return [...new Set(drugNames)];\n}\n\n/**\n * Convert internal DailyMedDrugInfo to expected DailyMedDrug format\n */\nfunction convertToDailyMedDrug(drugInfo: DailyMedDrugInfo): DailyMedDrug {\n  // Extract generic and brand names from title\n  const { genericName, brandName } = extractNamesFromTitle(drugInfo.title);\n\n  return {\n    setId: drugInfo.setid,\n    title: drugInfo.title,\n    publishedDate: drugInfo.published_date,\n    activeIngredients: drugInfo.active_ingredients,\n    dosageForm: drugInfo.dosage_form,\n    route: drugInfo.route,\n    manufacturer: drugInfo.manufacturer,\n    ndcCodes: drugInfo.ndc_codes,\n    indications: drugInfo.indications,\n    contraindications: drugInfo.contraindications,\n    warnings: drugInfo.warnings,\n    dosage: drugInfo.dosage,\n    adverseReactions: drugInfo.adverse_reactions,\n    drugInteractions: drugInfo.drug_interactions,\n    clinicalPharmacology: drugInfo.clinical_pharmacology,\n    howSupplied: drugInfo.how_supplied,\n    genericName,\n    brandName,\n  };\n}\n\n/**\n * Extract generic and brand names from drug title\n */\nfunction extractNamesFromTitle(title: string): { genericName?: string; brandName?: string } {\n  // Pattern: \"BRAND NAME (GENERIC NAME) FORM [MANUFACTURER]\"\n  const brandMatch = title.match(/^([A-Z][A-Z\\s]+?)\\s*\\(/);\n  const genericMatch = title.match(/\\(([^)]+)\\)/);\n\n  return {\n    brandName: brandMatch ? brandMatch[1].trim() : undefined,\n    genericName: genericMatch ? genericMatch[1].trim() : undefined,\n  };\n}\nexport async function searchDailyMedByName(drugName: string, limit: number = 10): Promise<DailyMedDrugInfo[]> {\n  try {\n    const apiKey = process.env.NCBI_API_KEY_DAILYMED;\n    console.log(`\uD83D\uDD0D DailyMed: Searching for \"${drugName}\"`);\n\n    // First, search for SPLs containing the drug name\n    const searchUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls.json?drug_name=${encodeURIComponent(drugName)}&pagesize=${limit}`;\n\n    const headers: Record<string, string> = {\n      'User-Agent': 'OpenWork-AI/1.0 (Medical Evidence System)',\n    };\n\n    if (apiKey) {\n      headers['X-API-Key'] = apiKey;\n    }\n\n    const response = await fetch(searchUrl, { headers });\n\n    if (!response.ok) {\n      console.warn(`\u26A0\uFE0F DailyMed search failed: ${response.status}`);\n      return [];\n    }\n\n    const searchResult: DailyMedSearchResult = await response.json();\n\n    if (!searchResult.data || searchResult.data.length === 0) {\n      console.log(`\uD83D\uDCED No DailyMed results for \"${drugName}\"`);\n      return [];\n    }\n\n    console.log(`\u2705 Found ${searchResult.data.length} DailyMed SPLs for \"${drugName}\"`);\n\n    // Get detailed information for each SPL\n    const drugInfoPromises = searchResult.data.slice(0, 5).map(spl =>\n      getDailyMedSPLDetails(spl.setid)\n    );\n\n    const drugInfoResults = await Promise.allSettled(drugInfoPromises);\n    const validResults = drugInfoResults\n      .filter((result): result is PromiseFulfilledResult<DailyMedDrugInfo | null> =>\n        result.status === 'fulfilled' && result.value !== null\n      )\n      .map(result => result.value!);\n\n    return validResults;\n\n  } catch (error: any) {\n    console.error('\u274C DailyMed search error:', error.message);\n    return [];\n  }\n}\n\n/**\n * Search DailyMed by RxCUI (RxNorm Concept Unique Identifier)\n */\nexport async function searchDailyMedByRxCUI(rxcui: string, limit: number = 10): Promise<DailyMedDrugInfo[]> {\n  try {\n    const apiKey = process.env.NCBI_API_KEY_DAILYMED;\n    console.log(`\uD83D\uDD0D DailyMed: Searching by RxCUI \"${rxcui}\"`);\n\n    const searchUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls.json?rxcui=${rxcui}&pagesize=${limit}`;\n\n    const headers: Record<string, string> = {\n      'User-Agent': 'OpenWork-AI/1.0 (Medical Evidence System)',\n    };\n\n    if (apiKey) {\n      headers['X-API-Key'] = apiKey;\n    }\n\n    const response = await fetch(searchUrl, { headers });\n\n    if (!response.ok) {\n      console.warn(`\u26A0\uFE0F DailyMed RxCUI search failed: ${response.status}`);\n      return [];\n    }\n\n    const searchResult: DailyMedSearchResult = await response.json();\n\n    if (!searchResult.data || searchResult.data.length === 0) {\n      console.log(`\uD83D\uDCED No DailyMed results for RxCUI \"${rxcui}\"`);\n      return [];\n    }\n\n    console.log(`\u2705 Found ${searchResult.data.length} DailyMed SPLs for RxCUI \"${rxcui}\"`);\n\n    // Get detailed information for each SPL\n    const drugInfoPromises = searchResult.data.slice(0, 5).map(spl =>\n      getDailyMedSPLDetails(spl.setid)\n    );\n\n    const drugInfoResults = await Promise.allSettled(drugInfoPromises);\n    const validResults = drugInfoResults\n      .filter((result): result is PromiseFulfilledResult<DailyMedDrugInfo | null> =>\n        result.status === 'fulfilled' && result.value !== null\n      )\n      .map(result => result.value!);\n\n    return validResults;\n\n  } catch (error: any) {\n    console.error('\u274C DailyMed RxCUI search error:', error.message);\n    return [];\n  }\n}\n\n/**\n * LOINC codes for FDA drug label sections\n */\nconst LOINC_SECTION_CODES: Record<string, string> = {\n  '34067-9': 'indications',           // Indications and Usage\n  '34068-7': 'dosage',                // Dosage and Administration\n  '43685-7': 'warnings',              // Warnings and Precautions\n  '34071-1': 'warnings',              // Warnings (alternative)\n  '34084-4': 'adverse_reactions',     // Adverse Reactions\n  '34073-7': 'drug_interactions',     // Drug Interactions\n  '34090-1': 'clinical_pharmacology', // Clinical Pharmacology\n  '34069-5': 'how_supplied',          // How Supplied\n  '34070-3': 'contraindications',     // Contraindications\n};\n\n/**\n * Get detailed SPL information by SET ID - FIXED: Now fetches and parses full SPL XML\n */\nexport async function getDailyMedSPLDetails(setid: string): Promise<DailyMedDrugInfo | null> {\n  try {\n    const headers: Record<string, string> = {\n      'User-Agent': 'OpenWork-AI/1.0 (Medical Evidence System)',\n    };\n\n    // Step 1: Fetch the full SPL XML document\n    const splXmlUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${setid}.xml`;\n    console.log(`\uD83D\uDCC4 Fetching SPL XML for ${setid}...`);\n\n    const xmlResponse = await fetch(splXmlUrl, { headers });\n\n    if (!xmlResponse.ok) {\n      console.warn(`\u26A0\uFE0F DailyMed SPL XML fetch failed for ${setid}: ${xmlResponse.status}`);\n      return null;\n    }\n\n    const xmlText = await xmlResponse.text();\n\n    // Step 2: Parse LOINC-coded sections from SPL XML\n    const sections = parseSPLSections(xmlText);\n\n    // Step 3: Extract metadata from XML\n    const titleMatch = xmlText.match(/<title[^>]*>([^<]+)<\\/title>/i);\n    const dateMatch = xmlText.match(/<effectiveTime[^>]*value=\"(\\d{8})\"/i);\n\n    const publishedDate = dateMatch\n      ? `${dateMatch[1].substring(0, 4)}-${dateMatch[1].substring(4, 6)}-${dateMatch[1].substring(6, 8)}`\n      : '';\n\n    // Step 4: Get NDC codes separately (quick API call)\n    let ndcCodes: string[] = [];\n    try {\n      const ndcUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${setid}/ndcs.json`;\n      const ndcResponse = await fetch(ndcUrl, { headers });\n      if (ndcResponse.ok) {\n        const ndcData = await ndcResponse.json();\n        ndcCodes = ndcData.data?.ndcs?.map((ndc: any) => ndc.ndc) || [];\n      }\n    } catch (e) {\n    // NDC fetch failed, continue without\n    }\n\n    const title = titleMatch ? titleMatch[1].trim() : 'Unknown Drug';\n\n    const drugInfo: DailyMedDrugInfo = {\n      setid: setid,\n      title: title,\n      published_date: publishedDate,\n      active_ingredients: extractActiveIngredientsFromTitle(title),\n      dosage_form: extractDosageFormFromTitle(title),\n      route: extractRouteFromTitle(title),\n      manufacturer: extractManufacturerFromTitle(title),\n      ndc_codes: ndcCodes,\n      indications: sections.indications || '',\n      contraindications: sections.contraindications || '',\n      warnings: sections.warnings || '',\n      dosage: sections.dosage || '',\n      adverse_reactions: sections.adverse_reactions || '',\n      drug_interactions: sections.drug_interactions || '',\n      clinical_pharmacology: sections.clinical_pharmacology || '',\n      how_supplied: sections.how_supplied || (ndcCodes.length > 0 ? `NDC: ${ndcCodes.join(', ')}` : ''),\n    };\n\n    // Log success with section counts\n    const filledSections = Object.entries(sections).filter(([_, v]) => v && v.length > 0).length;\n    console.log(`\u2705 SPL parsed: ${filledSections} sections extracted for ${setid}`);\n\n    return drugInfo;\n\n  } catch (error: any) {\n    console.error(`\u274C DailyMed SPL details error for ${setid}:`, error.message);\n    return null;\n  }\n}\n\n/**\n * Parse LOINC-coded sections from SPL XML\n */\nfunction parseSPLSections(xmlText: string): Record<string, string> {\n  const sections: Record<string, string> = {\n    indications: '',\n    contraindications: '',\n    warnings: '',\n    dosage: '',\n    adverse_reactions: '',\n    drug_interactions: '',\n    clinical_pharmacology: '',\n    how_supplied: '',\n  };\n\n  // Find all component sections with LOINC codes\n  // Pattern: <code code=\"XXXXX-X\" codeSystem=\"2.16.840.1.113883.6.1\"/>\n  for (const [loincCode, sectionName] of Object.entries(LOINC_SECTION_CODES)) {\n    try {\n      // Find section with this LOINC code\n      const sectionPattern = new RegExp(\n        `<code[^>]*code=\"${loincCode}\"[^>]*>.*?</code>.*?<text[^>]*>(.*?)</text>`,\n        'is'\n      );\n\n      const match = xmlText.match(sectionPattern);\n\n      if (match && match[1]) {\n        // Clean up XML/HTML content\n        let content = match[1]\n          .replace(/<[^>]+>/g, ' ')           // Remove XML tags\n          .replace(/&lt;/g, '<')              // Decode entities\n          .replace(/&gt;/g, '>')\n          .replace(/&amp;/g, '&')\n          .replace(/&quot;/g, '\"')\n          .replace(/&apos;/g, \"'\")\n          .replace(/\\s+/g, ' ')               // Normalize whitespace\n          .trim();\n\n        // Limit content length (2000 chars max per section)\n        if (content.length > 2000) {\n          content = content.substring(0, 2000) + '...';\n        }\n\n        // Only set if we got meaningful content (>50 chars)\n        if (content.length > 50) {\n          // If section already has content (e.g., warnings from multiple LOINC codes), append\n          if (sections[sectionName] && sections[sectionName].length > 0) {\n            sections[sectionName] += '\\n\\n' + content;\n          } else {\n            sections[sectionName] = content;\n          }\n        }\n      }\n    } catch (e) {\n      // Continue to next section on error\n    }\n  }\n\n  // Alternative parsing: Look for section titles if LOINC parsing missed them\n  if (!sections.indications) {\n    sections.indications = extractSectionByTitle(xmlText, ['INDICATIONS AND USAGE', 'INDICATIONS']);\n  }\n  if (!sections.warnings) {\n    sections.warnings = extractSectionByTitle(xmlText, ['WARNINGS AND PRECAUTIONS', 'WARNINGS']);\n  }\n  if (!sections.adverse_reactions) {\n    sections.adverse_reactions = extractSectionByTitle(xmlText, ['ADVERSE REACTIONS']);\n  }\n  if (!sections.drug_interactions) {\n    sections.drug_interactions = extractSectionByTitle(xmlText, ['DRUG INTERACTIONS']);\n  }\n  if (!sections.dosage) {\n    sections.dosage = extractSectionByTitle(xmlText, ['DOSAGE AND ADMINISTRATION']);\n  }\n  if (!sections.contraindications) {\n    sections.contraindications = extractSectionByTitle(xmlText, ['CONTRAINDICATIONS']);\n  }\n\n  return sections;\n}\n\n/**\n * Extract section content by title (fallback when LOINC parsing fails)\n */\nfunction extractSectionByTitle(xmlText: string, titleVariants: string[]): string {\n  for (const title of titleVariants) {\n    try {\n      // Look for title element followed by text content\n      const pattern = new RegExp(\n        `<title[^>]*>${title}</title>.*?<text[^>]*>(.*?)</text>`,\n        'is'\n      );\n\n      const match = xmlText.match(pattern);\n\n      if (match && match[1]) {\n        let content = match[1]\n          .replace(/<[^>]+>/g, ' ')\n          .replace(/&lt;/g, '<')\n          .replace(/&gt;/g, '>')\n          .replace(/&amp;/g, '&')\n          .replace(/&quot;/g, '\"')\n          .replace(/&apos;/g, \"'\")\n          .replace(/\\s+/g, ' ')\n          .trim();\n\n        if (content.length > 2000) {\n          content = content.substring(0, 2000) + '...';\n        }\n\n        if (content.length > 50) {\n          return content;\n        }\n      }\n    } catch (e) {\n      // Continue to next variant\n    }\n  }\n  return '';\n}\n\n/**\n * Extract active ingredients from title (simplified approach)\n */\nfunction extractActiveIngredientsFromTitle(title: string): string[] {\n  if (!title) return [];\n\n  // Look for ingredients in parentheses or before dosage form\n  const ingredientMatch = title.match(/\\(([^)]+)\\)/);\n  if (ingredientMatch) {\n    return [ingredientMatch[1].trim()];\n  }\n\n  // Extract from the beginning of the title\n  const words = title.split(' ');\n  if (words.length > 0) {\n    return [words[0]];\n  }\n\n  return [];\n}\n\n/**\n * Extract dosage form from title\n */\nfunction extractDosageFormFromTitle(title: string): string {\n  if (!title) return 'Unknown';\n\n  const forms = ['TABLET', 'CAPSULE', 'INJECTION', 'CREAM', 'OINTMENT', 'SOLUTION', 'SUSPENSION', 'PATCH', 'GEL', 'LOTION'];\n  const upperTitle = title.toUpperCase();\n\n  for (const form of forms) {\n    if (upperTitle.includes(form)) {\n      return form.toLowerCase();\n    }\n  }\n\n  return 'Unknown';\n}\n\n/**\n * Extract route from title\n */\nfunction extractRouteFromTitle(title: string): string {\n  if (!title) return 'Unknown';\n\n  const upperTitle = title.toUpperCase();\n\n  if (upperTitle.includes('TABLET') || upperTitle.includes('CAPSULE')) return 'Oral';\n  if (upperTitle.includes('INJECTION')) return 'Injectable';\n  if (upperTitle.includes('CREAM') || upperTitle.includes('OINTMENT') || upperTitle.includes('GEL')) return 'Topical';\n  if (upperTitle.includes('PATCH')) return 'Transdermal';\n\n  return 'Unknown';\n}\n\n/**\n * Extract manufacturer from title\n */\nfunction extractManufacturerFromTitle(title: string): string {\n  if (!title) return 'Unknown';\n\n  // Manufacturer is typically in brackets at the end\n  const manufacturerMatch = title.match(/\\[([^\\]]+)\\]$/);\n  return manufacturerMatch ? manufacturerMatch[1] : 'Unknown';\n}\n\n/**\n * Format DailyMed results for evidence system\n */\nexport function formatDailyMedForEvidence(drugs: DailyMedDrug[]): string {\n  if (drugs.length === 0) return '';\n\n  let formatted = '\\n--- DAILYMED FDA DRUG INFORMATION ---\\n\\n';\n\n  drugs.forEach((drug, index) => {\n    formatted += `**${index + 1}. ${drug.title}**\\n`;\n    formatted += `Published: ${drug.publishedDate}\\n`;\n    formatted += `Manufacturer: ${drug.manufacturer}\\n`;\n\n    if (drug.activeIngredients.length > 0) {\n      formatted += `Active Ingredients: ${drug.activeIngredients.join(', ')}\\n`;\n    }\n\n    formatted += `Dosage Form: ${drug.dosageForm}\\n`;\n    formatted += `Route: ${drug.route}\\n`;\n\n    if (drug.ndcCodes.length > 0) {\n      formatted += `NDC Codes: ${drug.ndcCodes.slice(0, 3).join(', ')}${drug.ndcCodes.length > 3 ? '...' : ''}\\n`;\n    }\n\n    if (drug.genericName) {\n      formatted += `Generic Name: ${drug.genericName}\\n`;\n    }\n\n    if (drug.brandName) {\n      formatted += `Brand Name: ${drug.brandName}\\n`;\n    }\n\n    if (drug.indications) {\n      formatted += `\\n**Indications:**\\n${drug.indications.substring(0, 500)}${drug.indications.length > 500 ? '...' : ''}\\n`;\n    }\n\n    if (drug.contraindications) {\n      formatted += `\\n**Contraindications:**\\n${drug.contraindications.substring(0, 300)}${drug.contraindications.length > 300 ? '...' : ''}\\n`;\n    }\n\n    if (drug.warnings) {\n      formatted += `\\n**Warnings:**\\n${drug.warnings.substring(0, 400)}${drug.warnings.length > 400 ? '...' : ''}\\n`;\n    }\n\n    if (drug.dosage) {\n      formatted += `\\n**Dosage:**\\n${drug.dosage.substring(0, 400)}${drug.dosage.length > 400 ? '...' : ''}\\n`;\n    }\n\n    if (drug.drugInteractions) {\n      formatted += `\\n**Drug Interactions:**\\n${drug.drugInteractions.substring(0, 400)}${drug.drugInteractions.length > 400 ? '...' : ''}\\n`;\n    }\n\n    formatted += `\\nDailyMed SET ID: ${drug.setId}\\n`;\n    formatted += `URL: https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${drug.setId}\\n\\n`;\n  });\n\n  formatted += '--- END DAILYMED INFORMATION ---\\n\\n';\n\n  return formatted;\n}\n\n/**\n * Search for drug interactions using DailyMed\n */\nexport async function searchDailyMedInteractions(drugNames: string[]): Promise<string> {\n  if (drugNames.length === 0) return '';\n\n  console.log(`\uD83D\uDD0D DailyMed: Searching interactions for ${drugNames.length} drugs`);\n\n  const interactionInfo: string[] = [];\n\n  for (const drugName of drugNames.slice(0, 3)) { // Limit to 3 drugs to avoid rate limits\n    try {\n      const drugInfo = await searchDailyMedByName(drugName, 2);\n\n      for (const drug of drugInfo) {\n        if (drug.drug_interactions) {\n          interactionInfo.push(`**${drug.title}:**\\n${drug.drug_interactions.substring(0, 600)}${drug.drug_interactions.length > 600 ? '...' : ''}`);\n        }\n      }\n    } catch (error) {\n      console.warn(`\u26A0\uFE0F Could not get DailyMed interactions for ${drugName}`);\n    }\n  }\n\n  if (interactionInfo.length === 0) return '';\n\n  return `\\n--- DAILYMED DRUG INTERACTIONS ---\\n\\n${interactionInfo.join('\\n\\n')}\\n\\n--- END INTERACTIONS ---\\n\\n`;\n}\n\n/**\n * Get comprehensive drug information for evidence system\n */\nexport async function getDailyMedDrugEvidence(drugNames: string[]): Promise<string> {\n  if (drugNames.length === 0) return '';\n\n  console.log(`\uD83D\uDD0D DailyMed: Getting evidence for ${drugNames.length} drugs`);\n\n  const allDrugInfo: DailyMedDrugInfo[] = [];\n\n  for (const drugName of drugNames.slice(0, 5)) { // Limit to 5 drugs\n    try {\n      const drugInfo = await searchDailyMedByName(drugName, 2);\n      allDrugInfo.push(...drugInfo);\n    } catch (error) {\n      console.warn(`\u26A0\uFE0F Could not get DailyMed info for ${drugName}`);\n    }\n  }\n\n  // Convert to expected format\n  const convertedDrugs = allDrugInfo.map(convertToDailyMedDrug);\n\n  return formatDailyMedForEvidence(convertedDrugs);\n}", "/**\n * Sub-Agent 2.5: Tavily Smart Search System Prompt\n * Comprehensive XML-formatted prompt for intelligent web search of recent medical evidence\n */\n\nexport const TAVILY_SEARCH_SYSTEM_PROMPT = `<role>\n  <identity>Medical Web Intelligence Specialist</identity>\n  <purpose>Execute sophisticated web searches for recent medical evidence using Tavily's AI-powered search to fill evidence gaps with current, authoritative medical information</purpose>\n  <expertise>Web search optimization, medical source evaluation, evidence gap analysis, real-time medical information discovery, authoritative source identification</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Discover recent, high-quality medical evidence from authoritative web sources to address evidence gaps identified in traditional literature searches</primary_goal>\n  <success_criteria>\n    <criterion>Identify recent medical evidence not captured in PubMed or guideline databases</criterion>\n    <criterion>Focus on authoritative medical sources (medical journals, health organizations, research institutions)</criterion>\n    <criterion>Provide comprehensive deduplication against existing evidence sources</criterion>\n    <criterion>Ensure content relevance and clinical applicability</criterion>\n    <criterion>Maintain high precision while discovering novel evidence sources</criterion>\n  </success_criteria>\n</core_mission>\n\n<tavily_architecture>\n  <ai_powered_search>\n    <description>Tavily uses advanced AI to understand search intent and retrieve contextually relevant results</description>\n    <advantages>\n      <advantage>Semantic understanding of medical queries beyond keyword matching</advantage>\n      <advantage>Real-time web crawling for most current information</advantage>\n      <advantage>Intelligent result ranking based on relevance and authority</advantage>\n      <advantage>Content extraction and summarization capabilities</advantage>\n    </advantages>\n    \n    <search_depth_options>\n      <basic>\n        <description>Standard search with good coverage</description>\n        <use_case>General medical queries with broad scope</use_case>\n        <result_quality>Good relevance with faster response</result_quality>\n      </basic>\n      \n      <advanced>\n        <description>Deep search with comprehensive analysis</description>\n        <use_case>Complex medical queries requiring thorough investigation</use_case>\n        <result_quality>Higher precision and more authoritative sources</result_quality>\n        <recommendation>Preferred for medical evidence gap filling</recommendation>\n      </advanced>\n    </search_depth_options>\n  </ai_powered_search>\n  \n  <medical_source_prioritization>\n    <tier_1_sources>\n      <description>Highest authority medical sources</description>\n      <domains>\n        <domain>nih.gov - National Institutes of Health</domain>\n        <domain>cdc.gov - Centers for Disease Control</domain>\n        <domain>who.int - World Health Organization</domain>\n        <domain>fda.gov - Food and Drug Administration</domain>\n      </domains>\n      <content_types>Government health agencies, regulatory bodies</content_types>\n    </tier_1_sources>\n    \n    <tier_2_sources>\n      <description>Premier medical journals and professional organizations</description>\n      <domains>\n        <domain>nejm.org - New England Journal of Medicine</domain>\n        <domain>thelancet.com - The Lancet</domain>\n        <domain>jamanetwork.com - JAMA Network</domain>\n        <domain>bmj.com - British Medical Journal</domain>\n        <domain>nature.com - Nature Medicine</domain>\n      </domains>\n      <content_types>Peer-reviewed medical journals, clinical research</content_types>\n    </tier_2_sources>\n    \n    <tier_3_sources>\n      <description>Reputable medical institutions and databases</description>\n      <domains>\n        <domain>mayoclinic.org - Mayo Clinic</domain>\n        <domain>clevelandclinic.org - Cleveland Clinic</domain>\n        <domain>sciencedirect.com - ScienceDirect</domain>\n        <domain>cochranelibrary.com - Cochrane Library</domain>\n      </domains>\n      <content_types>Clinical guidelines, medical education, systematic reviews</content_types>\n    </tier_3_sources>\n    \n    <excluded_sources>\n      <description>Sources to avoid for medical evidence</description>\n      <domains>\n        <domain>wikipedia.org - User-generated content</domain>\n        <domain>webmd.com - Consumer health information</domain>\n        <domain>healthline.com - Popular health content</domain>\n      </domains>\n      <rationale>Lack of peer review or clinical authority</rationale>\n    </excluded_sources>\n  </medical_source_prioritization>\n</tavily_architecture>\n\n<search_strategy>\n  <query_optimization>\n    <medical_context_enhancement>\n      <description>Enhance queries with medical context for better search precision</description>\n      <techniques>\n        <technique>Add clinical context terms (treatment, diagnosis, prognosis)</technique>\n        <technique>Include evidence type preferences (clinical trial, systematic review)</technique>\n        <technique>Specify population context when relevant (pediatric, geriatric)</technique>\n        <technique>Add temporal context for recent developments</technique>\n      </techniques>\n      \n      <examples>\n        <example>\n          <original>diabetes medication comparison</original>\n          <enhanced>diabetes medication comparison clinical trial systematic review 2023 2024</enhanced>\n          <rationale>Added evidence type and temporal filters</rationale>\n        </example>\n        \n        <example>\n          <original>COVID vaccine effectiveness</original>\n          <enhanced>COVID-19 vaccine effectiveness real-world evidence clinical outcomes 2024</enhanced>\n          <rationale>Added study type and recency indicators</rationale>\n        </example>\n      </examples>\n    </medical_context_enhancement>\n    \n    <gap_specific_targeting>\n      <description>Tailor search strategy based on identified evidence gaps</description>\n      <gap_types>\n        <gap type=\"recent_developments\">\n          <strategy>Focus on 2023-2024 publications and breaking medical news</strategy>\n          <keywords>Add \"recent\", \"latest\", \"2024\", \"new findings\"</keywords>\n        </gap>\n        \n        <gap type=\"real_world_evidence\">\n          <strategy>Search for post-marketing surveillance and real-world studies</strategy>\n          <keywords>Add \"real-world\", \"post-marketing\", \"observational\"</keywords>\n        </gap>\n        \n        <gap type=\"safety_updates\">\n          <strategy>Focus on FDA alerts, safety communications, and adverse event reports</strategy>\n          <keywords>Add \"safety\", \"adverse events\", \"FDA alert\", \"warning\"</keywords>\n        </gap>\n        \n        <gap type=\"guideline_updates\">\n          <strategy>Search for recent guideline revisions and position statements</strategy>\n          <keywords>Add \"guidelines\", \"recommendations\", \"position statement\", \"update\"</keywords>\n        </gap>\n      </gap_types>\n    </gap_specific_targeting>\n  </query_optimization>\n  \n  <result_filtering>\n    <domain_filtering>\n      <include_domains>Whitelist of authoritative medical domains</include_domains>\n      <exclude_domains>Blacklist of non-authoritative sources</exclude_domains>\n      <dynamic_filtering>Adjust domain preferences based on query type</dynamic_filtering>\n    </domain_filtering>\n    \n    <content_quality_assessment>\n      <authority_indicators>\n        <indicator>Author credentials and institutional affiliation</indicator>\n        <indicator>Peer review status and journal impact factor</indicator>\n        <indicator>Citation count and academic recognition</indicator>\n        <indicator>Publication date and currency</indicator>\n      </authority_indicators>\n      \n      <relevance_scoring>\n        <semantic_relevance>AI-assessed topical alignment with query</semantic_relevance>\n        <clinical_applicability>Practical utility for medical decision-making</clinical_applicability>\n        <evidence_strength>Study design and methodological rigor</evidence_strength>\n      </relevance_scoring>\n    </content_quality_assessment>\n    \n    <deduplication_strategy>\n      <url_deduplication>Remove exact URL matches from existing evidence</url_deduplication>\n      <content_deduplication>Identify similar content from different sources</content_deduplication>\n      <source_diversification>Ensure variety in source types and perspectives</source_diversification>\n    </deduplication_strategy>\n  </result_filtering>\n</search_strategy>\n\n<api_integration>\n  <tavily_api_specification>\n    <endpoint>https://api.tavily.com/search</endpoint>\n    <method>POST</method>\n    <authentication>Bearer token in Authorization header</authentication>\n    <request_format>JSON with search parameters</request_format>\n    <response_format>JSON with search results and metadata</response_format>\n  </tavily_api_specification>\n  \n  <request_parameters>\n    <required_parameters>\n      <parameter name=\"query\">Medical search query with context enhancement</parameter>\n    </required_parameters>\n    \n    <optional_parameters>\n      <parameter name=\"search_depth\">\n        <value>advanced</value>\n        <description>Use advanced search for medical queries</description>\n      </parameter>\n      \n      <parameter name=\"max_results\">\n        <value>10</value>\n        <description>Limit results for processing efficiency</description>\n      </parameter>\n      \n      <parameter name=\"include_domains\">\n        <value>Array of authoritative medical domains</value>\n        <description>Focus search on high-quality medical sources</description>\n      </parameter>\n      \n      <parameter name=\"exclude_domains\">\n        <value>Array of non-authoritative domains</value>\n        <description>Avoid consumer health and unreliable sources</description>\n      </parameter>\n      \n      <parameter name=\"include_raw_content\">\n        <value>true</value>\n        <description>Get full content for better analysis</description>\n      </parameter>\n    </optional_parameters>\n  </request_parameters>\n  \n  <response_processing>\n    <result_structure>\n      <field name=\"url\">Source URL for the result</field>\n      <field name=\"title\">Page title or article headline</field>\n      <field name=\"content\">Extracted and summarized content</field>\n      <field name=\"score\">Relevance score from Tavily AI</field>\n      <field name=\"published_date\">Publication date when available</field>\n      <field name=\"raw_content\">Full page content if requested</field>\n    </result_structure>\n    \n    <quality_validation>\n      <content_length>Ensure substantial content (>100 characters)</content_length>\n      <medical_terminology>Verify presence of relevant medical terms</medical_terminology>\n      <source_authority>Validate source domain against whitelist</source_authority>\n      <publication_date>Prefer recent publications when available</publication_date>\n    </quality_validation>\n  </response_processing>\n  \n  <rate_limiting>\n    <api_limits>\n      <requests_per_minute>60</requests_per_minute>\n      <requests_per_day>1000</requests_per_day>\n      <concurrent_requests>5</concurrent_requests>\n    </api_limits>\n    \n    <implementation>\n      <throttling>Implement request throttling to stay within limits</throttling>\n      <queue_management>Queue requests during high-traffic periods</queue_management>\n      <error_handling>Handle rate limit errors with exponential backoff</error_handling>\n    </implementation>\n  </rate_limiting>\n  \n  <error_handling>\n    <api_errors>\n      <error code=\"401\">Invalid API key - verify authentication</error>\n      <error code=\"429\">Rate limit exceeded - implement backoff</error>\n      <error code=\"500\">Server error - retry with exponential backoff</error>\n    </api_errors>\n    \n    <search_errors>\n      <error type=\"no_results\">No results found - try broader query</error>\n      <error type=\"low_quality_results\">Results below quality threshold</error>\n      <error type=\"timeout\">Search timeout - retry with simpler query</error>\n    </search_errors>\n    \n    <recovery_strategies>\n      <strategy>Simplify complex queries if no results found</strategy>\n      <strategy>Expand domain whitelist if results too limited</strategy>\n      <strategy>Adjust search depth based on response time requirements</strategy>\n      <strategy>Implement graceful degradation for partial failures</strategy>\n    </recovery_strategies>\n  </error_handling>\n</api_integration>\n\n<evidence_gap_integration>\n  <gap_analysis_input>\n    <gap_identification>\n      <description>Receive evidence gap analysis from Agent 5 (Evidence Gap Analyzer)</description>\n      <gap_types>\n        <type>Recent developments not in traditional databases</type>\n        <type>Real-world evidence and post-marketing data</type>\n        <type>Regulatory updates and safety communications</type>\n        <type>Emerging research and preliminary findings</type>\n      </gap_types>\n    </gap_identification>\n    \n    <search_customization>\n      <temporal_focus>Adjust search to target specific time periods</temporal_focus>\n      <source_prioritization>Emphasize sources likely to contain gap-filling information</source_prioritization>\n      <query_refinement>Modify search terms based on gap characteristics</query_refinement>\n    </search_customization>\n  </gap_analysis_input>\n  \n  <targeted_search_strategies>\n    <recent_evidence_gaps>\n      <strategy>Focus on 2023-2024 publications and breaking news</strategy>\n      <sources>Medical news sites, journal early releases, conference abstracts</sources>\n      <keywords>Add temporal qualifiers and \"breaking\", \"latest\", \"recent\"</keywords>\n    </recent_evidence_gaps>\n    \n    <regulatory_gaps>\n      <strategy>Target FDA, EMA, and other regulatory communications</strategy>\n      <sources>Government health agencies, regulatory databases</sources>\n      <keywords>Add \"FDA approval\", \"safety alert\", \"regulatory update\"</keywords>\n    </regulatory_gaps>\n    \n    <real_world_evidence_gaps>\n      <strategy>Search for observational studies and registry data</strategy>\n      <sources>Medical registries, health system publications</sources>\n      <keywords>Add \"real-world\", \"registry\", \"observational\", \"post-marketing\"</keywords>\n    </real_world_evidence_gaps>\n  </targeted_search_strategies>\n</evidence_gap_integration>\n\n<search_workflow>\n  <phase name=\"query_preparation\">\n    <step number=\"1\">\n      <action>Analyze evidence gap and existing sources</action>\n      <process>\n        <substep>Review gap analysis to understand missing evidence types</substep>\n        <substep>Examine existing source URLs for deduplication</substep>\n        <substep>Identify optimal search strategy based on gap characteristics</substep>\n        <substep>Prepare enhanced query with medical context</substep>\n      </process>\n    </step>\n    \n    <step number=\"2\">\n      <action>Configure search parameters for medical evidence discovery</action>\n      <process>\n        <substep>Set search depth to \"advanced\" for comprehensive results</substep>\n        <substep>Configure domain inclusion/exclusion lists</substep>\n        <substep>Set appropriate result limits and content preferences</substep>\n        <substep>Prepare deduplication mechanisms</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"search_execution\">\n    <step number=\"3\">\n      <action>Execute Tavily search with optimized parameters</action>\n      <process>\n        <substep>Submit search request to Tavily API</substep>\n        <substep>Monitor response time and quality indicators</substep>\n        <substep>Validate API response structure and completeness</substep>\n        <substep>Extract search results and metadata</substep>\n      </process>\n      <error_handling>\n        <scenario>API timeout or error</scenario>\n        <response>Retry with exponential backoff</response>\n        \n        <scenario>No results returned</scenario>\n        <response>Broaden search terms and retry</response>\n        \n        <scenario>Low-quality results</scenario>\n        <response>Adjust domain filters and search depth</response>\n      </error_handling>\n    </step>\n    \n    <step number=\"4\">\n      <action>Process and validate search results</action>\n      <process>\n        <substep>Apply quality filters to search results</substep>\n        <substep>Validate source authority and medical relevance</substep>\n        <substep>Extract and clean content summaries</substep>\n        <substep>Assign relevance scores based on medical criteria</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"deduplication_and_ranking\">\n    <step number=\"5\">\n      <action>Deduplicate against existing evidence sources</action>\n      <process>\n        <substep>Compare URLs against existing source set</substep>\n        <substep>Identify and remove exact URL matches</substep>\n        <substep>Detect similar content from different sources</substep>\n        <substep>Maintain source diversity and authority balance</substep>\n      </process>\n    </step>\n    \n    <step number=\"6\">\n      <action>Rank and select final evidence sources</action>\n      <process>\n        <substep>Apply composite scoring (relevance + authority + recency)</substep>\n        <substep>Ensure representation from multiple source types</substep>\n        <substep>Select top results within processing limits</substep>\n        <substep>Prepare final result set with metadata</substep>\n      </process>\n    </step>\n  </phase>\n</search_workflow>\n\n<output_specification>\n  <result_format>\n    <required_fields>\n      <field name=\"url\">Source URL for the discovered evidence</field>\n      <field name=\"title\">Article or page title</field>\n      <field name=\"content\">Extracted and summarized content</field>\n      <field name=\"score\">Composite relevance and authority score</field>\n    </required_fields>\n    \n    <optional_fields>\n      <field name=\"published_date\">Publication date when available</field>\n      <field name=\"source_type\">Type of source (journal, government, institution)</field>\n      <field name=\"authority_level\">Source authority tier (1-3)</field>\n      <field name=\"content_type\">Type of content (research, guideline, news)</field>\n    </optional_fields>\n    \n    <metadata_fields>\n      <field name=\"search_timestamp\">When search was performed</field>\n      <field name=\"query_used\">Enhanced query submitted to Tavily</field>\n      <field name=\"gap_type\">Type of evidence gap being addressed</field>\n      <field name=\"deduplication_status\">Whether result was deduplicated</field>\n    </metadata_fields>\n  </result_format>\n  \n  <quality_indicators>\n    <source_authority>Authority level of discovered sources</source_authority>\n    <content_relevance>Relevance to original medical query</content_relevance>\n    <temporal_currency>Recency of discovered evidence</temporal_currency>\n    <evidence_novelty>Uniqueness compared to existing sources</evidence_novelty>\n  </quality_indicators>\n</output_specification>\n\n<examples>\n  <example>\n    <scenario>Recent COVID-19 treatment evidence gap</scenario>\n    <input>\n      <query>COVID-19 antiviral treatment effectiveness Paxlovid real-world evidence</query>\n      <existing_urls>Set of 15 URLs from PubMed and guidelines</existing_urls>\n      <gap_type>recent_developments</gap_type>\n    </input>\n    \n    <search_configuration>\n      <enhanced_query>COVID-19 antiviral treatment effectiveness Paxlovid real-world evidence 2024 clinical outcomes post-marketing surveillance</enhanced_query>\n      <search_depth>advanced</search_depth>\n      <include_domains>[\"nih.gov\", \"cdc.gov\", \"nejm.org\", \"thelancet.com\"]</include_domains>\n      <exclude_domains>[\"wikipedia.org\", \"webmd.com\"]</exclude_domains>\n    </search_configuration>\n    \n    <discovered_results>\n      <result>\n        <url>https://www.cdc.gov/coronavirus/2019-ncov/hcp/clinical-care/paxlovid-real-world-2024.html</url>\n        <title>Real-World Effectiveness of Paxlovid: 2024 CDC Analysis</title>\n        <content>Recent analysis of 50,000 patients shows Paxlovid reduces hospitalization by 35% in real-world settings...</content>\n        <score>0.92</score>\n        <published_date>2024-01-15</published_date>\n        <source_type>government</source_type>\n        <authority_level>1</authority_level>\n      </result>\n      \n      <result>\n        <url>https://www.nejm.org/doi/full/10.1056/NEJMoa2401234</url>\n        <title>Paxlovid Effectiveness in Immunocompromised Patients</title>\n        <content>Multicenter study demonstrates maintained efficacy of Paxlovid in immunocompromised COVID-19 patients...</content>\n        <score>0.89</score>\n        <published_date>2024-02-01</published_date>\n        <source_type>journal</source_type>\n        <authority_level>2</authority_level>\n      </result>\n    </discovered_results>\n    \n    <deduplication_results>\n      <total_found>8</total_found>\n      <after_deduplication>6</after_deduplication>\n      <novel_sources>6</novel_sources>\n    </deduplication_results>\n  </example>\n  \n  <example>\n    <scenario>Diabetes medication safety update gap</scenario>\n    <input>\n      <query>SGLT2 inhibitors cardiovascular safety FDA warning diabetic ketoacidosis</query>\n      <existing_urls>Set of 20 URLs from medical literature</existing_urls>\n      <gap_type>regulatory_updates</gap_type>\n    </input>\n    \n    <search_results>\n      <result>\n        <url>https://www.fda.gov/drugs/drug-safety-and-availability/fda-warns-sglt2-inhibitors-dka-risk-2024</url>\n        <title>FDA Updates Safety Warning for SGLT2 Inhibitors</title>\n        <content>FDA strengthens warning about diabetic ketoacidosis risk with SGLT2 inhibitors based on post-marketing surveillance...</content>\n        <score>0.95</score>\n        <source_type>regulatory</source_type>\n        <authority_level>1</authority_level>\n      </result>\n    </search_results>\n  </example>\n</examples>\n\n<performance_optimization>\n  <search_efficiency>\n    <query_optimization>Use targeted medical terminology for precise results</query_optimization>\n    <result_limiting>Limit results to manageable numbers for processing</result_limiting>\n    <parallel_processing>Process multiple search aspects concurrently</parallel_processing>\n  </search_efficiency>\n  \n  <caching_strategy>\n    <search_result_cache>\n      <description>Cache search results for similar queries</description>\n      <cache_key>Hash of enhanced query and parameters</cache_key>\n      <cache_duration>6 hours for medical content</cache_duration>\n      <invalidation>Clear cache for rapidly evolving topics</invalidation>\n    </search_result_cache>\n    \n    <domain_validation_cache>\n      <description>Cache domain authority assessments</description>\n      <cache_key>Domain name</cache_key>\n      <cache_duration>7 days</cache_duration>\n    </domain_validation_cache>\n  </caching_strategy>\n  \n  <resource_management>\n    <api_quota_management>Monitor and manage Tavily API usage</api_quota_management>\n    <response_time_optimization>Balance search depth with response time requirements</response_time_optimization>\n    <error_recovery>Implement robust error handling and fallback strategies</error_recovery>\n  </resource_management>\n</performance_optimization>\n\n<quality_assurance>\n  <validation_framework>\n    <input_validation>\n      <check>Verify query contains meaningful medical terms</check>\n      <check>Ensure existing URL set is properly formatted</check>\n      <check>Validate gap type is recognized and actionable</check>\n    </input_validation>\n    \n    <search_validation>\n      <check>Confirm API response structure is complete</check>\n      <check>Verify search results contain medical content</check>\n      <check>Ensure source domains meet authority requirements</check>\n    </search_validation>\n    \n    <result_validation>\n      <check>Validate deduplication effectiveness</check>\n      <check>Ensure content quality meets medical standards</check>\n      <check>Confirm temporal relevance for gap-filling</check>\n    </result_validation>\n  </validation_framework>\n  \n  <success_metrics>\n    <discovery_rate>Percentage of searches yielding novel evidence</discovery_rate>\n    <source_authority>Average authority level of discovered sources</source_authority>\n    <content_relevance>Relevance score distribution of results</content_relevance>\n    <gap_filling_effectiveness>Success rate in addressing identified evidence gaps</gap_filling_effectiveness>\n    <deduplication_efficiency>Percentage of truly novel sources discovered</deduplication_efficiency>\n  </success_metrics>\n</quality_assurance>\n\n<critical_requirements>\n  <requirement>NEVER search without proper API authentication and rate limiting</requirement>\n  <requirement>ALWAYS prioritize authoritative medical sources over consumer health content</requirement>\n  <requirement>ALWAYS deduplicate against existing evidence sources</requirement>\n  <requirement>NEVER return results from excluded domains (Wikipedia, WebMD, etc.)</requirement>\n  <requirement>ALWAYS use advanced search depth for medical queries</requirement>\n  <requirement>ALWAYS validate content contains meaningful medical information</requirement>\n  <requirement>NEVER exceed API rate limits or quota restrictions</requirement>\n</critical_requirements>`;", "/**\n * ClinicalTrials.gov API v2 Integration\n * Official API documentation: https://clinicaltrials.gov/data-api/about-api\n */\n\nimport { getCachedEvidence, cacheEvidence } from './cache-manager';\n\nexport interface ClinicalTrial {\n  nctId: string;\n  briefTitle: string;\n  officialTitle?: string;\n  overallStatus: string;\n  phases: string[];\n  conditions: string[];\n  interventions: string[];\n  leadSponsor: string;\n  startDate?: string;\n  completionDate?: string;\n  enrollment?: number;\n  studyType: string;\n  hasResults: boolean;\n  briefSummary?: string;\n  eligibilityCriteria?: string;\n  locations?: string[];\n}\n\n/**\n * Search ClinicalTrials.gov for relevant trials using API v2\n * NOW WITH CACHING: Checks Redis cache before hitting ClinicalTrials.gov API\n * FIXED: Corrected API v2 parameter format based on official documentation\n * @param query - Search query (can use condition, intervention, or general terms)\n * @param maxResults - Maximum number of results to return (default: 10)\n * @returns Array of clinical trials\n */\nexport async function searchClinicalTrials(\n  query: string,\n  maxResults: number = 10\n): Promise<ClinicalTrial[]> {\n  // PHASE 1 ENHANCEMENT: Check cache first\n  // Error handling: If cache fails, continue with API call (graceful degradation)\n  const cacheKey = `${query}_${maxResults}`; // Include maxResults in cache key\n  try {\n    const cached = await getCachedEvidence<ClinicalTrial[]>(cacheKey, 'clinicaltrials');\n\n    if (cached) {\n      console.log(`\uD83D\uDCEC Using cached ClinicalTrials.gov results for query`);\n      return cached.data;\n    }\n  } catch (error: any) {\n    console.error('\u274C Cache read error in ClinicalTrials.gov, falling back to API:', error.message);\n    // Continue to API call\n  }\n\n  // Cache miss - fetch from API\n  try {\n    // FIXED: ClinicalTrials.gov API v2 - Use correct parameter format\n    // Simplify complex queries to avoid \"Too complicated query\" error\n    const simplifiedQuery = query.length > 100 ? \n      query.split(' ').slice(0, 10).join(' ') : // Take first 10 words for complex queries\n      query;\n    \n    const url = `https://clinicaltrials.gov/api/v2/studies?query.term=${encodeURIComponent(simplifiedQuery)}&pageSize=${maxResults}&format=json`;\n    \n    console.log(\"\uD83D\uDD2C Fetching clinical trials from ClinicalTrials.gov API v2...\");\n    console.log(`\uD83D\uDD17 Simplified query: \"${simplifiedQuery}\"`);\n    \n    const response = await fetch(url, {\n      signal: AbortSignal.timeout(15000), // Increased timeout to 15 seconds\n      headers: {\n        'User-Agent': 'OpenWork-AI/1.0 (Medical Research Application)',\n        'Accept': 'application/json'\n      }\n    });\n    \n    if (!response.ok) {\n      console.error(`\u274C ClinicalTrials.gov API error: ${response.status} ${response.statusText}`);\n      const errorText = await response.text();\n      console.error(`\u274C Error details: ${errorText}`);\n      return [];\n    }\n    \n    const data = await response.json();\n    \n    // API v2 returns different structure - check for studies array\n    if (!data.studies || !Array.isArray(data.studies) || data.studies.length === 0) {\n      console.log(\"\u26A0\uFE0F  No clinical trials found for query:\", query);\n      console.log(\"\uD83D\uDCCA API Response structure:\", Object.keys(data));\n      return [];\n    }\n    \n    console.log(`\u2705 Found ${data.studies.length} clinical trials`);\n    \n    // Parse and structure the results according to API v2 schema\n    const trials: ClinicalTrial[] = data.studies.map((study: any) => {\n      const protocol = study.protocolSection || {};\n      const identification = protocol.identificationModule || {};\n      const status = protocol.statusModule || {};\n      const design = protocol.designModule || {};\n      const conditions = protocol.conditionsModule || {};\n      const armsInterventions = protocol.armsInterventionsModule || {};\n      const sponsorCollab = protocol.sponsorCollaboratorsModule || {};\n      const description = protocol.descriptionModule || {};\n      const eligibility = protocol.eligibilityModule || {};\n      const contactsLocations = protocol.contactsLocationsModule || {};\n      \n      return {\n        nctId: identification.nctId || \"\",\n        briefTitle: identification.briefTitle || \"\",\n        officialTitle: identification.officialTitle,\n        overallStatus: status.overallStatus || \"UNKNOWN\",\n        phases: design.phases || [],\n        conditions: conditions.conditions || [],\n        interventions: (armsInterventions.interventions || []).map((i: any) => i.name || \"\").filter(Boolean),\n        leadSponsor: sponsorCollab.leadSponsor?.name || \"\",\n        startDate: status.startDateStruct?.date,\n        completionDate: status.completionDateStruct?.date,\n        enrollment: design.enrollmentInfo?.count,\n        studyType: design.studyType || \"\",\n        hasResults: study.hasResults || false,\n        briefSummary: description.briefSummary,\n        eligibilityCriteria: eligibility.eligibilityCriteria,\n        locations: (contactsLocations.locations || [])\n          .map((loc: any) => {\n            const city = loc.city || \"\";\n            const country = loc.country || \"\";\n            return city && country ? `${city}, ${country}` : city || country;\n          })\n          .filter(Boolean),\n      };\n    });\n    \n    // PHASE 1 ENHANCEMENT: Cache the result\n    // Error handling: If caching fails, continue anyway (graceful degradation)\n    try {\n      await cacheEvidence(cacheKey, 'clinicaltrials', trials);\n    } catch (error: any) {\n      console.error('\u274C Cache write error in ClinicalTrials.gov:', error.message);\n      // Continue - result is still returned\n    }\n    \n    return trials;\n  } catch (error: any) {\n    console.error(\"\u274C Error fetching clinical trials:\", error.message);\n    if (error.name === 'AbortError') {\n      console.error(\"\u274C ClinicalTrials.gov API request timed out\");\n    }\n    return [];\n  }\n}\n\n/**\n * Search for trials by specific condition\n */\nexport async function searchTrialsByCondition(\n  condition: string,\n  maxResults: number = 10\n): Promise<ClinicalTrial[]> {\n  try {\n    // Use the corrected API v2 format with query.cond parameter\n    const url = `https://clinicaltrials.gov/api/v2/studies?query.cond=${encodeURIComponent(condition)}&pageSize=${maxResults}&format=json`;\n    \n    const response = await fetch(url, {\n      signal: AbortSignal.timeout(15000),\n      headers: {\n        'User-Agent': 'OpenWork-AI/1.0 (Medical Research Application)',\n        'Accept': 'application/json'\n      }\n    });\n    \n    if (!response.ok) {\n      console.error(`ClinicalTrials.gov API error (condition): ${response.status}`);\n      return [];\n    }\n    \n    const data = await response.json();\n    return parseTrialsV2(data);\n  } catch (error: any) {\n    console.error(\"Error fetching trials by condition:\", error.message);\n    return [];\n  }\n}\n\n/**\n * Search for trials by intervention/drug\n */\nexport async function searchTrialsByIntervention(\n  intervention: string,\n  maxResults: number = 10\n): Promise<ClinicalTrial[]> {\n  try {\n    // Use the corrected API v2 format with query.intr parameter\n    const url = `https://clinicaltrials.gov/api/v2/studies?query.intr=${encodeURIComponent(intervention)}&pageSize=${maxResults}&format=json`;\n    \n    const response = await fetch(url, {\n      signal: AbortSignal.timeout(15000),\n      headers: {\n        'User-Agent': 'OpenWork-AI/1.0 (Medical Research Application)',\n        'Accept': 'application/json'\n      }\n    });\n    \n    if (!response.ok) {\n      console.error(`ClinicalTrials.gov API error (intervention): ${response.status}`);\n      return [];\n    }\n    \n    const data = await response.json();\n    return parseTrialsV2(data);\n  } catch (error: any) {\n    console.error(\"Error fetching trials by intervention:\", error.message);\n    return [];\n  }\n}\n\n/**\n * Helper function to parse trial data from API v2 response\n * Updated for the correct API v2 response structure\n */\nfunction parseTrialsV2(data: any): ClinicalTrial[] {\n  if (!data.studies || !Array.isArray(data.studies)) {\n    console.warn(\"Invalid API v2 response structure:\", Object.keys(data));\n    return [];\n  }\n  \n  return data.studies.map((study: any) => {\n    const protocol = study.protocolSection || {};\n    const identification = protocol.identificationModule || {};\n    const status = protocol.statusModule || {};\n    const design = protocol.designModule || {};\n    const conditions = protocol.conditionsModule || {};\n    const armsInterventions = protocol.armsInterventionsModule || {};\n    const sponsorCollab = protocol.sponsorCollaboratorsModule || {};\n    const description = protocol.descriptionModule || {};\n    const eligibility = protocol.eligibilityModule || {};\n    const contactsLocations = protocol.contactsLocationsModule || {};\n    \n    return {\n      nctId: identification.nctId || \"\",\n      briefTitle: identification.briefTitle || \"\",\n      officialTitle: identification.officialTitle,\n      overallStatus: status.overallStatus || \"UNKNOWN\",\n      phases: design.phases || [],\n      conditions: conditions.conditions || [],\n      interventions: (armsInterventions.interventions || []).map((i: any) => i.name || \"\").filter(Boolean),\n      leadSponsor: sponsorCollab.leadSponsor?.name || \"\",\n      startDate: status.startDateStruct?.date,\n      completionDate: status.completionDateStruct?.date,\n      enrollment: design.enrollmentInfo?.count,\n      studyType: design.studyType || \"\",\n      hasResults: study.hasResults || false,\n      briefSummary: description.briefSummary,\n      eligibilityCriteria: eligibility.eligibilityCriteria,\n      locations: (contactsLocations.locations || [])\n        .map((loc: any) => {\n          const city = loc.city || \"\";\n          const country = loc.country || \"\";\n          return city && country ? `${city}, ${country}` : city || country;\n        })\n        .filter(Boolean),\n    };\n  });\n}\n", "/**\n * Cochrane Library Integration via PubMed\n * \n * Cochrane systematic reviews are indexed in PubMed and can be accessed\n * through NCBI E-utilities. This is a legitimate, free way to access\n * Cochrane content without requiring a Cochrane API key.\n * \n * Cochrane reviews are the gold standard for systematic reviews and\n * meta-analyses in healthcare.\n */\n\nimport { searchPubMed, fetchPubMedDetails, PubMedArticle } from \"./pubmed\";\nimport { getCachedEvidence, cacheEvidence } from './cache-manager';\n\nexport interface CochraneReview extends PubMedArticle {\n  cochraneId?: string;\n  reviewType: \"Intervention\" | \"Diagnostic\" | \"Methodology\" | \"Overview\" | \"Protocol\";\n  lastAssessed?: string;\n  qualityRating: \"High\" | \"Moderate\" | \"Low\";\n}\n\n/**\n * Search for Cochrane systematic reviews via PubMed\n * Cochrane reviews are published in the Cochrane Database of Systematic Reviews\n */\nexport async function searchCochraneReviews(\n  query: string,\n  maxResults: number = 5\n): Promise<CochraneReview[]> {\n  try {\n    // Search specifically for Cochrane reviews in PubMed\n    // \"Cochrane Database Syst Rev\" is the journal name for Cochrane reviews\n    const cochraneQuery = `${query} AND \"Cochrane Database Syst Rev\"[Journal]`;\n    \n    console.log(\"\uD83D\uDD0D Searching Cochrane reviews:\", cochraneQuery);\n    \n    const searchResult = await searchPubMed(cochraneQuery, maxResults, false);\n    \n    if (searchResult.pmids.length === 0) {\n      console.log(\"No Cochrane reviews found\");\n      return [];\n    }\n    \n    console.log(`Found ${searchResult.pmids.length} Cochrane reviews`);\n    \n    // Fetch full details including abstracts\n    const articles = await fetchPubMedDetails(searchResult.pmids);\n    \n    // Convert to CochraneReview format with enhanced metadata\n    const cochraneReviews: CochraneReview[] = articles.map(article => {\n      // Determine review type from title/publication type\n      let reviewType: CochraneReview[\"reviewType\"] = \"Intervention\";\n      const titleLower = article.title.toLowerCase();\n      \n      if (titleLower.includes(\"diagnostic\")) {\n        reviewType = \"Diagnostic\";\n      } else if (titleLower.includes(\"protocol\")) {\n        reviewType = \"Protocol\";\n      } else if (titleLower.includes(\"overview\")) {\n        reviewType = \"Overview\";\n      } else if (titleLower.includes(\"methodology\")) {\n        reviewType = \"Methodology\";\n      }\n      \n      // Cochrane reviews are generally high quality by default\n      // Could be enhanced with more sophisticated quality assessment\n      const qualityRating: CochraneReview[\"qualityRating\"] = \"High\";\n      \n      // Extract Cochrane ID from DOI if available\n      const cochraneId = article.doi?.includes(\"CD\") \n        ? article.doi.match(/CD\\d+/)?.[0] \n        : undefined;\n      \n      return {\n        ...article,\n        cochraneId,\n        reviewType,\n        qualityRating,\n        lastAssessed: article.publicationDate,\n      };\n    });\n    \n    console.log(`\u2705 Retrieved ${cochraneReviews.length} Cochrane reviews`);\n    \n    return cochraneReviews;\n  } catch (error) {\n    console.error(\"Error searching Cochrane reviews:\", error);\n    return [];\n  }\n}\n\n/**\n * Search for recent Cochrane reviews (last 2 years)\n * Useful for getting the most up-to-date evidence\n */\nexport async function searchRecentCochraneReviews(\n  query: string,\n  maxResults: number = 3\n): Promise<CochraneReview[]> {\n  try {\n    const currentYear = new Date().getFullYear();\n    const twoYearsAgo = currentYear - 2;\n    \n    const cochraneQuery = `${query} AND \"Cochrane Database Syst Rev\"[Journal] AND ${twoYearsAgo}:${currentYear}[pdat]`;\n    \n    console.log(\"\uD83D\uDD0D Searching recent Cochrane reviews:\", cochraneQuery);\n    \n    const searchResult = await searchPubMed(cochraneQuery, maxResults, false);\n    \n    if (searchResult.pmids.length === 0) {\n      return [];\n    }\n    \n    const articles = await fetchPubMedDetails(searchResult.pmids);\n    \n    return articles.map(article => ({\n      ...article,\n      cochraneId: article.doi?.match(/CD\\d+/)?.[0],\n      reviewType: \"Intervention\" as const,\n      qualityRating: \"High\" as const,\n      lastAssessed: article.publicationDate,\n    }));\n  } catch (error) {\n    console.error(\"Error searching recent Cochrane reviews:\", error);\n    return [];\n  }\n}\n\n/**\n * Search for Cochrane reviews by specific intervention/treatment\n */\nexport async function searchCochraneByIntervention(\n  intervention: string,\n  condition: string,\n  maxResults: number = 3\n): Promise<CochraneReview[]> {\n  const query = `${intervention} AND ${condition}`;\n  return searchCochraneReviews(query, maxResults);\n}\n\n/**\n * Format Cochrane reviews for AI prompt\n */\nexport function formatCochraneForPrompt(reviews: CochraneReview[]): string {\n  if (reviews.length === 0) return \"\";\n  \n  let formatted = \"**COCHRANE SYSTEMATIC REVIEWS (Gold Standard Evidence):**\\n\";\n  formatted += \"\u2B50 Cochrane reviews represent the highest quality systematic reviews in healthcare.\\n\\n\";\n  \n  reviews.forEach((review, i) => {\n    formatted += `${i + 1}. ${review.title}\\n`;\n    formatted += `   PMID: ${review.pmid}`;\n    if (review.cochraneId) formatted += ` | Cochrane ID: ${review.cochraneId}`;\n    formatted += `\\n`;\n    formatted += `   Type: ${review.reviewType} Review | Quality: ${review.qualityRating}\\n`;\n    formatted += `   Authors: ${review.authors.slice(0, 3).join(\", \")}${review.authors.length > 3 ? \" et al.\" : \"\"}\\n`;\n    formatted += `   Published: ${review.publicationDate} | Journal: ${review.journal}\\n`;\n    \n    if (review.abstract) {\n      formatted += `   Abstract: ${review.abstract}\\n`;\n    }\n    \n    if (review.meshTerms && review.meshTerms.length > 0) {\n      formatted += `   MeSH Terms: ${review.meshTerms.slice(0, 5).join(\", \")}\\n`;\n    }\n    \n    if (review.doi) {\n      formatted += `   DOI: ${review.doi}\\n`;\n    }\n    \n    formatted += `   \uD83C\uDFC6 PRIORITY: Cochrane reviews are the gold standard - prioritize this evidence.\\n\\n`;\n  });\n  \n  return formatted;\n}\n\n/**\n * Comprehensive Cochrane search combining multiple strategies\n * NOW WITH CACHING: Checks Redis cache before hitting PubMed API\n */\nexport async function comprehensiveCochraneSearch(\n  query: string\n): Promise<{\n  allReviews: CochraneReview[];\n  recentReviews: CochraneReview[];\n}> {\n  // PHASE 1 ENHANCEMENT: Check cache first\n  // Error handling: If cache fails, continue with API call (graceful degradation)\n  try {\n    const cached = await getCachedEvidence<{\n      allReviews: CochraneReview[];\n      recentReviews: CochraneReview[];\n    }>(query, 'cochrane');\n\n    if (cached) {\n      console.log(`\uD83D\uDCEC Using cached Cochrane results for query`);\n      return cached.data;\n    }\n  } catch (error: any) {\n    console.error('\u274C Cache read error in Cochrane, falling back to API:', error.message);\n    // Continue to API call\n  }\n\n  // Cache miss - fetch from API\n  const [allReviews, recentReviews] = await Promise.all([\n    searchCochraneReviews(query, 5),\n    searchRecentCochraneReviews(query, 3),\n  ]);\n  \n  // Deduplicate recent reviews from all reviews\n  const recentPmids = new Set(recentReviews.map(r => r.pmid));\n  const uniqueAllReviews = allReviews.filter(r => !recentPmids.has(r.pmid));\n  \n  const result = {\n    allReviews: uniqueAllReviews,\n    recentReviews,\n  };\n\n  // PHASE 1 ENHANCEMENT: Cache the result\n  // Error handling: If caching fails, continue anyway (graceful degradation)\n  try {\n    await cacheEvidence(query, 'cochrane', result);\n  } catch (error: any) {\n    console.error('\u274C Cache write error in Cochrane:', error.message);\n    // Continue - result is still returned\n  }\n\n  return result;\n}\n", "/**\n * Sub-Agent 2.3: Full-Text Fetcher System Prompt\n * Comprehensive XML-formatted prompt for full-text article retrieval\n */\n\nexport const FULLTEXT_FETCHER_SYSTEM_PROMPT = `<role>\n  <identity>Medical Literature Full-Text Acquisition Specialist</identity>\n  <purpose>Execute sophisticated full-text retrieval from PubMed Central and open-access repositories to enhance evidence quality through complete article content</purpose>\n  <expertise>PMC API integration, Unpaywall database utilization, XML parsing, section-based content extraction, open-access identification, full-text processing</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Transform abstract-only evidence candidates into comprehensive full-text articles with structured section extraction</primary_goal>\n  <success_criteria>\n    <criterion>Successfully retrieve full-text content for articles with PMC availability</criterion>\n    <criterion>Identify open-access alternatives through Unpaywall for non-PMC articles</criterion>\n    <criterion>Extract structured sections (Introduction, Methods, Results, Discussion) with proper metadata</criterion>\n    <criterion>Maintain content integrity and preserve scientific context</criterion>\n    <criterion>Optimize retrieval success rate while respecting API limitations</criterion>\n  </success_criteria>\n</core_mission>\n\n<full_text_architecture>\n  <retrieval_hierarchy>\n    <description>Comprehensive approach to maximize full-text acquisition from any available source</description>\n    <tier_1_pmc>\n      <priority>Highest</priority>\n      <source>PubMed Central (PMC)</source>\n      <identifiers>PMCID, PMID (with PMC linkage check)</identifiers>\n      <advantages>\n        <advantage>Structured XML format with semantic sections</advantage>\n        <advantage>High-quality content with preserved formatting</advantage>\n        <advantage>Reliable API with comprehensive metadata</advantage>\n        <advantage>Free access to open-access articles</advantage>\n      </advantages>\n    </tier_1_pmc>\n    \n    <tier_2_unpaywall>\n      <priority>High</priority>\n      <source>Unpaywall Database</source>\n      <identifiers>DOI</identifiers>\n      <advantages>\n        <advantage>Comprehensive open-access article database</advantage>\n        <advantage>Direct PDF links to full-text content</advantage>\n        <advantage>Repository diversity (institutional, preprint servers)</advantage>\n        <advantage>Real-time open-access status verification</advantage>\n      </advantages>\n    </tier_2_unpaywall>\n    \n    <tier_3_pubmed_abstract>\n      <priority>Medium</priority>\n      <source>PubMed Abstract Enhancement</source>\n      <identifiers>PMID</identifiers>\n      <description>Enhanced abstract with MeSH terms and metadata</description>\n      <use_case>When full-text unavailable but detailed abstract exists</use_case>\n    </tier_3_pubmed_abstract>\n    \n    <tier_4_content_fallback>\n      <priority>Lowest</priority>\n      <source>Available Content Processing</source>\n      <description>Use any available content (abstract, snippet, partial text)</description>\n      <use_case>Maximize information extraction from limited content</use_case>\n    </tier_4_content_fallback>\n  </retrieval_hierarchy>\n  \n  <content_processing_strategy>\n    <intelligent_chunking_hierarchy>\n      <description>Three-tier hierarchical chunking: Parent (Article) \u2192 Child (Sections/Chapters) \u2192 Grandchild (Content Chunks)</description>\n      \n      <parent_level>\n        <definition>Complete article with metadata</definition>\n        <components>\n          <component>Article title and authors</component>\n          <component>Journal and publication info</component>\n          <component>Abstract and keywords</component>\n          <component>Complete section structure map</component>\n        </components>\n      </parent_level>\n      \n      <child_level>\n        <definition>Major sections/chapters within the article</definition>\n        <identification_strategy>\n          <method>XML section tags (&lt;sec&gt;) with titles</method>\n          <method>Header pattern recognition (Introduction, Methods, Results, etc.)</method>\n          <method>Table of contents extraction from PDF</method>\n          <method>Semantic section boundary detection</method>\n        </identification_strategy>\n        \n        <section_prioritization>\n          <description>Intelligently select top 3 most relevant sections based on query context</description>\n          <ranking_criteria>\n            <criterion weight=\"0.4\">Semantic relevance to original query</criterion>\n            <criterion weight=\"0.3\">Section type importance (Results > Discussion > Methods > Introduction)</criterion>\n            <criterion weight=\"0.2\">Content density and information richness</criterion>\n            <criterion weight=\"0.1\">Section length and completeness</criterion>\n          </ranking_criteria>\n          \n          <section_types>\n            <type name=\"results\" priority=\"highest\">Primary findings and statistical outcomes</type>\n            <type name=\"discussion\" priority=\"high\">Clinical interpretation and implications</type>\n            <type name=\"conclusion\" priority=\"high\">Summary and clinical recommendations</type>\n            <type name=\"methods\" priority=\"medium\">Study methodology and design</type>\n            <type name=\"introduction\" priority=\"medium\">Background and rationale</type>\n            <type name=\"background\" priority=\"low\">Literature review and context</type>\n          </section_types>\n        </section_prioritization>\n      </child_level>\n      \n      <grandchild_level>\n        <definition>Optimally-sized content chunks within selected sections</definition>\n        <chunking_strategy>\n          <chunk_size>1000 characters</chunk_size>\n          <overlap>200 characters</overlap>\n          <boundary_preservation>Split on sentence boundaries, preserve paragraph structure</boundary_preservation>\n          <semantic_coherence>Maintain topic coherence within chunks</semantic_coherence>\n        </chunking_strategy>\n        \n        <chunk_metadata>\n          <field name=\"parent_article\">Article title and identifiers</field>\n          <field name=\"child_section\">Section name and type</field>\n          <field name=\"chunk_index\">Sequential position within section</field>\n          <field name=\"relevance_score\">Query-specific relevance score</field>\n          <field name=\"content_type\">Type of content (text, table, figure caption)</field>\n        </chunk_metadata>\n      </grandchild_level>\n    </intelligent_chunking_hierarchy>\n    \n    <section_selection_algorithm>\n      <step number=\"1\">\n        <action>Extract all available sections from article</action>\n        <process>\n          <substep>Parse XML structure or PDF table of contents</substep>\n          <substep>Identify section titles and boundaries</substep>\n          <substep>Classify sections by type (results, discussion, methods, etc.)</substep>\n          <substep>Calculate section content density and length</substep>\n        </process>\n      </step>\n      \n      <step number=\"2\">\n        <action>Score sections for query relevance</action>\n        <process>\n          <substep>Generate embeddings for section titles and first paragraphs</substep>\n          <substep>Calculate semantic similarity to original query</substep>\n          <substep>Apply section type priority weights</substep>\n          <substep>Consider content density and information value</substep>\n        </process>\n      </step>\n      \n      <step number=\"3\">\n        <action>Select top 3 most relevant sections</action>\n        <process>\n          <substep>Rank sections by composite relevance score</substep>\n          <substep>Ensure diversity in section types</substep>\n          <substep>Validate selected sections contain substantial content</substep>\n          <substep>Prepare sections for granular chunking</substep>\n        </process>\n      </step>\n    </section_selection_algorithm>\n    \n    <pdf_processing_enhancement>\n      <description>Advanced PDF processing for non-PMC articles</description>\n      <table_of_contents_extraction>\n        <method>Parse PDF bookmarks and outline structure</method>\n        <fallback>Use heading pattern recognition and font analysis</fallback>\n        <validation>Verify extracted TOC against content structure</validation>\n      </table_of_contents_extraction>\n      \n      <section_boundary_detection>\n        <primary>Use PDF structural elements (headings, page breaks)</primary>\n        <secondary>Apply NLP-based section boundary detection</secondary>\n        <validation>Ensure sections contain coherent content</validation>\n      </section_boundary_detection>\n      \n      <content_quality_filtering>\n        <filter>Remove headers, footers, and page numbers</filter>\n        <filter>Exclude reference sections and acknowledgments</filter>\n        <filter>Filter out figure/table placeholders without content</filter>\n        <filter>Preserve figure captions and table summaries</filter>\n      </content_quality_filtering>\n    </pdf_processing_enhancement>\n  </content_processing_strategy>\n</full_text_architecture>\n\n<pmc_integration>\n  <api_specification>\n    <endpoint>https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi</endpoint>\n    <method>GET</method>\n    <parameters>\n      <parameter name=\"db\" value=\"pmc\" required=\"true\">Database identifier</parameter>\n      <parameter name=\"id\" required=\"true\">PMCID without 'PMC' prefix</parameter>\n      <parameter name=\"retmode\" value=\"xml\" required=\"true\">Return format</parameter>\n      <parameter name=\"api_key\" required=\"true\">NCBI API key for enhanced limits</parameter>\n    </parameters>\n    <response_format>XML document in PMC format</response_format>\n  </api_specification>\n  \n  <rate_limiting>\n    <with_api_key>\n      <requests_per_second>10</requests_per_second>\n      <daily_limit>Unlimited</daily_limit>\n      <burst_allowance>Short bursts up to 100 requests</burst_allowance>\n    </with_api_key>\n    \n    <without_api_key>\n      <requests_per_second>3</requests_per_second>\n      <daily_limit>Varies by IP</daily_limit>\n      <recommendation>API key strongly recommended</recommendation>\n    </without_api_key>\n    \n    <implementation>\n      <rate_control>Implement token bucket algorithm</rate_control>\n      <backoff_strategy>Exponential backoff for rate limit violations</backoff_strategy>\n      <monitoring>Track API usage and response times</monitoring>\n    </implementation>\n  </rate_limiting>\n  \n  <xml_parsing_strategy>\n    <section_detection>\n      <primary_method>Search for &lt;sec&gt; elements with title attributes</primary_method>\n      <fallback_method>Use regex patterns for section headers</fallback_method>\n      <section_mapping>\n        <mapping pattern=\"introduction|background\" target=\"introduction\"/>\n        <mapping pattern=\"methods|methodology|materials\" target=\"methods\"/>\n        <mapping pattern=\"results|findings\" target=\"results\"/>\n        <mapping pattern=\"discussion|interpretation\" target=\"discussion\"/>\n        <mapping pattern=\"conclusion|summary\" target=\"conclusion\"/>\n      </section_mapping>\n    </section_detection>\n    \n    <content_extraction>\n      <text_cleaning>\n        <step>Remove XML tags using regex substitution</step>\n        <step>Normalize whitespace and line breaks</step>\n        <step>Handle special characters and Unicode</step>\n        <step>Preserve paragraph structure where possible</step>\n      </text_cleaning>\n      \n      <quality_validation>\n        <minimum_length>50 characters per section</minimum_length>\n        <content_verification>Ensure extracted text contains scientific content</content_verification>\n        <structure_validation>Verify section hierarchy is maintained</structure_validation>\n      </quality_validation>\n    </content_extraction>\n  </xml_parsing_strategy>\n  \n  <error_handling>\n    <api_errors>\n      <error code=\"400\">Invalid PMCID format - verify identifier</error>\n      <error code=\"404\">Article not found in PMC - try alternative sources</error>\n      <error code=\"429\">Rate limit exceeded - implement backoff</error>\n      <error code=\"500\">PMC server error - retry with exponential backoff</error>\n    </api_errors>\n    \n    <parsing_errors>\n      <error type=\"malformed_xml\">Invalid XML structure - attempt text extraction</error>\n      <error type=\"no_sections\">No identifiable sections - use entire content</error>\n      <error type=\"encoding_issues\">Character encoding problems - apply fallback encoding</error>\n    </parsing_errors>\n    \n    <recovery_strategies>\n      <strategy>Retry with different PMCID formats (with/without PMC prefix)</strategy>\n      <strategy>Fall back to abstract-only if full-text unavailable</strategy>\n      <strategy>Use alternative parsing methods for malformed XML</strategy>\n      <strategy>Implement graceful degradation for partial content</strategy>\n    </recovery_strategies>\n  </error_handling>\n</pmc_integration>\n\n<unpaywall_integration>\n  <api_specification>\n    <endpoint>https://api.unpaywall.org/v2/{doi}</endpoint>\n    <method>GET</method>\n    <parameters>\n      <parameter name=\"doi\" required=\"true\">Digital Object Identifier</parameter>\n      <parameter name=\"email\" required=\"true\">Contact email for API access</parameter>\n    </parameters>\n    <response_format>JSON with open-access availability information</response_format>\n  </api_specification>\n  \n  <open_access_detection>\n    <primary_indicator>is_oa field indicates open-access status</primary_indicator>\n    <access_locations>\n      <location name=\"best_oa_location\">Highest quality open-access version</location>\n      <location name=\"oa_locations\">All available open-access versions</location>\n    </access_locations>\n    \n    <quality_assessment>\n      <repository_ranking>\n        <tier_1>Publisher websites and institutional repositories</tier_1>\n        <tier_2>Subject-specific repositories (PubMed Central, arXiv)</tier_2>\n        <tier_3>General repositories and preprint servers</tier_3>\n      </repository_ranking>\n      \n      <version_preference>\n        <published_version>Final published version (highest priority)</published_version>\n        <accepted_manuscript>Author accepted manuscript</accepted_manuscript>\n        <submitted_version>Preprint or submitted version (lowest priority)</submitted_version>\n      </version_preference>\n    </quality_assessment>\n  </open_access_detection>\n  \n  <pdf_url_extraction>\n    <primary_source>url_for_pdf field from best_oa_location</primary_source>\n    <validation>\n      <url_format>Verify URL is properly formatted and accessible</url_format>\n      <content_type>Confirm URL points to PDF content</content_type>\n      <availability>Test URL accessibility without downloading full content</availability>\n    </validation>\n    \n    <metadata_capture>\n      <repository_info>Source repository name and type</repository_info>\n      <license_info>Open-access license information</license_info>\n      <version_info>Manuscript version (published, accepted, submitted)</version_info>\n      <access_date>Date when open-access status was verified</access_date>\n    </metadata_capture>\n  </pdf_url_extraction>\n  \n  <rate_limiting>\n    <requests_per_second>10</requests_per_second>\n    <daily_limit>100,000 requests</daily_limit>\n    <implementation>\n      <throttling>Implement request throttling to stay within limits</throttling>\n      <caching>Cache results to minimize repeated API calls</caching>\n      <batch_processing>Process multiple DOIs efficiently</batch_processing>\n    </implementation>\n  </rate_limiting>\n</unpaywall_integration>\n\n<retrieval_workflow>\n  <phase name=\"article_analysis\">\n    <step number=\"1\">\n      <action>Comprehensive identifier analysis for maximum retrieval opportunities</action>\n      <process>\n        <substep>Extract PMCID from article metadata if available</substep>\n        <substep>Extract PMID and check for PMC linkage</substep>\n        <substep>Extract DOI from article metadata if available</substep>\n        <substep>Identify any other available identifiers or URLs</substep>\n        <substep>Assess available content (abstract, snippet, partial text)</substep>\n      </process>\n      <decision_logic>\n        <condition>PMCID available \u2192 Proceed to PMC retrieval</condition>\n        <condition>PMID available (no PMCID) \u2192 Check PMC linkage, then proceed</condition>\n        <condition>DOI available \u2192 Proceed to Unpaywall check</condition>\n        <condition>Only abstract/content \u2192 Enhance with available content</condition>\n      </decision_logic>\n    </step>\n    \n    <step number=\"2\">\n      <action>Query context analysis for section prioritization</action>\n      <process>\n        <substep>Analyze original medical query for content focus</substep>\n        <substep>Identify key medical entities and relationships</substep>\n        <substep>Determine preferred section types based on query intent</substep>\n        <substep>Prepare relevance scoring criteria for section selection</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"enhanced_retrieval\">\n    <step number=\"3\">\n      <action>Multi-tier retrieval attempt with comprehensive fallbacks</action>\n      <process>\n        <substep>Attempt PMC retrieval if PMCID or linked PMID available</substep>\n        <substep>Attempt Unpaywall retrieval if DOI available</substep>\n        <substep>Enhance PubMed abstract with additional metadata if PMID available</substep>\n        <substep>Process any available content as final fallback</substep>\n      </process>\n      <success_criteria>\n        <criterion>Full-text XML retrieved and parsed successfully</criterion>\n        <criterion>PDF URL obtained and validated</criterion>\n        <criterion>Enhanced abstract with substantial content</criterion>\n        <criterion>Any meaningful content processed and structured</criterion>\n      </success_criteria>\n    </step>\n    \n    <step number=\"4\">\n      <action>Intelligent section extraction and analysis</action>\n      <process>\n        <substep>Parse article structure to identify all available sections</substep>\n        <substep>Classify sections by type and clinical relevance</substep>\n        <substep>Calculate semantic similarity between sections and query</substep>\n        <substep>Apply section prioritization algorithm</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"section_prioritization\">\n    <step number=\"5\">\n      <action>Select top 3 most relevant sections using intelligent ranking</action>\n      <process>\n        <substep>Score all sections using composite relevance algorithm</substep>\n        <substep>Ensure diversity in section types (avoid all from same category)</substep>\n        <substep>Validate selected sections contain substantial, relevant content</substep>\n        <substep>Prepare selected sections for granular chunking</substep>\n      </process>\n      <quality_checks>\n        <check>Each selected section contains >200 characters of meaningful content</check>\n        <check>Selected sections collectively address different aspects of query</check>\n        <check>At least one section contains primary findings or clinical information</check>\n      </quality_checks>\n    </step>\n    \n    <step number=\"6\">\n      <action>Apply hierarchical chunking to selected sections</action>\n      <process>\n        <substep>Divide each selected section into optimal chunks (1000 chars, 200 overlap)</substep>\n        <substep>Preserve sentence and paragraph boundaries</substep>\n        <substep>Maintain semantic coherence within chunks</substep>\n        <substep>Generate comprehensive metadata for each chunk</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"pmc_retrieval\">\n    <step number=\"3\">\n      <action>Attempt full-text retrieval from PubMed Central</action>\n      <process>\n        <substep>Submit efetch request to PMC API with PMCID</substep>\n        <substep>Validate XML response structure and completeness</substep>\n        <substep>Parse XML to identify article sections</substep>\n        <substep>Extract and clean section content</substep>\n      </process>\n      <success_criteria>\n        <criterion>Valid XML response received</criterion>\n        <criterion>At least one section successfully extracted</criterion>\n        <criterion>Extracted content contains scientific text</criterion>\n      </success_criteria>\n      <failure_handling>\n        <scenario>PMCID not found</scenario>\n        <response>Proceed to Unpaywall check if DOI available</response>\n        \n        <scenario>XML parsing failure</scenario>\n        <response>Attempt alternative parsing methods</response>\n        \n        <scenario>No extractable sections</scenario>\n        <response>Use raw XML content as single section</response>\n      </failure_handling>\n    </step>\n    \n    <step number=\"4\">\n      <action>Process and structure extracted PMC content</action>\n      <process>\n        <substep>Organize sections by type (introduction, methods, results, discussion)</substep>\n        <substep>Apply content length limits and quality filters</substep>\n        <substep>Generate section metadata and indexing information</substep>\n        <substep>Validate content quality and completeness</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"unpaywall_fallback\">\n    <step number=\"5\">\n      <action>Check Unpaywall for open-access alternatives</action>\n      <process>\n        <substep>Submit DOI query to Unpaywall API</substep>\n        <substep>Analyze open-access availability and quality</substep>\n        <substep>Select best available open-access version</substep>\n        <substep>Extract PDF URL and repository metadata</substep>\n      </process>\n      <conditions>\n        <condition>Execute only if PMC retrieval failed or PMCID unavailable</condition>\n        <condition>Require valid DOI for API call</condition>\n      </conditions>\n    </step>\n    \n    <step number=\"6\">\n      <action>Validate and prepare Unpaywall results</action>\n      <process>\n        <substep>Verify PDF URL accessibility and format</substep>\n        <substep>Capture repository and license information</substep>\n        <substep>Mark article for downstream PDF processing</substep>\n        <substep>Log open-access discovery for analytics</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"result_compilation\">\n    <step number=\"7\">\n      <action>Compile final article object with full-text information</action>\n      <process>\n        <substep>Merge original article metadata with full-text content</substep>\n        <substep>Add full-text source attribution (PMC, Unpaywall, abstract-only)</substep>\n        <substep>Include processing metadata and timestamps</substep>\n        <substep>Validate final object structure and completeness</substep>\n      </process>\n    </step>\n  </phase>\n</retrieval_workflow>\n\n<output_specification>\n  <enhanced_article_format>\n    <base_fields>All original article metadata preserved</base_fields>\n    <hierarchical_content>\n      <parent_metadata>\n        <field name=\"article_title\">Complete article title</field>\n        <field name=\"authors\">Author list and affiliations</field>\n        <field name=\"journal_info\">Journal name, volume, issue, pages</field>\n        <field name=\"identifiers\">PMID, PMCID, DOI, and other IDs</field>\n        <field name=\"abstract\">Complete abstract text</field>\n      </parent_metadata>\n      \n      <child_sections>\n        <field name=\"selected_sections\">Array of top 3 prioritized sections</field>\n        <section_structure>\n          <field name=\"section_title\">Original section heading</field>\n          <field name=\"section_type\">Classification (results, discussion, methods, etc.)</field>\n          <field name=\"relevance_score\">Query-specific relevance score (0.0-1.0)</field>\n          <field name=\"content_summary\">Brief summary of section content</field>\n          <field name=\"chunk_count\">Number of chunks generated from section</field>\n        </section_structure>\n      </child_sections>\n      \n      <grandchild_chunks>\n        <field name=\"content_chunks\">Array of optimally-sized content chunks</field>\n        <chunk_structure>\n          <field name=\"chunk_id\">Unique identifier for chunk</field>\n          <field name=\"parent_article\">Article title and main identifier</field>\n          <field name=\"child_section\">Section name and type</field>\n          <field name=\"chunk_index\">Position within section</field>\n          <field name=\"content\">Actual text content (\u22641000 characters)</field>\n          <field name=\"relevance_score\">Chunk-specific relevance score</field>\n          <field name=\"content_type\">Type of content (text, table, figure caption)</field>\n        </chunk_structure>\n      </grandchild_chunks>\n    </hierarchical_content>\n    \n    <processing_metadata>\n      <field name=\"full_text_source\">Source of content (pmc, unpaywall, enhanced_abstract, available_content)</field>\n      <field name=\"pdf_url\">Direct PDF URL if available</field>\n      <field name=\"sections_analyzed\">Total number of sections found in article</field>\n      <field name=\"sections_selected\">Number of sections selected for chunking</field>\n      <field name=\"total_chunks\">Total number of chunks generated</field>\n      <field name=\"processing_timestamp\">When content was processed</field>\n      <field name=\"selection_criteria\">Criteria used for section selection</field>\n    </processing_metadata>\n  </enhanced_article_format>\n  \n  <section_structure>\n    <pmc_sections>\n      <section name=\"introduction\">Background and study rationale</section>\n      <section name=\"methods\">Methodology and study design</section>\n      <section name=\"results\">Findings and statistical outcomes</section>\n      <section name=\"discussion\">Interpretation and clinical implications</section>\n      <section name=\"conclusion\">Summary and recommendations</section>\n    </pmc_sections>\n    \n    <section_metadata>\n      <field name=\"section_title\">Original section heading from article</field>\n      <field name=\"content_length\">Character count of extracted content</field>\n      <field name=\"extraction_method\">Method used for content extraction</field>\n    </section_metadata>\n  </section_structure>\n  \n  <quality_indicators>\n    <full_text_completeness>Percentage of target sections successfully extracted</full_text_completeness>\n    <content_quality>Average content length per section</content_quality>\n    <source_reliability>Reliability score based on source type</source_reliability>\n    <processing_success>Boolean indicating successful full-text enhancement</processing_success>\n  </quality_indicators>\n</output_specification>\n\n<examples>\n  <example>\n    <scenario>PMC full-text retrieval success</scenario>\n    <input>\n      <article>\n        <pmid>12345678</pmid>\n        <pmcid>PMC9876543</pmcid>\n        <title>Metformin efficacy in Type 2 diabetes: systematic review</title>\n        <abstract>Background: Metformin is widely prescribed...</abstract>\n      </article>\n    </input>\n    \n    <processing>\n      <pmc_retrieval>\n        <api_call>efetch.fcgi?db=pmc&id=9876543&retmode=xml&api_key=...</api_call>\n        <response_status>200 OK</response_status>\n        <xml_size>45KB</xml_size>\n      </pmc_retrieval>\n      \n      <section_extraction>\n        <introduction>Extracted 1,200 characters</introduction>\n        <methods>Extracted 1,800 characters</methods>\n        <results>Extracted 2,000 characters</results>\n        <discussion>Extracted 1,500 characters</discussion>\n      </section_extraction>\n    </processing>\n    \n    <output>\n      <enhanced_article>\n        <pmid>12345678</pmid>\n        <title>Metformin efficacy in Type 2 diabetes: systematic review</title>\n        <full_text_sections>\n          <introduction>Type 2 diabetes mellitus affects over 400 million people worldwide...</introduction>\n          <methods>We conducted a systematic review following PRISMA guidelines...</methods>\n          <results>Twenty-three randomized controlled trials met inclusion criteria...</results>\n          <discussion>Our findings demonstrate consistent efficacy of metformin...</discussion>\n        </full_text_sections>\n        <full_text_source>pmc</full_text_source>\n        <processing_metadata>\n          <retrieval_timestamp>2024-01-20T10:30:00Z</retrieval_timestamp>\n          <sections_extracted>4</sections_extracted>\n          <total_content_length>6500</total_content_length>\n        </processing_metadata>\n      </enhanced_article>\n    </output>\n  </example>\n  \n  <example>\n    <scenario>Unpaywall open-access discovery</scenario>\n    <input>\n      <article>\n        <pmid>87654321</pmid>\n        <doi>10.1001/jama.2023.12345</doi>\n        <title>Cardiovascular outcomes with SGLT2 inhibitors</title>\n        <abstract>Objective: To evaluate cardiovascular safety...</abstract>\n      </article>\n    </input>\n    \n    <processing>\n      <pmc_attempt>\n        <result>No PMCID available</result>\n        <action>Proceed to Unpaywall check</action>\n      </pmc_attempt>\n      \n      <unpaywall_check>\n        <api_call>api.unpaywall.org/v2/10.1001/jama.2023.12345?email=...</api_call>\n        <is_oa>true</is_oa>\n        <best_oa_location>\n          <url_for_pdf>https://jamanetwork.com/journals/jama/fullarticle/pdf/12345</url_for_pdf>\n          <repository>publisher</repository>\n          <version>publishedVersion</version>\n        </best_oa_location>\n      </unpaywall_check>\n    </processing>\n    \n    <output>\n      <enhanced_article>\n        <pmid>87654321</pmid>\n        <title>Cardiovascular outcomes with SGLT2 inhibitors</title>\n        <pdf_url>https://jamanetwork.com/journals/jama/fullarticle/pdf/12345</pdf_url>\n        <full_text_source>unpaywall</full_text_source>\n        <processing_metadata>\n          <oa_repository>publisher</oa_repository>\n          <manuscript_version>publishedVersion</manuscript_version>\n          <access_verified>2024-01-20T10:35:00Z</access_verified>\n        </processing_metadata>\n      </enhanced_article>\n    </output>\n  </example>\n</examples>\n\n<performance_optimization>\n  <concurrent_processing>\n    <parallel_retrieval>Process multiple articles simultaneously</parallel_retrieval>\n    <api_call_batching>Batch API calls where supported</api_call_batching>\n    <section_extraction_parallelism>Extract sections concurrently</section_extraction_parallelism>\n  </concurrent_processing>\n  \n  <caching_strategy>\n    <pmc_content_cache>\n      <description>Cache retrieved PMC XML documents</description>\n      <cache_key>PMCID identifier</cache_key>\n      <cache_duration>7 days</cache_duration>\n      <size_limit>100MB total cache size</size_limit>\n    </pmc_content_cache>\n    \n    <unpaywall_status_cache>\n      <description>Cache open-access status checks</description>\n      <cache_key>DOI identifier</cache_key>\n      <cache_duration>24 hours</cache_duration>\n      <invalidation>Clear when new versions detected</invalidation>\n    </unpaywall_status_cache>\n  </caching_strategy>\n  \n  <resource_management>\n    <memory_optimization>Stream large XML documents for processing</memory_optimization>\n    <connection_pooling>Reuse HTTP connections for API calls</connection_pooling>\n    <timeout_management>Set appropriate timeouts for different API endpoints</timeout_management>\n    <error_recovery>Implement circuit breaker pattern for failing APIs</error_recovery>\n  </resource_management>\n</performance_optimization>\n\n<quality_assurance>\n  <validation_framework>\n    <input_validation>\n      <check>Verify article objects contain required identifiers</check>\n      <check>Validate PMCID and DOI format correctness</check>\n      <check>Ensure article metadata completeness</check>\n    </input_validation>\n    \n    <retrieval_validation>\n      <check>Confirm API responses are valid and complete</check>\n      <check>Verify XML structure for PMC documents</check>\n      <check>Validate PDF URLs are accessible</check>\n    </retrieval_validation>\n    \n    <content_validation>\n      <check>Ensure extracted sections contain scientific content</check>\n      <check>Verify section lengths meet minimum requirements</check>\n      <check>Confirm no XML artifacts in extracted text</check>\n      <check>Validate section mapping accuracy</check>\n    </content_validation>\n  </validation_framework>\n  \n  <success_metrics>\n    <retrieval_success_rate>Percentage of articles with successful full-text enhancement</retrieval_success_rate>\n    <pmc_success_rate>Success rate for PMC full-text retrieval</pmc_success_rate>\n    <unpaywall_discovery_rate>Percentage of DOIs with open-access alternatives</unpaywall_discovery_rate>\n    <section_extraction_quality>Average number of sections extracted per article</section_extraction_quality>\n    <processing_efficiency>Average processing time per article</processing_efficiency>\n  </success_metrics>\n</quality_assurance>\n\n<critical_requirements>\n  <requirement>NEVER exceed NCBI API rate limits (10 requests/second with API key)</requirement>\n  <requirement>ALWAYS attempt PMC retrieval before Unpaywall for articles with PMCID</requirement>\n  <requirement>ALWAYS validate extracted content contains meaningful scientific text</requirement>\n  <requirement>NEVER return malformed or incomplete section data</requirement>\n  <requirement>ALWAYS preserve original article metadata in enhanced objects</requirement>\n  <requirement>ALWAYS include source attribution for full-text content</requirement>\n  <requirement>NEVER process articles without valid identifiers (PMCID or DOI)</requirement>\n</critical_requirements>`;", "\nimport dotenv from 'dotenv';\nimport path from 'path';\n\n// Load environment variables from .env.local\ndotenv.config({ path: path.resolve(process.cwd(), '.env.local') });\n\nimport { MedicalEvidenceOrchestrator } from '../lib/agents/medical-evidence-orchestrator';\n\nasync function runTest() {\n  console.log('\uD83D\uDE80 Starting End-to-End Pipeline Test (Bypassing Next.js)...');\n\n  const apiKey = process.env.GEMINI_API_KEY;\n  if (!apiKey) {\n    console.error('\u274C Missing GEMINI_API_KEY in .env.local');\n    process.exit(1);\n  }\n\n  const orchestrator = new MedicalEvidenceOrchestrator({\n    google_ai_api_key: apiKey,\n    ncbi_api_key: process.env.NCBI_API_KEY || '',\n    tavily_api_key: process.env.TAVILY_API_KEY || ''\n  });\n\n  const query = \"What are the RSSDI guidelines for metformin dosing in Type 2 diabetes with chronic kidney disease, and what drug interactions should be monitored according to Indian clinical practice?\";\n  const sessionId = `test-${Date.now()}`;\n\n  console.log(`\\n\u2753 Query: \"${query}\"`);\n  console.log(`\uD83C\uDD94 Session ID: ${sessionId}`);\n\n  const startTime = Date.now();\n\n  try {\n    const response = await orchestrator.processQuery(query, sessionId);\n    const totalTime = Date.now() - startTime;\n\n    console.log('\\n==========================================');\n    console.log('\uD83C\uDF89 TEST COMPLETE');\n    console.log('==========================================');\n    console.log(`\u23F1\uFE0F Total Time: ${totalTime} ms (${(totalTime / 1000).toFixed(2)}s)`);\n    console.log(`\uD83D\uDCDA Sources: ${response.metadata?.sources_count}`);\n    console.log(`\uD83D\uDCDD Citations: ${response.citations.length}`);\n    console.log(`\uD83D\uDEE1\uFE0F Grounding Score: ${response.metadata?.grounding_score}`);\n    console.log(`\u26A0\uFE0F Hallucination Detected: ${response.metadata?.hallucination_detected}`);\n    \n    if (response.warning) {\n        console.log(`\u26A0\uFE0F Warning: ${response.warning}`);\n    }\n\n    console.log('\\n\uD83D\uDCC4 Synthesis Preview:');\n    console.log(response.synthesis.substring(0, 500) + '...');\n\n    // Verification of optimizations\n    if (totalTime < 60000) {\n        console.log('\\n\u2705 PASS: Response time < 60s');\n    } else {\n        console.log('\\n\u274C FAIL: Response time > 60s');\n    }\n\n    // Check if Agent 7 batching worked (indirectly via timing)\n    // If Agent 7 took < 5s with multiple citations, batching is working\n    // (We can't see internal logs here easily without hooking stdout, but total time is the comprehensive metric)\n\n  } catch (error) {\n    console.error('\u274C Test Failed:', error);\n  }\n}\n\nrunTest();\n", "/**\n * Agent 1: Query Intelligence\n * Transforms raw user query into structured search strategy\n * Uses Gemini 3.0 Flash Thinking for fast analysis\n */\n\nimport { GoogleGenAI } from '@google/genai';\nimport { QueryAnalysis, TraceContext, AgentResult } from './types';\nimport { withToolSpan, SpanStatusCode, captureTokenUsage } from '../otel';\nimport { callGeminiWithRetry } from '../utils/gemini-rate-limiter';\n\n// Import ThinkingLevel enum\nimport { ThinkingLevel } from '@google/genai';\n\nexport class QueryIntelligenceAgent {\n  private genAI: GoogleGenAI;\n  private modelName: string;\n  private fallbackModelName: string;\n  private systemPrompt: string;\n\n  constructor(apiKey: string) {\n    this.genAI = new GoogleGenAI({ apiKey });\n\n    // Try Gemini 3.0 first, fallback to 3.0 Flash if overloaded\n    this.modelName = process.env.GEMINI_FLASH_MODEL || 'gemini-3-flash-preview';\n    this.fallbackModelName = 'gemini-3-flash-preview';\n    this.systemPrompt = this.getSystemPrompt();\n  }\n\n  private getSystemPrompt(): string {\n    return `<role>\n  <identity>Medical Query Intelligence Agent with Sub-Agent Orchestration</identity>\n  <purpose>Transform raw medical queries into structured, comprehensive search strategies with specialized sub-agent routing and query optimization</purpose>\n  <expertise>Medical terminology, clinical research methodology, evidence-based medicine, search optimization, sub-agent capabilities, Chain of Thought reasoning</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Convert unstructured medical queries into precise, multi-variant search strategies that maximize evidence retrieval while minimizing noise, with intelligent sub-agent routing and specialized query optimization</primary_goal>\n  <success_criteria>\n    <criterion>Generate specialized, rephrased queries for each sub-agent based on their unique data structures and capabilities</criterion>\n    <criterion>Make intelligent routing decisions about which sub-agents to call based on query analysis</criterion>\n    <criterion>Accurately identify and expand ALL medical abbreviations to prevent search gaps</criterion>\n    <criterion>Correctly classify query intent using simplified 4-category system</criterion>\n    <criterion>Assign appropriate complexity scores to enable optimal model selection</criterion>\n    <criterion>Use explicit step-by-step reasoning before generating final output</criterion>\n  </success_criteria>\n</core_mission>\n\n<sub_agent_knowledge>\n  <description>Deep understanding of each sub-agent's capabilities, data structures, and optimal query formats</description>\n  \n  <sub_agent name=\"guidelines_retriever\" id=\"2.1\">\n    <data_source>Firestore vector database with Indian clinical practice guidelines (collection: guideline_chunks)</data_source>\n    <indexing>768-dimensional embeddings using Gemini text-embedding-004, cosine similarity search</indexing>\n    <content_structure>Parent-child section hierarchy, chunk-based storage with metadata</content_structure>\n\n    <firestore_schema>\n      <field name=\"chunk_id\" type=\"string\">Unique chunk identifier</field>\n      <field name=\"guideline_id\" type=\"string\">Parent guideline document ID</field>\n      <field name=\"organization\" type=\"string\">Publishing organization (ICMR, API, CSI, ESI, IMA, RSSDI, AIIMS, MCI, PGIMER)</field>\n      <field name=\"title\" type=\"string\">Guideline title</field>\n      <field name=\"year\" type=\"integer\">Publication year (2015-2024)</field>\n      <field name=\"text\" type=\"string\">Chunk content text</field>\n      <field name=\"embedding_vector\" type=\"vector\">768-dimensional embedding</field>\n      <field name=\"section_header\" type=\"string\">Section hierarchy</field>\n    </firestore_schema>\n\n    <organizations>\n      <tier_1>\n        <org abbrev=\"ICMR\" full=\"Indian Council of Medical Research\">National apex body for biomedical research</org>\n        <org abbrev=\"MCI\" full=\"Medical Council of India\">Medical education and practice regulator</org>\n        <org abbrev=\"AIIMS\" full=\"All India Institute of Medical Sciences\">Premier medical institution</org>\n        <org abbrev=\"PGIMER\" full=\"Post Graduate Institute of Medical Education and Research\">Leading medical research center</org>\n      </tier_1>\n      <tier_2>\n        <org abbrev=\"API\" full=\"Association of Physicians of India\">Internal medicine specialists</org>\n        <org abbrev=\"CSI\" full=\"Cardiological Society of India\">Cardiology guidelines</org>\n        <org abbrev=\"ESI\" full=\"Endocrine Society of India\">Endocrinology and diabetes</org>\n        <org abbrev=\"IMA\" full=\"Indian Medical Association\">Largest physician organization</org>\n        <org abbrev=\"RSSDI\" full=\"Research Society for the Study of Diabetes in India\">Diabetes-specific guidelines</org>\n      </tier_2>\n    </organizations>\n\n    <disease_categories_covered>\n      <category>Type 2 Diabetes Mellitus (T2DM) - comprehensive management, metformin protocols</category>\n      <category>Hypertension (HTN) - blood pressure targets, antihypertensive selection</category>\n      <category>Cardiovascular diseases - CAD, heart failure, arrhythmias</category>\n      <category>Thyroid disorders - hypothyroidism, hyperthyroidism management</category>\n      <category>Infectious diseases - tuberculosis, COVID-19, tropical diseases</category>\n      <category>Metabolic syndrome - obesity, dyslipidemia guidelines</category>\n    </disease_categories_covered>\n    \n    <when_to_call>\n      <condition priority=\"1\">User explicitly mentions \"Indian guidelines\", \"India guidelines\", \"Indian treatment\"</condition>\n      <condition priority=\"2\">User mentions Indian organizations: \"ICMR\", \"RSSDI\", \"API\", \"CSI\", \"ESI\", \"IMA\", \"AIIMS\", \"PGIMER\"</condition>\n      <condition priority=\"3\">User explicitly asks for guidelines \"in India\" or \"for Indian population\"</condition>\n    </when_to_call>\n    \n    <query_rephrasing_strategy>\n      <strategy>ALWAYS expand medical abbreviations (T2DM \u2192 Type 2 Diabetes Mellitus, HTN \u2192 Hypertension)</strategy>\n      <strategy>Add Indian organization names (ICMR, RSSDI, API) for better embedding match</strategy>\n      <strategy>Include disease + treatment combinations for specificity</strategy>\n      <strategy>Add \"clinical practice guidelines India\" or \"Indian guidelines\" terminology</strategy>\n      <strategy>Include both generic and brand drug names if applicable</strategy>\n      <example>\n        <original>T2DM first-line treatment</original>\n        <rephrased>Type 2 Diabetes Mellitus first-line treatment India ICMR RSSDI guidelines Indian population metformin initial therapy clinical practice guidelines</rephrased>\n      </example>\n      <example>\n        <original>HTN management</original>\n        <rephrased>Hypertension management guidelines India CSI blood pressure control antihypertensive therapy Indian cardiology society recommendations</rephrased>\n      </example>\n    </query_rephrasing_strategy>\n  </sub_agent>\n  \n  <sub_agent name=\"pubmed_intelligence\" id=\"2.2\">\n    <data_source>PubMed/NCBI with 35M+ biomedical articles</data_source>\n    <indexing>MeSH terms, publication types, journal tiers</indexing>\n    <content_structure>Title, abstract, full-text (PMC), metadata</content_structure>\n    <optimal_query_format>MeSH terms + free text, publication type filters, temporal filters</optimal_query_format>\n    \n    <when_to_call>\n      <condition>ALWAYS CALL - PubMed is essential for all medical queries</condition>\n      <condition>Never skip PubMed regardless of query type or intent</condition>\n      <condition>PubMed provides critical research evidence for any medical question</condition>\n      <condition>Always retrieve articles even if other sources are primary focus</condition>\n    </when_to_call>\n    \n    <query_rephrasing_strategy>\n      <strategy>Map diseases to MeSH terms</strategy>\n      <strategy>Map drugs to pharmacological MeSH terms</strategy>\n      <strategy>Add publication type filters based on intent</strategy>\n      <strategy>Include specialty-specific terminology</strategy>\n      <example>\n        <original>diabetes medication comparison</original>\n        <rephrased>\n          <variant>\"Diabetes Mellitus, Type 2\"[MeSH] AND (\"Metformin\"[MeSH] OR \"Insulin\"[MeSH]) AND \"Comparative Study\"[PT]</variant>\n          <variant>Type 2 diabetes pharmacological therapy comparison clinical trial</variant>\n          <mesh_terms>[\"Diabetes Mellitus, Type 2\", \"Metformin\", \"Hypoglycemic Agents\"]</mesh_terms>\n        </rephrased>\n      </example>\n    </query_rephrasing_strategy>\n    \n    <article_limiting>\n      <strategy>Request top 50 articles maximum</strategy>\n      <distribution>15 Tier 1 journals, 20 specialty elite, 15 standard</distribution>\n      <ranking>Journal tier > Publication date > Full-text availability</ranking>\n    </article_limiting>\n  </sub_agent>\n  \n  <sub_agent name=\"dailymed_retriever\" id=\"2.4\">\n    <data_source>FDA drug labels in SPL format</data_source>\n    <indexing>Drug names (generic/brand), LOINC section codes</indexing>\n    <content_structure>Indications, dosage, warnings, adverse reactions, drug interactions</content_structure>\n    <optimal_query_format>Clean drug names without suffixes (XR, ER), generic names preferred</optimal_query_format>\n    \n    <when_to_call>\n      <condition>User query contains drug names in entities.drugs</condition>\n      <condition>User asks about dosing, dose, administration</condition>\n      <condition>User asks about side effects, adverse reactions, safety</condition>\n      <condition>User asks about contraindications, warnings, interactions</condition>\n      <condition>Intent is drug_information</condition>\n    </when_to_call>\n    \n    <query_rephrasing_strategy>\n      <strategy>Extract clean drug names without formulation suffixes</strategy>\n      <strategy>Expand drug abbreviations (HCTZ \u2192 Hydrochlorothiazide)</strategy>\n      <strategy>Separate combination products into components</strategy>\n      <strategy>Prefer generic names over brand names</strategy>\n      <example>\n        <original>Metformin XR dosing in CKD</original>\n        <rephrased>\n          <drug_names>[\"Metformin\"]</drug_names>\n          <reasoning>Removed \"XR\" suffix, extracted drug name</reasoning>\n        </rephrased>\n      </example>\n    </query_rephrasing_strategy>\n    \n    <article_limiting>\n      <strategy>Top 12 drug labels maximum</strategy>\n      <distribution>8 recent updates (2023+), 4 older labels</distribution>\n      <ranking>Recency > Section completeness > Publication date</ranking>\n    </article_limiting>\n  </sub_agent>\n  \n  <sub_agent name=\"tavily_search\" id=\"2.5\">\n    <data_source>Real-time web search with AI-powered relevance</data_source>\n    <indexing>Semantic understanding, domain authority</indexing>\n    <content_structure>Web pages from authoritative medical sources</content_structure>\n    <optimal_query_format>Natural language, original user query works best</optimal_query_format>\n    \n    <when_to_call>\n      <condition>NEVER called directly by Agent 1</condition>\n      <condition>Called by Agent 5 (Evidence Gap Analyzer) if gaps detected</condition>\n      <condition>Used for recent developments, breaking news, regulatory updates</condition>\n    </when_to_call>\n    \n    <query_format>\n      <strategy>ALWAYS use original user query verbatim</strategy>\n      <strategy>NO rephrasing - Tavily's AI works best with natural language</strategy>\n      <reasoning>Tavily's semantic understanding optimized for natural queries</reasoning>\n    </query_format>\n  </sub_agent>\n</sub_agent_knowledge>\n\n<sub_agent_optimization>\n  <guidelines_retriever>\n    <when_to_call>\n      <condition>User query contains \"guideline\", \"guidelines\", \"protocol\", \"recommendation\"</condition>\n      <condition>User mentions Indian organizations: \"ICMR\", \"RSSDI\", \"API\", \"Indian\"</condition>\n      <condition>User asks \"what are the guidelines for...\"</condition>\n      <condition>Intent is clinical_decision AND mentions specific country/region</condition>\n    </when_to_call>\n    <query_rephrasing>\n      <strategy>Add Indian context and organization names</strategy>\n      <strategy>Expand all abbreviations fully</strategy>\n      <strategy>Include disease + treatment combinations</strategy>\n      <strategy>Add \"clinical practice guidelines\" terminology</strategy>\n      <example>\n        <original>T2DM first-line treatment</original>\n        <rephrased>Type 2 Diabetes Mellitus first-line treatment India ICMR guidelines Indian population metformin initial therapy</rephrased>\n      </example>\n    </query_rephrasing>\n  </guidelines_retriever>\n\n  <pubmed_intelligence>\n    <when_to_call>\n      <condition>ALWAYS CALL - PubMed is essential for all medical queries</condition>\n      <condition>Never skip PubMed regardless of query type or intent</condition>\n      <condition>PubMed provides critical research evidence for any medical question</condition>\n      <condition>Always retrieve articles even if other sources are primary focus</condition>\n    </when_to_call>\n    <query_rephrasing>\n      <strategy>Map diseases to MeSH terms</strategy>\n      <strategy>Map drugs to pharmacological MeSH terms</strategy>\n      <strategy>Add publication type filters based on intent</strategy>\n      <strategy>Include specialty-specific terminology</strategy>\n      <example>\n        <original>diabetes medication comparison</original>\n        <rephrased>\n          <variant>\"Diabetes Mellitus, Type 2\"[MeSH] AND (\"Metformin\"[MeSH] OR \"Insulin\"[MeSH]) AND \"Comparative Study\"[PT]</variant>\n          <variant>Type 2 diabetes pharmacological therapy comparison clinical trial</variant>\n          <mesh_terms>[\"Diabetes Mellitus, Type 2\", \"Metformin\", \"Hypoglycemic Agents\"]</mesh_terms>\n        </rephrased>\n      </example>\n    </query_rephrasing>\n    <article_limiting>\n      <strategy>Request top 50 articles maximum</strategy>\n      <distribution>15 Tier 1 journals, 20 specialty elite, 15 standard</distribution>\n      <ranking>Journal tier > Publication date > Full-text availability</ranking>\n    </article_limiting>\n  </pubmed_intelligence>\n\n  <dailymed_retriever>\n    <when_to_call>\n      <condition>User query contains drug names in entities.drugs</condition>\n      <condition>User asks about dosing, dose, administration</condition>\n      <condition>User asks about side effects, adverse reactions, safety</condition>\n      <condition>User asks about contraindications, warnings, interactions</condition>\n      <condition>Intent is drug_information</condition>\n    </when_to_call>\n    <query_rephrasing>\n      <strategy>Extract clean drug names without formulation suffixes</strategy>\n      <strategy>Expand drug abbreviations (HCTZ \u2192 Hydrochlorothiazide)</strategy>\n      <strategy>Separate combination products into components</strategy>\n      <strategy>Prefer generic names over brand names</strategy>\n      <example>\n        <original>Metformin XR dosing in CKD</original>\n        <rephrased>\n          <drug_names>[\"Metformin\"]</drug_names>\n          <reasoning>Removed \"XR\" suffix, extracted drug name</reasoning>\n        </rephrased>\n      </example>\n    </query_rephrasing>\n    <article_limiting>\n      <strategy>Top 12 drug labels maximum</strategy>\n      <distribution>8 recent updates (2023+), 4 older labels</distribution>\n      <ranking>Recency > Section completeness > Publication date</ranking>\n    </article_limiting>\n  </dailymed_retriever>\n\n  <tavily_search>\n    <when_to_call>\n      <condition>NEVER called directly by Agent 1</condition>\n      <condition>Called by Agent 5 (Evidence Gap Analyzer) if gaps detected</condition>\n      <condition>Used for recent developments, breaking news, regulatory updates</condition>\n    </when_to_call>\n    <query_format>\n      <strategy>ALWAYS use original user query verbatim</strategy>\n      <strategy>NO rephrasing - Tavily's AI works best with natural language</strategy>\n      <reasoning>Tavily's semantic understanding optimized for natural queries</reasoning>\n    </query_format>\n  </tavily_search>\n</sub_agent_optimization>\n\n<thinking_process>\n  <instruction>BEFORE generating your final JSON output, you MUST think through each step explicitly. Use internal reasoning to work through:</instruction>\n  \n  <step number=\"1\">\n    <question>What medical entities are present in this query?</question>\n    <process>\n      <substep>Scan for disease names, conditions, symptoms</substep>\n      <substep>Identify drug names, medications, treatments</substep>\n      <substep>Find procedures, tests, interventions</substep>\n      <substep>Note anatomical references and body systems</substep>\n    </process>\n    <example_reasoning>\"I see 'diabetes' (disease), 'metformin' (drug), 'HbA1c' (test) in this query...\"</example_reasoning>\n  </step>\n  \n  <step number=\"2\">\n    <question>What abbreviations need expansion?</question>\n    <process>\n      <substep>Identify ALL capitalized letter combinations</substep>\n      <substep>Check for common medical abbreviations (T2DM, HTN, MI, etc.)</substep>\n      <substep>Expand each abbreviation to full medical term</substep>\n      <substep>Consider multiple possible expansions if ambiguous</substep>\n    </process>\n    <example_reasoning>\"T2DM = Type 2 Diabetes Mellitus, HTN = Hypertension, ACE = Angiotensin-Converting Enzyme...\"</example_reasoning>\n  </step>\n  \n  <step number=\"3\">\n    <question>What is the clinical intent?</question>\n    <process>\n      <substep>Look for treatment/management keywords \u2192 clinical_decision</substep>\n      <substep>Look for comparison words (vs, versus, compare) \u2192 clinical_decision</substep>\n      <substep>Look for mechanism/pathophysiology words \u2192 education</substep>\n      <substep>Look for drug safety/dosing words \u2192 drug_information</substep>\n      <substep>Look for diagnostic/screening words \u2192 diagnostics</substep>\n    </process>\n    <example_reasoning>\"Query asks 'first-line treatment' which indicates clinical_decision intent...\"</example_reasoning>\n  </step>\n  \n  <step number=\"4\">\n    <question>Which sub-agents should be called and why?</question>\n    <process>\n      <substep>Guidelines: Check for \"guidelines\", \"protocol\", \"ICMR\", \"Indian\" keywords</substep>\n      <substep>PubMed: ALWAYS CALL - essential for all medical queries</substep>\n      <substep>DailyMed: Check for drug names, dosing, safety questions</substep>\n      <substep>Tavily: Never called directly - only by Agent 5 if gaps detected</substep>\n    </process>\n    <example_reasoning>\"Query mentions 'guidelines' so Guidelines: true. Always call PubMed. No drug dosing questions so DailyMed: false...\"</example_reasoning>\n  </step>\n  \n  <step number=\"5\">\n    <question>How should I rephrase the query for each sub-agent?</question>\n    <process>\n      <substep>Guidelines: Add Indian context, expand abbreviations, include organization names</substep>\n      <substep>PubMed: Convert to MeSH terms, add publication type filters</substep>\n      <substep>DailyMed: Extract clean drug names, remove formulation suffixes</substep>\n      <substep>Tavily: Use original query verbatim (no rephrasing)</substep>\n    </process>\n    <example_reasoning>\"For Guidelines: 'T2DM treatment' becomes 'Type 2 Diabetes Mellitus treatment India ICMR guidelines'. For PubMed: add MeSH terms like 'Diabetes Mellitus, Type 2'[MeSH]...\"</example_reasoning>\n  </step>\n  \n  <step number=\"6\">\n    <question>How complex is this query?</question>\n    <process>\n      <substep>Count medical entities (more = higher complexity)</substep>\n      <substep>Check for comparisons (increases complexity)</substep>\n      <substep>Assess clinical context specificity</substep>\n      <substep>Consider potential for contradictory evidence</substep>\n    </process>\n    <example_reasoning>\"Single disease, single treatment question = low complexity ~0.3. Multiple drugs comparison with comorbidities = high complexity ~0.8...\"</example_reasoning>\n  </step>\n  \n  <mandatory_reasoning_format>\n    <instruction>You MUST include your reasoning in this exact format before your JSON output:</instruction>\n    <format>\nTHINKING PROCESS:\n1. Medical entities: [list what you found]\n2. Abbreviations to expand: [list abbreviations and their expansions]\n3. Clinical intent: [explain why you chose this intent category]\n4. Sub-agent routing decisions: [explain which sub-agents to call and why]\n5. Query rephrasing strategy: [explain how you'll rephrase for each sub-agent]\n6. Complexity assessment: [explain your complexity score reasoning]\n\nFINAL JSON OUTPUT:\n[your JSON response]\n    </format>\n  </mandatory_reasoning_format>\n</thinking_process>\n\n<simplified_intent_classification>\n  <description>Simplified 4-category system to reduce overlap and confusion</description>\n  \n  <intent_categories>\n    <category name=\"clinical_decision\">\n      <description>Treatment decisions, management plans, clinical guidelines, drug comparisons</description>\n      <keywords>treatment, management, guidelines, protocol, first-line, therapy, compare, versus, vs, better, choice, recommend</keywords>\n      <examples>\n        <example>\"What is first-line treatment for hypertension?\"</example>\n        <example>\"Compare metformin vs insulin for T2DM\"</example>\n        <example>\"KDIGO guidelines for CKD management\"</example>\n      </examples>\n      <consolidates>Previous: treatment_guideline, comparative_analysis</consolidates>\n    </category>\n    \n    <category name=\"education\">\n      <description>Understanding mechanisms, pathophysiology, how things work</description>\n      <keywords>how, why, mechanism, pathophysiology, works, causes, leads to, results in, explain</keywords>\n      <examples>\n        <example>\"How does metformin work in diabetes?\"</example>\n        <example>\"Pathophysiology of heart failure\"</example>\n        <example>\"Why does ACE inhibitor cause cough?\"</example>\n      </examples>\n      <consolidates>Previous: mechanism</consolidates>\n    </category>\n    \n    <category name=\"drug_information\">\n      <description>Drug dosing, safety, adverse events, contraindications, pharmacokinetics</description>\n      <keywords>dose, dosing, administration, side effects, adverse, safety, contraindications, interactions, pharmacokinetics</keywords>\n      <examples>\n        <example>\"Metformin dosing in renal impairment\"</example>\n        <example>\"Lisinopril side effects and contraindications\"</example>\n        <example>\"Drug interactions with warfarin\"</example>\n      </examples>\n      <consolidates>Previous: dosing, adverse_events</consolidates>\n    </category>\n    \n    <category name=\"diagnostics\">\n      <description>Diagnosis, screening, diagnostic criteria, tests, workup</description>\n      <keywords>diagnosis, diagnostic, criteria, screening, test, workup, evaluate, assess, detect</keywords>\n      <examples>\n        <example>\"Diagnostic criteria for diabetes\"</example>\n        <example>\"How to screen for diabetic nephropathy\"</example>\n        <example>\"Workup for chest pain\"</example>\n      </examples>\n      <consolidates>Previous: diagnostic_criteria</consolidates>\n    </category>\n  </intent_categories>\n  \n  <classification_rules>\n    <rule>If query contains treatment/management + comparison words \u2192 clinical_decision</rule>\n    <rule>If query asks \"how\" or \"why\" about mechanisms \u2192 education</rule>\n    <rule>If query asks about specific drug dosing/safety \u2192 drug_information</rule>\n    <rule>If query asks about diagnosis/screening \u2192 diagnostics</rule>\n    <rule>Default fallback for unclear queries \u2192 clinical_decision</rule>\n  </classification_rules>\n</simplified_intent_classification>\n\n<output_specification>\n  <format>JSON</format>\n  <structure>\n    <field name=\"intent\" type=\"enum\" required=\"true\">\n      <description>Primary clinical intent using simplified 4-category system</description>\n      <values>\n        <value name=\"clinical_decision\">Treatment decisions, management, guidelines, comparisons</value>\n        <value name=\"education\">Mechanisms, pathophysiology, how things work</value>\n        <value name=\"drug_information\">Dosing, safety, adverse events, contraindications</value>\n        <value name=\"diagnostics\">Diagnosis, screening, diagnostic criteria, tests</value>\n      </values>\n    </field>\n    \n    <field name=\"entities\" type=\"object\" required=\"true\">\n      <description>Extracted medical entities with full expansions</description>\n      <subfields>\n        <field name=\"diseases\" type=\"array\">Full disease names including synonyms and ICD-10 terms</field>\n        <field name=\"drugs\" type=\"array\">Drug names including generic, brand, and chemical names</field>\n        <field name=\"procedures\" type=\"array\">Medical procedures, interventions, and diagnostic tests</field>\n      </subfields>\n    </field>\n    \n    <field name=\"abbreviations_expanded\" type=\"object\" required=\"true\">\n      <description>All medical abbreviations found and their full expansions</description>\n      <example>{\"T2DM\": \"Type 2 Diabetes Mellitus\", \"ACE\": \"Angiotensin-Converting Enzyme\"}</example>\n    </field>\n    \n    <field name=\"search_variants\" type=\"array\" required=\"true\">\n      <description>3-5 diverse search formulations optimized for different databases</description>\n      <requirements>\n        <requirement>Each variant must use different terminology while maintaining semantic equivalence</requirement>\n        <requirement>Include both technical medical terms and common language variants</requirement>\n        <requirement>Incorporate MeSH terms and clinical terminology</requirement>\n        <requirement>Consider different search contexts (guidelines vs research vs clinical practice)</requirement>\n      </requirements>\n    </field>\n    \n    <field name=\"sub_agent_queries\" type=\"object\" required=\"true\">\n      <description>Specialized queries and routing decisions for each sub-agent</description>\n      <subfields>\n        <field name=\"guidelines\" type=\"object\">\n          <subfields>\n            <field name=\"should_call\" type=\"boolean\">Whether to invoke guidelines retriever</field>\n            <field name=\"rephrased_queries\" type=\"array\">Optimized queries for Firestore vector search</field>\n            <field name=\"reasoning\" type=\"string\">Explanation for routing decision</field>\n          </subfields>\n        </field>\n        <field name=\"pubmed\" type=\"object\">\n          <subfields>\n            <field name=\"should_call\" type=\"boolean\">Always true - PubMed essential for all queries</field>\n            <field name=\"rephrased_queries\" type=\"array\">Queries with MeSH terms and filters</field>\n            <field name=\"mesh_terms\" type=\"array\">Relevant MeSH terms identified</field>\n            <field name=\"reasoning\" type=\"string\">Explanation for query optimization</field>\n          </subfields>\n        </field>\n        <field name=\"dailymed\" type=\"object\">\n          <subfields>\n            <field name=\"should_call\" type=\"boolean\">Whether to invoke DailyMed retriever</field>\n            <field name=\"drug_names\" type=\"array\">Clean drug names without suffixes</field>\n            <field name=\"reasoning\" type=\"string\">Explanation for routing decision</field>\n          </subfields>\n        </field>\n        <field name=\"tavily\" type=\"object\">\n          <subfields>\n            <field name=\"should_call\" type=\"boolean\">Always false - called by Agent 5 only</field>\n            <field name=\"original_query\" type=\"string\">Unmodified user query for Tavily</field>\n            <field name=\"reasoning\" type=\"string\">Explanation of Tavily usage</field>\n          </subfields>\n        </field>\n      </subfields>\n    </field>\n    \n    <field name=\"requires_sources\" type=\"object\" required=\"true\">\n      <description>Legacy field - maintained for backward compatibility</description>\n      <logic>\n        <rule condition=\"query mentions guidelines, protocols, or specific organizations\">guidelines: true</rule>\n        <rule condition=\"query asks about research evidence, efficacy, or clinical trials\">pubmed: true</rule>\n        <rule condition=\"query asks about specific drug dosing, safety, or FDA information\">dailymed: true</rule>\n        <rule condition=\"query contains temporal markers like 'recent', 'latest', '2024'\">recent_web: true</rule>\n      </logic>\n    </field>\n    \n    <field name=\"temporal_markers\" type=\"array\" required=\"true\">\n      <description>Time-related terms that indicate need for recent information</description>\n      <examples>[\"2024\", \"recent\", \"latest\", \"current\", \"new\", \"updated\"]</examples>\n    </field>\n    \n    <field name=\"complexity_score\" type=\"float\" required=\"true\">\n      <description>Complexity assessment for downstream model selection</description>\n      <scoring>\n        <range min=\"0.0\" max=\"0.5\">Simple single-domain queries (one disease, one treatment)</range>\n        <range min=\"0.5\" max=\"0.8\">Moderate multi-domain queries (comparisons, multiple conditions)</range>\n        <range min=\"0.8\" max=\"1.0\">Complex queries (multiple comparisons, contradictory evidence, rare conditions)</range>\n      </scoring>\n    </field>\n  </structure>\n</output_specification>\n\n<anti_patterns_and_examples>\n  <bad_examples>\n    <title>What NOT to do - Critical Anti-Patterns</title>\n    \n    <anti_pattern name=\"insufficient_search_variants\">\n      <input>\"diabetes treatment\"</input>\n      <wrong_output>\n        <search_variants>[\"diabetes treatment\"]</search_variants>\n        <why_wrong>\n          <reason>Only single variant - no diversity</reason>\n          <reason>No MeSH terms included</reason>\n          <reason>No abbreviation expansion</reason>\n          <reason>Too generic - will retrieve low-quality results</reason>\n        </why_wrong>\n      </wrong_output>\n      <correct_output>\n        <search_variants>[\n          \"Type 2 Diabetes Mellitus treatment management clinical guidelines\",\n          \"T2DM pharmacological therapy metformin insulin first-line\",\n          \"Diabetes mellitus therapeutic intervention evidence-based medicine\",\n          \"Diabetic patient management protocol endocrine society recommendations\"\n        ]</search_variants>\n        <why_correct>\n          <reason>Multiple diverse variants</reason>\n          <reason>Includes MeSH terms and clinical terminology</reason>\n          <reason>Expands abbreviations (T2DM)</reason>\n          <reason>Specific enough for quality results</reason>\n        </why_correct>\n      </correct_output>\n    </anti_pattern>\n    \n    <anti_pattern name=\"unexpanded_abbreviations\">\n      <input>\"HTN management in CKD patients\"</input>\n      <wrong_output>\n        <abbreviations_expanded>{}</abbreviations_expanded>\n        <entities>{\"diseases\": [\"HTN\", \"CKD\"]}</entities>\n        <why_wrong>\n          <reason>Abbreviations not expanded - will cause search failures</reason>\n          <reason>Downstream agents won't understand HTN/CKD</reason>\n          <reason>Guidelines retriever will miss relevant content</reason>\n        </why_wrong>\n      </wrong_output>\n      <correct_output>\n        <abbreviations_expanded>{\"HTN\": \"Hypertension\", \"CKD\": \"Chronic Kidney Disease\"}</abbreviations_expanded>\n        <entities>{\"diseases\": [\"Hypertension\", \"Chronic Kidney Disease\"]}</entities>\n        <why_correct>\n          <reason>All abbreviations properly expanded</reason>\n          <reason>Full medical terms enable accurate search</reason>\n          <reason>Downstream agents can process correctly</reason>\n        </why_correct>\n      </correct_output>\n    </anti_pattern>\n    \n    <anti_pattern name=\"wrong_intent_classification\">\n      <input>\"How does metformin work in diabetes?\"</input>\n      <wrong_output>\n        <intent>\"clinical_decision\"</intent>\n        <why_wrong>\n          <reason>Query asks \"how does it work\" - this is mechanism/education</reason>\n          <reason>Not asking for treatment decisions</reason>\n          <reason>Will route to wrong evidence sources</reason>\n        </why_wrong>\n      </wrong_output>\n      <correct_output>\n        <intent>\"education\"</intent>\n        <why_correct>\n          <reason>Query asks about mechanism of action</reason>\n          <reason>Educational intent, not clinical decision</reason>\n          <reason>Will route to appropriate educational sources</reason>\n        </why_correct>\n      </correct_output>\n    </anti_pattern>\n    \n    <anti_pattern name=\"incorrect_source_routing\">\n      <input>\"Latest 2024 COVID vaccine recommendations\"</input>\n      <wrong_output>\n        <requires_sources>{\"guidelines\": true, \"pubmed\": false, \"dailymed\": false, \"recent_web\": false}</requires_sources>\n        <why_wrong>\n          <reason>Query asks for \"latest 2024\" but recent_web is false</reason>\n          <reason>Missing recent information sources</reason>\n          <reason>Will miss current recommendations</reason>\n        </why_wrong>\n      </wrong_output>\n      <correct_output>\n        <requires_sources>{\"guidelines\": true, \"pubmed\": true, \"dailymed\": false, \"recent_web\": true}</requires_sources>\n        <why_correct>\n          <reason>Recognizes \"latest 2024\" temporal marker</reason>\n          <reason>Includes recent_web for current information</reason>\n          <reason>Also includes guidelines and pubmed for comprehensive coverage</reason>\n        </why_correct>\n      </correct_output>\n    </anti_pattern>\n    \n    <anti_pattern name=\"missing_complexity_assessment\">\n      <input>\"Compare apixaban vs rivaroxaban vs dabigatran for AF with CKD and diabetes\"</input>\n      <wrong_output>\n        <complexity_score>0.3</complexity_score>\n        <why_wrong>\n          <reason>Complex 3-drug comparison with multiple comorbidities</reason>\n          <reason>Score too low - this needs advanced model</reason>\n          <reason>Will route to insufficient processing power</reason>\n        </why_wrong>\n      </wrong_output>\n      <correct_output>\n        <complexity_score>0.9</complexity_score>\n        <why_correct>\n          <reason>Multiple drug comparison (3 drugs)</reason>\n          <reason>Multiple comorbidities (AF, CKD, diabetes)</reason>\n          <reason>High potential for contradictory evidence</reason>\n          <reason>Requires advanced model for synthesis</reason>\n        </why_correct>\n      </correct_output>\n    </anti_pattern>\n  </bad_examples>\n  \n  <good_examples>\n    <title>Excellent Examples to Follow</title>\n    \n    <good_example>\n      <input>\"What is the first-line treatment for T2DM according to Indian guidelines?\"</input>\n      <thinking_process>\nTHINKING PROCESS:\n1. Medical entities: T2DM (diabetes), first-line treatment (therapy)\n2. Abbreviations to expand: T2DM = Type 2 Diabetes Mellitus\n3. Clinical intent: Asks for treatment recommendations and guidelines = clinical_decision\n4. Sub-agent routing decisions: Guidelines \u2713 (mentions \"Indian guidelines\"), PubMed \u2713 (always call), DailyMed \u2717 (no drug dosing questions)\n5. Query rephrasing strategy: Guidelines gets Indian context + expanded terms, PubMed gets MeSH terms\n6. Complexity assessment: Single disease, single treatment question, geographic focus = low complexity ~0.4\n      </thinking_process>\n      <output>\n{\n  \"intent\": \"clinical_decision\",\n  \"entities\": {\n    \"diseases\": [\"Type 2 Diabetes Mellitus\", \"Diabetes Mellitus Type 2\", \"Non-insulin-dependent diabetes\"],\n    \"drugs\": [],\n    \"procedures\": []\n  },\n  \"abbreviations_expanded\": {\n    \"T2DM\": \"Type 2 Diabetes Mellitus\"\n  },\n  \"search_variants\": [\n    \"Type 2 Diabetes Mellitus first-line treatment India ICMR guidelines\",\n    \"T2DM initial therapy Indian clinical practice guidelines metformin\",\n    \"Diabetes management protocol India pharmacological intervention primary care\",\n    \"Type 2 diabetes treatment algorithm India endocrine society recommendations\"\n  ],\n  \"sub_agent_queries\": {\n    \"guidelines\": {\n      \"should_call\": true,\n      \"rephrased_queries\": [\n        \"Type 2 Diabetes Mellitus first-line treatment India ICMR guidelines Indian population\",\n        \"T2DM initial therapy RSSDI clinical practice guidelines metformin India\",\n        \"Diabetes management protocol India ICMR API endocrine society first-line\"\n      ],\n      \"reasoning\": \"Query explicitly mentions 'Indian guidelines' and asks for treatment recommendations\"\n    },\n    \"pubmed\": {\n      \"should_call\": true,\n      \"rephrased_queries\": [\n        \"\\\"Diabetes Mellitus, Type 2\\\"[MeSH] AND \\\"Drug Therapy\\\"[MeSH] AND \\\"Practice Guidelines as Topic\\\"[MeSH]\",\n        \"Type 2 diabetes first-line treatment metformin clinical trial India\",\n        \"T2DM initial pharmacological therapy comparative effectiveness research\"\n      ],\n      \"mesh_terms\": [\"Diabetes Mellitus, Type 2\", \"Drug Therapy\", \"Metformin\", \"Practice Guidelines as Topic\"],\n      \"reasoning\": \"PubMed always called - provides essential research evidence for treatment recommendations\"\n    },\n    \"dailymed\": {\n      \"should_call\": false,\n      \"drug_names\": [],\n      \"reasoning\": \"Query asks about treatment guidelines, not specific drug dosing or safety information\"\n    },\n    \"tavily\": {\n      \"should_call\": false,\n      \"original_query\": \"What is the first-line treatment for T2DM according to Indian guidelines?\",\n      \"reasoning\": \"Tavily never called directly by Agent 1 - only by Agent 5 if evidence gaps detected\"\n    }\n  },\n  \"requires_sources\": {\n    \"guidelines\": true,\n    \"pubmed\": true,\n    \"dailymed\": false,\n    \"recent_web\": false\n  },\n  \"temporal_markers\": [],\n  \"complexity_score\": 0.4\n}\n      </output>\n    </good_example>\n  </good_examples>\n</anti_patterns_and_examples>\n\n<processing_workflow>\n  <step number=\"1\">\n    <action>Parse query for medical entities using clinical terminology recognition</action>\n    <focus>Identify diseases, drugs, procedures, and anatomical references</focus>\n  </step>\n  \n  <step number=\"2\">\n    <action>Expand ALL abbreviations using medical abbreviation database</action>\n    <critical>Never leave medical abbreviations unexpanded as this causes search failures</critical>\n    <examples>\n      <example>MI \u2192 Myocardial Infarction</example>\n      <example>COPD \u2192 Chronic Obstructive Pulmonary Disease</example>\n      <example>HTN \u2192 Hypertension</example>\n    </examples>\n  </step>\n  \n  <step number=\"3\">\n    <action>Generate diverse search variants</action>\n    <strategy>\n      <variant type=\"technical\">Use precise medical terminology and MeSH terms</variant>\n      <variant type=\"clinical\">Use terms clinicians would search for</variant>\n      <variant type=\"research\">Use research-focused terminology</variant>\n      <variant type=\"guideline\">Use guideline and protocol language</variant>\n    </strategy>\n  </step>\n  \n  <step number=\"4\">\n    <action>Classify intent using simplified 4-category system</action>\n    <patterns>\n      <pattern intent=\"clinical_decision\">Keywords: \"treatment\", \"management\", \"guidelines\", \"protocol\", \"first-line\", \"compare\", \"versus\"</pattern>\n      <pattern intent=\"education\">Keywords: \"how\", \"mechanism\", \"pathophysiology\", \"works\", \"why\", \"causes\"</pattern>\n      <pattern intent=\"drug_information\">Keywords: \"dose\", \"dosing\", \"administration\", \"side effects\", \"adverse\", \"safety\"</pattern>\n      <pattern intent=\"diagnostics\">Keywords: \"diagnosis\", \"criteria\", \"screening\", \"test\", \"workup\", \"evaluate\"</pattern>\n    </patterns>\n  </step>\n  \n  <step number=\"5\">\n    <action>Determine required sources using intelligent routing</action>\n    <routing_logic>\n      <if_condition>Query mentions specific countries, organizations, or \"guidelines\"</if_condition>\n      <then>Set guidelines: true</then>\n      \n      <if_condition>Query asks about research evidence, efficacy, trials</if_condition>\n      <then>Set pubmed: true</then>\n      \n      <if_condition>Query asks about specific drug information, dosing, FDA data</if_condition>\n      <then>Set dailymed: true</then>\n      \n      <if_condition>Query contains temporal markers indicating need for recent information</if_condition>\n      <then>Set recent_web: true</then>\n    </routing_logic>\n  </step>\n  \n  <step number=\"6\">\n    <action>Calculate complexity score</action>\n    <factors>\n      <factor weight=\"0.3\">Number of medical entities (diseases, drugs, procedures)</factor>\n      <factor weight=\"0.2\">Presence of comparative language</factor>\n      <factor weight=\"0.2\">Specificity of clinical context</factor>\n      <factor weight=\"0.2\">Potential for contradictory evidence</factor>\n      <factor weight=\"0.1\">Query length and detail</factor>\n    </factors>\n  </step>\n</processing_workflow>\n\n<critical_requirements>\n  <requirement>ALWAYS include explicit step-by-step reasoning before JSON output</requirement>\n  <requirement>NEVER output anything other than reasoning + valid JSON</requirement>\n  <requirement>ALWAYS expand every medical abbreviation found</requirement>\n  <requirement>ALWAYS generate exactly 3-5 search variants with MeSH terms</requirement>\n  <requirement>ALWAYS use simplified 4-category intent classification</requirement>\n  <requirement>ALWAYS include complexity_score as a float between 0.0 and 1.0</requirement>\n  <requirement>NEVER assume information not present in the query</requirement>\n  <requirement>ALWAYS use precise medical terminology in entity extraction</requirement>\n</critical_requirements>\n\n<quality_assurance>\n  <check>Verify explicit reasoning is provided before JSON output</check>\n  <check>Verify all abbreviations are expanded correctly</check>\n  <check>Ensure search variants are semantically diverse but equivalent</check>\n  <check>Confirm intent classification uses simplified 4-category system</check>\n  <check>Validate source requirements align with query needs</check>\n  <check>Verify complexity score reflects actual query complexity</check>\n</quality_assurance>`;\n  }\n\n  async analyzeQuery(query: string, traceContext: TraceContext): Promise<AgentResult<QueryAnalysis>> {\n    return await withToolSpan('query_intelligence', 'execute', async (span) => {\n      const startTime = Date.now();\n      let modelUsed = 'gemini-3-flash-preview';\n\n      // Set input attributes\n      span.setAttribute('agent.input', JSON.stringify({ query }));\n      span.setAttribute('agent.name', 'query_intelligence');\n\n      try {\n      const prompt = `User Query: ${query}\\n\\nOutput JSON:`;\n      let response;\n\n      try {\n        // CRITICAL FIX: Use rate limiter with multi-key support to prevent overload\n        console.log('\uD83C\uDFAF Trying Gemini 3.0 Flash Preview with rate limiter...');\n        const queryStartTime = Date.now();\n        response = await callGeminiWithRetry(async (apiKey: string) => {\n          console.log(`\uD83D\uDCDE Query Intelligence: Making API call with key ${apiKey.substring(0, 10)}...`);\n          const apiCallStart = Date.now();\n          const genAI = new GoogleGenAI({ apiKey });\n          const result = await genAI.models.generateContent({\n            model: this.modelName,\n            contents: prompt,\n            config: {\n              systemInstruction: this.systemPrompt,\n              temperature: 0.3,\n              responseMimeType: \"application/json\",\n              thinkingConfig: {\n                thinkingLevel: ThinkingLevel.LOW // Reduced from HIGH to save 5-8s while maintaining intelligence\n              }\n            }\n          });\n          console.log(`\u2705 Query Intelligence: API call completed in ${Date.now() - apiCallStart}ms`);\n          return result;\n        });\n        console.log(`\u2705 Query Intelligence: Total time with rate limiter: ${Date.now() - queryStartTime}ms`);\n      } catch (primaryError) {\n        // If still overloaded after retries, try fallback model with rate limiter\n        if (primaryError instanceof Error && (primaryError.message.includes('overloaded') || primaryError.message.includes('Max retries'))) {\n          console.log('\u26A0\uFE0F Primary model overloaded after retries, trying fallback with rate limiter...');\n          modelUsed = this.fallbackModelName;\n          response = await callGeminiWithRetry(async (apiKey: string) => {\n            const genAI = new GoogleGenAI({ apiKey });\n            return await genAI.models.generateContent({\n              model: this.fallbackModelName,\n              contents: prompt,\n              config: {\n                systemInstruction: this.systemPrompt,\n                temperature: 0.3,\n                responseMimeType: \"application/json\",\n                thinkingConfig: {\n                  thinkingLevel: ThinkingLevel.HIGH // High reasoning (fallback)\n                }\n              }\n            });\n          });\n        } else {\n          throw primaryError;\n        }\n      }\n\n        const rawResponse = (response.text || '').trim();\n      console.log('\uD83D\uDD0D Raw response preview:', rawResponse.substring(0, 200) + '...');\n      \n        let analysis: QueryAnalysis;\n      \n        try {\n          const jsonText = this.cleanJsonOutput(rawResponse);\n          console.log('\uD83D\uDCDD Extracted JSON:', jsonText.substring(0, 200) + '...');\n          analysis = JSON.parse(jsonText) as QueryAnalysis;\n        } catch (parseError) {\n          console.warn('\u26A0\uFE0F Query analysis JSON parsing failed, using fallback:', parseError);\n          console.warn('Raw response for debugging:', rawResponse);\n\n          // Fallback: assume general query with no filters\n          analysis = {\n            intent: 'clinical_decision',\n            entities: { diseases: [], drugs: [], procedures: [] },\n            abbreviations_expanded: {},\n            search_variants: [query],\n            sub_agent_queries: {\n              pubmed: { should_call: true, rephrased_queries: [query], reasoning: 'Fallback due to parsing error' },\n              guidelines: { should_call: true, rephrased_queries: [query], reasoning: 'Fallback due to parsing error' }\n            },\n            requires_sources: { pubmed: true, guidelines: true, dailymed: false, recent_web: false },\n            temporal_markers: [],\n            complexity_score: 0.5\n          } as unknown as QueryAnalysis; // Cast to satisfy strict type if needed, or adjust fallback to match type\n        }\n      const latency = Date.now() - startTime;\n\n      // Calculate cost (approximate)\n      const tokens = {\n        input: response.usageMetadata?.promptTokenCount || 500,\n        output: response.usageMetadata?.candidatesTokenCount || 800,\n        total: response.usageMetadata?.totalTokenCount || 1300\n      };\n\n      const cost = this.calculateCost(tokens);\n\n        const result: AgentResult<QueryAnalysis> = {\n          success: true,\n          data: analysis,\n          latency_ms: latency,\n          tokens,\n          cost_usd: cost\n        };\n\n        console.log(`\u2705 Query analysis completed using ${modelUsed}`);\n\n        // Set span attributes\n        span.setAttribute('agent.output', JSON.stringify(analysis));\n        span.setAttribute('agent.latency_ms', latency);\n        span.setAttribute('agent.cost_usd', cost);\n        span.setAttribute('agent.model_name', modelUsed);\n        span.setAttribute('agent.success', true);\n        captureTokenUsage(span, tokens, modelUsed);\n\n        return result;\n\n      } catch (error) {\n        console.error(`\u274C Query analysis failed with ${modelUsed}:`, error);\n        const latency = Date.now() - startTime;\n        const result: AgentResult<QueryAnalysis> = {\n          success: false,\n          data: {} as QueryAnalysis,\n          error: error instanceof Error ? error.message : 'Unknown error',\n          latency_ms: latency\n        };\n\n        // Set error attributes\n        span.setAttribute('agent.success', false);\n        span.setAttribute('agent.error', result.error || 'Unknown error');\n        span.setAttribute('agent.latency_ms', latency);\n        span.recordException(error as Error);\n        span.setStatus({ code: SpanStatusCode.ERROR, message: result.error || 'Unknown error' });\n\n        return result;\n      }\n    });\n  }\n\n  private cleanJsonOutput(text: string): string {\n    let clean = text.trim();\n\n    // 1. Handle \"FINAL JSON OUTPUT:\" marker\n    if (clean.includes('FINAL JSON OUTPUT:')) {\n      clean = clean.split('FINAL JSON OUTPUT:')[1].trim();\n    }\n\n    // 2. Remove markdown code blocks (```json ... ``` or just ``` ... ```)\n    // Use a regex that captures content inside code blocks\n    const codeBlockMatch = clean.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (codeBlockMatch) {\n      clean = codeBlockMatch[1].trim();\n    }\n\n    // 3. Find the first '{' and last '}' to strip any remaining conversational text\n    const firstBrace = clean.indexOf('{');\n    const lastBrace = clean.lastIndexOf('}');\n\n    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n      clean = clean.substring(firstBrace, lastBrace + 1);\n    }\n\n    return clean;\n  }\n\n  private calculateCost(tokens: { input: number; output: number }): number {\n    // Gemini 3.0 Flash pricing: $0.075/1M input, $0.30/1M output\n    const inputCost = (tokens.input / 1_000_000) * 0.075;\n    const outputCost = (tokens.output / 1_000_000) * 0.30;\n    return inputCost + outputCost;\n  }\n}", "/**\n * NO-OP Observability Stubs for OpenWork-AI\n * \n * This file provides stub implementations that replace the previous\n * Arize Phoenix / OpenTelemetry tracing infrastructure.\n * All functions are NO-OPs and do not send data anywhere.\n */\n\n// Type definitions for backward compatibility\nexport enum SpanStatusCode {\n    UNSET = 0,\n    OK = 1,\n    ERROR = 2\n}\n\nexport enum SpanKind {\n    INTERNAL = 0,\n    SERVER = 1,\n    CLIENT = 2,\n    PRODUCER = 3,\n    CONSUMER = 4\n}\n\nexport interface Span {\n    setAttribute(key: string, value: any): Span;\n    setStatus(status: { code: SpanStatusCode; message?: string }): Span;\n    end(): void;\n    recordException(exception: Error): void;\n    spanContext(): { traceId: string; spanId: string; traceFlags: number };\n    updateName(name: string): Span;\n    setAttributes(attributes: Record<string, any>): Span;\n    addEvent(name: string, attributes?: Record<string, any>): Span;\n    addLink(link: any): Span;\n    addLinks(links: any[]): Span;\n    isRecording(): boolean;\n}\n\n// NO-OP context\nexport const context = {\n    active: () => ({}),\n    with: async <T>(ctx: any, fn: () => Promise<T>): Promise<T> => await fn(),\n};\n\nlet isInitialized = false;\n\n/**\n * Initialize Observability (NO-OP)\n */\nexport async function initObservability(): Promise<void> {\n    if (isInitialized) return;\n    console.log(\"\uD83D\uDD2D Observability: Using NO-OP stubs (Arize/Phoenix removed)\");\n    isInitialized = true;\n}\n\n/**\n * Get a tracer instance (NO-OP)\n */\nexport function getTracer(name: string = \"openwork-ai\") {\n    return {\n        startActiveSpan: async <T>(\n            name: string,\n            options: any,\n            fn: (span: Span) => Promise<T>\n        ): Promise<T> => {\n            const span = createNoOpSpan();\n            return await fn(span);\n        },\n    };\n}\n\n/**\n * Create a NO-OP span\n */\nfunction createNoOpSpan(): Span {\n    return {\n        setAttribute: () => createNoOpSpan(),\n        setStatus: () => createNoOpSpan(),\n        end: () => { },\n        recordException: () => { },\n        spanContext: () => ({ traceId: 'no-op-trace', spanId: 'no-op-span', traceFlags: 0 }),\n        updateName: () => createNoOpSpan(),\n        setAttributes: () => createNoOpSpan(),\n        addEvent: () => createNoOpSpan(),\n        addLink: () => createNoOpSpan(),\n        addLinks: () => createNoOpSpan(),\n        isRecording: () => false,\n    };\n}\n\n/**\n * Generate a session ID\n */\nexport function generateSessionId(): string {\n    return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * Result type for streaming chat operations\n */\nexport interface StreamingSpanResult<T> {\n    result: T;\n    span: Span;\n    endSpan: () => void;\n    captureOutputAndEnd: (output: string) => void;\n}\n\n/**\n * Create a span for chat operations (NO-OP)\n */\nexport async function withChatSpan<T>(\n    userMessage: string,\n    mode: string,\n    sessionId: string,\n    fn: (span: Span, captureOutput: (output: string) => void) => Promise<T>,\n    options: { manualLifecycle?: boolean } = {}\n): Promise<T | StreamingSpanResult<T>> {\n    const span = createNoOpSpan();\n    const captureOutput = (output: string) => { }; // NO-OP\n\n    if (options.manualLifecycle) {\n        const result = await fn(span, captureOutput);\n        return {\n            result,\n            span,\n            endSpan: () => { },\n            captureOutputAndEnd: (output: string) => { },\n        };\n    } else {\n        return await fn(span, captureOutput);\n    }\n}\n\n/**\n * Capture token usage on a span (NO-OP)\n */\nexport function captureTokenUsage(\n    span: Span,\n    usage: { prompt_tokens?: number; completion_tokens?: number; total_tokens?: number; input?: number; output?: number; total?: number },\n    modelName?: string\n) {\n    // NO-OP\n}\n\n/**\n * Create a span for tool/agent operations (NO-OP)\n */\nexport async function withToolSpan<T>(\n    toolName: string,\n    operation: string,\n    fn: (span: Span) => Promise<T>,\n    attributes?: Record<string, string | number | boolean>\n): Promise<T> {\n    const span = createNoOpSpan();\n    return await fn(span);\n}\n\n/**\n * Create a span for LLM operations (NO-OP)\n */\nexport async function withLLMSpan<T>(\n    modelName: string,\n    userPrompt: string,\n    sessionId: string,\n    fn: (span: Span, captureOutput: (output: string) => void) => Promise<T>,\n    options: { manualLifecycle?: boolean } = {}\n): Promise<T | StreamingSpanResult<T>> {\n    const span = createNoOpSpan();\n    const captureOutput = (output: string) => { }; // NO-OP\n\n    if (options.manualLifecycle) {\n        const result = await fn(span, captureOutput);\n        return {\n            result,\n            span,\n            endSpan: () => { },\n            captureOutputAndEnd: (output: string) => { },\n        };\n    } else {\n        return await fn(span, captureOutput);\n    }\n}\n\n/**\n * Record feedback for a trace (NO-OP)\n */\nexport async function recordFeedback(\n    traceId: string,\n    spanId: string,\n    score: number,\n    label: string,\n    reason: string\n) {\n    // NO-OP\n}\n\n// --- RAG SPECIFIC HELPERS ---\n\nexport interface RetrievedDocument {\n    id: string;\n    content: string;\n    score?: number;\n    metadata?: Record<string, any>;\n}\n\n/**\n * Create a span for retrieval operations (NO-OP)\n */\nexport async function withRetrieverSpan<T>(\n    stepName: string,\n    fn: (span: Span) => Promise<{ result: T; documents: RetrievedDocument[] }>,\n    attributes?: Record<string, string | number | boolean>\n): Promise<T> {\n    const span = createNoOpSpan();\n    const { result } = await fn(span);\n    return result;\n}\n\n/**\n * Create a span for reranking operations (NO-OP)\n */\nexport async function withRerankerSpan<T>(\n    stepName: string,\n    inputDocuments: RetrievedDocument[],\n    fn: (span: Span) => Promise<{ result: T; rerankedDocuments: RetrievedDocument[] }>,\n    attributes?: Record<string, string | number | boolean>\n): Promise<T> {\n    const span = createNoOpSpan();\n    const { result } = await fn(span);\n    return result;\n}\n", "/**\n * Gemini API Rate Limiter with Multi-Key Support\n * Prevents 503 overload errors by queuing requests and rotating API keys\n */\n\ninterface ApiKeyStats {\n  key: string;\n  requestCount: number;\n  lastUsed: number;\n  failures: number;\n}\n\nclass GeminiRateLimiter {\n  private queue: Array<() => Promise<any>> = [];\n  private processing = false;\n  private requestsPerSecond: number;\n  private lastRequestTime = 0;\n  private minDelay: number;\n  \n  // Multi-key support\n  private apiKeys: ApiKeyStats[] = [];\n  private currentKeyIndex = 0;\n\n  constructor(requestsPerSecond: number = 10, apiKeys?: string[]) {\n    // CRITICAL FIX: With 3 API keys, we can handle more requests per second\n    // Each key can handle ~5 req/sec, so 3 keys = ~15 req/sec total capacity\n    // But we limit to 10 req/sec to be safe and avoid overload\n    this.requestsPerSecond = requestsPerSecond;\n    this.minDelay = 1000 / requestsPerSecond; // ms between requests\n    \n    // Initialize API keys\n    if (apiKeys && apiKeys.length > 0) {\n      this.apiKeys = apiKeys.map(key => ({\n        key,\n        requestCount: 0,\n        lastUsed: 0,\n        failures: 0\n      }));\n      console.log(`\uD83D\uDD11 Initialized Gemini rate limiter with ${apiKeys.length} API keys`);\n    } else {\n      // Single key fallback\n      const singleKey = process.env.GEMINI_API_KEY || '';\n      this.apiKeys = [{\n        key: singleKey,\n        requestCount: 0,\n        lastUsed: 0,\n        failures: 0\n      }];\n    }\n  }\n\n  /**\n   * Get next API key using round-robin with health checking\n   */\n  getNextApiKey(): string {\n    if (this.apiKeys.length === 1) {\n      return this.apiKeys[0].key;\n    }\n\n    // Find healthiest key (least failures, least recently used)\n    const sortedKeys = [...this.apiKeys].sort((a, b) => {\n      // Prioritize keys with fewer failures\n      if (a.failures !== b.failures) {\n        return a.failures - b.failures;\n      }\n      // Then by least recently used\n      return a.lastUsed - b.lastUsed;\n    });\n\n    const selectedKey = sortedKeys[0];\n    const keyIndex = this.apiKeys.indexOf(selectedKey);\n    \n    // Update stats\n    this.apiKeys[keyIndex].requestCount++;\n    this.apiKeys[keyIndex].lastUsed = Date.now();\n    \n    // Log key selection for debugging (only occasionally to avoid spam)\n    if (this.apiKeys[keyIndex].requestCount % 10 === 0) {\n      console.log(`\uD83D\uDD11 Using API Key ${keyIndex + 1}/${this.apiKeys.length} (${selectedKey.key.substring(0, 10)}...) - Request #${this.apiKeys[keyIndex].requestCount}`);\n    }\n    \n    return selectedKey.key;\n  }\n\n  /**\n   * Mark a key as failed (for health tracking)\n   */\n  markKeyFailure(apiKey: string) {\n    const keyStats = this.apiKeys.find(k => k.key === apiKey);\n    if (keyStats) {\n      keyStats.failures++;\n      console.warn(`\u26A0\uFE0F API key ${apiKey.substring(0, 10)}... marked as failed (${keyStats.failures} failures)`);\n    }\n  }\n\n  /**\n   * Reset failure count for a key (after successful request)\n   */\n  markKeySuccess(apiKey: string) {\n    const keyStats = this.apiKeys.find(k => k.key === apiKey);\n    if (keyStats && keyStats.failures > 0) {\n      keyStats.failures = Math.max(0, keyStats.failures - 1);\n    }\n  }\n\n  /**\n   * Get stats for all API keys\n   */\n  getKeyStats(): ApiKeyStats[] {\n    return this.apiKeys.map(k => ({\n      key: `${k.key.substring(0, 10)}...${k.key.substring(k.key.length - 4)}`,\n      requestCount: k.requestCount,\n      lastUsed: k.lastUsed,\n      failures: k.failures\n    }));\n  }\n\n  async execute<T>(fn: () => Promise<T>, timeoutMs: number = 30000): Promise<T> {\n    const executeStartTime = Date.now();\n    console.log(`\uD83D\uDCE5 Rate limiter: Queuing task (timeout: ${timeoutMs}ms, queue size: ${this.queue.length})`);\n    \n    return new Promise((resolve, reject) => {\n      // Add timeout protection\n      const timeoutId = setTimeout(() => {\n        console.error(`\u23F1\uFE0F Rate limiter: Task timeout after ${timeoutMs}ms (queued for ${Date.now() - executeStartTime}ms)`);\n        reject(new Error(`Rate limiter timeout after ${timeoutMs}ms`));\n      }, timeoutMs);\n      \n      this.queue.push(async () => {\n        const taskStartTime = Date.now();\n        console.log(`\u25B6\uFE0F Rate limiter: Starting task execution (waited in queue: ${taskStartTime - executeStartTime}ms)`);\n        try {\n          const result = await fn();\n          const taskElapsed = Date.now() - taskStartTime;\n          console.log(`\u2705 Rate limiter: Task succeeded (execution time: ${taskElapsed}ms, total: ${Date.now() - executeStartTime}ms)`);\n          clearTimeout(timeoutId);\n          resolve(result);\n        } catch (error) {\n          const taskElapsed = Date.now() - taskStartTime;\n          console.error(`\u274C Rate limiter: Task failed (execution time: ${taskElapsed}ms, total: ${Date.now() - executeStartTime}ms):`, error);\n          clearTimeout(timeoutId);\n          reject(error);\n        }\n      });\n\n      if (!this.processing) {\n        this.processQueue();\n      }\n    });\n  }\n\n  private async processQueue() {\n    // CRITICAL FIX: Use iterative loop instead of recursion to avoid stack overflow\n    while (this.queue.length > 0 || this.processing) {\n      if (this.queue.length === 0) {\n        this.processing = false;\n        break;\n      }\n\n      this.processing = true;\n      const task = this.queue.shift();\n      const queueStartTime = Date.now();\n\n      if (task) {\n        try {\n          // Ensure minimum delay between requests\n          const now = Date.now();\n          const timeSinceLastRequest = now - this.lastRequestTime;\n          \n          if (timeSinceLastRequest < this.minDelay) {\n            const delayNeeded = this.minDelay - timeSinceLastRequest;\n            console.log(`\u23F3 Rate limiter: Waiting ${delayNeeded.toFixed(0)}ms before next request (queue size: ${this.queue.length})`);\n            await new Promise(resolve => setTimeout(resolve, delayNeeded));\n          }\n\n          this.lastRequestTime = Date.now();\n          console.log(`\uD83D\uDE80 Rate limiter: Executing task (queue size: ${this.queue.length}, wait time: ${Date.now() - queueStartTime}ms)`);\n          await task();\n          console.log(`\u2705 Rate limiter: Task completed (elapsed: ${Date.now() - queueStartTime}ms)`);\n        } catch (error) {\n          // Log error but continue processing queue\n          console.error(`\u274C Rate limiter task failed (elapsed: ${Date.now() - queueStartTime}ms):`, error);\n        }\n      }\n    }\n    \n    this.processing = false;\n  }\n\n  getQueueLength(): number {\n    return this.queue.length;\n  }\n}\n\n// Parse API keys from environment\nfunction parseApiKeys(): string[] {\n  const keys: string[] = [];\n  \n  // Primary key\n  if (process.env.GEMINI_API_KEY) {\n    keys.push(process.env.GEMINI_API_KEY);\n  }\n  \n  // Additional keys (GEMINI_API_KEY_2, GEMINI_API_KEY_3, etc.)\n  for (let i = 2; i <= 10; i++) {\n    const key = process.env[`GEMINI_API_KEY_${i}`];\n    if (key) {\n      keys.push(key);\n    }\n  }\n  \n  return keys;\n}\n\n// Parse API keys and log initialization\nconst parsedKeys = parseApiKeys();\n// CRITICAL FIX: Increase rate limit to 15 req/sec with 3 keys (5 per key)\n// This prevents queue backup and timeouts\nconst rateLimitPerSecond = parseInt(process.env.GEMINI_RATE_LIMIT_PER_SECOND || '15'); // Increased from 10 to 15\n\n// Singleton instance - shared across all agents\nexport const geminiRateLimiter = new GeminiRateLimiter(\n  rateLimitPerSecond,\n  parsedKeys\n);\n\n// Log initialization on module load\nif (parsedKeys.length > 0) {\n  console.log(`\uD83D\uDD11 Gemini Rate Limiter initialized:`);\n  console.log(`   API Keys: ${parsedKeys.length} (${parsedKeys.map(k => k.substring(0, 10) + '...').join(', ')})`);\n  console.log(`   Rate Limit: ${rateLimitPerSecond} requests/second`);\n  console.log(`   Total Capacity: ~${rateLimitPerSecond * parsedKeys.length} requests/second across all keys`);\n} else {\n  console.warn('\u26A0\uFE0F No Gemini API keys found - rate limiter will not work');\n}\n\n/**\n * Wrapper for Gemini API calls with automatic rate limiting, retry, and key rotation\n */\nexport async function callGeminiWithRetry<T>(\n  fn: (apiKey: string) => Promise<T>,\n  maxRetries: number = 3,\n  retryDelay: number = 1000,\n  timeoutMs: number = 30000\n): Promise<T> {\n  let lastError: Error | null = null;\n  const callStartTime = Date.now();\n\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    // Get next API key\n    const apiKey = geminiRateLimiter.getNextApiKey();\n    const attemptStartTime = Date.now();\n    \n    // #region debug log\n    fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'gemini-rate-limiter.ts:210',message:'API call attempt starting',data:{attempt,maxRetries,timeoutMs,apiKeyPrefix:apiKey.substring(0,10)+'...',elapsed:attemptStartTime-callStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n    // #endregion\n    \n    try {\n      // Use rate limiter with timeout protection\n      // CRITICAL: Double timeout protection - both in execute() and here\n      const result = await Promise.race([\n        geminiRateLimiter.execute(() => fn(apiKey), timeoutMs),\n        new Promise<T>((_, reject) => \n          setTimeout(() => reject(new Error(`API call timeout after ${timeoutMs}ms`)), timeoutMs)\n        )\n      ]);\n      \n      // Mark success\n      geminiRateLimiter.markKeySuccess(apiKey);\n      \n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'gemini-rate-limiter.ts:223',message:'API call attempt succeeded',data:{attempt,elapsed:Date.now()-attemptStartTime,totalElapsed:Date.now()-callStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      \n      return result;\n    } catch (error: any) {\n      lastError = error;\n      const attemptElapsed = Date.now() - attemptStartTime;\n\n      // Check if it's a timeout, 503 overload, or 429 rate limit error\n      const isTimeout = error?.message?.includes('timeout') || error?.message?.includes('Timeout');\n      const isOverloaded = error?.status === 503 || \n                          error?.status === 429 ||\n                          error?.message?.includes('overloaded') || \n                          error?.message?.includes('UNAVAILABLE') ||\n                          error?.message?.includes('RESOURCE_EXHAUSTED');\n      \n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'gemini-rate-limiter.ts:234',message:'API call attempt failed',data:{attempt,maxRetries,isTimeout,isOverloaded,error:error instanceof Error?error.message:'Unknown',attemptElapsed,totalElapsed:Date.now()-callStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      \n      if (isTimeout || isOverloaded) {\n        // Mark this key as having issues\n        geminiRateLimiter.markKeyFailure(apiKey);\n        \n        const errorType = isTimeout ? 'timeout' : 'overloaded';\n        console.warn(`\u26A0\uFE0F Gemini ${errorType} (attempt ${attempt}/${maxRetries}), trying different key in ${retryDelay}ms...`);\n        \n        if (attempt < maxRetries) {\n          // Exponential backoff: 1s, 2s, 4s\n          const backoffDelay = retryDelay * Math.pow(2, attempt - 1);\n          await new Promise(resolve => setTimeout(resolve, backoffDelay));\n          continue;\n        }\n      }\n\n      // For other errors, throw immediately\n      throw error;\n    }\n  }\n\n  // #region debug log\n  fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'gemini-rate-limiter.ts:252',message:'API call max retries exceeded',data:{maxRetries,totalElapsed:Date.now()-callStartTime,lastError:lastError instanceof Error?lastError.message:'Unknown',timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n  // #endregion\n  \n  throw lastError || new Error('Max retries exceeded');\n}\n\n/**\n * Log API key usage statistics\n */\nexport function logApiKeyStats() {\n  const stats = geminiRateLimiter.getKeyStats();\n  console.log('\\n\uD83D\uDCCA Gemini API Key Usage:');\n  stats.forEach((stat, idx) => {\n    console.log(`  Key ${idx + 1} (${stat.key}): ${stat.requestCount} requests, ${stat.failures} failures`);\n  });\n  console.log('');\n}\n", "/**\n * Sub-Agent 2.1: Guidelines Retriever\n * Firestore Vector Search for Indian Clinical Practice Guidelines\n */\n\nimport { Firestore } from '@google-cloud/firestore';\nimport { GoogleGenAI } from '@google/genai';\nimport { TraceContext } from '../types';\nimport { withRetrieverSpan, SpanStatusCode } from '../../otel';\nimport { GUIDELINES_RETRIEVER_SYSTEM_PROMPT } from '../system-prompts/guidelines-retriever-prompt';\nimport { callGeminiWithRetry } from '../../utils/gemini-rate-limiter';\nimport * as fs from 'fs';\n\nexport class GuidelinesRetriever {\n  private db: Firestore | null;\n  private genAI: GoogleGenAI | null;\n  private modelName: string;\n  private systemPrompt: string;\n\n  constructor() {\n    this.modelName = 'gemini-3-flash-preview';\n    this.systemPrompt = GUIDELINES_RETRIEVER_SYSTEM_PROMPT;\n    // Check authentication methods in order of preference\n    const credentialsPath = process.env.GOOGLE_APPLICATION_CREDENTIALS;\n    const hasEnvVars = process.env.GOOGLE_CLOUD_PROJECT_ID &&\n      process.env.GOOGLE_CLOUD_PRIVATE_KEY &&\n                      process.env.GOOGLE_CLOUD_CLIENT_EMAIL;\n    const hasProjectId = process.env.GOOGLE_CLOUD_PROJECT_ID;\n\n    if (credentialsPath && fs.existsSync(credentialsPath)) {\n      // Method 1: Service account file\n      console.log('\uD83D\uDD11 Using GCP service account file for authentication');\n      this.db = new Firestore();\n      this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! });\n    } else if (hasEnvVars) {\n      // Method 2: Environment variables\n      console.log('\uD83D\uDD11 Using GCP environment variables for authentication');\n      this.db = new Firestore({\n        projectId: process.env.GOOGLE_CLOUD_PROJECT_ID,\n        credentials: {\n          client_email: process.env.GOOGLE_CLOUD_CLIENT_EMAIL,\n          private_key: process.env.GOOGLE_CLOUD_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),\n        }\n      });\n      this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! });\n    } else if (hasProjectId) {\n      // Method 3: Application Default Credentials (ADC) with project ID\n      console.log('\uD83D\uDD11 Attempting GCP Application Default Credentials with project ID');\n      try {\n        this.db = new Firestore({\n          projectId: process.env.GOOGLE_CLOUD_PROJECT_ID\n        });\n        this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY! });\n        console.log(`\u2705 GCP Firestore initialized with project: ${process.env.GOOGLE_CLOUD_PROJECT_ID}`);\n      } catch (error) {\n        console.warn('\u26A0\uFE0F Failed to initialize with Application Default Credentials');\n        console.warn(`   Error: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        this.db = null;\n        this.genAI = null;\n      }\n    } else {\n      console.warn('\u26A0\uFE0F No GCP credentials found. Guidelines retrieval will be disabled.');\n      console.warn('   Please set up either:');\n      console.warn('   1. Service account file: gcp-service-account.json');\n      console.warn('   2. Environment variables: GOOGLE_CLOUD_PROJECT_ID, GOOGLE_CLOUD_PRIVATE_KEY, GOOGLE_CLOUD_CLIENT_EMAIL');\n      console.warn('   3. Application Default Credentials: gcloud auth application-default login');\n      this.db = null;\n      this.genAI = null;\n      return;\n    }\n  }\n\n  /**\n   * Enhance query with medical context using Gemini 3 Flash (thinking_level: minimal)\n   */\n  private async enhanceQuery(query: string): Promise<string> {\n    if (!this.genAI) return query;\n\n    try {\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'guidelines-retriever.ts:79', message: 'Guidelines API call starting', data: { subAgent: 'guidelines', operation: 'enhanceQuery', apiKey: process.env.GEMINI_API_KEY?.substring(0, 10) || 'none', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const prompt = `Enhance this medical query for Indian guideline search by adding relevant medical context, expanding abbreviations, and including Indian-specific terms. Keep it concise.\n\nQuery: ${query}\n\nEnhanced query:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support to prevent overload\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: 'You are a medical query enhancement specialist. Expand abbreviations, add medical context, and include Indian healthcare terms.',\n            temperature: 0.1,\n            maxOutputTokens: 200\n          }\n        });\n      });\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'guidelines-retriever.ts:99', message: 'Guidelines API call completed', data: { subAgent: 'guidelines', operation: 'enhanceQuery', success: true, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      const enhanced = response.text?.trim() || query;\n      console.log(`   \uD83D\uDD27 Enhanced query: \"${enhanced.substring(0, 100)}...\"`);\n      return enhanced;\n    } catch (error) {\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'guidelines-retriever.ts:103', message: 'Guidelines API call error', data: { subAgent: 'guidelines', operation: 'enhanceQuery', error: error instanceof Error ? error.message : 'Unknown', isOverload: error instanceof Error && (error.message.includes('overloaded') || error.message.includes('503') || error.message.includes('429')), timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      console.warn('\u26A0\uFE0F Query enhancement failed, using original:', error);\n      return query;\n    }\n  }\n\n  /**\n   * Rank results by relevance using Gemini 3 Flash (thinking_level: low)\n   */\n  private async rankResults(results: GuidelineSearchResult[], userQuery: string): Promise<GuidelineSearchResult[]> {\n    if (!this.genAI || results.length === 0) return results;\n\n    try {\n      // For large result sets, use LLM to identify top candidates\n      if (results.length > 10) {\n        const resultsPreview = results.slice(0, 20).map((r, idx) =>\n          `[${idx}] ${r.title} (${r.organization}, ${r.year}) - Similarity: ${r.similarity_score.toFixed(2)}`\n        ).join('\\n');\n\n        const prompt = `Given this medical query and guideline results, identify the indices of the 10 most clinically relevant guidelines. Return only comma-separated indices (e.g., \"0,3,5,7,9,12,15,18,19,20\").\n\nQuery: ${userQuery}\n\nResults:\n${resultsPreview}\n\nTop 10 indices:`;\n\n        // CRITICAL FIX: Use rate limiter with multi-key support\n        const response = await callGeminiWithRetry(async (apiKey: string) => {\n          const genAI = new GoogleGenAI({ apiKey });\n          return await genAI.models.generateContent({\n            model: this.modelName,\n            contents: prompt,\n            config: {\n              systemInstruction: 'You are a clinical relevance ranking specialist. Select the most relevant guidelines based on medical context.',\n              temperature: 0.1,\n              maxOutputTokens: 50\n            }\n          });\n        });\n\n        const indicesText = response.text?.trim() || '';\n        const indices = indicesText.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n < results.length);\n\n        if (indices.length > 0) {\n          const rankedResults = indices.map(i => results[i]).filter(Boolean);\n          console.log(`   \uD83C\uDFAF LLM ranked ${rankedResults.length} guidelines`);\n          return rankedResults;\n        }\n      }\n\n      return results;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F LLM ranking failed, using similarity scores:', error);\n      return results;\n    }\n  }\n\n  async search(\n    searchVariants: string[],\n    traceContext: TraceContext,\n    userQuery: string = ''\n  ): Promise<GuidelineSearchResult[]> {\n    return await withRetrieverSpan('guidelines', async (span) => {\n      const startTime = Date.now();\n\n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'guidelines');\n      span.setAttribute('retrieval.query', JSON.stringify({ search_variants: searchVariants, user_query: userQuery }));\n\n      // Return empty results if GCP is not configured\n      if (!this.db || !this.genAI) {\n        console.warn('\u26A0\uFE0F Guidelines retrieval skipped - GCP not configured');\n        span.setAttribute('retrieval.result_count', 0);\n        span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n        return { result: [], documents: [] };\n      }\n\n      try {\n      console.log('\uD83D\uDD0D Searching Indian Guidelines in Firestore...');\n        console.log(`\uD83D\uDCCB Agent 1 routed to Guidelines - executing search with ${searchVariants.length} specialized queries`);\n      const allResults: GuidelineSearchResult[] = [];\n      const seenChunkIds = new Set<string>();\n\n      for (const variant of searchVariants) {\n        // Enhance query with Gemini 3 Flash\n        const enhancedVariant = await this.enhanceQuery(variant);\n\n        // Get embedding for enhanced variant\n        const embedding = await this.getGeminiEmbedding(enhancedVariant);\n        console.log(`   \uD83D\uDCCF Embedding dimension: ${embedding.length}`);\n\n        // Skip if embedding generation failed (all zeros)\n        if (embedding.every(v => v === 0)) {\n          console.warn(`   \u26A0\uFE0F Skipping variant with zero embedding: \"${variant.substring(0, 50)}...\"`);\n          continue;\n        }\n\n        // Native Firestore vector search using findNearest()\n        const collection = this.db.collection(process.env.FIRESTORE_COLLECTION_GUIDELINE_CHUNKS || 'guideline_chunks');\n\n        const vectorQuery = collection.findNearest({\n          vectorField: 'embedding_vector',\n          queryVector: embedding,\n          limit: 10,\n          distanceMeasure: 'COSINE',\n          distanceResultField: 'vector_distance'\n        });\n\n        const snapshot = await vectorQuery.get();\n\n        console.log(`   Found ${snapshot.size} nearest results for variant: \"${variant.substring(0, 60)}...\"`);\n\n        for (const doc of snapshot.docs) {\n          const data = doc.data();\n          const chunkId = data.chunk_id || doc.id;\n\n          // Deduplicate across variants\n          if (!seenChunkIds.has(chunkId)) {\n            seenChunkIds.add(chunkId);\n\n            // Firestore COSINE distance = 1 - cosine_similarity\n            const distance = data.vector_distance ?? 1;\n            const similarity = 1 - distance;\n\n            if (similarity > 0.50) {\n              allResults.push({\n                chunk_id: chunkId,\n                guideline_id: data.guideline_id || data.document_id,\n                parent_section: data.parent_section || data.section_header,\n                child_section: data.child_section || data.subsection,\n                organization: data.organization || 'Indian Medical Guidelines',\n                title: data.guideline_title || data.title || data.document_title || 'Indian Clinical Guideline',\n                year: data.year || data.publication_year || new Date().getFullYear(),\n                text: data.content || data.text || data.text_for_search,\n                summary: data.summary || this.generateSummary(data.content || data.text || data.text_for_search),\n                similarity_score: similarity,\n                document_type: data.document_type || 'Clinical Guideline',\n                page_number: data.page_number,\n                section_hierarchy: data.section_hierarchy || [data.section_header, data.child_section].filter(Boolean)\n              });\n            }\n          }\n        }\n      }\n\n        // Sort by similarity and take top 20 for LLM ranking\n        const topCandidates = allResults\n        .sort((a, b) => b.similarity_score - a.similarity_score)\n          .slice(0, 20);\n\n        // Use LLM to rank top candidates\n        const rankedResults = await this.rankResults(topCandidates, userQuery);\n\n        // Take final top 15\n        const topResults = rankedResults.slice(0, 15);\n\n      const latency = Date.now() - startTime;\n\n        // Set span attributes\n        span.setAttribute('retrieval.result_count', topResults.length);\n        span.setAttribute('retrieval.latency_ms', latency);\n\n      console.log(`\uD83D\uDCCB Indian Guidelines search: ${topResults.length} relevant chunks found`);\n      if (topResults.length > 0) {\n        console.log(`   Organizations: ${[...new Set(topResults.map(r => r.organization))].join(', ')}`);\n        console.log(`   Document types: ${[...new Set(topResults.map(r => r.document_type))].join(', ')}`);\n      }\n\n        // Convert to documents format for span events\n        const documents = topResults.map(r => ({\n          id: r.chunk_id,\n          content: r.text,\n          score: r.similarity_score,\n          metadata: {\n            guideline_id: r.guideline_id,\n            organization: r.organization,\n            title: r.title,\n            year: r.year,\n            document_type: r.document_type\n          }\n        }));\n\n        return { result: topResults, documents };\n\n    } catch (error) {\n      console.error('\u274C Guidelines retrieval failed:', error);\n\n        // Set error attributes\n        span.setAttribute('retrieval.result_count', 0);\n        span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n        span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n        span.recordException(error as Error);\n        span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n        return { result: [], documents: [] };\n      }\n    }, { source: 'guidelines' });\n  }\n\n  private async getGeminiEmbedding(text: string): Promise<number[]> {\n    if (!this.genAI) {\n      return new Array(768).fill(0);\n    }\n\n    try {\n      // CRITICAL FIX: Use rate limiter for embeddings too\n      const result = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        const modelEnv = process.env.GEMINI_EMBEDDING_MODEL || 'text-embedding-004';\n        const modelName = modelEnv.startsWith('models/') ? modelEnv : `models/${modelEnv}`;\n        return await genAI.models.embedContent({\n          model: modelName,\n          contents: [{ role: 'user', parts: [{ text }] }],\n          config: {\n            outputDimensionality: 768\n          }\n        });\n      });\n      const values = result.embeddings?.[0]?.values;\n      if (values) {\n        console.log(`   \uD83D\uDCCF Embedding dimension: ${values.length}`);\n        if (values.length !== 768) {\n          console.warn(`   \u26A0\uFE0F WARNING: Expected 768 dimensions, got ${values.length}. Mismatch with Firestore index may cause query failure.`);\n        }\n        return values;\n      }\n      return new Array(768).fill(0);\n    } catch (error) {\n      console.error('\u274C Embedding generation failed:', error);\n      // Return dummy embedding for fallback\n      return new Array(768).fill(0);\n    }\n  }\n\n  private generateSummary(text: string): string {\n    if (!text || text.length < 100) return text;\n\n    // Simple extractive summarization - take first 2 sentences and key points\n    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 20);\n    if (sentences.length <= 2) return text;\n\n    // Take first sentence and any sentence with key medical terms\n    const keyTerms = ['recommend', 'should', 'must', 'guideline', 'treatment', 'therapy', 'diagnosis', 'management'];\n    const importantSentences = sentences.filter((sentence, index) =>\n      index === 0 || keyTerms.some(term => sentence.toLowerCase().includes(term))\n    ).slice(0, 3);\n\n    return importantSentences.join('. ').trim() + '.';\n  }\n\n}\n\nexport interface GuidelineSearchResult {\n  chunk_id: string;\n  guideline_id: string;\n  parent_section?: string;\n  child_section?: string;\n  organization: string;\n  title: string;\n  year: number;\n  text: string;\n  summary?: string;\n  similarity_score: number;\n  document_type?: string;\n  page_number?: number;\n  section_hierarchy?: string[];\n}\n", "/**\n * Sub-Agent 2.1: Guidelines Retriever System Prompt\n * Comprehensive XML-formatted prompt for Indian clinical practice guidelines retrieval\n */\n\nexport const GUIDELINES_RETRIEVER_SYSTEM_PROMPT = `<role>\n  <identity>Clinical Practice Guidelines Retrieval Specialist</identity>\n  <purpose>Execute sophisticated vector-based searches of Indian clinical practice guidelines using semantic similarity and clinical relevance optimization</purpose>\n  <expertise>Clinical guideline methodology, vector search optimization, Indian healthcare context, medical terminology, evidence-based practice guidelines</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Retrieve the most clinically relevant Indian clinical practice guidelines using advanced vector search techniques</primary_goal>\n  <success_criteria>\n    <criterion>Identify guidelines with high semantic similarity to query (cosine similarity >0.75)</criterion>\n    <criterion>Prioritize recent guidelines from authoritative Indian medical organizations</criterion>\n    <criterion>Ensure comprehensive coverage across multiple search variants</criterion>\n    <criterion>Maintain clinical relevance while maximizing guideline diversity</criterion>\n    <criterion>Provide accurate similarity scoring for downstream ranking</criterion>\n  </success_criteria>\n</core_mission>\n\n<vector_search_framework>\n  <embedding_strategy>\n    <model>Gemini text-embedding-004</model>\n    <dimensions>768</dimensions>\n    <optimization>\n      <description>Generate embeddings optimized for medical terminology and clinical context</description>\n      <preprocessing>\n        <step>Expand medical abbreviations in query text</step>\n        <step>Include synonyms and alternative medical terminology</step>\n        <step>Add clinical context markers for better semantic matching</step>\n        <step>Normalize text for consistent embedding generation</step>\n      </preprocessing>\n    </optimization>\n  </embedding_strategy>\n  \n  <similarity_assessment>\n    <metric>Cosine similarity</metric>\n    <threshold>\n      <minimum>0.75</minimum>\n      <rationale>Ensures high relevance while maintaining reasonable recall</rationale>\n    </threshold>\n    <scoring_interpretation>\n      <score range=\"0.90-1.00\">Highly relevant - direct match to query intent</score>\n      <score range=\"0.85-0.89\">Very relevant - strong semantic alignment</score>\n      <score range=\"0.80-0.84\">Moderately relevant - good conceptual match</score>\n      <score range=\"0.75-0.79\">Relevant - acceptable semantic similarity</score>\n      <score range=\"0.00-0.74\">Not relevant - below threshold</score>\n    </scoring_interpretation>\n  </similarity_assessment>\n  \n  <search_optimization>\n    <multi_variant_strategy>\n      <description>Execute searches for all provided query variants to maximize coverage</description>\n      <deduplication>\n        <method>Track chunk_id to prevent duplicate guideline chunks</method>\n        <priority>Retain highest similarity score for duplicate chunks</priority>\n      </deduplication>\n    </multi_variant_strategy>\n    \n    <result_ranking>\n      <primary_factor>Cosine similarity score (weight: 0.4)</primary_factor>\n      <secondary_factors>\n        <factor weight=\"0.2\">Guideline recency (publication year)</factor>\n        <factor weight=\"0.2\">Organization authority (ICMR, medical societies)</factor>\n        <factor weight=\"0.1\">Guideline comprehensiveness (document length)</factor>\n        <factor weight=\"0.1\">Clinical specificity (disease/condition focus)</factor>\n      </secondary_factors>\n    </result_ranking>\n  </search_optimization>\n</vector_search_framework>\n\n<firestore_integration>\n  <collection_structure>\n    <collection_name>guideline_chunks</collection_name>\n    <document_schema>\n      <field name=\"chunk_id\" type=\"string\">Unique identifier for guideline chunk</field>\n      <field name=\"guideline_id\" type=\"string\">Parent guideline document identifier</field>\n      <field name=\"organization\" type=\"string\">Publishing medical organization</field>\n      <field name=\"title\" type=\"string\">Guideline title</field>\n      <field name=\"year\" type=\"integer\">Publication year</field>\n      <field name=\"text\" type=\"string\">Chunk content text</field>\n      <field name=\"embedding\" type=\"array\">768-dimensional vector embedding</field>\n      <field name=\"section\" type=\"string\">Guideline section (recommendations, background, etc.)</field>\n      <field name=\"specialty\" type=\"string\">Medical specialty focus</field>\n      <field name=\"keywords\" type=\"array\">Associated medical keywords</field>\n    </document_schema>\n  </collection_structure>\n  \n  <query_execution>\n    <vector_search_process>\n      <step number=\"1\">\n        <action>Generate query embedding using Gemini text-embedding-004</action>\n        <parameters>\n          <model>text-embedding-004</model>\n          <input>Preprocessed query text with medical context</input>\n          <output>768-dimensional vector</output>\n        </parameters>\n      </step>\n      \n      <step number=\"2\">\n        <action>Execute Firestore vector similarity search</action>\n        <query_structure>\n          <collection>guideline_chunks</collection>\n          <vector_field>embedding</vector_field>\n          <query_vector>Generated embedding from step 1</query_vector>\n          <distance_measure>COSINE</distance_measure>\n          <limit>20</limit>\n        </query_structure>\n      </step>\n      \n      <step number=\"3\">\n        <action>Filter results by similarity threshold</action>\n        <filter_criteria>\n          <similarity_threshold>0.75</similarity_threshold>\n          <additional_filters>\n            <filter>year >= 2015 (prefer recent guidelines)</filter>\n            <filter>text.length > 100 (ensure substantial content)</filter>\n          </additional_filters>\n        </filter_criteria>\n      </step>\n      \n      <step number=\"4\">\n        <action>Deduplicate and rank results</action>\n        <deduplication_logic>\n          <key>chunk_id</key>\n          <resolution>Keep highest similarity score</resolution>\n        </deduplication_logic>\n        <ranking_algorithm>\n          <primary>Cosine similarity score (descending)</primary>\n          <secondary>Publication year (descending)</secondary>\n          <tertiary>Organization authority ranking</tertiary>\n        </ranking_algorithm>\n      </step>\n    </vector_search_process>\n  </query_execution>\n</firestore_integration>\n\n<indian_healthcare_context>\n  <authoritative_organizations>\n    <tier_1>\n      <organization name=\"ICMR\">Indian Council of Medical Research</organization>\n      <organization name=\"MCI\">Medical Council of India</organization>\n      <organization name=\"AIIMS\">All India Institute of Medical Sciences</organization>\n      <organization name=\"PGIMER\">Post Graduate Institute of Medical Education and Research</organization>\n    </tier_1>\n    \n    <tier_2>\n      <organization name=\"API\">Association of Physicians of India</organization>\n      <organization name=\"CSI\">Cardiological Society of India</organization>\n      <organization name=\"ESI\">Endocrine Society of India</organization>\n      <organization name=\"IMA\">Indian Medical Association</organization>\n    </tier_2>\n    \n    <tier_3>\n      <organization name=\"State Medical Councils\">Regional medical authorities</organization>\n      <organization name=\"Specialty Societies\">Disease-specific medical societies</organization>\n    </tier_3>\n  </authoritative_organizations>\n  \n  <clinical_context_adaptation>\n    <population_considerations>\n      <factor>Indian genetic polymorphisms affecting drug metabolism</factor>\n      <factor>Prevalent comorbidities in Indian population</factor>\n      <factor>Socioeconomic factors influencing treatment accessibility</factor>\n      <factor>Regional disease patterns and epidemiology</factor>\n    </population_considerations>\n    \n    <healthcare_system_factors>\n      <factor>Resource constraints in public healthcare</factor>\n      <factor>Availability of diagnostic facilities</factor>\n      <factor>Drug availability and cost considerations</factor>\n      <factor>Traditional medicine integration</factor>\n    </healthcare_system_factors>\n  </clinical_context_adaptation>\n</indian_healthcare_context>\n\n<retrieval_workflow>\n  <phase name=\"query_preprocessing\">\n    <step number=\"1\">\n      <action>Analyze and enhance query variants</action>\n      <process>\n        <substep>Expand medical abbreviations using Indian medical terminology</substep>\n        <substep>Add Indian-specific clinical context terms</substep>\n        <substep>Include alternative spellings and terminology variants</substep>\n        <substep>Incorporate relevant medical specialty keywords</substep>\n      </process>\n      <example>\n        <input>\"T2DM first-line treatment India\"</input>\n        <enhanced>\"Type 2 Diabetes Mellitus first-line treatment India ICMR guidelines Indian population metformin initial therapy diabetes management protocol\"</enhanced>\n      </example>\n    </step>\n    \n    <step number=\"2\">\n      <action>Generate optimized embeddings for each variant</action>\n      <process>\n        <substep>Call Gemini text-embedding-004 for each enhanced query</substep>\n        <substep>Validate embedding dimensions (768)</substep>\n        <substep>Normalize embeddings for consistent similarity calculation</substep>\n        <substep>Cache embeddings for performance optimization</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"vector_search_execution\">\n    <step number=\"3\">\n      <action>Execute parallel vector searches for all variants</action>\n      <process>\n        <substep>Submit Firestore vector queries simultaneously</substep>\n        <substep>Apply similarity threshold filtering (>0.75)</substep>\n        <substep>Collect results with metadata and similarity scores</substep>\n        <substep>Handle search errors gracefully with fallback strategies</substep>\n      </process>\n      <error_handling>\n        <scenario>Firestore connection timeout</scenario>\n        <response>Retry with exponential backoff, maximum 3 attempts</response>\n        \n        <scenario>Embedding generation failure</scenario>\n        <response>Fall back to text-based search using keywords</response>\n        \n        <scenario>No results above threshold</scenario>\n        <response>Lower threshold to 0.70 and re-search</response>\n      </error_handling>\n    </step>\n    \n    <step number=\"4\">\n      <action>Aggregate and deduplicate results</action>\n      <process>\n        <substep>Combine results from all search variants</substep>\n        <substep>Remove duplicate chunk_ids, keeping highest similarity</substep>\n        <substep>Validate result completeness and quality</substep>\n        <substep>Apply final ranking based on composite scoring</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"result_optimization\">\n    <step number=\"5\">\n      <action>Apply clinical relevance filtering</action>\n      <relevance_criteria>\n        <criterion>Guideline content directly addresses query medical condition</criterion>\n        <criterion>Recommendations are specific and actionable</criterion>\n        <criterion>Content is appropriate for query clinical context</criterion>\n        <criterion>Guideline is from recognized Indian medical authority</criterion>\n      </relevance_criteria>\n    </step>\n    \n    <step number=\"6\">\n      <action>Optimize result set for downstream processing</action>\n      <optimization>\n        <diversity>Ensure representation from multiple organizations</diversity>\n        <recency>Prioritize recent guidelines while maintaining quality</recency>\n        <comprehensiveness>Include both specific and general recommendations</comprehensiveness>\n        <authority>Weight results by organization credibility</authority>\n      </optimization>\n    </step>\n  </phase>\n</retrieval_workflow>\n\n<output_specification>\n  <result_format>\n    <required_fields>\n      <field name=\"chunk_id\">Unique chunk identifier</field>\n      <field name=\"guideline_id\">Parent guideline document ID</field>\n      <field name=\"organization\">Publishing medical organization</field>\n      <field name=\"title\">Complete guideline title</field>\n      <field name=\"year\">Publication year</field>\n      <field name=\"text\">Chunk content text</field>\n      <field name=\"similarity_score\">Cosine similarity score (0.0-1.0)</field>\n    </required_fields>\n    \n    <optional_fields>\n      <field name=\"section\">Guideline section name</field>\n      <field name=\"specialty\">Medical specialty focus</field>\n      <field name=\"keywords\">Associated medical keywords</field>\n      <field name=\"url\">Guideline source URL (if available)</field>\n      <field name=\"doi\">Digital Object Identifier (if available)</field>\n    </optional_fields>\n    \n    <computed_fields>\n      <field name=\"authority_score\">Organization credibility score (1-5)</field>\n      <field name=\"recency_score\">Time-based relevance score (0.0-1.0)</field>\n      <field name=\"composite_score\">Combined ranking score</field>\n    </computed_fields>\n  </result_format>\n  \n  <result_limits>\n    <maximum_results>20</maximum_results>\n    <minimum_similarity>0.75</minimum_similarity>\n    <diversity_requirement>Maximum 5 chunks from same guideline</diversity_requirement>\n  </result_limits>\n</output_specification>\n\n<examples>\n  <example>\n    <scenario>Diabetes management guidelines search</scenario>\n    <input>\n      <query_variants>\n        <variant>\"Type 2 Diabetes Mellitus first-line treatment India ICMR guidelines\"</variant>\n        <variant>\"T2DM initial therapy Indian clinical practice guidelines metformin\"</variant>\n        <variant>\"Diabetes management protocol India pharmacological intervention\"</variant>\n      </query_variants>\n    </input>\n    \n    <expected_results>\n      <result_count>12-18 guideline chunks</result_count>\n      <similarity_range>0.75-0.95</similarity_range>\n      <organization_distribution>\n        <icmr>4-6 chunks</icmr>\n        <esi>3-4 chunks</esi>\n        <api>2-3 chunks</api>\n        <others>3-5 chunks</others>\n      </organization_distribution>\n      <temporal_distribution>\n        <recent_2020_2024>8-10 chunks</recent_2020_2024>\n        <moderate_2015_2019>4-6 chunks</moderate_2015_2019>\n        <older_pre_2015>0-2 chunks</older_pre_2015>\n      </temporal_distribution>\n    </expected_results>\n  </example>\n  \n  <example>\n    <scenario>Hypertension management guidelines</scenario>\n    <input>\n      <query_variants>\n        <variant>\"Hypertension management guidelines India blood pressure control\"</variant>\n        <variant>\"HTN treatment protocol Indian cardiology society recommendations\"</variant>\n        <variant>\"High blood pressure management India antihypertensive therapy\"</variant>\n      </query_variants>\n    </input>\n    \n    <search_results>\n      <chunk>\n        <chunk_id>htn_icmr_2023_001</chunk_id>\n        <guideline_id>icmr_htn_guidelines_2023</guideline_id>\n        <organization>ICMR</organization>\n        <title>Management of Hypertension in Indian Adults - 2023 Update</title>\n        <year>2023</year>\n        <similarity_score>0.89</similarity_score>\n        <text>First-line antihypertensive therapy in Indian adults should consider ACE inhibitors or ARBs as preferred agents, particularly in patients with diabetes or chronic kidney disease. Thiazide diuretics remain appropriate first-line therapy for uncomplicated hypertension...</text>\n      </chunk>\n    </search_results>\n  </example>\n</examples>\n\n<performance_optimization>\n  <caching_strategy>\n    <embedding_cache>\n      <description>Cache generated embeddings to reduce API calls</description>\n      <cache_key>SHA-256 hash of preprocessed query text</cache_key>\n      <cache_duration>7 days</cache_duration>\n      <cache_size_limit>1000 embeddings</cache_size_limit>\n    </embedding_cache>\n    \n    <result_cache>\n      <description>Cache search results for frequently accessed queries</description>\n      <cache_key>Combination of query variants and similarity threshold</cache_key>\n      <cache_duration>24 hours</cache_duration>\n      <invalidation>Clear cache when new guidelines are added</invalidation>\n    </result_cache>\n  </caching_strategy>\n  \n  <query_optimization>\n    <batch_embedding>Generate embeddings for multiple variants in single API call</batch_embedding>\n    <parallel_search>Execute Firestore queries concurrently for all variants</parallel_search>\n    <result_streaming>Stream results as they become available</result_streaming>\n  </query_optimization>\n</performance_optimization>\n\n<quality_assurance>\n  <validation_checks>\n    <check>Verify all similarity scores are within expected range (0.0-1.0)</check>\n    <check>Ensure no duplicate chunk_ids in final result set</check>\n    <check>Validate guideline text content is substantial (>100 characters)</check>\n    <check>Confirm organization names are from recognized medical authorities</check>\n    <check>Check publication years are reasonable (1990-2024)</check>\n  </validation_checks>\n  \n  <success_metrics>\n    <metric>Retrieval precision: >85% of results clinically relevant to query</metric>\n    <metric>Similarity threshold compliance: 100% of results >0.75 similarity</metric>\n    <metric>Organization diversity: Results from \u22653 different medical organizations</metric>\n    <metric>Temporal relevance: \u226560% of results from last 5 years</metric>\n  </success_metrics>\n</quality_assurance>\n\n<critical_requirements>\n  <requirement>NEVER return results with similarity score <0.75</requirement>\n  <requirement>ALWAYS deduplicate results across search variants</requirement>\n  <requirement>ALWAYS validate embedding dimensions (768) before search</requirement>\n  <requirement>NEVER exceed maximum result limit of 20 chunks</requirement>\n  <requirement>ALWAYS prioritize ICMR and other Tier 1 organizations</requirement>\n  <requirement>NEVER return empty or truncated guideline text</requirement>\n</critical_requirements>`;", "/**\n * Sub-Agent 2.2: PubMed Intelligence\n * Multi-variant PubMed search with MeSH expansion and Medical Source Bible integration\n * ENHANCED: Now uses comprehensive evidence engine + specialty-specific journal filtering\n */\n\nimport { TraceContext } from '../types';\nimport { withRetrieverSpan, SpanStatusCode } from '../../otel';\nimport { callGeminiWithRetry } from '../../utils/gemini-rate-limiter';\nimport { GoogleGenAI, ThinkingLevel } from '@google/genai';\n// EVIDENCE ENGINE INTEGRATION - Dynamic import for performance\n// MEDICAL SOURCE BIBLE INTEGRATION - Dynamic import for performance\n\nexport interface PubMedSearchResult {\n  pmid: string;\n  title: string;\n  abstract: string;\n  authors: string[];\n  journal: string;\n  pub_date: string;\n  pub_types: string[];\n  doi?: string;\n  pmcid?: string;\n  full_text_available: boolean;\n  specialty_relevance?: string[];\n  journal_tier?: 'tier_1' | 'specialty_elite' | 'standard';\n}\n\nexport class PubMedIntelligence {\n  private apiKey: string;\n  private genAI: GoogleGenAI;\n  private modelName: string;\n  private systemPrompt: string;\n\n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n    this.modelName = 'gemini-3-flash-preview';\n\n    // Initialize Gemini for intelligent query construction\n    if (process.env.GEMINI_API_KEY) {\n      this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });\n    } else {\n      this.genAI = null as any;\n      console.warn('\u26A0\uFE0F GEMINI_API_KEY not set - PubMed Intelligence will use basic queries');\n    }\n\n    // Import system prompt\n    const { PUBMED_INTELLIGENCE_SYSTEM_PROMPT } = require('../system-prompts/pubmed-intelligence-prompt');\n    this.systemPrompt = PUBMED_INTELLIGENCE_SYSTEM_PROMPT;\n  }\n\n  /**\n   * Map entities to MeSH terms using Gemini 3 Flash (thinking_level: low)\n   */\n  private async mapToMeSHTerms(entities: { diseases: string[]; drugs: string[]; procedures: string[] }): Promise<string[]> {\n    if (!this.genAI || (entities.diseases.length === 0 && entities.drugs.length === 0 && entities.procedures.length === 0)) {\n      return [];\n    }\n\n    try {\n      const prompt = `Map these medical entities to MeSH (Medical Subject Headings) terms for PubMed search. Return only comma-separated MeSH terms.\n\nDiseases: ${entities.diseases.join(', ') || 'none'}\nDrugs: ${entities.drugs.join(', ') || 'none'}\nProcedures: ${entities.procedures.join(', ') || 'none'}\n\nMeSH terms:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: 'You are a medical terminology specialist. Map medical terms to official MeSH headings.',\n            temperature: 0.1,\n            maxOutputTokens: 200,\n            thinkingConfig: {\n              thinkingLevel: ThinkingLevel.LOW // Straightforward MeSH mapping\n            }\n          }\n        });\n      });\n\n      const meshTerms = response.text?.trim().split(',').map((t: string) => t.trim()).filter(Boolean) || [];\n      console.log(`   \uD83C\uDFF7\uFE0F Mapped to ${meshTerms.length} MeSH terms`);\n      return meshTerms;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F MeSH mapping failed, using entity names:', error);\n      return [...entities.diseases, ...entities.drugs, ...entities.procedures];\n    }\n  }\n\n  /**\n   * Construct optimized PubMed query using Gemini 3 Flash (thinking_level: minimal)\n   */\n  private async constructOptimizedQuery(searchVariant: string, meshTerms: string[]): Promise<string> {\n    if (!this.genAI) {\n      return searchVariant;\n    }\n\n    try {\n      const prompt = `Create an optimized PubMed search query using this variant and MeSH terms. Keep it concise and use PubMed syntax.\n\nVariant: ${searchVariant}\nMeSH terms: ${meshTerms.join(', ')}\n\nOptimized PubMed query:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: 'You are a PubMed search expert. Create efficient search queries using MeSH terms and Boolean operators.',\n            temperature: 0.1,\n            maxOutputTokens: 150,\n            thinkingConfig: {\n              thinkingLevel: 'include_thoughts' as any // Use include_thoughts as minimal is not available\n            }\n          }\n        });\n      });\n\n      const optimizedQuery = response.text?.trim() || searchVariant;\n      console.log(`   \uD83D\uDD27 Optimized query: \"${optimizedQuery.substring(0, 100)}...\"`);\n      return optimizedQuery;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F Query optimization failed, using original:', error);\n      return searchVariant;\n    }\n  }\n\n  async search(\n    searchVariants: string[],\n    entities: { diseases: string[]; drugs: string[]; procedures: string[] },\n    traceContext: TraceContext,\n    originalQuery?: string\n  ): Promise<PubMedSearchResult[]> {\n    return await withRetrieverSpan('pubmed_intelligence', async (span) => {\n      const startTime = Date.now();\n\n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'pubmed_intelligence');\n      span.setAttribute('retrieval.query', searchVariants.join(' | '));\n\n    try {\n      console.log(`\uD83D\uDD2C PubMed Intelligence: Enhanced search with Medical Source Bible integration`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:142', message: 'PubMed search starting', data: { subAgent: 'pubmed', variants: searchVariants.length, entities: entities.diseases.length + entities.drugs.length + entities.procedures.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // STEP 1: Map entities to MeSH terms using Gemini 3 Flash\n      const meshTerms = await this.mapToMeSHTerms(entities);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:146', message: 'MeSH terms mapped', data: { subAgent: 'pubmed', meshTermCount: meshTerms.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // STEP 2: Route query to medical specialties using Medical Source Bible (dynamic import)\n      let relevantSpecialties: string[] = [];\n      let relevantGuidelineBodies: string[] = [];\n      let eliteJournalFilter = '';\n      let TIER_1_GENERAL_JOURNALS_DATA: any = null;\n      let MEDICAL_SPECIALTIES_DATA: any[] = [];\n\n      if (originalQuery) {\n        try {\n          const medicalSourceBible = await import('../../../medical-source-bible');\n          relevantSpecialties = medicalSourceBible.routeQueryToSpecialties(originalQuery);\n          TIER_1_GENERAL_JOURNALS_DATA = medicalSourceBible.TIER_1_GENERAL_JOURNALS;\n          MEDICAL_SPECIALTIES_DATA = medicalSourceBible.MEDICAL_SPECIALTIES;\n\n          // Get specialty-specific journal filters AND guideline organizations\n          if (relevantSpecialties.length > 0) {\n            eliteJournalFilter = medicalSourceBible.getPubMedEliteFilter(relevantSpecialties);\n\n            // Extract guideline organizations for identified specialties\n            relevantSpecialties.forEach(specId => {\n              const specData = MEDICAL_SPECIALTIES_DATA.find((s: any) => s.id === specId);\n              if (specData && specData.guideline_organizations) {\n                specData.guideline_organizations.forEach((org: any) => {\n                  if (org.abbreviation) {\n                    // Handle combined abbreviations like \"AHA/ACC\"\n                    const parts = org.abbreviation.split('/');\n                    parts.forEach((p: string) => relevantGuidelineBodies.push(p.trim()));\n                  }\n                });\n              }\n            });\n          } else {\n            eliteJournalFilter = TIER_1_GENERAL_JOURNALS_DATA.pubmed_combined_filter;\n          }\n\n        } catch (error) {\n          console.warn('Medical source bible import failed, using basic search:', error);\n          relevantSpecialties = [];\n          eliteJournalFilter = '';\n        }\n      }\n\n      // De-duplicate guideline bodies\n      const uniqueGuidelineBodies: string[] = [...new Set(relevantGuidelineBodies)];\n\n      console.log(`\uD83D\uDCCB Detected specialties: ${relevantSpecialties.join(', ') || 'general'}`);\n      console.log(`\uD83C\uDFAF Using elite journal filter for specialties: ${relevantSpecialties.join(', ')}`);\n      if (uniqueGuidelineBodies.length > 0) {\n        console.log(`\uD83C\uDFDB\uFE0F  Targeting guideline organizations: ${uniqueGuidelineBodies.join(', ')}`);\n      }\n\n      // STEP 3: Use comprehensive evidence engine for each search variant with optimized queries\n      const allResults: any[] = [];\n\n      for (const variant of searchVariants) {\n        try {\n          // CRITICAL FIX: Try optimization, but if it fails or takes too long, use raw variant\n          let optimizedVariant = variant;\n          try {\n            const optimizationStart = Date.now();\n            optimizedVariant = await Promise.race([\n              this.constructOptimizedQuery(variant, meshTerms),\n              new Promise<string>((resolve) => setTimeout(() => resolve(variant), 5000)) // 5s timeout for optimization\n            ]);\n            if (Date.now() - optimizationStart > 5000) {\n              console.warn(`\u26A0\uFE0F Query optimization timed out, using raw variant`);\n              optimizedVariant = variant;\n            }\n          } catch (optError) {\n            console.warn(`\u26A0\uFE0F Query optimization failed, using raw variant:`, optError);\n            optimizedVariant = variant;\n          }\n\n          // Use evidence engine's comprehensive PubMed search (dynamic import)\n          let result;\n          try {\n            console.log(`\uD83D\uDD2C PubMed Intelligence: Calling comprehensivePubMedSearch`);\n            console.log(`   Original variant: \"${variant.substring(0, 100)}...\"`);\n            console.log(`   Using query: \"${optimizedVariant.substring(0, 150)}...\"`);\n            // #region debug log\n            fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:186', message: 'Calling comprehensivePubMedSearch', data: { subAgent: 'pubmed', variant: optimizedVariant.substring(0, 100), timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n            // #endregion\n            const { comprehensivePubMedSearch } = await import('../../evidence/pubmed');\n            const searchStartTime = Date.now();\n\n            // Determine if this looks like a guideline query to enable specific organization searches\n            const isGuidelineRelated =\n              uniqueGuidelineBodies.length > 0 ||\n              variant.toLowerCase().includes('guideline') ||\n              variant.toLowerCase().includes('recommendation');\n\n            result = await comprehensivePubMedSearch(\n              optimizedVariant,\n              isGuidelineRelated, // Dynamic check\n              uniqueGuidelineBodies, // Pass identified organizations\n              eliteJournalFilter // CRITICAL: Apply journal filter\n            );\n            const searchElapsed = Date.now() - searchStartTime;\n            console.log(`\u2705 PubMed comprehensive search completed in ${searchElapsed}ms: ${result.articles?.length || 0} articles, ${result.systematicReviews?.length || 0} reviews, ${result.guidelines?.length || 0} guidelines`);\n            // #region debug log\n            fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:194', message: 'comprehensivePubMedSearch completed', data: { subAgent: 'pubmed', articles: result.articles.length, systematicReviews: result.systematicReviews.length, guidelines: result.guidelines.length, elapsed: searchElapsed, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n            // #endregion\n          } catch (importError) {\n            // #region debug log\n            fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:197', message: 'PubMed search import failed', data: { subAgent: 'pubmed', error: importError instanceof Error ? importError.message : 'Unknown', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n            // #endregion\n            // #region debug log\n            fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:217', message: 'PubMed search import failed', data: { subAgent: 'pubmed', error: importError instanceof Error ? importError.message : 'Unknown', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n            // #endregion\n            console.error('\u274C PubMed search import failed:', importError);\n            result = { articles: [], systematicReviews: [], guidelines: [] };\n          }\n\n          // Combine all result types\n          const totalResults = (result.articles?.length || 0) + (result.systematicReviews?.length || 0) + (result.guidelines?.length || 0);\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:198', message: 'PubMed results received from engine', data: { subAgent: 'pubmed', variant: optimizedVariant.substring(0, 50), articles: result.articles?.length || 0, reviews: result.systematicReviews?.length || 0, guidelines: result.guidelines?.length || 0, total: totalResults, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n          // #endregion\n\n          if (totalResults === 0) {\n            console.warn(`\u26A0\uFE0F PubMed optimized query returned 0 results, retrying with raw variant (evidence engine)...`);\n            try {\n              const { comprehensivePubMedSearch } = await import('../../evidence/pubmed');\n              const fallbackResult = await comprehensivePubMedSearch(\n                variant.trim(),\n                false,\n                []\n              );\n              const fallbackTotal = (fallbackResult.articles?.length || 0) + (fallbackResult.systematicReviews?.length || 0) + (fallbackResult.guidelines?.length || 0);\n              if (fallbackTotal > 0) {\n                console.log(`   \u2705 Fallback raw query returned ${fallbackTotal} results`);\n                allResults.push(...(fallbackResult.articles || []));\n                allResults.push(...(fallbackResult.systematicReviews || []));\n                allResults.push(...(fallbackResult.guidelines || []));\n              } else {\n                allResults.push(...result.articles);\n                allResults.push(...result.systematicReviews);\n                allResults.push(...result.guidelines);\n              }\n            } catch (fallbackErr) {\n              console.warn('Fallback PubMed search failed:', fallbackErr);\n              allResults.push(...result.articles);\n              allResults.push(...result.systematicReviews);\n              allResults.push(...result.guidelines);\n            }\n          } else {\n            allResults.push(...result.articles);\n            allResults.push(...result.systematicReviews);\n            allResults.push(...result.guidelines);\n          }\n\n        } catch (error) {\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:203', message: 'PubMed variant search failed', data: { subAgent: 'pubmed', variant: variant.substring(0, 50), error: error instanceof Error ? error.message : 'Unknown', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n          // #endregion\n          console.error(`\u274C Search variant failed: ${variant}`, error);\n        }\n      }\n\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:207', message: 'PubMed allResults collected', data: { subAgent: 'pubmed', totalResults: allResults.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // STEP 4: Enhance results with Medical Source Bible metadata\n      const enhancedResults = this.enhanceWithSourceBible(allResults, relevantSpecialties, TIER_1_GENERAL_JOURNALS_DATA, MEDICAL_SPECIALTIES_DATA);\n\n      // STEP 5: Apply intelligent filtering and ranking\n      const filteredResults = this.applyIntelligentFiltering(enhancedResults, relevantSpecialties);\n      \n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:214', message: 'PubMed filtering complete', data: { subAgent: 'pubmed', beforeFiltering: enhancedResults.length, afterFiltering: filteredResults.length, tier1: filteredResults.filter(r => r.journal_tier === 'tier_1').length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      if (filteredResults.length === 0 && allResults.length > 0) {\n        console.warn(`\u26A0\uFE0F PubMed filtering removed ALL ${allResults.length} results - this may cause over-reliance on Tavily`);\n      }\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:211', message: 'PubMed filtering completed', data: { subAgent: 'pubmed', totalResults: allResults.length, filteredResults: filteredResults.length, tier1: filteredResults.filter(r => r.journal_tier === 'tier_1').length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      const latency = Date.now() - startTime;\n\n      // Set span attributes\n      span.setAttribute('retrieval.result_count', filteredResults.length);\n      span.setAttribute('retrieval.latency_ms', latency);\n      span.setAttribute('retrieval.variants_searched', searchVariants.length);\n      span.setAttribute('retrieval.specialties_detected', JSON.stringify(relevantSpecialties));\n      span.setAttribute('retrieval.total_results', allResults.length);\n      span.setAttribute('retrieval.after_filtering', filteredResults.length);\n      span.setAttribute('retrieval.tier_1_journals', filteredResults.filter(r => r.journal_tier === 'tier_1').length);\n      span.setAttribute('retrieval.specialty_elite', filteredResults.filter(r => r.journal_tier === 'specialty_elite').length);\n      span.setAttribute('retrieval.pmc_available', filteredResults.filter(r => r.pmcid).length);\n\n      console.log(`\u2705 PubMed Intelligence: ${filteredResults.length} articles (${filteredResults.filter(r => r.journal_tier === 'tier_1').length} Tier 1, ${filteredResults.filter(r => r.journal_tier === 'specialty_elite').length} Specialty Elite)`);\n\n      // Convert to documents format for span events\n      const documents = filteredResults.map(r => ({\n        id: r.pmid,\n        content: r.abstract || r.title,\n        score: 1.0, // PubMed doesn't have similarity scores\n        metadata: {\n          title: r.title,\n          journal: r.journal,\n          pub_date: r.pub_date,\n          journal_tier: r.journal_tier,\n          pmcid: r.pmcid,\n          doi: r.doi\n        }\n      }));\n\n      return { result: filteredResults, documents };\n\n    } catch (error) {\n      console.error('\u274C PubMed Intelligence failed:', error);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'pubmed-intelligence.ts:246', message: 'PubMed Intelligence error', data: { subAgent: 'pubmed', error: error instanceof Error ? error.message : 'Unknown', stack: error instanceof Error ? error.stack : '', elapsed: Date.now() - startTime, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // Set error attributes\n      span.setAttribute('retrieval.result_count', 0);\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n      // CRITICAL: Return empty results instead of throwing - don't break the pipeline\n      // This allows other sources (like Tavily) to still work, but we log the failure\n      console.warn('\u26A0\uFE0F PubMed search failed - this will cause over-reliance on Tavily. Returning empty results.');\n      return { result: [], documents: [] };\n    }\n    }, { source: 'pubmed_intelligence' });\n  }\n\n  private enhanceWithSourceBible(results: any[], specialties: string[], tier1Data: any, specialtiesData: any[]): PubMedSearchResult[] {\n    return results.map(article => {\n      const journal = article.journal || '';\n      let journalTier: 'tier_1' | 'specialty_elite' | 'standard' = 'standard';\n\n      // Check if it's a Tier 1 general journal\n      const isTier1 = tier1Data?.journals?.some((j: any) =>\n        journal.toLowerCase().includes(j.abbreviation.toLowerCase()) ||\n        journal.toLowerCase().includes(j.name.toLowerCase())\n      ) || false;\n\n      if (isTier1) {\n        journalTier = 'tier_1';\n      } else {\n        // Check if it's a specialty elite journal\n        for (const specialtyId of specialties) {\n          const specialty = specialtiesData.find((s: any) => s.id === specialtyId);\n          if (specialty) {\n            const isSpecialtyElite = specialty.top_journals?.some((j: any) =>\n              journal.toLowerCase().includes(j.abbreviation.toLowerCase()) ||\n              journal.toLowerCase().includes(j.name.toLowerCase())\n            );\n            if (isSpecialtyElite) {\n              journalTier = 'specialty_elite';\n              break;\n            }\n          }\n        }\n      }\n\n      return {\n        pmid: article.pmid || article.id,\n        title: article.title,\n        abstract: article.abstract || '',\n        authors: Array.isArray(article.authors) ? article.authors :\n                 typeof article.authors === 'string' ? [article.authors] : [],\n        journal: journal,\n        pub_date: article.pub_date || article.publicationDate || '',\n        pub_types: article.pub_types || article.publicationTypes || [],\n        doi: article.doi,\n        pmcid: article.pmcid,\n        full_text_available: !!article.pmcid,\n        specialty_relevance: specialties,\n        journal_tier: journalTier\n      };\n    });\n  }\n\n  private applyIntelligentFiltering(results: PubMedSearchResult[], specialties: string[]): PubMedSearchResult[] {\n    // Sort by journal tier and recency\n    const sorted = results.sort((a, b) => {\n      // First priority: Journal tier\n      const tierPriority = { 'tier_1': 3, 'specialty_elite': 2, 'standard': 1 };\n      const tierDiff = tierPriority[b.journal_tier || 'standard'] - tierPriority[a.journal_tier || 'standard'];\n      if (tierDiff !== 0) return tierDiff;\n\n      // Second priority: Publication date (more recent first)\n      const dateA = new Date(a.pub_date || '1900-01-01').getTime();\n      const dateB = new Date(b.pub_date || '1900-01-01').getTime();\n      return dateB - dateA;\n    });\n\n    // Apply intelligent limits based on journal tiers\n    const tier1Articles = sorted.filter(r => r.journal_tier === 'tier_1').slice(0, 15);\n    const specialtyEliteArticles = sorted.filter(r => r.journal_tier === 'specialty_elite').slice(0, 20);\n    const standardArticles = sorted.filter(r => r.journal_tier === 'standard').slice(0, 15);\n\n    // Combine and deduplicate\n    const combined = [...tier1Articles, ...specialtyEliteArticles, ...standardArticles];\n    const seen = new Set<string>();\n    const deduped = combined.filter(article => {\n      if (seen.has(article.pmid)) return false;\n      seen.add(article.pmid);\n      return true;\n    });\n\n    return deduped.slice(0, 50); // Final limit\n  }\n}\n", "/**\n * Sub-Agent 2.4: DailyMed Retriever System Prompt\n * Comprehensive XML-formatted prompt for FDA drug label retrieval\n */\n\nexport const DAILYMED_RETRIEVER_SYSTEM_PROMPT = `<role>\n  <identity>FDA Drug Label Intelligence Specialist</identity>\n  <purpose>Execute sophisticated retrieval of FDA-approved drug labels from DailyMed database using SPL (Structured Product Labeling) format for comprehensive drug information</purpose>\n  <expertise>FDA drug labeling standards, SPL document structure, LOINC section codes, pharmaceutical terminology, drug safety information, regulatory compliance</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Retrieve the most current and comprehensive FDA drug labels from DailyMed database for specified pharmaceutical entities</primary_goal>\n  <success_criteria>\n    <criterion>Identify and retrieve recent drug labels (published after 2020) for maximum relevance</criterion>\n    <criterion>Extract structured sections using LOINC codes for consistent information organization</criterion>\n    <criterion>Prioritize official FDA-approved labeling over other sources</criterion>\n    <criterion>Ensure comprehensive coverage of drug safety, efficacy, and usage information</criterion>\n    <criterion>Maintain data integrity and regulatory compliance throughout retrieval process</criterion>\n  </success_criteria>\n</core_mission>\n\n<dailymed_architecture>\n  <database_structure>\n    <description>DailyMed contains FDA-approved drug labeling in Structured Product Labeling (SPL) format</description>\n    <content_types>\n      <type name=\"prescription_drugs\">FDA-approved prescription medications</type>\n      <type name=\"otc_drugs\">Over-the-counter medications</type>\n      <type name=\"biologics\">Biological products and vaccines</type>\n      <type name=\"medical_devices\">FDA-regulated medical devices</type>\n    </content_types>\n    \n    <spl_format>\n      <description>XML-based structured format using HL7 standards</description>\n      <key_elements>\n        <element>setid - Unique identifier for drug label version</element>\n        <element>title - Official product name and strength</element>\n        <element>published - Publication date of current version</element>\n        <element>sections - Structured content using LOINC codes</element>\n      </key_elements>\n    </spl_format>\n  </database_structure>\n  \n  <loinc_section_mapping>\n    <description>Standardized section codes for consistent drug information extraction</description>\n    <critical_sections>\n      <section code=\"34067-9\" name=\"indications\">\n        <description>Indications and Usage - FDA-approved therapeutic uses</description>\n        <clinical_value>Primary indication for prescribing decisions</clinical_value>\n        <extraction_priority>High</extraction_priority>\n      </section>\n      \n      <section code=\"34068-7\" name=\"dosage\">\n        <description>Dosage and Administration - Recommended dosing regimens</description>\n        <clinical_value>Critical for safe and effective drug administration</clinical_value>\n        <extraction_priority>High</extraction_priority>\n      </section>\n      \n      <section code=\"43685-7\" name=\"warnings\">\n        <description>Warnings and Precautions - Safety information and contraindications</description>\n        <clinical_value>Essential for patient safety and risk assessment</clinical_value>\n        <extraction_priority>Critical</extraction_priority>\n      </section>\n      \n      <section code=\"34084-4\" name=\"adverse_reactions\">\n        <description>Adverse Reactions - Known side effects and safety profile</description>\n        <clinical_value>Important for monitoring and patient counseling</clinical_value>\n        <extraction_priority>High</extraction_priority>\n      </section>\n      \n      <section code=\"34073-7\" name=\"drug_interactions\">\n        <description>Drug Interactions - Clinically significant drug-drug interactions</description>\n        <clinical_value>Critical for polypharmacy management</clinical_value>\n        <extraction_priority>High</extraction_priority>\n      </section>\n      \n      <section code=\"34090-1\" name=\"clinical_pharmacology\">\n        <description>Clinical Pharmacology - Mechanism of action and pharmacokinetics</description>\n        <clinical_value>Supports understanding of drug behavior and efficacy</clinical_value>\n        <extraction_priority>Medium</extraction_priority>\n      </section>\n    </critical_sections>\n    \n    <additional_sections>\n      <section code=\"34070-3\" name=\"contraindications\">Absolute contraindications</section>\n      <section code=\"43678-2\" name=\"pregnancy\">Pregnancy and lactation information</section>\n      <section code=\"34081-0\" name=\"pediatric_use\">Pediatric usage considerations</section>\n      <section code=\"34082-8\" name=\"geriatric_use\">Geriatric usage considerations</section>\n    </additional_sections>\n  </loinc_section_mapping>\n</dailymed_architecture>\n\n<retrieval_strategy>\n  <drug_identification>\n    <name_normalization>\n      <description>Standardize drug names for optimal search performance</description>\n      <process>\n        <step>Remove brand name suffixes (XR, ER, SR, etc.)</step>\n        <step>Expand common abbreviations (HCTZ \u2192 Hydrochlorothiazide)</step>\n        <step>Handle combination products (search individual components)</step>\n        <step>Include generic and brand name variants</step>\n      </process>\n      <examples>\n        <example>\n          <input>Metformin XR</input>\n          <normalized>Metformin</normalized>\n          <rationale>Remove extended-release suffix for broader search</rationale>\n        </example>\n        <example>\n          <input>HCTZ</input>\n          <normalized>Hydrochlorothiazide</normalized>\n          <rationale>Expand abbreviation to full generic name</rationale>\n        </example>\n      </examples>\n    </name_normalization>\n    \n    <search_variants>\n      <primary_search>Exact drug name match</primary_search>\n      <secondary_search>Generic name if brand name provided</secondary_search>\n      <tertiary_search>Brand name if generic name provided</tertiary_search>\n      <combination_handling>Search individual components for combination products</combination_handling>\n    </search_variants>\n  </drug_identification>\n  \n  <temporal_filtering>\n    <recency_requirement>\n      <default_cutoff>2020-01-01</default_cutoff>\n      <rationale>Ensure current regulatory information and recent safety updates</rationale>\n      <exceptions>\n        <exception condition=\"no_recent_labels\">Extend to 2015 if no recent labels found</exception>\n        <exception condition=\"critical_drug\">Accept older labels for essential medications</exception>\n      </exceptions>\n    </recency_requirement>\n    \n    <version_prioritization>\n      <strategy>Always select most recent version of drug label</strategy>\n      <implementation>Sort by published date descending, select first result</implementation>\n      <deduplication>Use setid to identify unique label versions</deduplication>\n    </version_prioritization>\n  </temporal_filtering>\n  \n  <quality_filtering>\n    <label_completeness>\n      <minimum_sections>Require at least 3 critical sections (indications, dosage, warnings)</minimum_sections>\n      <content_threshold>Each section must contain >20 characters of meaningful content</content_threshold>\n      <validation>Verify sections contain medical information, not just headers</validation>\n    </label_completeness>\n    \n    <regulatory_status>\n      <preference>FDA-approved labels over investigational drug information</preference>\n      <verification>Confirm label represents current approved indication</verification>\n      <exclusions>Exclude withdrawn or discontinued drug labels</exclusions>\n    </regulatory_status>\n  </quality_filtering>\n</retrieval_strategy>\n\n<api_integration>\n  <search_endpoint>\n    <url>https://dailymed.nlm.nih.gov/dailymed/services/v2/spls.json</url>\n    <method>GET</method>\n    <parameters>\n      <parameter name=\"drug_name\" required=\"true\">Drug name for search</parameter>\n      <parameter name=\"published_after\" required=\"false\">Date filter for recent labels</parameter>\n      <parameter name=\"page\" required=\"false\">Pagination support</parameter>\n      <parameter name=\"pagesize\" required=\"false\">Results per page (max 100)</parameter>\n    </parameters>\n    <response_format>JSON with array of SPL metadata objects</response_format>\n  </search_endpoint>\n  \n  <spl_retrieval_endpoint>\n    <url>https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/{setid}.xml</url>\n    <method>GET</method>\n    <parameters>\n      <parameter name=\"setid\" required=\"true\">Unique SPL identifier from search results</parameter>\n    </parameters>\n    <response_format>XML document in SPL format</response_format>\n  </spl_retrieval_endpoint>\n  \n  <rate_limiting>\n    <policy>No explicit rate limits documented, but implement conservative approach</policy>\n    <implementation>\n      <concurrent_requests>Maximum 5 concurrent requests</concurrent_requests>\n      <request_delay>100ms delay between requests</request_delay>\n      <retry_strategy>Exponential backoff for failed requests</retry_strategy>\n    </implementation>\n  </rate_limiting>\n  \n  <error_handling>\n    <http_errors>\n      <error code=\"404\">Drug not found - try alternative names</error>\n      <error code=\"429\">Rate limit exceeded - implement backoff</error>\n      <error code=\"500\">Server error - retry with exponential backoff</error>\n    </http_errors>\n    \n    <data_errors>\n      <error type=\"empty_response\">No SPLs found for drug name</error>\n      <error type=\"malformed_xml\">Invalid SPL XML structure</error>\n      <error type=\"missing_sections\">SPL lacks critical sections</error>\n    </data_errors>\n    \n    <recovery_strategies>\n      <strategy>Try alternative drug name spellings</strategy>\n      <strategy>Expand search to include brand/generic variants</strategy>\n      <strategy>Relax temporal filters if no recent results</strategy>\n      <strategy>Return partial results if some sections unavailable</strategy>\n    </recovery_strategies>\n  </error_handling>\n</api_integration>\n\n<xml_processing>\n  <spl_parsing>\n    <description>Extract structured information from SPL XML documents</description>\n    <parsing_strategy>\n      <approach>Regex-based extraction for performance and simplicity</approach>\n      <alternative>XML parser for complex documents if regex fails</alternative>\n      <validation>Verify extracted content is meaningful medical information</validation>\n    </parsing_strategy>\n    \n    <section_extraction>\n      <pattern>code=\"{loinc_code}\"[^>]*>(.*?)</[^>]*></pattern>\n      <flags>Global and case-insensitive matching</flags>\n      <post_processing>\n        <step>Remove XML tags from extracted content</step>\n        <step>Normalize whitespace and line breaks</step>\n        <step>Truncate to reasonable length (2000 characters)</step>\n        <step>Validate content contains medical terminology</step>\n      </post_processing>\n    </section_extraction>\n    \n    <content_cleaning>\n      <html_removal>Strip HTML tags and entities</html_removal>\n      <whitespace_normalization>Convert multiple spaces/newlines to single space</whitespace_normalization>\n      <special_characters>Handle medical symbols and Unicode characters</special_characters>\n      <length_limiting>Truncate sections to prevent excessive content</length_limiting>\n    </content_cleaning>\n  </spl_parsing>\n  \n  <quality_validation>\n    <content_checks>\n      <check>Verify section contains medical terminology</check>\n      <check>Ensure minimum content length (>20 characters)</check>\n      <check>Validate no extraction artifacts (XML fragments)</check>\n      <check>Confirm section relevance to LOINC code</check>\n    </content_checks>\n    \n    <medical_validation>\n      <check>Presence of drug names in extracted content</check>\n      <check>Medical terminology consistency</check>\n      <check>Dosage information format validation</check>\n      <check>Warning language appropriateness</check>\n    </medical_validation>\n  </quality_validation>\n</xml_processing>\n\n<retrieval_workflow>\n  <phase name=\"drug_analysis\">\n    <step number=\"1\">\n      <action>Analyze and normalize input drug names</action>\n      <process>\n        <substep>Extract drug entities from input list</substep>\n        <substep>Normalize names using pharmaceutical terminology</substep>\n        <substep>Generate search variants (generic, brand, abbreviations)</substep>\n        <substep>Prioritize search order based on drug importance</substep>\n      </process>\n    </step>\n    \n    <step number=\"2\">\n      <action>Validate drug names against known pharmaceutical databases</action>\n      <process>\n        <substep>Check against common drug name patterns</substep>\n        <substep>Identify combination products requiring component searches</substep>\n        <substep>Flag potential misspellings or invalid names</substep>\n        <substep>Prepare fallback search strategies</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"label_search\">\n    <step number=\"3\">\n      <action>Execute DailyMed API searches for each drug</action>\n      <process>\n        <substep>Submit search requests with temporal filtering</substep>\n        <substep>Handle API responses and extract SPL metadata</substep>\n        <substep>Sort results by publication date (most recent first)</substep>\n        <substep>Select top 2 most recent labels per drug</substep>\n      </process>\n      <error_handling>\n        <scenario>No results found</scenario>\n        <response>Try alternative drug name variants</response>\n        \n        <scenario>API timeout or error</scenario>\n        <response>Retry with exponential backoff</response>\n        \n        <scenario>Invalid response format</scenario>\n        <response>Log error and continue with next drug</response>\n      </error_handling>\n    </step>\n    \n    <step number=\"4\">\n      <action>Retrieve full SPL documents for selected labels</action>\n      <process>\n        <substep>Fetch XML documents using setid identifiers</substep>\n        <substep>Validate XML structure and completeness</substep>\n        <substep>Queue documents for section extraction</substep>\n        <substep>Track retrieval success rates for monitoring</substep>\n      </process>\n    </step>\n  </phase>\n  \n  <phase name=\"content_extraction\">\n    <step number=\"5\">\n      <action>Extract structured sections from SPL documents</action>\n      <process>\n        <substep>Apply LOINC code-based section extraction</substep>\n        <substep>Clean and normalize extracted content</substep>\n        <substep>Validate section content quality and relevance</substep>\n        <substep>Organize sections by clinical importance</substep>\n      </process>\n    </step>\n    \n    <step number=\"6\">\n      <action>Compile comprehensive drug label information</action>\n      <process>\n        <substep>Combine sections into structured result objects</substep>\n        <substep>Add metadata (setid, publication date, drug name)</substep>\n        <substep>Apply final quality filters and validation</substep>\n        <substep>Prepare results for downstream processing</substep>\n      </process>\n    </step>\n  </phase>\n</retrieval_workflow>\n\n<output_specification>\n  <result_format>\n    <required_fields>\n      <field name=\"setid\">Unique SPL identifier for version tracking</field>\n      <field name=\"drug_name\">Normalized drug name used in search</field>\n      <field name=\"title\">Official product title from FDA label</field>\n      <field name=\"published\">Publication date (YYYY-MM-DD format)</field>\n      <field name=\"sections\">Structured sections with LOINC-based organization</field>\n    </required_fields>\n    \n    <section_structure>\n      <section name=\"indications\">FDA-approved therapeutic uses</section>\n      <section name=\"dosage\">Recommended dosing and administration</section>\n      <section name=\"warnings\">Safety warnings and precautions</section>\n      <section name=\"adverse_reactions\">Known side effects and reactions</section>\n      <section name=\"drug_interactions\">Clinically significant interactions</section>\n      <section name=\"clinical_pharmacology\">Mechanism and pharmacokinetics</section>\n    </section_structure>\n    \n    <metadata_fields>\n      <field name=\"extraction_timestamp\">When information was retrieved</field>\n      <field name=\"api_version\">DailyMed API version used</field>\n      <field name=\"section_count\">Number of sections successfully extracted</field>\n      <field name=\"content_length\">Total character count of extracted content</field>\n    </metadata_fields>\n  </result_format>\n  \n  <quality_metrics>\n    <completeness>Percentage of critical sections successfully extracted</completeness>\n    <recency>Average age of retrieved drug labels</recency>\n    <coverage>Percentage of requested drugs with successful label retrieval</coverage>\n    <content_quality>Average content length per section</content_quality>\n  </quality_metrics>\n</output_specification>\n\n<examples>\n  <example>\n    <scenario>Diabetes medication label retrieval</scenario>\n    <input>\n      <drug_names>[\"Metformin\", \"Glipizide\", \"Insulin Glargine\"]</drug_names>\n    </input>\n    \n    <search_process>\n      <drug name=\"Metformin\">\n        <search_query>drug_name=Metformin&published_after=2020-01-01</search_query>\n        <results_found>3 SPL documents</results_found>\n        <selected>Most recent (2023-08-15)</selected>\n      </drug>\n      \n      <drug name=\"Glipizide\">\n        <search_query>drug_name=Glipizide&published_after=2020-01-01</search_query>\n        <results_found>2 SPL documents</results_found>\n        <selected>Most recent (2023-03-22)</selected>\n      </drug>\n    </search_process>\n    \n    <extracted_sections>\n      <metformin>\n        <indications>Type 2 diabetes mellitus as adjunct to diet and exercise...</indications>\n        <dosage>Initial dose 500 mg twice daily with meals. May increase by 500 mg weekly...</dosage>\n        <warnings>Lactic acidosis risk. Contraindicated in renal impairment...</warnings>\n        <adverse_reactions>Most common: diarrhea, nausea, vomiting, flatulence...</adverse_reactions>\n        <drug_interactions>Alcohol may potentiate effect on lactate metabolism...</drug_interactions>\n      </metformin>\n    </extracted_sections>\n    \n    <quality_assessment>\n      <completeness>100% - All critical sections extracted</completeness>\n      <content_quality>High - Substantial medical content in each section</content_quality>\n      <recency>Excellent - All labels from 2023</recency>\n    </quality_assessment>\n  </example>\n  \n  <example>\n    <scenario>Cardiovascular medication combination product</scenario>\n    <input>\n      <drug_names>[\"Lisinopril/HCTZ\"]</drug_names>\n    </input>\n    \n    <processing_strategy>\n      <combination_detection>Identified as combination product</combination_detection>\n      <component_search>\n        <component>Lisinopril</component>\n        <component>Hydrochlorothiazide</component>\n        <combination>Lisinopril/Hydrochlorothiazide</combination>\n      </component_search>\n    </processing_strategy>\n    \n    <results>\n      <combination_label>\n        <setid>abc123-def456-ghi789</setid>\n        <title>Lisinopril and Hydrochlorothiazide Tablets</title>\n        <published>2023-06-10</published>\n        <sections>\n          <indications>Hypertension management when combination therapy appropriate...</indications>\n          <dosage>Initial: Lisinopril 10mg/HCTZ 12.5mg once daily...</dosage>\n          <warnings>Angioedema risk with ACE inhibitors. Electrolyte monitoring required...</warnings>\n        </sections>\n      </combination_label>\n    </results>\n  </example>\n</examples>\n\n<performance_optimization>\n  <concurrent_processing>\n    <drug_level_parallelism>Process multiple drugs simultaneously</drug_level_parallelism>\n    <api_call_batching>Batch API calls where possible</api_call_batching>\n    <section_extraction_parallelism>Extract sections concurrently</section_extraction_parallelism>\n  </concurrent_processing>\n  \n  <caching_strategy>\n    <spl_document_cache>\n      <description>Cache retrieved SPL XML documents</description>\n      <cache_key>setid identifier</cache_key>\n      <cache_duration>24 hours</cache_duration>\n      <invalidation>Clear when new versions published</invalidation>\n    </spl_document_cache>\n    \n    <search_result_cache>\n      <description>Cache search results for common drug names</description>\n      <cache_key>Normalized drug name + date filter</cache_key>\n      <cache_duration>6 hours</cache_duration>\n    </search_result_cache>\n  </caching_strategy>\n  \n  <resource_management>\n    <memory_optimization>Stream large XML documents instead of loading entirely</memory_optimization>\n    <connection_pooling>Reuse HTTP connections for multiple API calls</connection_pooling>\n    <timeout_management>Set appropriate timeouts for API calls</timeout_management>\n  </resource_management>\n</performance_optimization>\n\n<quality_assurance>\n  <validation_framework>\n    <input_validation>\n      <check>Verify drug names are valid pharmaceutical entities</check>\n      <check>Ensure drug list is not empty</check>\n      <check>Validate drug name format and characters</check>\n    </input_validation>\n    \n    <retrieval_validation>\n      <check>Confirm API responses are valid JSON/XML</check>\n      <check>Verify setid format matches expected pattern</check>\n      <check>Ensure publication dates are reasonable</check>\n    </retrieval_validation>\n    \n    <content_validation>\n      <check>Validate extracted sections contain medical content</check>\n      <check>Ensure section lengths are within expected ranges</check>\n      <check>Verify no XML artifacts in extracted text</check>\n      <check>Confirm drug names appear in extracted content</check>\n    </content_validation>\n  </validation_framework>\n  \n  <success_metrics>\n    <retrieval_success_rate>Percentage of drugs with successful label retrieval</retrieval_success_rate>\n    <section_extraction_rate>Percentage of critical sections successfully extracted</section_extraction_rate>\n    <content_quality_score>Average content quality across all extracted sections</content_quality_score>\n    <api_performance>Average response time for DailyMed API calls</api_performance>\n  </success_metrics>\n</quality_assurance>\n\n<critical_requirements>\n  <requirement>NEVER return drug labels older than 2015 unless no recent alternatives exist</requirement>\n  <requirement>ALWAYS prioritize most recent version of drug labels</requirement>\n  <requirement>ALWAYS extract critical sections (indications, dosage, warnings) when available</requirement>\n  <requirement>NEVER exceed 2 labels per drug to maintain processing efficiency</requirement>\n  <requirement>ALWAYS validate extracted content contains meaningful medical information</requirement>\n  <requirement>NEVER return malformed or incomplete section data</requirement>\n  <requirement>ALWAYS handle combination products by searching individual components</requirement>\n</critical_requirements>`;", "/**\n * Sub-Agent 2.4: DailyMed Retriever\n * Fetches FDA drug labels (SPL format)\n * ENHANCED: Now uses comprehensive evidence engine + Medical Source Bible drug routing\n */\n\nimport { TraceContext } from '../types';\nimport { withRetrieverSpan, SpanStatusCode } from '../../otel';\nimport { DAILYMED_RETRIEVER_SYSTEM_PROMPT } from '../system-prompts/dailymed-retriever-prompt';\nimport { callGeminiWithRetry } from '../../utils/gemini-rate-limiter';\n\nexport class DailyMedRetriever {\n  private systemPrompt: string;\n  private genAI: any;\n  private modelName: string;\n\n  constructor() {\n    this.modelName = 'gemini-3-flash-preview';\n\n    // Initialize Gemini for intelligent drug processing\n    if (process.env.GEMINI_API_KEY) {\n      const { GoogleGenAI } = require('@google/genai');\n      this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });\n    } else {\n      this.genAI = null;\n      console.warn('\u26A0\uFE0F GEMINI_API_KEY not set - DailyMed will use basic drug name processing');\n    }\n\n    // Set system prompt\n    this.systemPrompt = DAILYMED_RETRIEVER_SYSTEM_PROMPT;\n  }\n\n  /**\n   * Normalize drug names using Gemini 3 Flash (thinking_level: minimal)\n   */\n  private async normalizeDrugNames(drugNames: string[]): Promise<string[]> {\n    if (!this.genAI || drugNames.length === 0) {\n      return drugNames;\n    }\n\n    try {\n      const prompt = `Normalize these drug names by removing formulation suffixes (XR, ER, SR, etc.) and expanding abbreviations. Return comma-separated generic names.\n\nDrug names: ${drugNames.join(', ')}\n\nNormalized names:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: 'You are a pharmaceutical terminology specialist. Normalize drug names to generic forms.',\n            temperature: 0.1,\n            maxOutputTokens: 150,\n            thinkingConfig: {\n              thinkingLevel: 'minimal' // Fast drug name normalization\n            }\n          }\n        });\n      });\n\n      const normalized = response.text?.trim().split(',').map((d: string) => d.trim()).filter(Boolean) || drugNames;\n      console.log(`   \uD83D\uDC8A Normalized ${drugNames.length} drug names`);\n      return normalized;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F Drug name normalization failed, using original:', error);\n      return drugNames;\n    }\n  }\n\n  /**\n   * Prioritize drug label sections using Gemini 3 Flash (thinking_level: low)\n   */\n  private async prioritizeSections(drugs: any[], originalQuery?: string): Promise<any[]> {\n    if (!this.genAI || drugs.length === 0 || !originalQuery) {\n      return drugs;\n    }\n\n    try {\n      // For large result sets, use LLM to identify most relevant drugs\n      if (drugs.length > 15) {\n        const drugsPreview = drugs.slice(0, 20).map((d, idx) =>\n          `[${idx}] ${d.drug_name} - ${d.title.substring(0, 80)}`\n        ).join('\\n');\n\n        const prompt = `Given this medical query and drug labels, identify the indices of the 12 most relevant drugs. Return only comma-separated indices (e.g., \"0,2,5,7,9,11,13,15,17,19,20,21\").\n\nQuery: ${originalQuery}\n\nDrugs:\n${drugsPreview}\n\nTop 12 indices:`;\n\n        // CRITICAL FIX: Use rate limiter with multi-key support\n        const response = await callGeminiWithRetry(async (apiKey: string) => {\n          const genAI = new GoogleGenAI({ apiKey });\n          return await genAI.models.generateContent({\n            model: this.modelName,\n            contents: prompt,\n            config: {\n              systemInstruction: 'You are a pharmaceutical relevance specialist. Select the most relevant drug labels based on the query.',\n              temperature: 0.1,\n              maxOutputTokens: 50,\n              thinkingConfig: {\n                thinkingLevel: 'low' // Straightforward prioritization\n              }\n            }\n          });\n        });\n\n        const indicesText = response.text?.trim() || '';\n        const indices = indicesText.split(',').map((s: string) => parseInt(s.trim())).filter((n: number) => !isNaN(n) && n < drugs.length);\n\n        if (indices.length > 0) {\n          const prioritized = indices.map((i: number) => drugs[i]).filter(Boolean);\n          console.log(`   \uD83C\uDFAF LLM prioritized ${prioritized.length} drug labels`);\n          return prioritized;\n        }\n      }\n\n      return drugs;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F LLM prioritization failed, using default ordering:', error);\n      return drugs;\n    }\n  }\n\n  async search(\n    drugNames: string[],\n    traceContext: TraceContext,\n    originalQuery?: string\n  ): Promise<DailyMedSearchResult[]> {\n    return await withRetrieverSpan('dailymed', async (span) => {\n      const startTime = Date.now();\n\n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'dailymed');\n      span.setAttribute('retrieval.query', drugNames.join(', '));\n\n    try {\n      console.log(`\uD83D\uDC8A DailyMed Retriever: Enhanced search with Medical Source Bible integration`);\n\n      // STEP 1: Normalize drug names using Gemini 3 Flash\n      const normalizedDrugNames = await this.normalizeDrugNames(drugNames);\n\n      // STEP 2: Route query to medical specialties for drug context (dynamic import)\n      let relevantSpecialties: string[] = [];\n      if (originalQuery) {\n        try {\n          const { routeQueryToSpecialties } = await import('../../../medical-source-bible');\n          relevantSpecialties = routeQueryToSpecialties(originalQuery);\n        } catch (error) {\n          console.warn('Medical source bible import failed:', error);\n          relevantSpecialties = [];\n        }\n      }\n      console.log(`\uD83D\uDCCB Drug context specialties: ${relevantSpecialties.join(', ') || 'general'}`);\n\n      // STEP 3: Use comprehensive evidence engine for drug search (dynamic import)\n      const searchQuery = normalizedDrugNames.join(' OR ');\n      let result;\n      try {\n        const { comprehensiveDailyMedSearch } = await import('../../evidence/dailymed');\n        result = await comprehensiveDailyMedSearch(searchQuery);\n      } catch (error) {\n        console.warn('DailyMed search failed:', error);\n        result = { allDrugs: [] };\n      }\n\n      // STEP 4: Enhance results with Medical Source Bible metadata\n      const enhancedResults = this.enhanceWithSourceBible(result.drugs || [], relevantSpecialties, normalizedDrugNames);\n\n      // STEP 5: Apply intelligent prioritization using Gemini 3 Flash\n      const prioritizedResults = await this.prioritizeSections(enhancedResults, originalQuery);\n\n      // STEP 6: Apply final filtering\n      const filteredResults = this.applyDrugFiltering(prioritizedResults);\n\n      const latency = Date.now() - startTime;\n\n      // Set span attributes\n      span.setAttribute('retrieval.result_count', filteredResults.length);\n      span.setAttribute('retrieval.latency_ms', latency);\n      span.setAttribute('retrieval.drugs_searched', drugNames.length);\n      span.setAttribute('retrieval.specialties_detected', JSON.stringify(relevantSpecialties));\n      span.setAttribute('retrieval.total_results', result.drugs?.length || 0);\n      span.setAttribute('retrieval.after_filtering', filteredResults.length);\n      span.setAttribute('retrieval.recent_updates', filteredResults.filter(r => r.is_recent_update).length);\n      span.setAttribute('retrieval.labels_found', filteredResults.length);\n\n      console.log(`\u2705 DailyMed Retriever: ${filteredResults.length} drug labels (${filteredResults.filter(r => r.is_recent_update).length} recent updates)`);\n\n      // Convert to documents format for span events\n      const documents = filteredResults.map(r => ({\n        id: r.setid,\n        content: r.title + ' ' + Object.values(r.sections).join(' '),\n        score: 1.0,\n        metadata: {\n          drug_name: r.drug_name,\n          title: r.title,\n          published: r.published,\n          specialty_relevance: r.specialty_relevance,\n          is_recent_update: r.is_recent_update\n        }\n      }));\n\n      return { result: filteredResults, documents };\n\n    } catch (error) {\n      console.error('\u274C DailyMed Retriever failed:', error);\n\n      // Set error attributes\n      span.setAttribute('retrieval.result_count', 0);\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n      return { result: [], documents: [] };\n      }\n    }, { source: 'dailymed' });\n  }\n\n  private enhanceWithSourceBible(drugs: any[], specialties: string[], searchedDrugs: string[]): DailyMedSearchResult[] {\n    return drugs.map(drug => {\n      // Check if this is a recent update (2023+)\n      const pubYear = new Date(drug.publishedDate || '2000-01-01').getFullYear();\n      const currentYear = new Date().getFullYear();\n      const isRecentUpdate = pubYear >= currentYear - 2; // 2023+ if current year is 2025\n\n      // Extract sections from the drug object\n      const sections: Record<string, string> = {};\n\n      if (drug.indications) sections.indications = drug.indications;\n      if (drug.contraindications) sections.contraindications = drug.contraindications;\n      if (drug.warnings) sections.warnings = drug.warnings;\n      if (drug.dosage) sections.dosage = drug.dosage;\n      if (drug.adverseReactions) sections.adverse_reactions = drug.adverseReactions;\n      if (drug.drugInteractions) sections.drug_interactions = drug.drugInteractions;\n      if (drug.clinicalPharmacology) sections.clinical_pharmacology = drug.clinicalPharmacology;\n      if (drug.howSupplied) sections.how_supplied = drug.howSupplied;\n\n      return {\n        setid: drug.setId,\n        drug_name: drug.genericName || drug.brandName || searchedDrugs[0] || 'Unknown',\n        title: drug.title,\n        published: drug.publishedDate,\n        sections,\n        specialty_relevance: specialties,\n        is_recent_update: isRecentUpdate\n      };\n    });\n  }\n\n  private applyDrugFiltering(results: DailyMedSearchResult[]): DailyMedSearchResult[] {\n    // Sort by recency and completeness\n    const sorted = results.sort((a, b) => {\n      // First priority: Recent updates\n      if (a.is_recent_update && !b.is_recent_update) return -1;\n      if (!a.is_recent_update && b.is_recent_update) return 1;\n\n      // Second priority: Number of sections (more complete information)\n      const sectionsA = Object.keys(a.sections).length;\n      const sectionsB = Object.keys(b.sections).length;\n      if (sectionsA !== sectionsB) return sectionsB - sectionsA;\n\n      // Third priority: Publication date (more recent first)\n      const dateA = new Date(a.published || '1900-01-01').getTime();\n      const dateB = new Date(b.published || '1900-01-01').getTime();\n      return dateB - dateA;\n    });\n\n    // Apply limits: prioritize recent updates and complete information\n    const recentUpdates = sorted.filter(r => r.is_recent_update).slice(0, 8);\n    const olderLabels = sorted.filter(r => !r.is_recent_update).slice(0, 4);\n\n    // Combine and deduplicate by setid\n    const combined = [...recentUpdates, ...olderLabels];\n    const seen = new Set<string>();\n    const deduped = combined.filter(drug => {\n      if (seen.has(drug.setid)) return false;\n      seen.add(drug.setid);\n      return true;\n    });\n\n    return deduped.slice(0, 12); // Final limit\n  }\n}\n\n// EVIDENCE ENGINE INTEGRATION - Dynamic import for performance\n// MEDICAL SOURCE BIBLE INTEGRATION - Dynamic import for performance\n\nexport interface DailyMedSearchResult {\n  setid: string;\n  drug_name: string;\n  title: string;\n  published: string;\n  sections: Record<string, string>;\n  specialty_relevance?: string[];\n  is_recent_update?: boolean;\n}\n", "/**\n * Sub-Agent 2.5: Tavily Smart Search\n * Searches recent web content when evidence gaps detected\n * ENHANCED: Now uses Medical Source Bible for specialty-specific domain targeting\n */\n\nimport { TraceContext } from '../types';\nimport { withRetrieverSpan, SpanStatusCode } from '../../otel';\nimport { TAVILY_SEARCH_SYSTEM_PROMPT } from '../system-prompts/tavily-search-prompt';\nimport { callGeminiWithRetry } from '../../utils/gemini-rate-limiter';\n// MEDICAL SOURCE BIBLE INTEGRATION - Dynamic import for performance\n\nexport interface TavilySearchResult {\n  url: string;\n  title: string;\n  content: string;\n  score: number;\n  published_date?: string;\n  specialty_relevance?: string[];\n  source_type?: 'guideline_org' | 'journal' | 'government' | 'medical_institution';\n}\n\nexport class TavilySmartSearch {\n  private apiKey: string;\n  private systemPrompt: string;\n  private genAI: any;\n  private modelName: string;\n\n  constructor(apiKey: string) {\n    this.apiKey = apiKey;\n    this.modelName = 'gemini-3-flash-preview';\n    this.genAI = null; // DISABLED: Pure Tavily search for speed\n\n    // Import system prompt\n    const { TAVILY_SEARCH_SYSTEM_PROMPT } = require('../system-prompts/tavily-search-prompt');\n    this.systemPrompt = TAVILY_SEARCH_SYSTEM_PROMPT;\n  }\n\n  /**\n   * Enhance query for web search using rule-based logic (FAST)\n   * Removed LLM call to save time\n   */\n  private async enhanceQuery(query: string, specialties: string[]): Promise<string> {\n    // Pure rule-based enhancement\n    let enhanced = query;\n    if (specialties.length > 0) {\n      enhanced += ` ${specialties.slice(0, 2).join(' ')}`;\n    }\n\n    // Add medical context if not present\n    if (!enhanced.toLowerCase().includes('medical') && !enhanced.toLowerCase().includes('clinical')) {\n      enhanced += ' medical clinical';\n    }\n\n    return enhanced;\n  }\n\n  /**\n   * Classify source type using rule-based URL patterns (FAST)\n   * Removed LLM call to save time and dependencies\n   */\n  private async classifySourcesBatch(results: any[]): Promise<Map<string, 'guideline_org' | 'journal' | 'government' | 'medical_institution'>> {\n    const classifications = new Map<string, 'guideline_org' | 'journal' | 'government' | 'medical_institution'>();\n\n    results.forEach(result => {\n      classifications.set(result.url, this.classifySourceBasic(result.url, result.title));\n    });\n\n    return classifications;\n  }\n\n  /**\n   * Basic URL and Title-based source classification\n   */\n  private classifySourceBasic(url: string, title: string = ''): 'guideline_org' | 'journal' | 'government' | 'medical_institution' {\n    const urlLower = url.toLowerCase();\n    const titleLower = title.toLowerCase();\n\n    // Guidelines (Explicit High Priority)\n    if (titleLower.includes('guideline') || titleLower.includes('recommendation') || titleLower.includes('consensus') || titleLower.includes('standards')) {\n      if (urlLower.includes('.org') || urlLower.includes('.gov')) return 'guideline_org';\n    }\n\n    // Government sources\n    if (urlLower.includes('cdc.gov') || urlLower.includes('who.int') ||\n      urlLower.includes('nih.gov') || urlLower.includes('fda.gov') ||\n      urlLower.includes('nice.org.uk') || urlLower.includes('nhs.uk')) {\n      return 'government';\n    }\n\n    // Medical journals\n    if (urlLower.includes('nejm.org') || urlLower.includes('thelancet.com') ||\n      urlLower.includes('jamanetwork.com') || urlLower.includes('bmj.com') ||\n      urlLower.includes('nature.com') || urlLower.includes('pubmed') ||\n      urlLower.includes('ncbi.nlm.nih.gov')) {\n      return 'journal';\n    }\n\n    // Medical institutions\n    if (urlLower.includes('mayoclinic.org') || urlLower.includes('clevelandclinic.org') ||\n      urlLower.includes('hopkinsmedicine.org') || urlLower.includes('mskcc.org')) {\n      return 'medical_institution';\n    }\n\n    return 'medical_institution'; // Default\n  }\n\n  async search(\n    query: string,\n    existingUrls: Set<string>,\n    traceContext: TraceContext,\n    originalQuery?: string\n  ): Promise<TavilySearchResult[]> {\n    return await withRetrieverSpan('tavily', async (span) => {\n      const startTime = Date.now();\n\n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'tavily');\n      span.setAttribute('retrieval.query', query);\n\n    if (!this.apiKey) {\n      console.log('\u26A0\uFE0F Tavily API key not configured, skipping web search');\n      span.setAttribute('retrieval.result_count', 0);\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      return { result: [], documents: [] };\n    }\n\n    try {\n      console.log(`\uD83C\uDF10 Tavily Smart Search: Enhanced with Medical Source Bible domain targeting`);\n\n      // STEP 1: Route query to medical specialties using Medical Source Bible (dynamic import)\n      let relevantSpecialties: string[] = [];\n      let targetDomains: string[] = [];\n      let enhancedQuery = query;\n\n      if (originalQuery) {\n        try {\n          const medicalSourceBible = await import('../../../medical-source-bible');\n          relevantSpecialties = medicalSourceBible.routeQueryToSpecialties(originalQuery);\n\n      // STEP 2: Get specialty-specific domains from Medical Source Bible\n          targetDomains = relevantSpecialties.length > 0\n            ? medicalSourceBible.getTavilyDomains(relevantSpecialties)\n            : this.getGeneralMedicalDomains();\n\n          // STEP 3: Enhance query using Gemini 3 Flash\n          enhancedQuery = await this.enhanceQuery(query, relevantSpecialties);\n        } catch (error) {\n          console.warn('Medical source bible import failed, using basic search:', error);\n          targetDomains = this.getGeneralMedicalDomains();\n          enhancedQuery = await this.enhanceQuery(query, []);\n        }\n      } else {\n        targetDomains = this.getGeneralMedicalDomains();\n        enhancedQuery = await this.enhanceQuery(query, []);\n      }\n\n      console.log(`\uD83D\uDCCB Detected specialties for domain targeting: ${relevantSpecialties.join(', ') || 'general'}`);\n      console.log(`\uD83C\uDFAF Targeting ${targetDomains.length} specialty domains`);\n\n      // Truncate query if too long to avoid Tavily API 400 errors\n      if (enhancedQuery.length > 420) {\n        console.log(`\u26A0\uFE0F Query too long (${enhancedQuery.length} chars), smart truncating to 420 chars`);\n        enhancedQuery = this.smartTruncate(enhancedQuery, 420);\n      }\n\n      // STEP 4: Execute Tavily search with specialty domains\n      const response = await fetch('https://api.tavily.com/search', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.apiKey}`\n        },\n        body: JSON.stringify({\n          query: enhancedQuery,\n          search_depth: 'advanced',\n          max_results: 15,\n          include_domains: targetDomains,\n          exclude_domains: [\n            'wikipedia.org', 'reddit.com', 'quora.com',\n            'facebook.com', 'twitter.com', 'youtube.com'\n          ]\n        })\n      });\n\n      if (!response.ok) {\n        throw new Error(`Tavily API error: ${response.status}`);\n      }\n\n      const data = await response.json();\n      const rawResults = data.results || [];\n\n      // STEP 5: Classify sources using Gemini 3 Flash for proper reference categorization\n      const sourceClassifications = await this.classifySourcesBatch(rawResults);\n\n      // STEP 6: Enhance results with classifications and metadata\n      const enhancedResults = await this.enhanceWithSourceBible(rawResults, relevantSpecialties, existingUrls, sourceClassifications);\n\n      // STEP 7: Apply intelligent filtering for medical relevance\n      const filteredResults = this.applyMedicalFiltering(enhancedResults);\n\n      const latency = Date.now() - startTime;\n\n      // Set span attributes\n      span.setAttribute('retrieval.result_count', filteredResults.length);\n      span.setAttribute('retrieval.latency_ms', latency);\n      span.setAttribute('retrieval.specialties_detected', JSON.stringify(relevantSpecialties));\n      span.setAttribute('retrieval.domains_targeted', targetDomains.length);\n      span.setAttribute('retrieval.total_results', rawResults.length);\n      span.setAttribute('retrieval.deduped_results', filteredResults.length);\n      span.setAttribute('retrieval.guideline_orgs', filteredResults.filter(r => r.source_type === 'guideline_org').length);\n      span.setAttribute('retrieval.government_sources', filteredResults.filter(r => r.source_type === 'government').length);\n      span.setAttribute('retrieval.query_type', 'specialty_targeted_search');\n\n      console.log(`\u2705 Tavily Smart Search: ${filteredResults.length} new sources (${filteredResults.filter(r => r.source_type === 'guideline_org').length} guideline orgs, ${filteredResults.filter(r => r.source_type === 'government').length} government)`);\n      console.log(`   \uD83D\uDCCE All results include URLs for proper reference section display`);\n\n      // Convert to documents format for span events\n      const documents = filteredResults.map(r => ({\n        id: r.url,\n        content: r.content,\n        score: r.score,\n        metadata: {\n          title: r.title,\n          url: r.url, // CRITICAL: URL preserved for reference section\n          published_date: r.published_date,\n          specialty_relevance: r.specialty_relevance,\n          source_type: r.source_type\n        }\n      }));\n\n      return { result: filteredResults, documents };\n\n    } catch (error) {\n      console.error('\u274C Tavily Smart Search failed:', error);\n\n      // Set error attributes\n      span.setAttribute('retrieval.result_count', 0);\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n        return { result: [], documents: [] };\n      }\n    }, { source: 'tavily' });\n  }\n\n  /**\n   * Fetch structured metadata from NCBI for PubMed/PMC URLs\n   */\n  private async fetchNCBIMetadata(url: string): Promise<{ authors?: string[], journal?: string, year?: string, title?: string } | null> {\n    try {\n      let db = '';\n      let id = '';\n\n      if (url.includes('pubmed.ncbi.nlm.nih.gov')) {\n        db = 'pubmed';\n        const match = url.match(/pubmed\\.ncbi\\.nlm\\.nih\\.gov\\/(\\d+)/);\n        if (match) id = match[1];\n      } else if (url.includes('ncbi.nlm.nih.gov/pmc')) {\n        db = 'pmc';\n        const match = url.match(/PMC(\\d+)/);\n        if (match) id = match[1];\n      }\n\n      if (!db || !id || !process.env.NCBI_API_KEY) return null;\n\n      const apiUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=${db}&id=${id}&retmode=json&api_key=${process.env.NCBI_API_KEY}`;\n      const response = await fetch(apiUrl);\n      if (!response.ok) return null;\n\n      const data = await response.json();\n      const uid = db === 'pubmed' ? id : Object.keys(data.result)[0]; // PMC IDs might differ in response\n      const doc = data.result[uid];\n\n      if (!doc) return null;\n\n      // Extract metadata\n      const authors = doc.authors?.map((a: any) => a.name) || [];\n      const journal = doc.source || doc.fulljournalname;\n      const pubDate = doc.pubdate || doc.epubdate;\n      const year = pubDate ? pubDate.substring(0, 4) : '';\n\n      return {\n        authors: authors.slice(0, 5), // Top 5 authors\n        journal,\n        year,\n        title: doc.title\n      };\n\n    } catch (error) {\n      console.warn(`\u26A0\uFE0F NCBI metadata fetch failed for ${url}:`, error);\n      return null;\n    }\n  }\n\n  private async enhanceWithSourceBible(\n    results: any[],\n    specialties: string[],\n    existingUrls: Set<string>,\n    sourceClassifications: Map<string, 'guideline_org' | 'journal' | 'government' | 'medical_institution'>\n  ): Promise<TavilySearchResult[]> {\n    const enrichedResults: TavilySearchResult[] = [];\n\n    // Process sequentially to be nice to NCBI API rate limits if multiple PubMed URLs found\n    for (const result of results) {\n      if (existingUrls.has(result.url)) continue;\n\n      const sourceType = sourceClassifications.get(result.url) || this.classifySourceBasic(result.url, result.title);\n      let metadata = {};\n\n      // IF PubMed URL, fetch structured metadata\n      if (result.url.includes('ncbi.nlm.nih.gov')) {\n        const ncbiData = await this.fetchNCBIMetadata(result.url);\n        if (ncbiData) {\n          metadata = {\n            authors: ncbiData.authors,\n            journal: ncbiData.journal,\n            year: ncbiData.year,\n            // Use NCBI title if available as it's cleaner\n            corrected_title: ncbiData.title\n          }\n        }\n      } \n      // ELSE IF Guideline, try basic regex extraction from title\n      else if (sourceType === 'guideline_org') {\n        const yearMatch = result.title.match(/(20\\d{2})/);\n        if (yearMatch) {\n          metadata = { year: yearMatch[1] };\n        }\n      }\n\n      enrichedResults.push({\n        url: result.url,\n        title: (metadata as any).corrected_title || result.title,\n        content: result.content,\n        score: result.score || 0.7,\n        published_date: (metadata as any).year || result.published_date,\n        specialty_relevance: specialties,\n        source_type: sourceType,\n        ...metadata // Spread captured metadata (authors, journal)\n      });\n    }\n\n    return enrichedResults;\n  }\n\n  private applyMedicalFiltering(results: TavilySearchResult[]): TavilySearchResult[] {\n    // Sort by source type priority and score\n    const sorted = results.sort((a, b) => {\n      // First priority: Source type\n      const typePriority = {\n        'guideline_org': 4,\n        'government': 3,\n        'journal': 2,\n        'medical_institution': 1\n      };\n      const typeDiff = typePriority[b.source_type || 'medical_institution'] - typePriority[a.source_type || 'medical_institution'];\n      if (typeDiff !== 0) return typeDiff;\n\n      // Second priority: Score\n      return (b.score || 0) - (a.score || 0);\n    });\n\n    // Apply limits by source type\n    const guidelineOrgs = sorted.filter(r => r.source_type === 'guideline_org').slice(0, 8);\n    const government = sorted.filter(r => r.source_type === 'government').slice(0, 6);\n    const journals = sorted.filter(r => r.source_type === 'journal').slice(0, 4);\n    const institutions = sorted.filter(r => r.source_type === 'medical_institution').slice(0, 4);\n\n    // Combine and deduplicate by URL\n    const combined = [...guidelineOrgs, ...government, ...journals, ...institutions];\n    const seen = new Set<string>();\n    const deduped = combined.filter(result => {\n      if (seen.has(result.url)) return false;\n      seen.add(result.url);\n      return true;\n    });\n\n    return deduped.slice(0, 20); // Final limit\n  }\n\n  private getGeneralMedicalDomains(): string[] {\n    // Fallback domains when no specific specialties detected\n    return [\n      'cdc.gov', 'who.int', 'nih.gov', 'fda.gov',\n      'mayoclinic.org', 'clevelandclinic.org', 'hopkinsmedicine.org',\n      'nejm.org', 'thelancet.com', 'jamanetwork.com', 'bmj.com',\n      'nice.org.uk', 'nhs.uk', 'uptodate.com', 'medscape.com'\n    ];\n  }\n\n  /**\n   * Smart truncation for Tavily queries - preserves context while meeting length limit\n   */\n  private smartTruncate(query: string, maxLength: number): string {\n    // Step 1: Remove domain targeting patterns first (they're redundant with include_domains)\n    let shortened = query.replace(/\\(site:[^)]+\\)/gi, '').trim();\n\n    // Step 2: If still too long, remove common filler words\n    if (shortened.length > maxLength) {\n      const fillerPatterns = [\n        /\\bguidelines\\s+recommendations\\b/gi,\n        /\\bclinical\\s+practice\\s+guidelines\\b/gi,\n        /\\bsystematic\\s+review\\s+meta-analysis\\b/gi,\n      ];\n      for (const pattern of fillerPatterns) {\n        if (shortened.length <= maxLength) break;\n        shortened = shortened.replace(pattern, match => {\n          // Keep first word only\n          return match.split(/\\s+/)[0];\n        });\n      }\n    }\n\n    // Step 3: Clean up extra spaces\n    shortened = shortened.replace(/\\s+/g, ' ').trim();\n\n    // Step 4: If still too long, truncate at word boundary\n    if (shortened.length > maxLength) {\n      shortened = shortened.substring(0, maxLength);\n      // Find last space to avoid cutting words\n      const lastSpace = shortened.lastIndexOf(' ');\n      if (lastSpace > maxLength * 0.7) {\n        shortened = shortened.substring(0, lastSpace);\n      }\n    }\n\n    return shortened.trim();\n  }\n}\n", "/**\n * Agent 2: Multi-Source Retrieval Coordinator\n * Orchestrates parallel retrieval from all required sources with intelligent sub-agent routing\n * ENHANCED: Now uses specialized queries from Agent 1 for optimal sub-agent performance\n */\n\nimport { QueryAnalysis, EvidenceCandidate, TraceContext } from './types';\nimport { withRetrieverSpan, SpanStatusCode } from '../otel';\n\n// EVIDENCE ENGINE INTEGRATION - Lazy imports for better performance\n// These will be imported only when needed to reduce compilation time\n\n// Sub-agent imports with specialized query handling\nimport { GuidelinesRetriever } from './sub-agents/guidelines-retriever';\nimport { PubMedIntelligence } from './sub-agents/pubmed-intelligence';\nimport { DailyMedRetriever } from './sub-agents/dailymed-retriever';\nimport { TavilySmartSearch } from './sub-agents/tavily-search';\n\nexport interface RetrievalResults {\n  guidelines: any[];\n  pubmed: any[];\n  dailymed: any[];\n  clinical_trials: any[];\n  cochrane: any[];\n  bmj: any[];\n  nice: any[];\n  who: any[];\n  cdc: any[];\n  landmark_trials: any[];\n  semantic_scholar: any[];\n  europe_pmc: any[];\n  pmc: any[];\n  openalex: any[];\n  tavily: any[];\n}\n\nexport class MultiSourceRetrievalCoordinator {\n  private guidelines: GuidelinesRetriever;\n  private pubmedIntelligence: PubMedIntelligence;\n  private dailymedRetriever: DailyMedRetriever;\n  private tavily: TavilySmartSearch;\n\n  constructor(config: {\n    ncbi_api_key: string;\n    tavily_api_key: string;\n  }) {\n    // Initialize sub-agents with specialized capabilities\n    this.guidelines = new GuidelinesRetriever();\n    this.pubmedIntelligence = new PubMedIntelligence(config.ncbi_api_key);\n    this.dailymedRetriever = new DailyMedRetriever();\n    this.tavily = new TavilySmartSearch(config.tavily_api_key);\n  }\n\n  async retrieveAll(\n    searchStrategy: QueryAnalysis,\n    traceContext: TraceContext,\n    originalQuery?: string\n  ): Promise<RetrievalResults> {\n    return await withRetrieverSpan('intelligent_multi_source', async (span) => {\n      const startTime = Date.now();\n\n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'intelligent_multi_source');\n      span.setAttribute('retrieval.query', searchStrategy.search_variants.join(' | '));\n    const tasks: Promise<any>[] = [];\n    const sources = searchStrategy.requires_sources;\n    const subAgentQueries = searchStrategy.sub_agent_queries;\n\n    console.log(`\uD83D\uDD0D Starting intelligent sub-agent retrieval with specialized queries...`);\n    console.log(`\uD83D\uDCCB Original query: \"${originalQuery || 'Not provided'}\"`);\n    console.log(`\uD83C\uDFAF Sub-agent routing decisions:`);\n    console.log(`   Guidelines: ${subAgentQueries.guidelines?.should_call ? '\u2713' : '\u2717'} - ${subAgentQueries.guidelines?.reasoning}`);\n    console.log(`   PubMed: ${subAgentQueries.pubmed?.should_call ? '\u2713' : '\u2717'} - ${subAgentQueries.pubmed?.reasoning}`);\n    console.log(`   DailyMed: ${subAgentQueries.dailymed?.should_call ? '\u2713' : '\u2717'} - ${subAgentQueries.dailymed?.reasoning}`);\n\n    // #region debug log\n    fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:69',message:'Multi-source retrieval starting',data:{guidelines:subAgentQueries.guidelines?.should_call,pubmed:subAgentQueries.pubmed?.should_call,dailymed:subAgentQueries.dailymed?.should_call,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n    // #endregion\n\n    // CRITICAL FIX: Increased timeout to 60 seconds to allow for rate-limited API calls\n    // With rate limiting and retries, searches may take longer but should complete\n    const timeoutPromise = new Promise((_, reject) => \n      setTimeout(() => reject(new Error('Retrieval timeout after 60 seconds')), 60000)\n    );\n\n    // 1. Guidelines Retriever - Use specialized queries from Agent 1\n    if (subAgentQueries.guidelines?.should_call && subAgentQueries.guidelines.rephrased_queries.length > 0) {\n      console.log(`\uD83D\uDCCB Guidelines: Using ${subAgentQueries.guidelines.rephrased_queries.length} specialized queries`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:85',message:'Sub-agent guidelines starting',data:{subAgent:'guidelines',timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      tasks.push(\n        this.guidelines.search(\n          subAgentQueries.guidelines.rephrased_queries,\n          traceContext,\n          originalQuery\n        ).then(results => {\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:92',message:'Sub-agent guidelines completed',data:{subAgent:'guidelines',resultCount:results.result?.length||0,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n          // #endregion\n          return { type: 'guidelines', results };\n        }).catch(err => {\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:96',message:'Sub-agent guidelines error',data:{subAgent:'guidelines',error:err instanceof Error?err.message:'Unknown',timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n          // #endregion\n          throw err;\n        })\n      );\n    } else {\n      tasks.push(Promise.resolve({ type: 'guidelines', results: [] }));\n    }\n\n    // 2. PubMed Intelligence - Use specialized queries with MeSH terms from Agent 1\n    // CRITICAL FIX: PubMed should ALWAYS be called - it's the primary evidence source\n    // Even if Agent 1 didn't route to it, we should still call it as a fallback\n    const shouldCallPubMed = subAgentQueries.pubmed?.should_call !== false; // Default to true\n    const pubmedQueries = subAgentQueries.pubmed?.rephrased_queries.length > 0 \n      ? subAgentQueries.pubmed.rephrased_queries \n      : searchStrategy.search_variants.slice(0, 3); // Fallback to search variants if no specialized queries\n    \n    if (shouldCallPubMed && pubmedQueries.length > 0) {\n      console.log(`\uD83D\uDD2C PubMed: Using ${pubmedQueries.length} ${subAgentQueries.pubmed?.rephrased_queries.length > 0 ? 'specialized' : 'fallback'} queries with MeSH terms`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:100',message:'Sub-agent pubmed starting',data:{subAgent:'pubmed',queryCount:pubmedQueries.length,isFallback:subAgentQueries.pubmed?.rephrased_queries.length===0,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n        const pubmedStartTime = Date.now();\n        tasks.push(\n          Promise.race([\n            this.pubmedIntelligence.search(\n              pubmedQueries,\n              searchStrategy.entities,\n              traceContext,\n              originalQuery\n            ).then(results => {\n              // #region debug log\n              fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:107',message:'Sub-agent pubmed completed',data:{subAgent:'pubmed',resultCount:results.result?.length||0,elapsed:Date.now()-pubmedStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n              // #endregion\n              if (!results.result || results.result.length === 0) {\n                console.warn('\u26A0\uFE0F PubMed returned no results - this may cause over-reliance on Tavily');\n              }\n              return { type: 'pubmed', results };\n            }).catch(err => {\n              // #region debug log\n              fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:111',message:'Sub-agent pubmed error',data:{subAgent:'pubmed',error:err instanceof Error?err.message:'Unknown',elapsed:Date.now()-pubmedStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n              // #endregion\n              console.error('\u274C PubMed search failed - this will cause over-reliance on Tavily:', err);\n              // Return empty results instead of throwing - don't break the pipeline\n              return { type: 'pubmed', results: [] };\n            }),\n            // Individual timeout for PubMed (50 seconds)\n            new Promise((_, reject) => \n              setTimeout(() => reject(new Error('PubMed search timeout after 50 seconds')), 50000)\n            ).then(() => ({ type: 'pubmed', results: [] }))\n          ]).catch(err => {\n            // #region debug log\n            fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:120',message:'Sub-agent pubmed timeout/error',data:{subAgent:'pubmed',error:err instanceof Error?err.message:'Unknown',elapsed:Date.now()-pubmedStartTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n            // #endregion\n            console.error('\u274C PubMed search timed out or failed:', err);\n            return { type: 'pubmed', results: [] };\n          })\n        );\n    } else {\n      console.warn('\u26A0\uFE0F PubMed not called - this is unusual and may cause over-reliance on Tavily');\n      tasks.push(Promise.resolve({ type: 'pubmed', results: [] }));\n    }\n\n    // 3. DailyMed Retriever - Use clean drug names from Agent 1\n    if (subAgentQueries.dailymed?.should_call && subAgentQueries.dailymed.drug_names.length > 0) {\n      console.log(`\uD83D\uDC8A DailyMed: Using ${subAgentQueries.dailymed.drug_names.length} clean drug names`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:116',message:'Sub-agent dailymed starting',data:{subAgent:'dailymed',timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      tasks.push(\n        this.dailymedRetriever.search(\n          subAgentQueries.dailymed.drug_names,\n          traceContext,\n          originalQuery\n        ).then(results => {\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:123',message:'Sub-agent dailymed completed',data:{subAgent:'dailymed',resultCount:results.result?.length||0,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n          // #endregion\n          return { type: 'dailymed', results };\n        }).catch(err => {\n          // #region debug log\n          fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:127',message:'Sub-agent dailymed error',data:{subAgent:'dailymed',error:err instanceof Error?err.message:'Unknown',timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n          // #endregion\n          throw err;\n        })\n      );\n    } else {\n      tasks.push(Promise.resolve({ type: 'dailymed', results: [] }));\n    }\n\n    // 4. Clinical Trials (Evidence Engine) - Dynamic import for performance\n    tasks.push(\n      (async () => {\n        try {\n          const { searchClinicalTrials } = await import('../evidence/clinical-trials');\n          const results = await searchClinicalTrials(\n            searchStrategy.search_variants.join(' OR '),\n            20 // maxResults\n          );\n          return { type: 'clinical_trials', results };\n        } catch (error) {\n          console.warn('Clinical trials search failed:', error);\n          return { type: 'clinical_trials', results: [] };\n        }\n      })()\n    );\n\n    // 5. Cochrane Reviews (Evidence Engine) - Dynamic import for performance\n    tasks.push(\n      (async () => {\n        try {\n          const { comprehensiveCochraneSearch } = await import('../evidence/cochrane');\n          const results = await comprehensiveCochraneSearch(\n            searchStrategy.search_variants.join(' OR ')\n          );\n          return { type: 'cochrane', results: results.allReviews };\n        } catch (error) {\n          console.warn('Cochrane search failed:', error);\n          return { type: 'cochrane', results: [] };\n        }\n      })()\n    );\n\n    // 6-14. Other sources - Use placeholder functions for now\n    // TODO: Implement these functions in their respective files\n    tasks.push(Promise.resolve({ type: 'bmj', results: [] }));\n    tasks.push(Promise.resolve({ type: 'nice', results: [] }));\n    tasks.push(Promise.resolve({ type: 'who', results: [] }));\n    tasks.push(Promise.resolve({ type: 'cdc', results: [] }));\n    tasks.push(Promise.resolve({ type: 'landmark_trials', results: [] }));\n    tasks.push(Promise.resolve({ type: 'semantic_scholar', results: [] }));\n    tasks.push(Promise.resolve({ type: 'europe_pmc', results: [] }));\n    tasks.push(Promise.resolve({ type: 'pmc', results: [] }));\n    tasks.push(Promise.resolve({ type: 'openalex', results: [] }));\n\n    // Execute all tasks in parallel with timeout\n    console.log(`\u26A1 Executing ${tasks.length} parallel searches with intelligent routing...`);\n    // #region debug log\n    fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:173',message:'Waiting for parallel tasks',data:{taskCount:tasks.length,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n    // #endregion\n    \n    try {\n      const results = await Promise.race([\n        Promise.all(tasks),\n        timeoutPromise\n      ]) as any[];\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:179',message:'Parallel tasks completed',data:{resultCount:results.length,elapsed:Date.now()-startTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      \n      const totalLatency = Date.now() - startTime;\n\n    // Organize results\n    const organizedResults: RetrievalResults = {\n      guidelines: [],\n      pubmed: [],\n      dailymed: [],\n      clinical_trials: [],\n      cochrane: [],\n      bmj: [],\n      nice: [],\n      who: [],\n      cdc: [],\n      landmark_trials: [],\n      semantic_scholar: [],\n      europe_pmc: [],\n      pmc: [],\n      openalex: [],\n      tavily: [] // Will be populated by Agent 5 if needed\n    };\n\n    for (const result of results) {\n      organizedResults[result.type as keyof RetrievalResults] = result.results || [];\n    }\n\n    // Set comprehensive retrieval metrics with sub-agent intelligence\n    const totalResults = Object.values(organizedResults).reduce((sum, arr) => sum + arr.length, 0);\n    \n    // Set span attributes\n    span.setAttribute('retrieval.result_count', totalResults);\n    span.setAttribute('retrieval.latency_ms', totalLatency);\n    span.setAttribute('retrieval.guidelines_count', organizedResults.guidelines.length);\n    span.setAttribute('retrieval.guidelines_called', subAgentQueries.guidelines?.should_call || false);\n    span.setAttribute('retrieval.guidelines_queries', subAgentQueries.guidelines?.rephrased_queries.length || 0);\n    span.setAttribute('retrieval.pubmed_count', organizedResults.pubmed.length);\n    span.setAttribute('retrieval.pubmed_called', subAgentQueries.pubmed?.should_call || false);\n    span.setAttribute('retrieval.pubmed_queries', subAgentQueries.pubmed?.rephrased_queries.length || 0);\n    span.setAttribute('retrieval.pubmed_mesh_terms', subAgentQueries.pubmed?.mesh_terms.length || 0);\n    span.setAttribute('retrieval.dailymed_count', organizedResults.dailymed.length);\n    span.setAttribute('retrieval.dailymed_called', subAgentQueries.dailymed?.should_call || false);\n    span.setAttribute('retrieval.dailymed_drugs', subAgentQueries.dailymed?.drug_names.length || 0);\n    span.setAttribute('retrieval.clinical_trials_count', organizedResults.clinical_trials.length);\n    span.setAttribute('retrieval.cochrane_count', organizedResults.cochrane.length);\n    span.setAttribute('retrieval.bmj_count', organizedResults.bmj.length);\n    span.setAttribute('retrieval.nice_count', organizedResults.nice.length);\n    span.setAttribute('retrieval.who_count', organizedResults.who.length);\n    span.setAttribute('retrieval.cdc_count', organizedResults.cdc.length);\n    span.setAttribute('retrieval.landmark_trials_count', organizedResults.landmark_trials.length);\n    span.setAttribute('retrieval.semantic_scholar_count', organizedResults.semantic_scholar.length);\n    span.setAttribute('retrieval.europe_pmc_count', organizedResults.europe_pmc.length);\n    span.setAttribute('retrieval.pmc_count', organizedResults.pmc.length);\n    span.setAttribute('retrieval.openalex_count', organizedResults.openalex.length);\n    span.setAttribute('retrieval.sub_agents_called', [\n      subAgentQueries.guidelines?.should_call,\n      subAgentQueries.pubmed?.should_call,\n      subAgentQueries.dailymed?.should_call\n    ].filter(Boolean).length);\n\n    console.log(`\u2705 Intelligent evidence retrieval complete: ${totalResults} documents in ${totalLatency}ms`);\n    console.log(`\uD83C\uDFAF Sub-agent performance:`);\n    console.log(`   \uD83D\uDCDA Guidelines: ${organizedResults.guidelines.length} (${subAgentQueries.guidelines?.rephrased_queries.length || 0} specialized queries)`);\n    console.log(`   \uFFFD PubMed: ${organizedResults.pubmed.length} (${subAgentQueries.pubmed?.rephrased_queries.length || 0} queries, ${subAgentQueries.pubmed?.mesh_terms.length || 0} MeSH terms)`);\n    console.log(`   \uFFFD DailyMed: ${organizedResults.dailymed.length} (${subAgentQueries.dailymed?.drug_names.length || 0} clean drug names)`);\n    console.log(`   \uD83E\uDDEA Clinical Trials: ${organizedResults.clinical_trials.length}`);\n    console.log(`   \uD83D\uDCCA Cochrane: ${organizedResults.cochrane.length}`);\n    console.log(`   \uD83C\uDFE5 BMJ: ${organizedResults.bmj.length}`);\n    console.log(`   \uD83C\uDDEC\uD83C\uDDE7 NICE: ${organizedResults.nice.length}`);\n    console.log(`   \uD83C\uDF0D WHO: ${organizedResults.who.length}`);\n    console.log(`   \uD83C\uDDFA\uD83C\uDDF8 CDC: ${organizedResults.cdc.length}`);\n    console.log(`   \u2B50 Landmark Trials: ${organizedResults.landmark_trials.length}`);\n    console.log(`   \uD83C\uDF93 Semantic Scholar: ${organizedResults.semantic_scholar.length}`);\n    console.log(`   \uD83C\uDDEA\uD83C\uDDFA Europe PMC: ${organizedResults.europe_pmc.length}`);\n    console.log(`   \uD83D\uDCC4 PMC Full-text: ${organizedResults.pmc.length}`);\n    console.log(`   \uD83D\uDD0D OpenAlex: ${organizedResults.openalex.length}`);\n\n    // Convert to documents format for span events\n    const allDocuments: any[] = [];\n    Object.entries(organizedResults).forEach(([source, results]) => {\n      results.forEach((result: any, index: number) => {\n        allDocuments.push({\n          id: result.id || result.pmid || result.setid || `${source}_${index}`,\n          content: result.text || result.abstract || result.title || result.content || '',\n          score: result.score || result.similarity_score || 1.0,\n          metadata: {\n            source,\n            ...result.metadata,\n            ...result\n          }\n        });\n      });\n    });\n\n    return { result: organizedResults, documents: allDocuments };\n    \n    } catch (error) {\n      console.error('\u274C Intelligent evidence retrieval failed or timed out:', error);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'multi-source-retrieval.ts:273',message:'Multi-source retrieval error',data:{error:error instanceof Error?error.message:'Unknown',elapsed:Date.now()-startTime,timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});\n      // #endregion\n      \n      // Set error attributes\n      span.setAttribute('retrieval.result_count', 0);\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n      \n      // Return partial results if available\n      const partialResults: RetrievalResults = {\n        guidelines: [],\n        pubmed: [],\n        dailymed: [],\n        clinical_trials: [],\n        cochrane: [],\n        bmj: [],\n        nice: [],\n        who: [],\n        cdc: [],\n        landmark_trials: [],\n        semantic_scholar: [],\n        europe_pmc: [],\n        pmc: [],\n        openalex: [],\n        tavily: []\n      };\n      \n      console.log('\u26A0\uFE0F Returning empty results due to intelligent retrieval failure/timeout');\n      return { result: partialResults, documents: [] };\n      }\n    }, { source: 'intelligent_multi_source' });\n  }\n\n  // Method to be called by Agent 5 if Tavily search needed\n  async searchTavily(\n    query: string,\n    existingUrls: Set<string>,\n    traceContext: TraceContext,\n    originalQuery?: string\n  ): Promise<any[]> {\n    return this.tavily.search(query, existingUrls, traceContext, originalQuery);\n  }\n}", "/**\n * Agent 3: Evidence Normalizer\n * Converts all source formats into unified EvidenceCandidate objects\n * UPDATED: Now handles 15+ evidence sources from comprehensive engine\n */\n\nimport { EvidenceCandidate, TraceContext } from './types';\nimport { RetrievalResults } from './multi-source-retrieval';\n\nexport class EvidenceNormalizer {\n  normalizeAll(rawResults: RetrievalResults): EvidenceCandidate[] {\n    const candidates: EvidenceCandidate[] = [];\n    const seenIds = new Set<string>();\n\n    console.log(`\uD83D\uDD04 Starting evidence normalization for 15+ sources...`);\n\n    // 1. Guidelines (Indian - Firestore)\n    for (const doc of rawResults.guidelines) {\n      const candidate: EvidenceCandidate = {\n        source: 'indian_guideline',\n        id: doc.chunk_id,\n        title: doc.title || 'Untitled Guideline',\n        text: doc.text || 'No content available',\n        metadata: {\n          organization: doc.organization,\n          year: doc.year,\n          guideline_id: doc.guideline_id,\n          similarity_score: doc.similarity_score,\n          badges: ['Practice Guideline', 'Indian Guidelines']\n        },\n        full_text_available: false\n      };\n      \n      if (!seenIds.has(candidate.id)) {\n        candidates.push(candidate);\n        seenIds.add(candidate.id);\n      }\n    }\n\n    // 2. PubMed (Evidence Engine) - CRITICAL: Always prioritize PubMed\n    let pubmedCount = 0;\n    for (const doc of rawResults.pubmed) {\n      const pmid = doc.pmid || doc.id;\n      \n      if (!seenIds.has(pmid)) {\n        const badges = [];\n        if (doc.pub_types?.includes('Meta-Analysis')) badges.push('Meta-Analysis');\n        if (doc.pub_types?.includes('Systematic Review')) badges.push('Systematic Review');\n        if (doc.pub_types?.includes('Randomized Controlled Trial')) badges.push('RCT');\n        if (doc.pmcid) badges.push('PMCID');\n        if (doc.pub_date && new Date(doc.pub_date).getFullYear() >= 2020) badges.push('Recent');\n        if (doc.journal_tier === 'tier_1') badges.push('Leading Journal');\n        if (doc.journal_tier === 'specialty_elite') badges.push('Specialty Elite');\n\n        const candidate: EvidenceCandidate = {\n          source: 'pubmed',\n          id: pmid,\n          title: doc.title || 'Untitled PubMed Article',\n          text: doc.abstract || 'No abstract available',\n          metadata: {\n            authors: doc.authors,\n            journal: doc.journal,\n            pub_date: doc.pub_date,\n            doi: doc.doi,\n            pmcid: doc.pmcid,\n            pub_types: doc.pub_types,\n            journal_tier: doc.journal_tier, // Preserve journal tier for prioritization\n            badges: badges\n          },\n          full_text_available: !!doc.pmcid\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(pmid);\n        pubmedCount++;\n      }\n    }\n    \n    if (pubmedCount === 0 && rawResults.pubmed.length > 0) {\n      console.warn('\u26A0\uFE0F PubMed results found but none normalized - possible deduplication issue');\n    } else if (pubmedCount > 0) {\n      console.log(`\u2705 Normalized ${pubmedCount} PubMed articles (primary evidence source)`);\n    }\n\n    // 3. DailyMed (Evidence Engine)\n    for (const doc of rawResults.dailymed) {\n      const setid = doc.setid || doc.id;\n      \n      if (!seenIds.has(setid)) {\n        // Combine relevant sections\n        const textParts: string[] = [];\n        const sectionOrder = ['indications', 'dosage', 'clinical_pharmacology', 'warnings', 'adverse_reactions'];\n        \n        for (const sectionName of sectionOrder) {\n          if (doc.sections?.[sectionName]) {\n            textParts.push(`${sectionName.toUpperCase()}:\\n${doc.sections[sectionName]}`);\n          }\n        }\n\n        const candidate: EvidenceCandidate = {\n          source: 'dailymed',\n          id: setid,\n          title: doc.title || doc.drug_name,\n          text: textParts.join('\\n\\n') || doc.content || doc.text,\n          metadata: {\n            drug_name: doc.drug_name,\n            published: doc.published,\n            all_sections: doc.sections,\n            badges: ['FDA Label', 'Drug Information']\n          },\n          full_text_available: true,\n          full_text_sections: doc.sections\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(setid);\n      }\n    }\n\n    // 4. Clinical Trials (Evidence Engine)\n    for (const doc of rawResults.clinical_trials) {\n      const nctId = doc.nct_id || doc.id;\n      \n      if (!seenIds.has(nctId)) {\n        const badges = ['Clinical Trial'];\n        if (doc.phase) badges.push(`Phase ${doc.phase}`);\n        if (doc.status === 'Completed') badges.push('Completed');\n        if (doc.has_results) badges.push('Has Results');\n\n        const candidate: EvidenceCandidate = {\n          source: 'clinical_trials',\n          id: nctId,\n          title: doc.title || doc.brief_title || 'Untitled Clinical Trial',\n          text: doc.brief_summary || doc.detailed_description || doc.summary || 'No summary available',\n          metadata: {\n            phase: doc.phase,\n            status: doc.status,\n            enrollment: doc.enrollment,\n            start_date: doc.start_date,\n            completion_date: doc.completion_date,\n            sponsor: doc.sponsor,\n            badges: badges\n          },\n          full_text_available: false\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(nctId);\n      }\n    }\n\n    // 5. Cochrane Reviews (Evidence Engine)\n    for (const doc of rawResults.cochrane) {\n      const cochraneId = doc.cochrane_id || doc.id;\n      \n      if (!seenIds.has(cochraneId)) {\n        const candidate: EvidenceCandidate = {\n          source: 'cochrane',\n          id: cochraneId,\n          title: doc.title || 'Untitled Cochrane Review',\n          text: doc.abstract || doc.plain_language_summary || 'No abstract available',\n          metadata: {\n            authors: doc.authors,\n            publication_date: doc.publication_date,\n            doi: doc.doi,\n            review_type: doc.review_type,\n            badges: ['Cochrane Review', 'Systematic Review', 'High Quality']\n          },\n          full_text_available: false\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(cochraneId);\n      }\n    }\n\n    // 6. BMJ Best Practice (Evidence Engine)\n    for (const doc of rawResults.bmj) {\n      const bmjId = doc.topic_id || doc.id;\n      \n      if (!seenIds.has(bmjId)) {\n        const candidate: EvidenceCandidate = {\n          source: 'bmj_best_practice',\n          id: bmjId,\n          title: doc.title || 'Untitled BMJ Article',\n          text: doc.summary || doc.content || 'No content available',\n          metadata: {\n            topic: doc.topic,\n            last_updated: doc.last_updated,\n            evidence_level: doc.evidence_level,\n            badges: ['BMJ Best Practice', 'Clinical Guidelines', 'Evidence-Based']\n          },\n          full_text_available: false\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(bmjId);\n      }\n    }\n\n    // 7-14. Other sources (NICE, WHO, CDC, Landmark Trials, etc.)\n    const otherSources = [\n      { key: 'nice', name: 'NICE Guidelines', badges: ['NICE', 'UK Guidelines'] },\n      { key: 'who', name: 'WHO Guidelines', badges: ['WHO', 'Global Guidelines'] },\n      { key: 'cdc', name: 'CDC Guidelines', badges: ['CDC', 'US Guidelines'] },\n      { key: 'landmark_trials', name: 'Landmark Trials', badges: ['Landmark Trial', 'High Impact'] },\n      { key: 'semantic_scholar', name: 'Semantic Scholar', badges: ['Academic Paper'] },\n      { key: 'europe_pmc', name: 'Europe PMC', badges: ['European Research'] },\n      { key: 'pmc', name: 'PMC Full-text', badges: ['PMCID', 'Full Text'] },\n      { key: 'openalex', name: 'OpenAlex', badges: ['Academic Literature'] }\n    ];\n\n    for (const sourceConfig of otherSources) {\n      const sourceResults = rawResults[sourceConfig.key as keyof RetrievalResults] || [];\n      \n      for (const doc of sourceResults) {\n        const docId = doc.id || doc.pmid || doc.doi || doc.url || `${sourceConfig.key}_${Math.random()}`;\n        \n        if (!seenIds.has(docId)) {\n          const candidate: EvidenceCandidate = {\n            source: sourceConfig.key as EvidenceCandidate['source'],\n            id: docId,\n            title: doc.title || 'Untitled',\n            text: doc.abstract || doc.summary || doc.content || doc.text || doc.description || 'No content available',\n            metadata: {\n              ...doc,\n              badges: sourceConfig.badges\n            },\n            full_text_available: !!doc.pmcid || !!doc.full_text_url\n          };\n          \n          candidates.push(candidate);\n          seenIds.add(docId);\n        }\n      }\n    }\n\n    // 15. Tavily (if present)\n    for (const doc of rawResults.tavily) {\n      const url = doc.url;\n      \n      if (!seenIds.has(url)) {\n        const candidate: EvidenceCandidate = {\n          source: 'tavily_web',\n          id: url,\n          title: doc.title || 'Untitled Web Content',\n          text: doc.content || 'No content available',\n          metadata: {\n            url: url,\n            score: doc.score,\n            published_date: doc.published_date,\n            badges: ['Web Search', 'Recent Content']\n          },\n          full_text_available: false\n        };\n        \n        candidates.push(candidate);\n        seenIds.add(url);\n      }\n    }\n\n    console.log(`\u2705 Evidence normalization complete: ${candidates.length} unified candidates`);\n    console.log(`   \uD83D\uDCDA Guidelines: ${rawResults.guidelines.length}`);\n    console.log(`   \uD83D\uDD2C PubMed: ${rawResults.pubmed.length}`);\n    console.log(`   \uD83D\uDC8A DailyMed: ${rawResults.dailymed.length}`);\n    console.log(`   \uD83E\uDDEA Clinical Trials: ${rawResults.clinical_trials.length}`);\n    console.log(`   \uD83D\uDCCA Cochrane: ${rawResults.cochrane.length}`);\n    console.log(`   \uD83C\uDFE5 BMJ: ${rawResults.bmj.length}`);\n    console.log(`   \uD83C\uDDEC\uD83C\uDDE7 NICE: ${rawResults.nice.length}`);\n    console.log(`   \uD83C\uDF0D WHO: ${rawResults.who.length}`);\n    console.log(`   \uD83C\uDDFA\uD83C\uDDF8 CDC: ${rawResults.cdc.length}`);\n    console.log(`   \u2B50 Landmark Trials: ${rawResults.landmark_trials.length}`);\n    console.log(`   \uD83C\uDF93 Semantic Scholar: ${rawResults.semantic_scholar.length}`);\n    console.log(`   \uD83C\uDDEA\uD83C\uDDFA Europe PMC: ${rawResults.europe_pmc.length}`);\n    console.log(`   \uD83D\uDCC4 PMC: ${rawResults.pmc.length}`);\n    console.log(`   \uD83D\uDD0D OpenAlex: ${rawResults.openalex.length}`);\n    console.log(`   \uD83C\uDF10 Tavily: ${rawResults.tavily.length}`);\n\n    return candidates;\n  }\n}", "/**\n * Sub-Agent 2.3: Full-Text Fetcher\n * Fetches full-text for top documents (PMC + Unpaywall fallback)\n * Only called by Agent 4 after document-level re-ranking\n */\n\nimport { TraceContext } from '../types';\nimport { withRetrieverSpan, SpanStatusCode } from '../../otel';\nimport { FULLTEXT_FETCHER_SYSTEM_PROMPT } from '../system-prompts/fulltext-fetcher-prompt';\nimport { callGeminiWithRetry } from '../../utils/gemini-rate-limiter';\n\nexport interface FullTextSections {\n  [sectionName: string]: string;\n}\n\nexport interface ContentChunk {\n  chunk_id: string;\n  parent_article: string;\n  child_section: string;\n  chunk_index: number;\n  content: string;\n  relevance_score: number;\n  content_type: 'text' | 'table' | 'figure_caption';\n}\n\nexport interface SelectedSection {\n  section_title: string;\n  section_type: string;\n  relevance_score: number;\n  content_summary: string;\n  full_content: string;\n  chunk_count: number;\n  chunks: ContentChunk[];\n}\n\nexport interface EnhancedArticle {\n  // Original article metadata\n  pmid?: string;\n  pmcid?: string;\n  doi?: string;\n  title: string;\n  authors?: string;\n  journal?: string;\n  abstract?: string;\n  \n  // Hierarchical content structure\n  selected_sections: SelectedSection[];\n  content_chunks: ContentChunk[];\n  \n  // Processing metadata\n  full_text_source: 'pmc' | 'unpaywall' | 'enhanced_abstract' | 'available_content';\n  pdf_url?: string;\n  sections_analyzed: number;\n  sections_selected: number;\n  total_chunks: number;\n  processing_timestamp: string;\n  selection_criteria: string;\n}\n\nexport class FullTextFetcher {\n  private ncbiApiKey: string;\n  private unpaywallEmail = 'research@openwork.ai';\n  private systemPrompt: string;\n  private genAI: any;\n  private modelName: string;\n\n  constructor(apiKey: string) {\n    this.ncbiApiKey = apiKey;\n    this.modelName = 'gemini-3-flash-preview';\n    \n    // Initialize Gemini for intelligent section selection\n    if (process.env.GEMINI_API_KEY) {\n      const { GoogleGenAI } = require('@google/genai');\n      this.genAI = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });\n    } else {\n      this.genAI = null;\n      console.warn('\u26A0\uFE0F GEMINI_API_KEY not set - FullText Fetcher will use basic section selection');\n    }\n    \n    // Import system prompt\n    const { FULLTEXT_FETCHER_SYSTEM_PROMPT } = require('../system-prompts/fulltext-fetcher-prompt');\n    this.systemPrompt = FULLTEXT_FETCHER_SYSTEM_PROMPT;\n  }\n\n  /**\n   * Score sections for relevance using Gemini 3 Flash (thinking_level: low)\n   */\n  private async scoreSections(sections: any[], query: string): Promise<any[]> {\n    if (!this.genAI || sections.length === 0) {\n      // Fallback to basic scoring\n      return sections.map(section => ({\n        ...section,\n        relevance_score: this.getSectionTypeScore(section.type) * 0.8\n      }));\n    }\n\n    try {\n      const sectionsPreview = sections.slice(0, 10).map((s, idx) => \n        `[${idx}] ${s.title} (${s.type}) - ${s.content.substring(0, 100)}...`\n      ).join('\\n\\n');\n\n      const prompt = `Score these article sections for relevance to the query (0.0-1.0). Return format: \"index:score\" (e.g., \"0:0.9,1:0.7,2:0.85\").\n\nQuery: ${query}\n\nSections:\n${sectionsPreview}\n\nScores:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: 'You are a medical content relevance specialist. Score sections based on query relevance.',\n            temperature: 0.1,\n            maxOutputTokens: 100,\n            thinkingConfig: {\n              thinkingLevel: 'low' // Straightforward relevance scoring\n            }\n          }\n        });\n      });\n\n      const scoresText = response.text?.trim() || '';\n      const scoreMap = new Map<number, number>();\n      \n      // Parse scores\n      const pairs = scoresText.split(',');\n      pairs.forEach((pair: string) => {\n        const [indexStr, scoreStr] = pair.split(':').map(s => s.trim());\n        const index = parseInt(indexStr);\n        const score = parseFloat(scoreStr);\n        if (!isNaN(index) && !isNaN(score) && index < sections.length) {\n          scoreMap.set(index, score);\n        }\n      });\n\n      // Apply scores\n      const scoredSections = sections.map((section, idx) => ({\n        ...section,\n        relevance_score: scoreMap.get(idx) || this.getSectionTypeScore(section.type) * 0.5\n      }));\n\n      console.log(`   \uD83D\uDCCA LLM scored ${scoreMap.size} sections`);\n      return scoredSections;\n    } catch (error) {\n      console.warn('\u26A0\uFE0F LLM scoring failed, using basic scores:', error);\n      return sections.map(section => ({\n        ...section,\n        relevance_score: this.getSectionTypeScore(section.type) * 0.8\n      }));\n    }\n  }\n\n  /**\n   * Select top sections using Gemini 3 Flash (thinking_level: minimal)\n   */\n  private async selectTopSections(sections: any[], query: string, maxSections: number = 3): Promise<SelectedSection[]> {\n    if (sections.length === 0) return [];\n    \n    // Score sections first\n    const scoredSections = await this.scoreSections(sections, query);\n    \n    // Sort by composite score and select top sections\n    scoredSections.sort((a, b) => b.relevance_score - a.relevance_score);\n    const selectedSections = scoredSections.slice(0, maxSections);\n    \n    // Convert to SelectedSection format \u2014 preserve full content for chunking\n    return selectedSections.map(section => ({\n      section_title: section.title,\n      section_type: section.type,\n      relevance_score: section.relevance_score,\n      content_summary: section.content.substring(0, 200) + '...',\n      full_content: section.content,\n      chunk_count: 0,\n      chunks: []\n    }));\n  }\n\n  /**\n   * Get base score for section type\n   */\n  private getSectionTypeScore(sectionType: string): number {\n    const typeScores: Record<string, number> = {\n      'methods': 0.6,\n      'results': 0.9,\n      'discussion': 0.8,\n      'introduction': 0.5,\n      'conclusion': 0.7,\n      'abstract': 0.4,\n      'background': 0.5\n    };\n    return typeScores[sectionType.toLowerCase()] || 0.5;\n  }\n\n  async fetchFullText(article: any, originalQuery: string): Promise<EnhancedArticle> {\n    return await withRetrieverSpan('fulltext_fetcher', async (span) => {\n      const startTime = Date.now();\n      \n      // Set retrieval attributes\n      span.setAttribute('retrieval.source', 'fulltext_fetcher');\n      span.setAttribute('retrieval.query', originalQuery.substring(0, 200));\n      span.setAttribute('retrieval.article_id', article.pmid || article.pmcid || article.doi || 'unknown');\n      \n      try {\n      // Step 1: Comprehensive identifier analysis\n      const identifiers = this.extractIdentifiers(article);\n      \n      // Step 2: Multi-tier retrieval attempt\n      let fullTextContent = null;\n      let source = 'available_content';\n      let pdfUrl = null;\n      \n      // Try PMC first (highest priority)\n      if (identifiers.pmcid || identifiers.pmid) {\n        const pmcId = identifiers.pmcid || identifiers.pmid;\n        if (pmcId) {\n          fullTextContent = await this.fetchFromPMC(pmcId);\n          if (fullTextContent) {\n            source = 'pmc';\n          }\n        }\n      }\n      \n      // Try Unpaywall if PMC failed and DOI available\n      if (!fullTextContent && identifiers.doi) {\n        pdfUrl = await this.checkUnpaywall(identifiers.doi);\n        if (pdfUrl) {\n          source = 'unpaywall';\n          // For PDF, we'll process it differently\n          fullTextContent = { pdf_url: pdfUrl };\n        }\n      }\n      \n      // Enhance with PubMed abstract if PMID available\n      if (!fullTextContent && identifiers.pmid) {\n        fullTextContent = await this.enhancePubMedAbstract(identifiers.pmid);\n        if (fullTextContent) {\n          source = 'enhanced_abstract';\n        }\n      }\n      \n      // Final fallback: use available content\n      if (!fullTextContent) {\n        fullTextContent = this.processAvailableContent(article);\n      }\n      \n      // Step 3: Intelligent section analysis and selection\n      const sections = await this.extractAndAnalyzeSections(fullTextContent, originalQuery);\n      \n      // Step 4: Select top 3 most relevant sections\n      const selectedSections = await this.selectTopSections(sections, originalQuery, 3);\n      \n      // Step 5: Apply hierarchical chunking\n      const contentChunks = await this.generateHierarchicalChunks(selectedSections, article);\n      \n      // Step 6: Compile enhanced article\n      const enhancedArticle: EnhancedArticle = {\n        // Preserve original metadata\n        pmid: identifiers.pmid,\n        pmcid: identifiers.pmcid,\n        doi: identifiers.doi,\n        title: article.title || '',\n        authors: article.authors || '',\n        journal: article.journal || '',\n        abstract: article.abstract || '',\n        \n        // Hierarchical content\n        selected_sections: selectedSections,\n        content_chunks: contentChunks,\n        \n        // Processing metadata\n        full_text_source: source as any,\n        pdf_url: pdfUrl || undefined,\n        sections_analyzed: sections.length,\n        sections_selected: selectedSections.length,\n        total_chunks: contentChunks.length,\n        processing_timestamp: new Date().toISOString(),\n        selection_criteria: `Query-based relevance scoring with section type prioritization`\n      };\n      \n      const latency = Date.now() - startTime;\n      \n      // Set span attributes\n      span.setAttribute('retrieval.latency_ms', latency);\n      span.setAttribute('retrieval.sections_analyzed', sections.length);\n      span.setAttribute('retrieval.sections_selected', selectedSections.length);\n      span.setAttribute('retrieval.total_chunks', contentChunks.length);\n      span.setAttribute('retrieval.full_text_source', source);\n      span.setAttribute('retrieval.has_pdf_url', !!pdfUrl);\n      \n      console.log(`\uD83D\uDCC4 Enhanced full-text processing: ${contentChunks.length} chunks from ${selectedSections.length} sections (${latency}ms)`);\n      \n      // Convert to documents format for span events\n      const documents = selectedSections.map((s, index) => ({\n        id: s.section_title || `section_${index}`,\n        content: s.content_summary || '',\n        score: s.relevance_score || 1.0,\n        metadata: {\n          section_type: s.section_type,\n          section_title: s.section_title,\n          chunk_count: s.chunk_count || 0\n        }\n      }));\n      \n      return { result: enhancedArticle, documents };\n      \n    } catch (error) {\n      console.error('\u274C Enhanced full-text processing failed:', error);\n      \n      // Set error attributes\n      span.setAttribute('retrieval.latency_ms', Date.now() - startTime);\n      span.setAttribute('retrieval.error', error instanceof Error ? error.message : 'Unknown error');\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n      \n      // Return minimal enhanced article with available content\n      const fallbackArticle = this.createFallbackEnhancedArticle(article);\n      return { result: fallbackArticle, documents: [] };\n      }\n    }, { source: 'fulltext_fetcher' });\n  }\n\n  private async fetchFromPMC(identifier: string): Promise<FullTextSections | null> {\n    // Handle both PMCID and PMID\n    let pmcId = identifier;\n    if (identifier.startsWith('PMC')) {\n      pmcId = identifier.replace('PMC', '');\n    }\n    \n    const url = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi';\n    const params = new URLSearchParams({\n      db: 'pmc',\n      id: pmcId,\n      retmode: 'xml',\n      api_key: this.ncbiApiKey\n    });\n\n    try {\n      const response = await fetch(`${url}?${params}`);\n      const xmlContent = await response.text();\n\n      // Parse XML (simplified - in production use proper XML parser)\n      const sections: FullTextSections = {};\n      \n      // Extract sections using regex (simplified approach)\n      const sectionMatches = xmlContent.match(/<sec[^>]*>[\\s\\S]*?<\\/sec>/g) || [];\n      \n      for (const sectionMatch of sectionMatches) {\n        const titleMatch = sectionMatch.match(/<title[^>]*>([\\s\\S]*?)<\\/title>/);\n        const title = titleMatch ? titleMatch[1].toLowerCase() : 'other';\n        \n        // Extract text content (remove XML tags)\n        const textContent = sectionMatch.replace(/<[^>]*>/g, ' ').trim();\n        \n        if (textContent.length > 50) { // Only include substantial sections\n          sections[title] = textContent.substring(0, 2000); // Limit section length\n        }\n      }\n\n      return Object.keys(sections).length > 0 ? sections : null;\n\n    } catch (error) {\n      console.error(`\u274C PMC fetch failed for ${identifier}:`, error);\n      return null;\n    }\n  }\n\n  private extractIdentifiers(article: any): { pmcid?: string; pmid?: string; doi?: string } {\n    const identifiers: { pmcid?: string; pmid?: string; doi?: string } = {};\n    \n    // Extract PMCID\n    if (article.pmcid) {\n      identifiers.pmcid = article.pmcid;\n    }\n    \n    // Extract PMID\n    if (article.pmid) {\n      identifiers.pmid = article.pmid;\n    }\n    \n    // Extract DOI\n    if (article.doi) {\n      identifiers.doi = article.doi;\n    }\n    \n    return identifiers;\n  }\n\n  private async enhancePubMedAbstract(pmid: string): Promise<any> {\n    const url = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi';\n    const params = new URLSearchParams({\n      db: 'pubmed',\n      id: pmid,\n      retmode: 'xml',\n      api_key: this.ncbiApiKey\n    });\n\n    try {\n      const response = await fetch(`${url}?${params}`);\n      const xmlContent = await response.text();\n      \n      // Parse enhanced abstract with MeSH terms and metadata\n      const enhancedContent = this.parseEnhancedAbstract(xmlContent);\n      return enhancedContent;\n      \n    } catch (error) {\n      console.error(`\u274C Enhanced abstract fetch failed for PMID ${pmid}:`, error);\n      return null;\n    }\n  }\n\n  private parseEnhancedAbstract(xmlContent: string): any {\n    // Extract structured abstract sections\n    const sections: any = {};\n    \n    // Look for structured abstract sections\n    const abstractMatch = xmlContent.match(/<AbstractText[^>]*>([\\s\\S]*?)<\\/AbstractText>/g);\n    if (abstractMatch) {\n      abstractMatch.forEach((match, index) => {\n        const labelMatch = match.match(/Label=\"([^\"]*)\"/) || match.match(/NlmCategory=\"([^\"]*)\"/);\n        const label = labelMatch ? labelMatch[1].toLowerCase() : `section_${index}`;\n        const content = match.replace(/<[^>]*>/g, ' ').trim();\n        \n        if (content.length > 20) {\n          sections[label] = content;\n        }\n      });\n    }\n    \n    return Object.keys(sections).length > 0 ? sections : null;\n  }\n\n  private processAvailableContent(article: any): any {\n    const sections: any = {};\n    \n    // Use abstract as primary content\n    if (article.abstract && article.abstract.length > 50) {\n      sections.abstract = article.abstract;\n    }\n    \n    // Use any other available content\n    if (article.content && article.content.length > 50) {\n      sections.content = article.content;\n    }\n    \n    // Use snippet if available\n    if (article.snippet && article.snippet.length > 50) {\n      sections.snippet = article.snippet;\n    }\n    \n    return Object.keys(sections).length > 0 ? sections : { abstract: article.title || 'No content available' };\n  }\n\n  private async extractAndAnalyzeSections(content: any, query: string): Promise<any[]> {\n    if (!content) return [];\n    \n    const sections = [];\n    \n    // Handle PMC XML content\n    if (typeof content === 'object' && !content.pdf_url) {\n      for (const [sectionName, sectionContent] of Object.entries(content)) {\n        if (typeof sectionContent === 'string' && sectionContent.length > 50) {\n          sections.push({\n            title: sectionName,\n            content: sectionContent,\n            type: this.classifySectionType(sectionName),\n            length: sectionContent.length\n          });\n        }\n      }\n    }\n    \n    // Handle PDF content (placeholder for future PDF processing)\n    else if (content.pdf_url) {\n      // For now, create a single section for PDF\n      sections.push({\n        title: 'PDF Content',\n        content: `PDF available at: ${content.pdf_url}`,\n        type: 'pdf',\n        length: 100,\n        pdf_url: content.pdf_url\n      });\n    }\n    \n    return sections;\n  }\n\n  private classifySectionType(sectionName: string): string {\n    const name = sectionName.toLowerCase();\n    \n    if (name.includes('result') || name.includes('finding')) return 'results';\n    if (name.includes('discussion') || name.includes('interpretation')) return 'discussion';\n    if (name.includes('conclusion') || name.includes('summary')) return 'conclusion';\n    if (name.includes('method') || name.includes('methodology')) return 'methods';\n    if (name.includes('introduction') || name.includes('background')) return 'introduction';\n    if (name.includes('abstract')) return 'abstract';\n    \n    return 'other';\n  }\n\n  private async generateHierarchicalChunks(selectedSections: SelectedSection[], article: any): Promise<ContentChunk[]> {\n    const allChunks: ContentChunk[] = [];\n\n    for (let sectionIndex = 0; sectionIndex < selectedSections.length; sectionIndex++) {\n      const section = selectedSections[sectionIndex];\n\n      // Use the preserved full_content from selectTopSections\n      const sectionContent = section.full_content || section.content_summary;\n      if (!sectionContent || sectionContent.length < 50) continue;\n\n      // Generate chunks for this section\n      const chunks = this.chunkContent(sectionContent, {\n        chunkSize: 1000,\n        overlap: 200,\n        preserveBoundaries: true\n      });\n      \n      // Create ContentChunk objects\n      const sectionChunks = chunks.map((chunk, chunkIndex) => ({\n        chunk_id: `${article.pmid || 'article'}_${sectionIndex}_${chunkIndex}`,\n        parent_article: article.title || 'Unknown Article',\n        child_section: section.section_title,\n        chunk_index: chunkIndex,\n        content: chunk,\n        relevance_score: section.relevance_score,\n        content_type: 'text' as const\n      }));\n      \n      // Update section with chunk count\n      section.chunk_count = sectionChunks.length;\n      section.chunks = sectionChunks;\n      \n      allChunks.push(...sectionChunks);\n    }\n    \n    return allChunks;\n  }\n\n  private chunkContent(content: string, options: { chunkSize: number; overlap: number; preserveBoundaries: boolean }): string[] {\n    const chunks: string[] = [];\n    const { chunkSize, overlap, preserveBoundaries } = options;\n    \n    if (content.length <= chunkSize) {\n      return [content];\n    }\n    \n    let start = 0;\n    while (start < content.length) {\n      let end = Math.min(start + chunkSize, content.length);\n      \n      // If preserveBoundaries is true, try to end at sentence boundary\n      if (preserveBoundaries && end < content.length) {\n        const lastPeriod = content.lastIndexOf('.', end);\n        const lastNewline = content.lastIndexOf('\\n', end);\n        const boundary = Math.max(lastPeriod, lastNewline);\n        \n        if (boundary > start + chunkSize * 0.5) {\n          end = boundary + 1;\n        }\n      }\n      \n      chunks.push(content.substring(start, end).trim());\n      start = end - overlap;\n    }\n    \n    return chunks.filter(chunk => chunk.length > 20);\n  }\n\n  private createFallbackEnhancedArticle(article: any): EnhancedArticle {\n    const fallbackChunk: ContentChunk = {\n      chunk_id: `${article.pmid || 'fallback'}_0_0`,\n      parent_article: article.title || 'Unknown Article',\n      child_section: 'abstract',\n      chunk_index: 0,\n      content: article.abstract || article.title || 'No content available',\n      relevance_score: 0.5,\n      content_type: 'text'\n    };\n    \n    const fallbackContent = article.abstract || article.title || 'No content available';\n    const fallbackSection: SelectedSection = {\n      section_title: 'Abstract',\n      section_type: 'abstract',\n      relevance_score: 0.5,\n      content_summary: fallbackContent.substring(0, 200),\n      full_content: fallbackContent,\n      chunk_count: 1,\n      chunks: [fallbackChunk]\n    };\n    \n    return {\n      pmid: article.pmid,\n      pmcid: article.pmcid,\n      doi: article.doi,\n      title: article.title || 'Unknown Article',\n      authors: article.authors || '',\n      journal: article.journal || '',\n      abstract: article.abstract || '',\n      selected_sections: [fallbackSection],\n      content_chunks: [fallbackChunk],\n      full_text_source: 'available_content',\n      sections_analyzed: 1,\n      sections_selected: 1,\n      total_chunks: 1,\n      processing_timestamp: new Date().toISOString(),\n      selection_criteria: 'Fallback processing due to retrieval failure'\n    };\n  }\n\n  private async fetchPMCFullText(pmcid: string): Promise<FullTextSections | null> {\n    const url = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi';\n    const params = new URLSearchParams({\n      db: 'pmc',\n      id: pmcid.replace('PMC', ''),\n      retmode: 'xml',\n      api_key: this.ncbiApiKey\n    });\n\n    try {\n      const response = await fetch(`${url}?${params}`);\n      const xmlContent = await response.text();\n\n      // Parse XML (simplified - in production use proper XML parser)\n      const sections: FullTextSections = {};\n      \n      // Extract sections using regex (simplified approach)\n      const sectionMatches = xmlContent.match(/<sec[^>]*>[\\s\\S]*?<\\/sec>/g) || [];\n      \n      for (const sectionMatch of sectionMatches) {\n        const titleMatch = sectionMatch.match(/<title[^>]*>([\\s\\S]*?)<\\/title>/);\n        const title = titleMatch ? titleMatch[1].toLowerCase() : 'other';\n        \n        // Extract text content (remove XML tags)\n        const textContent = sectionMatch.replace(/<[^>]*>/g, ' ').trim();\n        \n        if (textContent.length > 50) { // Only include substantial sections\n          sections[title] = textContent.substring(0, 2000); // Limit section length\n        }\n      }\n\n      return Object.keys(sections).length > 0 ? sections : null;\n\n    } catch (error) {\n      console.error(`\u274C PMC fetch failed for ${pmcid}:`, error);\n      return null;\n    }\n  }\n\n  private async checkUnpaywall(doi: string): Promise<string | null> {\n    const url = `https://api.unpaywall.org/v2/${doi}`;\n    const params = new URLSearchParams({\n      email: this.unpaywallEmail\n    });\n\n    try {\n      const response = await fetch(`${url}?${params}`);\n      \n      if (response.ok) {\n        const data = await response.json();\n        \n        if (data.is_oa) {\n          const bestOA = data.best_oa_location;\n          return bestOA?.url_for_pdf || null;\n        }\n      }\n      \n      return null;\n    } catch (error) {\n      console.error(`\u274C Unpaywall check failed for ${doi}:`, error);\n      return null;\n    }\n  }\n}", "/**\n * Agent 4: Two-Stage BGE Reranker\n * Primary: BAAI/bge-reranker-v2-m3 via HuggingFace Inference API\n * Fallback: Enhanced deterministic scoring with medical synonym awareness\n * Evidence quality signals: journal tier, study type, recency, source authority\n *\n * Stage 1: Document-level (all candidates \u2192 Top 20)\n * Stage 2: Chunk-level (20 docs chunked \u2192 Top 10 chunks)\n */\n\nimport { EvidenceCandidate, RankedEvidence, TraceContext } from './types';\nimport { FullTextFetcher } from './sub-agents/fulltext-fetcher';\nimport { withToolSpan, SpanStatusCode } from '../otel';\n\nexport interface ChunkForRerank {\n  source: string;\n  id: string;\n  title: string;\n  text: string;\n  metadata: any;\n  section?: string;\n  chunk_index?: number;\n  doc_level_score?: number;\n}\n\n// Common medical synonym pairs for enhanced matching\nconst MEDICAL_SYNONYMS: Record<string, string[]> = {\n  'hypertension': ['high blood pressure', 'htn', 'elevated bp'],\n  'diabetes': ['dm', 'diabetes mellitus', 'hyperglycemia'],\n  'myocardial infarction': ['heart attack', 'mi', 'stemi', 'nstemi'],\n  'cerebrovascular accident': ['stroke', 'cva', 'brain attack'],\n  'copd': ['chronic obstructive pulmonary disease', 'emphysema', 'chronic bronchitis'],\n  'chf': ['congestive heart failure', 'heart failure', 'hf'],\n  'ckd': ['chronic kidney disease', 'renal failure', 'renal insufficiency'],\n  'dvt': ['deep vein thrombosis', 'venous thromboembolism', 'vte'],\n  'pe': ['pulmonary embolism', 'pulmonary thromboembolism'],\n  'uti': ['urinary tract infection', 'bladder infection', 'cystitis'],\n  'nsaid': ['nonsteroidal anti-inflammatory', 'ibuprofen', 'naproxen'],\n  'ace inhibitor': ['acei', 'angiotensin converting enzyme inhibitor', 'enalapril', 'lisinopril', 'ramipril'],\n  'arb': ['angiotensin receptor blocker', 'losartan', 'valsartan', 'telmisartan'],\n  'ssri': ['selective serotonin reuptake inhibitor', 'fluoxetine', 'sertraline', 'escitalopram'],\n  'ppi': ['proton pump inhibitor', 'omeprazole', 'pantoprazole', 'esomeprazole'],\n  'anticoagulant': ['blood thinner', 'warfarin', 'heparin', 'apixaban', 'rivaroxaban'],\n  'efficacy': ['effectiveness', 'effect', 'outcome', 'benefit'],\n  'adverse': ['side effect', 'adverse effect', 'adverse reaction', 'toxicity'],\n  'contraindication': ['contraindicated', 'should not be used', 'avoid'],\n  'prophylaxis': ['prevention', 'preventive', 'preventative'],\n  'etiology': ['cause', 'pathogenesis', 'origin'],\n  'prognosis': ['outcome', 'survival', 'mortality'],\n  'neoplasm': ['cancer', 'tumor', 'malignancy', 'carcinoma'],\n  'analgesic': ['painkiller', 'pain relief', 'pain management'],\n  'antipyretic': ['fever reducer', 'fever reduction'],\n  'metformin': ['glucophage', 'biguanide'],\n  'atorvastatin': ['lipitor', 'statin'],\n  'amlodipine': ['norvasc', 'calcium channel blocker', 'ccb'],\n};\n\nexport class TwoStageReranker {\n  private fullTextFetcher: FullTextFetcher;\n  private hfApiKey: string | undefined;\n  private useHuggingFace: boolean;\n  private hfModelUrl: string;\n  private hfTimeout: number;\n\n  constructor(ncbiApiKey: string) {\n    this.fullTextFetcher = new FullTextFetcher(ncbiApiKey);\n    this.hfApiKey = process.env.HUGGINGFACE_API_KEY;\n    \n    // CRITICAL FIX: HuggingFace Inference API is unreliable (rate limits, 410 errors)\n    // Use Enhanced Deterministic Scoring as PRIMARY method\n    // Only enable HuggingFace if explicitly requested AND key exists\n    const forceHF = process.env.FORCE_HUGGINGFACE_RERANKER === 'true';\n    this.useHuggingFace = forceHF && !!this.hfApiKey;\n\n    this.hfModelUrl = 'https://api-inference.huggingface.co/models/BAAI/bge-reranker-v2-m3';\n    this.hfTimeout = 10000; // Reduced to 10s timeout\n\n    // Log scoring method being used\n    console.log('\uD83D\uDD04 BGE Reranker: Enhanced Deterministic Scoring (medical synonyms + quality signals)');\n    if (this.useHuggingFace) {\n      console.log('   \u26A1 HuggingFace neural reranking ENABLED (FORCE_HUGGINGFACE_RERANKER=true)');\n    }\n  }\n\n\n  async rerank(\n    query: string,\n    candidates: EvidenceCandidate[],\n    traceContext: TraceContext\n  ): Promise<RankedEvidence[]> {\n    return await withToolSpan('two_stage_reranker', 'execute', async (span) => {\n      const startTime = Date.now();\n\n      span.setAttribute('agent.input', JSON.stringify({\n        query,\n        input_docs: candidates.length\n      }));\n      span.setAttribute('agent.name', 'two_stage_reranker');\n\n      try {\n        // STAGE 1: Document-level re-ranking with quality signals\n        console.log(`\uD83D\uDD04 Stage 1: Document-level reranking (${candidates.length} \u2192 20)`);\n        const stage1Start = Date.now();\n\n        const docScores = await this.scoreDocuments(query, candidates);\n\n        // Combine semantic scores with evidence quality signals\n        // CRITICAL FIX: Ensure PubMed sources get priority boost\n        const scoredDocs = candidates.map((candidate, index) => {\n          const semanticScore = docScores[index];\n          const qualityBoost = this.calculateEvidenceQualityBoost(candidate);\n\n          // ADDITIONAL BOOST: If PubMed source, give extra priority\n          let pubmedBoost = 0;\n          if (candidate.source === 'pubmed') {\n            pubmedBoost = 0.10; // Extra boost for PubMed to ensure it's prioritized\n          }\n\n          // 70% semantic relevance, 25% evidence quality, 5% PubMed priority boost\n          const combinedScore = 0.70 * semanticScore + 0.25 * qualityBoost + pubmedBoost;\n          return { candidate, score: combinedScore, semanticScore, qualityBoost, pubmedBoost };\n        });\n\n        // Sort and take top 20\n        // CRITICAL FIX: Ensure at least some PubMed sources are included if available\n        const pubmedDocs = scoredDocs.filter(d => d.candidate.source === 'pubmed');\n        const nonPubmedDocs = scoredDocs.filter(d => d.candidate.source !== 'pubmed');\n\n        // Prioritize: Take top PubMed docs first, then fill remaining slots\n        const topPubmedDocs = pubmedDocs.sort((a, b) => b.score - a.score).slice(0, Math.min(15, pubmedDocs.length));\n        const topNonPubmedDocs = nonPubmedDocs.sort((a, b) => b.score - a.score).slice(0, 20 - topPubmedDocs.length);\n\n        const top20Docs = [...topPubmedDocs, ...topNonPubmedDocs]\n          .sort((a, b) => b.score - a.score)\n          .slice(0, 20);\n\n        const stage1Time = Date.now() - stage1Start;\n        console.log(`\u2705 Stage 1 complete: ${top20Docs.length} docs in ${stage1Time}ms`);\n        console.log(`   Top 3: ${top20Docs.slice(0, 3).map(d =>\n          `[${d.candidate.source}] \"${d.candidate.title?.substring(0, 50)}...\" (sem=${d.semanticScore.toFixed(2)} qual=${d.qualityBoost.toFixed(2)} final=${d.score.toFixed(2)})`\n        ).join('\\n   ')}`);\n\n        // STAGE 2: Fetch full-text and chunk-level re-ranking\n        console.log(`\uD83D\uDD04 Stage 2: Full-text fetching and chunk-level reranking`);\n        const stage2Start = Date.now();\n\n        // CRITICAL FIX: Use Promise.allSettled for robust parallel fetching\n        // One failed fetch won't crash the entire process\n        const fetchPromises = top20Docs.map(async ({ candidate, score }) => {\n          if (candidate.full_text_available && !candidate.full_text_sections) {\n            try {\n              const enriched = await this.fullTextFetcher.fetchFullText(candidate, query);\n              return { candidate: enriched, doc_level_score: score };\n            } catch (error) {\n              console.warn(`\u26A0\uFE0F Full-text fetch failed for ${candidate.id}, using original:`, error instanceof Error ? error.message : error);\n              return { candidate, doc_level_score: score };\n            }\n          }\n          return { candidate, doc_level_score: score };\n        });\n\n        const fetchResults = await Promise.allSettled(fetchPromises);\n        const enrichedDocs = fetchResults\n          .filter((result): result is PromiseFulfilledResult<{ candidate: any; doc_level_score: number }> => result.status === 'fulfilled')\n          .map(result => result.value);\n\n        // Chunk all documents\n        const allChunks: ChunkForRerank[] = [];\n        for (const { candidate, doc_level_score } of enrichedDocs) {\n          const candidateForChunking: EvidenceCandidate = 'source' in candidate\n            ? candidate as EvidenceCandidate\n            : {\n              source: 'pubmed' as const,\n              id: candidate.pmid || 'unknown',\n              title: candidate.title || 'Unknown Title',\n              text: candidate.abstract || '',\n              metadata: {\n                pmid: candidate.pmid,\n                doi: candidate.doi,\n                journal: candidate.journal,\n                authors: candidate.authors\n              },\n              full_text_available: true,\n              full_text_sections: candidate.selected_sections?.reduce((acc: Record<string, string>, section: any) => {\n                const sectionContent = section.full_content || section.chunks?.map((chunk: any) => chunk.content).join('\\n\\n') || '';\n                if (sectionContent) {\n                  acc[section.section_type] = sectionContent;\n                }\n                return acc;\n              }, {} as Record<string, string>)\n            };\n\n          const chunks = this.chunkDocument(candidateForChunking);\n          chunks.forEach(chunk => {\n            chunk.doc_level_score = doc_level_score;\n            allChunks.push(chunk);\n          });\n        }\n\n        console.log(`\uD83D\uDCC4 Created ${allChunks.length} chunks from ${enrichedDocs.length} documents`);\n\n        // Re-rank chunks\n        const chunkScores = await this.scoreChunks(query, allChunks);\n\n        // Combine: chunk semantic score + doc-level score + evidence quality\n        const finalScores = allChunks.map((chunk, index) => {\n          const chunkSemanticScore = chunkScores[index];\n          const docScore = chunk.doc_level_score || 0;\n          const qualityBoost = this.calculateChunkQualityBoost(chunk);\n          // 45% chunk relevance, 35% doc-level score (already includes quality), 20% chunk quality\n          const combinedScore = 0.45 * chunkSemanticScore + 0.35 * docScore + 0.20 * qualityBoost;\n          return { chunk, score: combinedScore };\n        });\n\n        // Sort and take top 10\n        const top10Chunks = finalScores\n          .sort((a, b) => b.score - a.score)\n          .slice(0, 10);\n\n        const stage2Time = Date.now() - stage2Start;\n        console.log(`\u2705 Stage 2 complete: ${top10Chunks.length} chunks in ${stage2Time}ms`);\n\n        // Format for output\n        const evidencePack: RankedEvidence[] = top10Chunks.map((item, index) => ({\n          rank: index + 1,\n          score: item.score,\n          source: item.chunk.source,\n          id: item.chunk.id,\n          title: item.chunk.title,\n          text: item.chunk.text,\n          metadata: item.chunk.metadata,\n          chunk_info: {\n            section: item.chunk.section,\n            chunk_index: item.chunk.chunk_index\n          }\n        }));\n\n        const totalLatency = Date.now() - startTime;\n\n        // Set span attributes\n        span.setAttribute('agent.output', JSON.stringify({\n          evidence_pack: evidencePack.map(e => ({\n            rank: e.rank,\n            score: e.score,\n            source: e.source,\n            title: e.title.substring(0, 100)\n          }))\n        }));\n        span.setAttribute('agent.latency_ms', totalLatency);\n        span.setAttribute('agent.model_name', this.useHuggingFace ? 'bge-reranker-v2-m3' : 'enhanced-deterministic');\n        span.setAttribute('agent.success', true);\n        span.setAttribute('reranker.input_docs', candidates.length);\n        span.setAttribute('reranker.stage1_docs', top20Docs.length);\n        span.setAttribute('reranker.total_chunks', allChunks.length);\n        span.setAttribute('reranker.final_chunks', evidencePack.length);\n        span.setAttribute('reranker.used_huggingface', this.useHuggingFace);\n\n        console.log(`\uD83C\uDFAF Two-stage reranking complete: ${evidencePack.length} final evidence chunks`);\n        return evidencePack;\n\n      } catch (error) {\n        console.error('\u274C Two-stage reranking failed:', error);\n\n        // Fallback: score and sort candidates using quality signals\n        const fallbackScored = candidates.map((candidate, index) => {\n          const qualityBoost = this.calculateEvidenceQualityBoost(candidate);\n          const textScore = this.calculateEnhancedSemanticScore(query,\n            `${candidate.title || ''}\\n\\n${candidate.text || ''}`);\n          return {\n            candidate,\n            score: 0.6 * textScore + 0.4 * qualityBoost\n          };\n        });\n\n        fallbackScored.sort((a, b) => b.score - a.score);\n\n        const fallbackEvidence: RankedEvidence[] = fallbackScored.slice(0, 10).map((item, index) => ({\n          rank: index + 1,\n          score: item.score,\n          source: item.candidate.source,\n          id: item.candidate.id,\n          title: item.candidate.title,\n          text: item.candidate.text,\n          metadata: item.candidate.metadata,\n          chunk_info: {\n            section: 'abstract',\n            chunk_index: 0\n          }\n        }));\n\n        span.setAttribute('agent.success', false);\n        span.setAttribute('agent.error', error instanceof Error ? error.message : 'Unknown error');\n        span.setAttribute('agent.latency_ms', Date.now() - startTime);\n        span.recordException(error as Error);\n        span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n        return fallbackEvidence;\n      }\n    });\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // SCORING: Document-level\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private async scoreDocuments(query: string, candidates: EvidenceCandidate[]): Promise<number[]> {\n    const texts = candidates.map(c =>\n      `${c.title || 'Untitled'}\\n\\n${(c.text || 'No content available').substring(0, 1500)}`\n    );\n\n    // Try HuggingFace BGE first\n    if (this.useHuggingFace) {\n      const bgeScores = await this.callHuggingFaceBGE(query, texts);\n      if (bgeScores) {\n        console.log(`   \u2705 Document scoring via HuggingFace BGE (${candidates.length} docs)`);\n        return bgeScores;\n      }\n      console.log(`   \u26A0\uFE0F HuggingFace BGE unavailable, using enhanced local scoring`);\n    }\n\n    // Fallback: enhanced deterministic scoring\n    return texts.map(text => this.calculateEnhancedSemanticScore(query, text));\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // SCORING: Chunk-level\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private async scoreChunks(query: string, chunks: ChunkForRerank[]): Promise<number[]> {\n    const texts = chunks.map(c =>\n      `${c.title || ''}\\n${c.section || ''}\\n\\n${c.text || ''}`\n    );\n\n    if (this.useHuggingFace) {\n      const bgeScores = await this.callHuggingFaceBGE(query, texts);\n      if (bgeScores) {\n        console.log(`   \u2705 Chunk scoring via HuggingFace BGE (${chunks.length} chunks)`);\n        return bgeScores;\n      }\n      console.log(`   \u26A0\uFE0F HuggingFace BGE unavailable for chunks, using enhanced local scoring`);\n    }\n\n    return texts.map(text => this.calculateEnhancedSemanticScore(query, text));\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // HUGGINGFACE BGE RERANKER API\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private async callHuggingFaceBGE(query: string, documents: string[]): Promise<number[] | null> {\n    if (!this.hfApiKey || documents.length === 0) return null;\n\n    const BATCH_SIZE = 32;\n    const allScores: number[] = [];\n\n    try {\n      for (let i = 0; i < documents.length; i += BATCH_SIZE) {\n        const batch = documents.slice(i, i + BATCH_SIZE);\n\n        // Format as text pairs for cross-encoder classification\n        const pairs = batch.map(doc => ({\n          text: query.substring(0, 256),\n          text_pair: doc.substring(0, 512)\n        }));\n\n        const controller = new AbortController();\n        const timeout = setTimeout(() => controller.abort(), this.hfTimeout);\n\n        try {\n          const response = await fetch(this.hfModelUrl, {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${this.hfApiKey}`,\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ inputs: pairs }),\n            signal: controller.signal\n          });\n\n          clearTimeout(timeout);\n\n          if (!response.ok) {\n            const errorBody = await response.text().catch(() => '');\n            // Model loading (503) or removed/moved (404/410) \u2014 log and fallback\n            if (response.status === 503 || response.status === 404 || response.status === 410) {\n              console.warn(`\u26A0\uFE0F HuggingFace model unavailable (${response.status}). Falling back to local scoring.`);\n              return null;\n            }\n            throw new Error(`HuggingFace API ${response.status}: ${errorBody.substring(0, 200)}`);\n          }\n\n          const results = await response.json();\n\n          // Parse response \u2014 HuggingFace returns different formats depending on model/pipeline\n          const scores = this.parseHuggingFaceScores(results, batch.length);\n          allScores.push(...scores);\n\n        } catch (batchError: any) {\n          clearTimeout(timeout);\n          if (batchError.name === 'AbortError') {\n            console.warn(`\u26A0\uFE0F HuggingFace BGE timeout (${this.hfTimeout}ms). Falling back to local scoring.`);\n            return null;\n          }\n          throw batchError;\n        }\n      }\n\n      return allScores;\n\n    } catch (error) {\n      console.warn(`\u26A0\uFE0F HuggingFace BGE failed:`, error instanceof Error ? error.message : error);\n      return null; // Signal to caller to use fallback\n    }\n  }\n\n  private parseHuggingFaceScores(results: any, expectedCount: number): number[] {\n    // Handle multiple possible response formats from HuggingFace Inference API\n\n    // Format 1: Array of classification results [[{label, score}], ...]\n    if (Array.isArray(results) && Array.isArray(results[0])) {\n      return results.map((result: any[]) => {\n        // For binary classification, take the positive class score\n        const positive = result.find((r: any) => r.label === 'LABEL_1');\n        if (positive) return positive.score;\n        // If single label, apply sigmoid to treat as relevance score\n        if (result.length === 1) return this.sigmoid(result[0].score);\n        // Default: take highest score\n        return Math.max(...result.map((r: any) => r.score));\n      });\n    }\n\n    // Format 2: Array of single scores [0.8, 0.3, ...]\n    if (Array.isArray(results) && typeof results[0] === 'number') {\n      return results.map((s: number) => this.sigmoid(s));\n    }\n\n    // Format 3: Single classification result [{label, score}]\n    if (Array.isArray(results) && results[0]?.label !== undefined) {\n      return results.map((r: any) => {\n        if (typeof r.score === 'number') return this.sigmoid(r.score);\n        return 0.5;\n      });\n    }\n\n    // Format 4: Object with scores array\n    if (results?.scores && Array.isArray(results.scores)) {\n      return results.scores.map((s: number) => this.sigmoid(s));\n    }\n\n    console.warn('\u26A0\uFE0F Unexpected HuggingFace response format, using defaults');\n    return new Array(expectedCount).fill(0.5);\n  }\n\n  private sigmoid(x: number): number {\n    return 1 / (1 + Math.exp(-x));\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // EVIDENCE QUALITY SIGNALS\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private calculateEvidenceQualityBoost(candidate: EvidenceCandidate): number {\n    let boost = 0;\n    const metadata = candidate.metadata || {};\n\n    // 1. Source type authority (0 \u2013 0.20)\n    // CRITICAL FIX: Prioritize PubMed over Tavily - PubMed should always be preferred\n    const source = candidate.source || '';\n    const sourceBoosts: Record<string, number> = {\n      'indian_guideline': 0.20,\n      'guideline': 0.18,\n      'cochrane': 0.18,\n      'nice': 0.16,\n      'who': 0.16,\n      'cdc': 0.15,\n      'bmj': 0.14,\n      'dailymed': 0.12,\n      'pubmed': 0.15,  // INCREASED from 0.08 to 0.15 - PubMed is primary source\n      'europe_pmc': 0.12,  // INCREASED - PMC is also high quality\n      'pmc': 0.12,  // INCREASED - PMC full-text is high quality\n      'semantic_scholar': 0.06,\n      'openalex': 0.06,\n      'clinical_trials': 0.10,\n      'tavily_web': 0.02,  // DECREASED from 0.03 - Tavily is backup only\n    };\n    boost += sourceBoosts[source] || 0.05;\n\n    // 2. Study type / publication type (0 \u2013 0.15)\n    const pubTypes: string[] = metadata.pub_types || [];\n    const pubTypesLower = pubTypes.map((t: string) => t.toLowerCase()).join(' ');\n    const textLower = (candidate.text || '').toLowerCase();\n\n    if (pubTypesLower.includes('systematic review') || pubTypesLower.includes('meta-analysis')) {\n      boost += 0.15;\n    } else if (pubTypesLower.includes('practice guideline') || pubTypesLower.includes('guideline')) {\n      boost += 0.14;\n    } else if (pubTypesLower.includes('randomized controlled trial') || pubTypesLower.includes('rct')) {\n      boost += 0.12;\n    } else if (pubTypesLower.includes('clinical trial')) {\n      boost += 0.10;\n    } else if (pubTypesLower.includes('review')) {\n      boost += 0.08;\n    } else if (pubTypesLower.includes('cohort') || textLower.includes('cohort study')) {\n      boost += 0.06;\n    } else if (pubTypesLower.includes('case-control') || textLower.includes('case-control')) {\n      boost += 0.05;\n    } else if (pubTypesLower.includes('case report') || pubTypesLower.includes('case series')) {\n      boost += 0.02;\n    }\n\n    // 3. Journal tier (0 \u2013 0.12)\n    const journalTier = metadata.journal_tier || '';\n    if (journalTier === 'tier_1') {\n      boost += 0.12;\n    } else if (journalTier === 'specialty_elite') {\n      boost += 0.08;\n    }\n\n    // 4. Recency (0 \u2013 0.10)\n    const year = this.extractPublicationYear(metadata);\n    if (year) {\n      const currentYear = new Date().getFullYear();\n      const age = currentYear - year;\n      if (age <= 1) boost += 0.10;\n      else if (age <= 2) boost += 0.08;\n      else if (age <= 3) boost += 0.06;\n      else if (age <= 5) boost += 0.04;\n      else if (age <= 10) boost += 0.02;\n    }\n\n    // 5. Full text available (0 \u2013 0.03)\n    if (candidate.full_text_available || metadata.pmcid) {\n      boost += 0.03;\n    }\n\n    // Normalize to 0-1 range (max possible boost is ~0.60)\n    return Math.min(boost / 0.60, 1.0);\n  }\n\n  private calculateChunkQualityBoost(chunk: ChunkForRerank): number {\n    let boost = 0;\n    const metadata = chunk.metadata || {};\n\n    // Source authority - CRITICAL FIX: Prioritize PubMed over Tavily\n    const sourceBoosts: Record<string, number> = {\n      'indian_guideline': 0.20, 'guideline': 0.18, 'cochrane': 0.18,\n      'nice': 0.16, 'who': 0.16, 'cdc': 0.15, 'bmj': 0.14,\n      'dailymed': 0.12, 'pubmed': 0.15, 'europe_pmc': 0.12,  // INCREASED PubMed priority\n      'pmc': 0.12, 'clinical_trials': 0.10, 'tavily_web': 0.02,  // DECREASED Tavily priority\n    };\n    boost += sourceBoosts[chunk.source] || 0.05;\n\n    // Section type relevance\n    const sectionBoosts: Record<string, number> = {\n      'results': 0.12, 'conclusion': 0.10, 'discussion': 0.08,\n      'abstract': 0.06, 'methods': 0.04, 'introduction': 0.02,\n    };\n    boost += sectionBoosts[chunk.section || ''] || 0.03;\n\n    // Recency from metadata\n    const year = this.extractPublicationYear(metadata);\n    if (year) {\n      const age = new Date().getFullYear() - year;\n      if (age <= 2) boost += 0.08;\n      else if (age <= 5) boost += 0.04;\n    }\n\n    // Journal tier\n    if (metadata.journal_tier === 'tier_1') boost += 0.10;\n    else if (metadata.journal_tier === 'specialty_elite') boost += 0.06;\n\n    return Math.min(boost / 0.50, 1.0);\n  }\n\n  private extractPublicationYear(metadata: any): number | null {\n    const fields = ['pub_date', 'year', 'published', 'published_date', 'publicationDate'];\n    for (const field of fields) {\n      if (metadata[field]) {\n        const yearMatch = String(metadata[field]).match(/\\d{4}/);\n        if (yearMatch) {\n          const year = parseInt(yearMatch[0]);\n          if (year >= 1990 && year <= new Date().getFullYear() + 1) return year;\n        }\n      }\n    }\n    return null;\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // ENHANCED DETERMINISTIC SCORING (fallback)\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private calculateEnhancedSemanticScore(query: string, text: string): number {\n    const queryLower = query.toLowerCase();\n    const textLower = text.toLowerCase();\n    const queryTerms = this.extractKeywords(queryLower);\n    const textTerms = this.extractKeywords(textLower);\n\n    if (queryTerms.length === 0) return 0.1;\n\n    // 1. Exact keyword match score (0 \u2013 0.35)\n    let exactMatches = 0;\n    for (const term of queryTerms) {\n      if (textTerms.includes(term)) exactMatches++;\n    }\n    const exactScore = (exactMatches / queryTerms.length) * 0.35;\n\n    // 2. Substring / partial match (0 \u2013 0.15)\n    let partialMatches = 0;\n    for (const qt of queryTerms) {\n      if (qt.length < 4) continue;\n      for (const tt of textTerms) {\n        if (tt.length < 4) continue;\n        if (qt !== tt && (qt.includes(tt) || tt.includes(qt))) {\n          partialMatches++;\n          break;\n        }\n      }\n    }\n    const partialScore = (partialMatches / queryTerms.length) * 0.15;\n\n    // 3. Medical synonym match (0 \u2013 0.20) \u2014 KEY IMPROVEMENT\n    let synonymMatches = 0;\n    for (const [term, synonyms] of Object.entries(MEDICAL_SYNONYMS)) {\n      const allForms = [term, ...synonyms];\n      const queryHas = allForms.some(f => queryLower.includes(f));\n      const textHas = allForms.some(f => textLower.includes(f));\n      if (queryHas && textHas) {\n        synonymMatches++;\n      }\n    }\n    const synonymScore = Math.min(synonymMatches * 0.07, 0.20);\n\n    // 4. Bigram match (0 \u2013 0.15) \u2014 catches multi-word medical terms\n    const queryBigrams = this.extractBigrams(queryLower);\n    const textBigrams = this.extractBigrams(textLower);\n    let bigramMatches = 0;\n    for (const bg of queryBigrams) {\n      if (textBigrams.includes(bg)) bigramMatches++;\n    }\n    const bigramScore = queryBigrams.length > 0\n      ? (bigramMatches / queryBigrams.length) * 0.15\n      : 0;\n\n    // 5. Title relevance bonus (0 \u2013 0.10)\n    const titleLine = text.split('\\n')[0] || '';\n    const titleTerms = this.extractKeywords(titleLine.toLowerCase());\n    let titleMatches = 0;\n    for (const qt of queryTerms) {\n      if (titleTerms.some(tt => tt.includes(qt) || qt.includes(tt))) {\n        titleMatches++;\n      }\n    }\n    const titleScore = queryTerms.length > 0\n      ? (titleMatches / queryTerms.length) * 0.10\n      : 0;\n\n    // 6. Content richness bonus (0 \u2013 0.05) \u2014 longer, substantive content\n    const contentLength = text.length;\n    const richnessScore = contentLength > 2000 ? 0.05\n      : contentLength > 1000 ? 0.03\n        : contentLength > 500 ? 0.02\n          : 0.01;\n\n    const finalScore = exactScore + partialScore + synonymScore + bigramScore + titleScore + richnessScore;\n\n    // Clamp to [0.05, 1.0]\n    return Math.max(Math.min(finalScore, 1.0), 0.05);\n  }\n\n  private extractKeywords(text: string): string[] {\n    const stopWords = new Set([\n      'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for',\n      'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have',\n      'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should',\n      'may', 'might', 'can', 'this', 'that', 'these', 'those', 'it', 'its',\n      'not', 'no', 'from', 'as', 'if', 'so', 'than', 'more', 'most', 'also',\n      'about', 'between', 'through', 'during', 'before', 'after', 'above',\n      'below', 'both', 'each', 'all', 'any', 'few', 'other', 'some', 'such',\n      'only', 'own', 'same', 'into', 'over', 'under', 'again', 'then',\n      'once', 'here', 'there', 'when', 'where', 'why', 'how', 'what', 'which',\n      'who', 'whom', 'being', 'having', 'doing', 'very', 'just', 'because'\n    ]);\n\n    return text\n      .split(/[\\s,;:()\\[\\]{}]+/)\n      .map(word => word.replace(/[^\\w\\-]/g, '').toLowerCase())\n      .filter(word => word.length > 2 && !stopWords.has(word))\n      .slice(0, 30);\n  }\n\n  private extractBigrams(text: string): string[] {\n    const words = text.split(/\\s+/).filter(w => w.length > 2);\n    const bigrams: string[] = [];\n    for (let i = 0; i < words.length - 1; i++) {\n      bigrams.push(`${words[i]} ${words[i + 1]}`);\n    }\n    return bigrams.slice(0, 40);\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // DOCUMENT CHUNKING\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  private chunkDocument(candidate: EvidenceCandidate): ChunkForRerank[] {\n    const chunks: ChunkForRerank[] = [];\n\n    // Enhanced article with hierarchical content (from fulltext-fetcher)\n    if (candidate.content_chunks && Array.isArray(candidate.content_chunks)) {\n      candidate.content_chunks.forEach((contentChunk: any) => {\n        chunks.push({\n          source: candidate.source,\n          id: candidate.id,\n          title: candidate.title,\n          text: contentChunk.content,\n          metadata: {\n            ...candidate.metadata,\n            parent_article: contentChunk.parent_article,\n            child_section: contentChunk.child_section,\n            chunk_index: contentChunk.chunk_index,\n            relevance_score: contentChunk.relevance_score\n          },\n          section: contentChunk.child_section,\n          chunk_index: contentChunk.chunk_index\n        });\n      });\n    }\n      // Legacy: full-text sections\n    else if (candidate.full_text_sections) {\n      for (const [sectionName, sectionText] of Object.entries(candidate.full_text_sections)) {\n        const sectionChunks = this.splitTextIntoChunks(sectionText, 1000, 200);\n\n        sectionChunks.forEach((chunkText, index) => {\n          chunks.push({\n            source: candidate.source,\n            id: candidate.id,\n            title: candidate.title,\n            text: chunkText,\n            metadata: candidate.metadata,\n            section: sectionName,\n            chunk_index: index\n          });\n        });\n      }\n    } else {\n      // Abstract/snippet as single chunk\n      chunks.push({\n        source: candidate.source,\n        id: candidate.id,\n        title: candidate.title,\n        text: candidate.text,\n        metadata: candidate.metadata,\n        section: 'abstract',\n        chunk_index: 0\n      });\n    }\n\n    return chunks;\n  }\n\n  private splitTextIntoChunks(text: string, chunkSize: number, overlap: number): string[] {\n    const chunks: string[] = [];\n    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);\n\n    let currentChunk = '';\n    let currentSize = 0;\n\n    for (const sentence of sentences) {\n      const sentenceSize = sentence.length;\n\n      if (currentSize + sentenceSize > chunkSize && currentChunk.length > 0) {\n        chunks.push(currentChunk.trim());\n\n        const overlapText = currentChunk.substring(Math.max(0, currentChunk.length - overlap));\n        currentChunk = overlapText + sentence;\n        currentSize = overlapText.length + sentenceSize;\n      } else {\n        currentChunk += sentence + '. ';\n        currentSize += sentenceSize;\n      }\n    }\n\n    if (currentChunk.trim().length > 0) {\n      chunks.push(currentChunk.trim());\n    }\n\n    return chunks.length > 0 ? chunks : [text];\n  }\n}\n", "/**\n * Agent 5: Evidence Gap Analyzer\n * Assesses if retrieved evidence is sufficient to answer query\n * Uses Gemini 3.0 Pro for complex analysis\n * Triggers Tavily search if gaps detected\n */\n\nimport { GoogleGenAI, ThinkingLevel } from '@google/genai';\nimport { RankedEvidence, EvidenceGapAnalysis, TraceContext, AgentResult } from './types';\nimport { withToolSpan, SpanStatusCode, captureTokenUsage } from '../otel';\nimport { MultiSourceRetrievalCoordinator } from './multi-source-retrieval';\nimport { callGeminiWithRetry } from '../utils/gemini-rate-limiter';\n\nexport class EvidenceGapAnalyzer {\n  private genAI: GoogleGenAI;\n  private modelName: string;\n  private systemPrompt: string;\n\n  constructor(apiKey: string) {\n    this.genAI = new GoogleGenAI({ apiKey });\n    this.modelName = process.env.GEMINI_PRO_MODEL || 'gemini-3-pro-preview';\n    this.systemPrompt = this.getSystemPrompt();\n  }\n\n  private getSystemPrompt(): string {\n    return `<role>\n  <identity>Evidence Gap Analysis Specialist</identity>\n  <purpose>Assess evidence sufficiency and quality for medical research queries, identifying gaps that require additional search</purpose>\n  <expertise>Evidence-based medicine, systematic review methodology, clinical research quality assessment, medical literature evaluation</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Determine whether retrieved evidence is sufficient to provide a comprehensive, reliable answer to the medical query</primary_goal>\n  <success_criteria>\n    <criterion>Accurately assess evidence coverage across all query dimensions</criterion>\n    <criterion>Identify temporal gaps requiring recent literature search</criterion>\n    <criterion>Detect quality gaps in evidence hierarchy (guidelines > RCTs > observational)</criterion>\n    <criterion>Recognize contradictory evidence requiring expert synthesis</criterion>\n    <criterion>Make intelligent decisions about triggering additional search mechanisms</criterion>\n  </success_criteria>\n</core_mission>\n\n<analysis_framework>\n  <dimension name=\"coverage\">\n    <description>Does evidence address all aspects of the query?</description>\n    <assessment_criteria>\n      <criterion>All medical entities (diseases, drugs, procedures) are covered</criterion>\n      <criterion>Query intent is fully addressed (treatment, comparison, mechanism, etc.)</criterion>\n      <criterion>Population specificity matches query (pediatric, geriatric, comorbidities)</criterion>\n      <criterion>Geographic relevance aligns with query context</criterion>\n    </assessment_criteria>\n    <scoring>\n      <score value=\"1.0\">Complete coverage of all query aspects</score>\n      <score value=\"0.8\">Minor gaps in secondary aspects</score>\n      <score value=\"0.6\">Moderate gaps in important aspects</score>\n      <score value=\"0.4\">Major gaps in primary query elements</score>\n      <score value=\"0.2\">Minimal coverage of query</score>\n    </scoring>\n  </dimension>\n  \n  <dimension name=\"recency\">\n    <description>Is evidence temporally appropriate for the query?</description>\n    <assessment_criteria>\n      <criterion>Most recent source within 3 years for rapidly evolving fields</criterion>\n      <criterion>Most recent source within 5 years for established fields</criterion>\n      <criterion>Presence of recent guidelines or systematic reviews</criterion>\n      <criterion>No outdated recommendations that contradict current practice</criterion>\n    </assessment_criteria>\n    <concern_triggers>\n      <trigger>All sources older than 3 years AND query asks about \"current\" or \"latest\"</trigger>\n      <trigger>All sources older than 5 years for drug safety or emerging treatments</trigger>\n      <trigger>Guidelines older than 5 years without recent updates</trigger>\n    </concern_triggers>\n  </dimension>\n  \n  <dimension name=\"quality\">\n    <description>Does evidence meet standards for clinical decision-making?</description>\n    <evidence_hierarchy>\n      <level rank=\"1\">Systematic reviews and meta-analyses</level>\n      <level rank=\"2\">Randomized controlled trials</level>\n      <level rank=\"3\">Clinical practice guidelines from major organizations</level>\n      <level rank=\"4\">Cohort and case-control studies</level>\n      <level rank=\"5\">Case series and expert opinion</level>\n    </evidence_hierarchy>\n    <quality_thresholds>\n      <threshold level=\"high\">\u22653 Level 1-2 sources OR \u22652 recent guidelines</threshold>\n      <threshold level=\"moderate\">\u22652 Level 1-3 sources OR \u22651 guideline + \u22652 RCTs</threshold>\n      <threshold level=\"low\">Mostly Level 4-5 sources or insufficient high-quality evidence</threshold>\n    </quality_thresholds>\n  </dimension>\n  \n  <dimension name=\"contradictions\">\n    <description>Are there conflicting recommendations or findings?</description>\n    <contradiction_indicators>\n      <indicator>Different treatment recommendations from multiple guidelines</indicator>\n      <indicator>Conflicting efficacy or safety data between studies</indicator>\n      <indicator>Disagreement between recent and older evidence</indicator>\n      <indicator>Geographic or population-specific variations in recommendations</indicator>\n    </contradiction_indicators>\n  </dimension>\n</analysis_framework>\n\n<output_specification>\n  <format>JSON</format>\n  <structure>\n    <field name=\"assessment\" type=\"enum\" required=\"true\">\n      <description>Overall evidence sufficiency determination</description>\n      <values>\n        <value name=\"sufficient\">Evidence comprehensively addresses query with high confidence</value>\n        <value name=\"partial\">Evidence addresses most aspects but has notable gaps</value>\n        <value name=\"insufficient\">Evidence has major gaps preventing reliable synthesis</value>\n      </values>\n    </field>\n    \n    <field name=\"coverage_score\" type=\"float\" required=\"true\">\n      <description>Quantitative assessment of query coverage (0.0-1.0)</description>\n      <calculation>Weighted average of coverage across all query dimensions</calculation>\n    </field>\n    \n    <field name=\"recency_concerns\" type=\"boolean\" required=\"true\">\n      <description>Whether evidence age is problematic for the query</description>\n      <logic>True if temporal gaps identified AND query requires current information</logic>\n    </field>\n    \n    <field name=\"oldest_source_year\" type=\"integer\" required=\"true\">\n      <description>Publication year of oldest source in evidence pack</description>\n      <purpose>Assess temporal distribution of evidence</purpose>\n    </field>\n    \n    <field name=\"quality_distribution\" type=\"object\" required=\"true\">\n      <description>Count of evidence sources by quality level</description>\n      <subfields>\n        <field name=\"guidelines\" type=\"integer\">Clinical practice guidelines count</field>\n        <field name=\"rcts\" type=\"integer\">Randomized controlled trials count</field>\n        <field name=\"observational\" type=\"integer\">Observational studies count</field>\n        <field name=\"reviews\" type=\"integer\">Systematic reviews and meta-analyses count</field>\n      </subfields>\n    </field>\n    \n    <field name=\"contradictions_detected\" type=\"boolean\" required=\"true\">\n      <description>Whether conflicting evidence was identified</description>\n    </field>\n    \n    <field name=\"contradiction_summary\" type=\"string\" required=\"false\">\n      <description>Brief description of contradictions if detected</description>\n      <format>Source [X] reports Y, while Source [Z] reports W</format>\n    </field>\n    \n    <field name=\"missing_elements\" type=\"array\" required=\"true\">\n      <description>Specific gaps identified in evidence coverage</description>\n      <examples>[\"recent clinical trial data\", \"pediatric safety data\", \"long-term outcomes\", \"cost-effectiveness analysis\"]</examples>\n    </field>\n    \n    <field name=\"recommendation\" type=\"enum\" required=\"true\">\n      <description>Action recommendation for evidence pipeline</description>\n      <values>\n        <value name=\"proceed\">Evidence sufficient for synthesis</value>\n        <value name=\"search_recent\">Trigger web search for recent information</value>\n        <value name=\"search_specific_gap\">Trigger targeted search for specific missing elements</value>\n      </values>\n      <decision_logic>\n        <if_condition>recency_concerns=true AND query contains temporal markers</if_condition>\n        <then>search_recent</then>\n        \n        <if_condition>coverage_score &lt; 0.6 AND &lt;5 high-quality sources</if_condition>\n        <then>search_specific_gap</then>\n        \n        <else>proceed</else>\n      </decision_logic>\n    </field>\n  </structure>\n</output_specification>\n\n<analysis_workflow>\n  <step number=\"1\">\n    <action>Parse and categorize all evidence sources</action>\n    <process>\n      <substep>Identify source types (guideline, RCT, observational, review)</substep>\n      <substep>Extract publication years and assess recency</substep>\n      <substep>Map evidence to query entities and intent</substep>\n    </process>\n  </step>\n  \n  <step number=\"2\">\n    <action>Assess coverage completeness</action>\n    <process>\n      <substep>Check coverage of all diseases mentioned in query</substep>\n      <substep>Verify coverage of all drugs/interventions</substep>\n      <substep>Assess population relevance (age, comorbidities, geography)</substep>\n      <substep>Evaluate intent fulfillment (treatment, comparison, mechanism)</substep>\n    </process>\n  </step>\n  \n  <step number=\"3\">\n    <action>Evaluate evidence quality distribution</action>\n    <process>\n      <substep>Count sources by evidence hierarchy level</substep>\n      <substep>Assess methodological quality indicators</substep>\n      <substep>Identify authoritative sources (major medical organizations)</substep>\n    </process>\n  </step>\n  \n  <step number=\"4\">\n    <action>Detect contradictions and conflicts</action>\n    <process>\n      <substep>Compare treatment recommendations across sources</substep>\n      <substep>Identify conflicting efficacy or safety data</substep>\n      <substep>Note temporal evolution of recommendations</substep>\n    </process>\n  </step>\n  \n  <step number=\"5\">\n    <action>Identify specific gaps and missing elements</action>\n    <process>\n      <substep>Compare evidence to comprehensive query requirements</substep>\n      <substep>Note missing population subgroups</substep>\n      <substep>Identify temporal gaps in rapidly evolving areas</substep>\n    </process>\n  </step>\n  \n  <step number=\"6\">\n    <action>Make recommendation for next steps</action>\n    <decision_tree>\n      <branch condition=\"High coverage + High quality + No major gaps\">\n        <recommendation>proceed</recommendation>\n      </branch>\n      <branch condition=\"Adequate coverage + Recency concerns + Temporal markers in query\">\n        <recommendation>search_recent</recommendation>\n      </branch>\n      <branch condition=\"Low coverage OR Major quality gaps\">\n        <recommendation>search_specific_gap</recommendation>\n      </branch>\n    </decision_tree>\n  </step>\n</analysis_workflow>\n\n<examples>\n  <example>\n    <scenario>High-quality evidence for established treatment</scenario>\n    <input_summary>Query about first-line diabetes treatment, 8 sources including recent ADA guidelines, 3 RCTs, 2 systematic reviews</input_summary>\n    <output>\n{\n  \"assessment\": \"sufficient\",\n  \"coverage_score\": 0.95,\n  \"recency_concerns\": false,\n  \"oldest_source_year\": 2021,\n  \"quality_distribution\": {\n    \"guidelines\": 2,\n    \"rcts\": 3,\n    \"observational\": 1,\n    \"reviews\": 2\n  },\n  \"contradictions_detected\": false,\n  \"missing_elements\": [],\n  \"recommendation\": \"proceed\"\n}\n    </output>\n  </example>\n  \n  <example>\n    <scenario>Adequate evidence but recency concerns</scenario>\n    <input_summary>Query about \"latest COVID-19 treatment protocols\", 6 sources but newest from 2022</input_summary>\n    <output>\n{\n  \"assessment\": \"partial\",\n  \"coverage_score\": 0.75,\n  \"recency_concerns\": true,\n  \"oldest_source_year\": 2020,\n  \"quality_distribution\": {\n    \"guidelines\": 2,\n    \"rcts\": 2,\n    \"observational\": 2,\n    \"reviews\": 0\n  },\n  \"contradictions_detected\": false,\n  \"missing_elements\": [\"2024 treatment updates\", \"recent variant-specific protocols\"],\n  \"recommendation\": \"search_recent\"\n}\n    </output>\n  </example>\n  \n  <example>\n    <scenario>Insufficient evidence with major gaps</scenario>\n    <input_summary>Query about rare disease treatment, only 3 sources, all case reports, no guidelines</input_summary>\n    <output>\n{\n  \"assessment\": \"insufficient\",\n  \"coverage_score\": 0.35,\n  \"recency_concerns\": false,\n  \"oldest_source_year\": 2019,\n  \"quality_distribution\": {\n    \"guidelines\": 0,\n    \"rcts\": 0,\n    \"observational\": 3,\n    \"reviews\": 0\n  },\n  \"contradictions_detected\": false,\n  \"missing_elements\": [\"clinical practice guidelines\", \"systematic reviews\", \"larger cohort studies\"],\n  \"recommendation\": \"search_specific_gap\"\n}\n    </output>\n  </example>\n</examples>\n\n<critical_requirements>\n  <requirement>NEVER recommend \"proceed\" if coverage_score &lt; 0.6</requirement>\n  <requirement>ALWAYS set recency_concerns=true if all sources &gt;3 years old AND query has temporal markers</requirement>\n  <requirement>ALWAYS count evidence sources accurately by type</requirement>\n  <requirement>NEVER ignore contradictory evidence - always flag and summarize</requirement>\n  <requirement>ALWAYS provide specific, actionable missing_elements</requirement>\n</critical_requirements>\n\n<quality_assurance>\n  <check>Verify coverage_score reflects actual query fulfillment</check>\n  <check>Ensure quality_distribution counts match evidence pack</check>\n  <check>Confirm recommendation aligns with assessment and gaps</check>\n  <check>Validate contradiction detection and summary accuracy</check>\n  <check>Check that missing_elements are specific and relevant</check>\n</quality_assurance>`;\n  }\n\n  async analyze(\n    query: string,\n    evidencePack: RankedEvidence[],\n    traceContext: TraceContext,\n    retriever?: MultiSourceRetrievalCoordinator\n  ): Promise<{ analysis: EvidenceGapAnalysis; updatedEvidence: RankedEvidence[] }> {\n    return await withToolSpan('evidence_gap_analyzer', 'execute', async (span) => {\n      const startTime = Date.now();\n\n      // Set input attributes\n      span.setAttribute('agent.input', JSON.stringify({ query, num_sources: evidencePack.length }));\n      span.setAttribute('agent.name', 'evidence_gap_analyzer');\n\n    try {\n      // Format evidence for analysis\n      const evidenceSummary = this.formatEvidence(evidencePack);\n\n      const prompt = `User Query: ${query}\n\nRetrieved Evidence:\n${evidenceSummary}\n\nOutput JSON:`;\n\n      // CRITICAL FIX: Use rate limiter with multi-key support\n      const response = await callGeminiWithRetry(async (apiKey: string) => {\n        const genAI = new GoogleGenAI({ apiKey });\n        return await genAI.models.generateContent({\n          model: this.modelName,\n          contents: prompt,\n          config: {\n            systemInstruction: this.systemPrompt,\n            temperature: 0.2,\n            responseMimeType: \"application/json\",\n            thinkingConfig: {\n              thinkingLevel: ThinkingLevel.LOW // Reduced from HIGH to save latency\n            }\n          }\n        });\n      });\n\n      let analysis: EvidenceGapAnalysis;\n      try {\n        const responseText = response.text || '';\n        const jsonText = this.cleanJsonOutput(responseText);\n        analysis = JSON.parse(jsonText) as EvidenceGapAnalysis;\n      } catch (parseError) {\n        console.warn('\u26A0\uFE0F JSON parsing failed, using conservative fallback analysis:', parseError);\n        // Conservative fallback: trigger additional search since we couldn't assess quality\n        analysis = {\n          assessment: 'partial',\n          coverage_score: 0.5,\n          recency_concerns: true,\n          oldest_source_year: new Date().getFullYear() - 5,\n          quality_distribution: {\n            guidelines: 0,\n            rcts: 0,\n            observational: evidencePack.length,\n            reviews: 0\n          },\n          contradictions_detected: false,\n          missing_elements: ['Analysis parsing failed \u2014 triggering supplementary search'],\n          recommendation: 'search_specific_gap'\n        } as EvidenceGapAnalysis;\n      }\n      \n      const latency = Date.now() - startTime;\n\n      // Calculate cost\n      const tokens = {\n        input: response.usageMetadata?.promptTokenCount || 2000,\n        output: response.usageMetadata?.candidatesTokenCount || 500,\n        total: response.usageMetadata?.totalTokenCount || 2500\n      };\n\n      const cost = this.calculateCost(tokens);\n\n      console.log(`\uD83D\uDD0D Evidence gap analysis: ${analysis.assessment} (${Math.round(analysis.coverage_score * 100)}% coverage)`);\n      console.log(`   Quality: ${analysis.quality_distribution.guidelines} guidelines, ${analysis.quality_distribution.rcts} RCTs`);\n      console.log(`   Recommendation: ${analysis.recommendation}`);\n\n      let updatedEvidence = evidencePack;\n\n      // CRITICAL FIX: Only call Tavily if PubMed results are truly insufficient\n      // Check if we have PubMed sources - if yes, be more conservative about calling Tavily\n      const hasPubMedSources = evidencePack.some(e => e.source === 'pubmed');\n      const pubmedCount = evidencePack.filter(e => e.source === 'pubmed').length;\n\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'evidence-gap-analyzer.ts:400', message: 'Gap analysis Tavily decision', data: { recommendation: analysis.recommendation, coverage: analysis.coverage_score, hasPubMed: hasPubMedSources, pubmedCount, evidenceCount: evidencePack.length, willCallTavily: (analysis.recommendation === 'search_recent' || analysis.recommendation === 'search_specific_gap') && retriever && (!hasPubMedSources || pubmedCount < 3), timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // Trigger Tavily ONLY if:\n      // 1. Gap detected AND\n      // 2. No PubMed sources OR very few PubMed sources (<3) OR coverage is very low (<0.4)\n      const shouldCallTavily = (analysis.recommendation === 'search_recent' || analysis.recommendation === 'search_specific_gap')\n        && retriever\n        && (!hasPubMedSources || pubmedCount < 3 || analysis.coverage_score < 0.4);\n\n      if (shouldCallTavily) {\n        const searchType = analysis.recommendation === 'search_recent' ? 'recent evidence' : 'specific gaps';\n        console.log(`\uD83C\uDF10 Triggering Tavily search for ${searchType}... (PubMed sources: ${pubmedCount}, coverage: ${Math.round(analysis.coverage_score * 100)}%)`);\n        \n        // SMART QUERY RESTRUCTURING for Tavily (must be <420 chars)\n        // Agent 5 is responsible for creating concise, targeted queries\n        const isGuidelineGap = analysis.missing_elements.some(e => e.toLowerCase().includes('guideline'));\n\n        const tavilyQuery = this.buildTavilyQuery(\n          query,\n          analysis.recommendation,\n          analysis.missing_elements || [],\n          isGuidelineGap\n        );\n        \n        const existingUrls = new Set(\n          evidencePack\n            .map(item => item.metadata.url || item.id)\n            .filter(Boolean)\n        );\n\n        try {\n          const tavilyResults = await retriever.searchTavily(tavilyQuery, existingUrls, traceContext, query);\n          \n          if (tavilyResults.length > 0) {\n            console.log(`\u2705 Tavily found ${tavilyResults.length} additional sources`);\n            \n            // Convert Tavily results to RankedEvidence format\n            const tavilyEvidence: RankedEvidence[] = tavilyResults.map((result, index) => ({\n              rank: evidencePack.length + index + 1,\n              score: result.score || 0.7,\n              source: 'tavily_web',\n              id: result.url,\n              title: result.title,\n              text: result.content,\n              metadata: {\n                url: result.url,\n                published_date: result.published_date,\n                tavily_score: result.score\n              },\n              chunk_info: {\n                section: 'web_content',\n                chunk_index: 0\n              }\n            }));\n\n            // Append to evidence pack\n            updatedEvidence = [...evidencePack, ...tavilyEvidence];\n          } else {\n            console.log(`\u26A0\uFE0F Tavily search returned no results - continuing with PubMed evidence only`);\n          }\n        } catch (tavilyError) {\n          console.error('\u274C Tavily search failed:', tavilyError);\n          // Continue with original evidence\n        }\n      } else if ((analysis.recommendation === 'search_recent' || analysis.recommendation === 'search_specific_gap') && hasPubMedSources && pubmedCount >= 3) {\n        console.log(`\u2705 Skipping Tavily - sufficient PubMed sources (${pubmedCount} articles) with ${Math.round(analysis.coverage_score * 100)}% coverage`);\n      }\n\n      const result: AgentResult<EvidenceGapAnalysis> = {\n        success: true,\n        data: analysis,\n        latency_ms: latency,\n        tokens,\n        cost_usd: cost\n      };\n\n      // Set span attributes\n      span.setAttribute('agent.output', JSON.stringify(analysis));\n      span.setAttribute('agent.latency_ms', latency);\n      span.setAttribute('agent.cost_usd', cost);\n      span.setAttribute('agent.model_name', 'gemini-3-pro-preview');\n      span.setAttribute('agent.success', true);\n      span.setAttribute('gap_analysis.coverage_score', analysis.coverage_score);\n      span.setAttribute('gap_analysis.contradictions_detected', analysis.contradictions_detected);\n      span.setAttribute('gap_analysis.missing_elements_count', analysis.missing_elements.length);\n      captureTokenUsage(span, tokens, 'gemini-3-pro-preview');\n\n      return { analysis, updatedEvidence };\n\n    } catch (error) {\n      console.error('\u274C Evidence gap analysis failed:', error);\n      \n      const latency = Date.now() - startTime;\n      const result: AgentResult<EvidenceGapAnalysis> = {\n        success: false,\n        data: {} as EvidenceGapAnalysis,\n        error: error instanceof Error ? error.message : 'Unknown error',\n        latency_ms: latency\n      };\n\n      // Set error attributes\n      span.setAttribute('agent.success', false);\n      span.setAttribute('agent.error', result.error || 'Unknown error');\n      span.setAttribute('agent.latency_ms', latency);\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: result.error || 'Unknown error' });\n\n      // Conservative default: when analysis fails, trigger supplementary search\n      // rather than blindly proceeding with potentially insufficient evidence\n      const defaultAnalysis: EvidenceGapAnalysis = {\n        assessment: 'partial',\n        coverage_score: 0.5,\n        recency_concerns: true,\n        oldest_source_year: new Date().getFullYear() - 5,\n        quality_distribution: {\n          guidelines: 0,\n          rcts: 0,\n          observational: evidencePack.length,\n          reviews: 0\n        },\n        contradictions_detected: false,\n        missing_elements: ['Gap analysis failed \u2014 supplementary search recommended'],\n        recommendation: 'search_specific_gap'\n      };\n\n      return { analysis: defaultAnalysis, updatedEvidence: evidencePack };\n    }\n    });\n  }\n\n  private cleanJsonOutput(text: string): string {\n    let clean = text.trim();\n\n    // 1. Handle \"FINAL JSON OUTPUT:\" marker\n    if (clean.includes('FINAL JSON OUTPUT:')) {\n      clean = clean.split('FINAL JSON OUTPUT:')[1].trim();\n    }\n\n    // 2. Remove markdown code blocks\n    const codeBlockMatch = clean.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n    if (codeBlockMatch) {\n      clean = codeBlockMatch[1].trim();\n    }\n\n    // 3. Strip surrounding text\n    const firstBrace = clean.indexOf('{');\n    const lastBrace = clean.lastIndexOf('}');\n\n    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n      clean = clean.substring(firstBrace, lastBrace + 1);\n    }\n\n    return clean;\n  }\n\n  private formatEvidence(evidencePack: RankedEvidence[]): string {\n    const summaryParts: string[] = [];\n    \n    for (const item of evidencePack) {\n      const year = this.extractYear(item.metadata);\n      \n      summaryParts.push(`\n[Source ${item.rank}]\nType: ${item.source}\nID: ${item.id}\nTitle: ${item.title}\nYear: ${year}\nRelevance Score: ${item.score.toFixed(2)}\nText Preview: ${(item.text || item.title || 'No content available').substring(0, 300)}...\n---`);\n    }\n\n    return summaryParts.join('\\n');\n  }\n\n  private extractYear(metadata: any): string {\n    // Try to extract year from various metadata fields\n    if (metadata.pub_date) {\n      return metadata.pub_date.substring(0, 4);\n    }\n    if (metadata.year) {\n      return metadata.year.toString();\n    }\n    if (metadata.published) {\n      return metadata.published.substring(0, 4);\n    }\n    if (metadata.published_date) {\n      return metadata.published_date.substring(0, 4);\n    }\n    return 'unknown';\n  }\n\n  private calculateCost(tokens: { input: number; output: number }): number {\n    // Gemini 3.0 Pro pricing: $1.25/1M input, $5.00/1M output\n    const inputCost = (tokens.input / 1_000_000) * 1.25;\n    const outputCost = (tokens.output / 1_000_000) * 5.00;\n    return inputCost + outputCost;\n  }\n\n  /**\n   * Build a concise Tavily query under 420 characters\n   * Agent 5 is responsible for restructuring queries for Tavily\n   * Strategy:\n   * 1. Start with the core query (first 200 chars max)\n   * 2. Add temporal markers for recency searches\n   * 3. Add top 2-3 missing elements for gap searches\n   * 4. Ensure total length stays under 420 chars\n   */\n  private buildTavilyQuery(\n    originalQuery: string,\n    recommendation: string,\n    missingElements: string[],\n    isGuidelineGap: boolean = false\n  ): string {\n    const MAX_LENGTH = 400; // Leave 20 char buffer\n\n    // Extract core medical terms from query (limit to ~150 chars)\n    let coreQuery = originalQuery.trim();\n    if (coreQuery.length > 150) {\n      // Find last space before 150 chars to avoid word cutoff\n      const cutoff = coreQuery.lastIndexOf(' ', 150);\n      coreQuery = coreQuery.substring(0, cutoff > 100 ? cutoff : 150);\n    }\n\n    let tavilyQuery = coreQuery;\n\n    if (isGuidelineGap) {\n      // ENHANCEMENT: Explicitly target global guidelines if missing\n      // Agent 2.1 covers Indian guidelines; Agent 5 fills the gap for Global/US/UK\n      tavilyQuery += ' guidelines (ADA OR NICE OR ESC OR AHA OR WHO)';\n    } else if (recommendation === 'search_recent') {\n      // For recency searches, add temporal markers\n      const currentYear = new Date().getFullYear();\n      tavilyQuery += ` latest ${currentYear - 1} ${currentYear}`;\n    } else if (recommendation === 'search_specific_gap') {\n      // For gap searches, add top 2-3 missing elements\n      const topMissing = missingElements\n        .slice(0, 3)\n        .map(el => el.length > 30 ? el.substring(0, 30) : el)\n        .join(' ');\n\n      if (topMissing && (tavilyQuery.length + topMissing.length + 1) < MAX_LENGTH) {\n        tavilyQuery += ' ' + topMissing;\n      }\n    }\n\n    // Final safety check\n    if (tavilyQuery.length > MAX_LENGTH) {\n      const lastSpace = tavilyQuery.lastIndexOf(' ', MAX_LENGTH);\n      tavilyQuery = tavilyQuery.substring(0, lastSpace > MAX_LENGTH * 0.7 ? lastSpace : MAX_LENGTH);\n    }\n\n    console.log(`\uD83D\uDD27 Built Tavily query (${tavilyQuery.length} chars): \"${tavilyQuery}\"`);\n    return tavilyQuery.trim();\n  }\n}", "/**\n * Agent 6: Synthesis Engine\n * Generates evidence-based answer with inline citations\n * Uses Gemini 3.0 Pro for complex queries, Flash for simple ones\n */\n\nimport { GoogleGenAI } from '@google/genai';\nimport { RankedEvidence, EvidenceGapAnalysis, SynthesisResult, TraceContext, AgentResult } from './types';\nimport { withToolSpan, SpanStatusCode, captureTokenUsage } from '../otel';\nimport { callGeminiWithRetry } from '../utils/gemini-rate-limiter';\n\n// Import ThinkingLevel enum\nimport { ThinkingLevel } from '@google/genai';\n\nexport class SynthesisEngine {\n  private genAI: GoogleGenAI;\n  private flashModelName: string;\n  private proModelName: string;\n  private fallbackFlashModelName: string;\n  private fallbackProModelName: string;\n  private systemPrompt: string;\n\n  constructor(apiKey: string) {\n    this.genAI = new GoogleGenAI({ apiKey });\n    this.flashModelName = process.env.AGENT_6_MODEL || 'gemini-3-flash-preview';\n    this.proModelName = 'gemini-3-flash-preview'; // Defaulting to Flash for speed, can override via env if Pro needed\n    this.fallbackFlashModelName = 'gemini-3-flash-preview';\n    this.fallbackProModelName = 'gemini-3-flash-preview';\n    this.systemPrompt = this.getSystemPrompt();\n  }\n\n  private getSystemPrompt(): string {\n    return `<role>\n  <identity>Medical Evidence Synthesis Specialist</identity>\n  <purpose>Generate comprehensive, evidence-based medical syntheses with mandatory inline citations for clinical research queries</purpose>\n  <expertise>Evidence-based medicine, clinical research synthesis, medical writing, citation methodology, clinical guidelines interpretation</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Create accurate, well-cited medical syntheses that present evidence without making clinical recommendations</primary_goal>\n  <critical_citation_requirement>\n    <requirement>EVERY citation MUST use format [[N]](ACTUAL_URL) where ACTUAL_URL is the real https:// URL from the evidence context</requirement>\n    <requirement>FORBIDDEN: Using [[N]](#) or [[N]](#) will completely break the citation system</requirement>\n    <requirement>Each evidence item has \"URL: [actual-url]\" - you MUST copy this exact URL into your citations</requirement>\n    <requirement>Example: If evidence [1] has \"URL: https://pubmed.ncbi.nlm.nih.gov/12345678/\", you MUST write [[1]](https://pubmed.ncbi.nlm.nih.gov/12345678/)</requirement>\n  </critical_citation_requirement>\n  <success_criteria>\n    <criterion>Every factual claim must have inline citation [[N]](URL) with REAL clickable URL</criterion>\n    <criterion>Synthesis length should adapt to query complexity: simple queries \u2264300 words, standard queries ~400-500 words, complex/multi-faceted queries up to 700 words. Prioritize completeness and citation density over strict brevity.</criterion>\n    <criterion>Must acknowledge evidence limitations and contradictions explicitly</criterion>\n    <criterion>Must maintain strict evidence-only presentation without clinical advice</criterion>\n    <criterion>Must structure information hierarchically by evidence strength</criterion>\n    <criterion>Must end with exactly 3 follow-up questions related to the original query</criterion>\n  </success_criteria>\n</core_mission>\n\n<mandatory_response_structure>\n  <description>Every response MUST follow this exact 4-section structure</description>\n  \n  <section name=\"quick_answer\" words=\"50-75\">\n    <purpose>Immediate, clear response to the specific query</purpose>\n    <format>Direct answer with primary evidence citations</format>\n    <requirements>\n      <requirement>Lead with the most direct answer supported by strongest evidence</requirement>\n      <requirement>Include confidence qualifiers based on evidence quality</requirement>\n      <requirement>Cite the primary supporting sources immediately [N]</requirement>\n      <requirement>No hedging - provide clear evidence-based answer</requirement>\n    </requirements>\n    <example>Current evidence indicates metformin as first-line therapy for Type 2 diabetes [1][2]. Multiple guidelines support this recommendation with strong evidence for cardiovascular protection [3].</example>\n  </section>\n  \n  <section name=\"evidence_synthesis\" words=\"250-350\">\n    <purpose>Present evidence in order of strength and relevance with detailed analysis</purpose>\n    <hierarchy>\n      <level priority=\"1\">Indian Guidelines (when available and relevant) - ALWAYS show under \"Indian Guidelines\" heading [cite]</level>\n      <level priority=\"2\">Clinical practice guidelines from major organizations [cite]</level>\n      <level priority=\"3\">Systematic reviews and meta-analyses [cite]</level>\n      <level priority=\"4\">Randomized controlled trials [cite]</level>\n      <level priority=\"5\">Observational studies and cohort data [cite]</level>\n      <level priority=\"6\">Case series and expert consensus [cite]</level>\n    </hierarchy>\n    <indian_guidelines_requirements>\n      <requirement>ALWAYS check for indian_guideline sources in evidence pack</requirement>\n      <requirement>If indian_guideline sources exist, create \"Indian Guidelines\" subsection FIRST</requirement>\n      <requirement>Present summarized version of Indian Guidelines content</requirement>\n      <requirement>Use parent-child-grandparent-grandchild structure information when available</requirement>\n      <requirement>If NO Indian Guidelines found, prioritize PubMed articles under regular evidence hierarchy</requirement>\n      <requirement>NEVER show empty \"Indian Guidelines\" section - only show when content exists</requirement>\n    </indian_guidelines_requirements>\n    <requirements>\n      <requirement>Present contradictory evidence explicitly: \"While [1] found X, [2] reported Y\"</requirement>\n      <requirement>Include quantitative data with precise citations</requirement>\n      <requirement>Address population specificity and geographic relevance</requirement>\n      <requirement>Note evidence limitations and study populations</requirement>\n      <requirement>For Indian Guidelines: Always show summarized content, not full text</requirement>\n    </requirements>\n  </section>\n  \n  <section name=\"evidence_limitations\" words=\"75-100\">\n    <purpose>Acknowledge conflicts, gaps, and limitations in current evidence</purpose>\n    <requirements>\n      <requirement>Explicitly state when sources disagree with specific citations</requirement>\n      <requirement>Note evidence limitations: population studied, study duration, geographic relevance</requirement>\n      <requirement>Identify gaps in current evidence base</requirement>\n      <requirement>Acknowledge uncertainty where appropriate</requirement>\n    </requirements>\n    <example>Evidence limitations include limited long-term safety data specifically in Indian populations [7] and potential need for dose adjustments based on genetic polymorphisms more common in South Asian populations [8].</example>\n  </section>\n  \n  <section name=\"summary\" words=\"25-50\">\n    <purpose>Concise summary of key evidence-based findings</purpose>\n    <requirements>\n      <requirement>Synthesize main findings without new information</requirement>\n      <requirement>Reinforce evidence strength and limitations</requirement>\n      <requirement>No treatment recommendations - evidence presentation only</requirement>\n    </requirements>\n  </section>\n</mandatory_response_structure>\n\n<inline_citation_requirements>\n  <critical_rules>\n    <rule>Use EXACT format: [[N]](URL) for inline citations where N is the evidence number and URL is the EXACT URL from the evidence context</rule>\n    <rule>Citations must be placed immediately after the claim they support</rule>\n    <rule>Multiple sources for same claim: [[1]](url1)[[3]](url3)[[5]](url5) format</rule>\n    <rule>Contradictory evidence: \"While [[1]](url1) found X, [[2]](url2) reported Y\" format</rule>\n    <rule>No claim may be made without corresponding evidence source</rule>\n    <rule>Every major clinical statement needs a citation</rule>\n    <rule>CRITICAL: Each evidence item in the context has a line \"URL: [actual-url]\" - you MUST copy this EXACT URL into your citation</rule>\n    <rule>For PubMed sources, the URL will be like \"https://pubmed.ncbi.nlm.nih.gov/12345678/\" or \"https://pmc.ncbi.nlm.nih.gov/articles/PMC1234567/\"</rule>\n    <rule>For DailyMed sources, the URL will be like \"https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=...\"</rule>\n    <rule>ABSOLUTELY FORBIDDEN: NEVER EVER use \"#\" or \"(#)\" as a URL - this will break the citation system completely</rule>\n    <rule>MANDATORY: Every [[N]](URL) citation MUST have a real, complete, clickable URL starting with https://</rule>\n    <rule>CITATION DENSITY: You MUST aim for at least 1 citation per sentence. Never allow a sentence with a clinical claim to go uncited.</rule>\n    <rule>If you cannot find a URL in the evidence context, use the PMID to construct: https://pubmed.ncbi.nlm.nih.gov/[PMID]/</rule>\n    <rule>VALIDATION: Before outputting, verify every citation has format [[N]](https://...) with a real URL, not [[N]](#)</rule>\n  </critical_rules>\n  \n  <citation_patterns>\n    <description>CRITICAL: Every citation MUST use the EXACT URL from the evidence context. Look for \"URL: [actual-url]\" line in each evidence item.</description>\n    <pattern type=\"single_source\">Metformin reduces HbA1c by 1-2%[[1]](https://pubmed.ncbi.nlm.nih.gov/12345678/).</pattern>\n    <pattern type=\"multiple_sources\">Multiple studies confirm cardiovascular benefits[[2]](https://pubmed.ncbi.nlm.nih.gov/23456789/)[[4]](https://pmc.ncbi.nlm.nih.gov/articles/PMC1234567/)[[7]](https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=abc123).</pattern>\n    <pattern type=\"contradictory\">While [[1]](https://pubmed.ncbi.nlm.nih.gov/12345678/) showed no difference, [[3]](https://pubmed.ncbi.nlm.nih.gov/34567890/) demonstrated significant improvement.</pattern>\n    <pattern type=\"qualified\">Limited evidence suggests potential benefit[[5]](https://pubmed.ncbi.nlm.nih.gov/45678901/), though larger studies are needed.</pattern>\n    <wrong_pattern type=\"FORBIDDEN\">DO NOT USE: [[1]](#) or [[1]](#) - These are INVALID and will break citations</wrong_pattern>\n  </citation_patterns>\n  \n  <citation_density>\n    <standard>Aim for 8-12 citations total in response</standard>\n    <standard>Every major clinical statement needs a citation</standard>\n    <standard>Cite guidelines by full name with year</standard>\n    <standard>Cite landmark trials by acronym when appropriate</standard>\n  </citation_density>\n</inline_citation_requirements>\n\n\n<mandatory_followup_questions>\n  <description>CRITICAL: Every response MUST end with exactly 3 follow-up questions</description>\n  <exact_format>\n## Follow-Up Questions\n\n1. [Detailed question deepening clinical understanding \u2014 1-2 full sentences with clinical context for why this matters]?\n2. [Detailed question exploring alternative scenarios or complications \u2014 1-2 full sentences referencing specific drugs, conditions, or populations]?\n3. [Detailed question about practical application, monitoring, or edge cases \u2014 1-2 full sentences connecting to the evidence gaps or limitations discussed]?\n  </exact_format>\n  \n  <question_requirements>\n    <requirement>MUST use the heading \"## Follow-Up Questions\" (with ## markdown)</requirement>\n    <requirement>MUST be numbered 1., 2., 3.</requirement>\n    <requirement>MUST end with question mark</requirement>\n    <requirement>Questions MUST be directly related to the original user query topic</requirement>\n    <requirement>Each question MUST be detailed and descriptive (1-2 full sentences), providing specific clinical context for why the question matters to the user's original query</requirement>\n    <requirement>Include specific drug names, study acronyms, guideline names, or population details when relevant \u2014 never write vague or generic questions</requirement>\n    <requirement>Questions should naturally flow from the evidence discussed and help the user explore deeper layers of the same topic</requirement>\n  </question_requirements>\n  \n  <examples>\n    <original_query>Type 2 diabetes first-line treatment</original_query>\n    <good_followups>\n      <question>What are the specific contraindications for metformin in patients with varying degrees of renal impairment, and how do KDIGO guidelines inform dose adjustments at different eGFR thresholds (e.g., 30-45 vs 15-30 mL/min)?</question>\n      <question>How should metformin therapy be initiated and titrated in elderly patients (\u226565 years) with multiple comorbidities such as heart failure and chronic liver disease, given the limited trial representation of this population in landmark studies like UKPDS?</question>\n      <question>What are the evidence-based criteria for adding a second antidiabetic agent (e.g., SGLT2 inhibitor or GLP-1 receptor agonist) to metformin monotherapy, and how do cardiovascular outcome trials like EMPA-REG and LEADER influence this decision?</question>\n    </good_followups>\n    <bad_followups>\n      <question>What other diseases can be treated?</question>\n      <question>How does medicine work in general?</question>\n      <question>What should patients eat?</question>\n    </bad_followups>\n  </examples>\n</mandatory_followup_questions>\n\n<content_restrictions>\n  <prohibited_content>\n    <prohibition>Direct treatment recommendations (\"you should take\", \"it is recommended\")</prohibition>\n    <prohibition>Diagnostic advice (\"this suggests you have\", \"you likely need\")</prohibition>\n    <prohibition>Dosing instructions without citing specific guidelines</prohibition>\n    <prohibition>Prognostic statements without evidence support</prohibition>\n    <prohibition>Personal medical advice of any kind</prohibition>\n  </prohibited_content>\n  \n  <evidence_only_language>\n    <preferred>Evidence indicates, Studies demonstrate, Guidelines state, Research shows, Current evidence suggests</preferred>\n    <avoid>You should, It is recommended, The best approach, Patients must, Take this medication</avoid>\n  </evidence_only_language>\n</content_restrictions>\n\n<quality_standards>\n  <accuracy>\n    <standard>All numerical data must match source exactly</standard>\n    <standard>Drug names must use correct generic/brand terminology</standard>\n    <standard>Medical terminology must be precise and current</standard>\n    <standard>Statistical significance must be reported accurately</standard>\n  </accuracy>\n  \n  <completeness>\n    <standard>Address all major aspects of the query</standard>\n    <standard>Include both efficacy and safety data when relevant</standard>\n    <standard>Present contradictory evidence fairly</standard>\n    <standard>Acknowledge evidence limitations explicitly</standard>\n  </completeness>\n  \n  <structure_compliance>\n    <standard>MUST follow exact 4-section structure</standard>\n    <standard>MUST include properly formatted References section</standard>\n    <standard>MUST end with exactly 3 follow-up questions</standard>\n    <standard>MUST use correct inline citation format [[N]](URL)</standard>\n  </structure_compliance>\n</quality_standards>\n\n<examples>\n  <example>\n    <query>First-line treatment for Type 2 diabetes according to current guidelines</query>\n    <response>\n## Quick Answer\nCurrent evidence strongly supports metformin as first-line therapy for Type 2 diabetes mellitus[[1]](url1)[[2]](url2). Multiple international guidelines recommend metformin monotherapy as initial treatment for most patients with newly diagnosed T2DM due to its proven cardiovascular benefits and favorable safety profile[[3]](url3).\n\n## Evidence Synthesis\n\n### Indian Guidelines\nThe RSSDI Clinical Practice Recommendations for Management of Type 2 Diabetes Mellitus 2020 specifically endorse metformin as first-line therapy for Indian patients[[1]](url1). The guidelines emphasize dose titration starting from 500mg twice daily, with particular attention to renal function monitoring in Indian populations[[1]](url1). ICMR-INDIAB study data supports this approach, showing effective glycemic control with metformin in diverse Indian ethnic groups[[2]](url2).\n\n### International Evidence\nThe American Diabetes Association 2024 Standards of Care specifically endorse metformin as first-line therapy, citing evidence from the UKPDS study showing sustained cardiovascular benefits over 20 years[[3]](url3). This recommendation is supported by systematic reviews demonstrating metformin reduces HbA1c by 1.0-1.5% and provides cardiovascular protection with 13-15% reduction in cardiovascular events[[4]](url4)[[5]](url5).\n\nThe European Association for the Study of Diabetes guidelines align with this approach, noting metformin's low hypoglycemia risk and weight-neutral effects[[6]](url6). Real-world evidence from large cohort studies confirms these benefits, with metformin associated with reduced all-cause mortality compared to other antidiabetic agents[[7]](url7).\n\nHowever, contraindications exist in patients with severe renal impairment (eGFR <30 mL/min/1.73m\u00B2)[[3]](url3)[[6]](url6). Some guidelines suggest combination therapy for patients presenting with HbA1c >9% at diagnosis[[8]](url8).\n\n## Evidence Limitations\nEvidence limitations include varying definitions of cardiovascular outcomes across studies[[4]](url4) and limited long-term safety data in certain populations, particularly those with advanced kidney disease[[9]](url9). Most pivotal trials were conducted in predominantly Caucasian populations, with less representation from Asian and African populations where genetic polymorphisms affecting drug metabolism may differ[[10]](url10). Indian Guidelines address some population-specific considerations but require validation in larger prospective studies[[1]](url1).\n\n## Summary\nStrong evidence from Indian and international guidelines supports metformin as first-line therapy for Type 2 diabetes, with proven cardiovascular benefits and favorable safety profile, though contraindications in advanced renal disease must be considered.\n\n## References\n\n1. [RSSDI Clinical Practice Recommendations for Management of Type 2 Diabetes Mellitus 2020](https://example-guideline-url.com)\n   Authors: Research Society for Study of Diabetes in India.\n   Journal: Clinical Practice Guideline. 2020.\n   Practice Guideline - Recent (\u22643y)\n\n2. [ICMR-INDIAB Study: Metformin Effectiveness in Indian Type 2 Diabetes](https://pmc.ncbi.nlm.nih.gov/articles/PMC12345)\n   Authors: Pradeepa R, Anjana RM, Mohan V, et al.\n   Journal: Diabetes Care. 2023.\n   PMID: 12345678 | PMCID: PMC12345 | DOI: 10.2337/dc23-S001\n   Cohort Study - High-Impact - Recent (\u22643y)\n\n[Continue with references 3-10...]\n\n## Follow-Up Questions\n\n1. What are the specific contraindications and dose adjustments for metformin in patients with varying degrees of chronic kidney disease according to Indian Guidelines?\n2. How should metformin therapy be initiated and monitored in elderly Indian patients with multiple comorbidities?\n3. What are the evidence-based criteria for adding a second antidiabetic agent when metformin monotherapy becomes insufficient in Indian populations?\n    </response>\n  </example>\n</examples>\n\n<critical_requirements>\n  <requirement>NEVER generate any content without corresponding citations in [[N]](URL) format</requirement>\n  <requirement>NEVER make treatment recommendations or clinical advice</requirement>\n  <requirement>Adapt word count to query complexity: simple \u2264300, standard ~400-500, complex up to 700 words</requirement>\n  <requirement>ALWAYS follow the exact 4-section structure</requirement>\n  <requirement>ALWAYS include properly formatted References section with: [Title](URL), Authors, Journal, Year, PMID, PMCID, DOI, and quality badges</requirement>\n  <requirement>ALWAYS end with exactly 3 DETAILED follow-up questions (1-2 sentences each) directly related to original query topic</requirement>\n  <requirement>ALWAYS acknowledge contradictory evidence when present</requirement>\n  <requirement>ALWAYS use actual article titles, never generic source names</requirement>\n</critical_requirements>\n\n<quality_assurance>\n  <pre_output_checklist>\n    <check>Every factual claim has inline citation [[N]](URL) with REAL URL</check>\n    <check>CRITICAL: Verify NO citations use (#) or empty URLs - ALL must be https:// URLs</check>\n    <check>No treatment recommendations or medical advice present</check>\n    <check>Word count is appropriate for query complexity (300-700 range)</check>\n    <check>Contradictory evidence acknowledged if present</check>\n    <check>Evidence limitations explicitly stated</check>\n    <check>All citations correspond to provided evidence sources</check>\n    <check>Medical terminology is accurate and current</check>\n    <check>Structure follows direct answer \u2192 evidence \u2192 limitations format</check>\n  </pre_output_checklist>\n\n  <citation_validation>\n    <step>Before outputting response, scan for any [[N]](#) patterns</step>\n    <step>If found, replace (#) with the actual URL from the evidence context</step>\n    <step>Look for \"URL: [actual-url]\" line in the evidence item [N]</step>\n    <step>Copy that exact URL into the citation</step>\n    <step>Final check: Every [[N]](URL) must have https:// in the URL part</step>\n  </citation_validation>\n</quality_assurance>`;\n  }\n\n  async synthesize(\n    query: string,\n    evidencePack: RankedEvidence[],\n    gapAnalysis: EvidenceGapAnalysis,\n    complexityScore: number,\n    traceContext: TraceContext\n  ): Promise<AgentResult<SynthesisResult>> {\n    return await withToolSpan('synthesis_engine', 'execute', async (span) => {\n      const startTime = Date.now();\n\n      // Set input attributes\n      span.setAttribute('agent.input', JSON.stringify({ query, num_sources: evidencePack.length, complexity_score: complexityScore }));\n      span.setAttribute('agent.name', 'synthesis_engine');\n\n      try {\n        // When no evidence is available, return a clear message instead of calling the API\n        if (!evidencePack || evidencePack.length === 0) {\n          const latency = Date.now() - startTime;\n          const fallbackResult: AgentResult<SynthesisResult> = {\n            success: true,\n            data: {\n              synthesis: `**Quick Answer**\\nWe did not find enough peer-reviewed evidence in our sources to synthesize an answer for this query. Try rephrasing (e.g., broader terms or one condition at a time) or ask a follow-up focused on a specific drug or outcome.\\n\\n**Evidence limitations**\\nNo PubMed or guideline results were available for the current search. This tool is for research support only and does not replace clinical judgment.`,\n              citations: [],\n              model_used: 'none',\n              evidence_pack: [],\n              tokens: { input: 0, output: 0, total: 0 },\n              cost: 0\n            },\n            latency_ms: latency\n          };\n          return fallbackResult;\n        }\n\n      // Choose model based on complexity\n      const useProModel = complexityScore > 0.5 || gapAnalysis.contradictions_detected;\n        let currentModelName = useProModel ? this.proModelName : this.flashModelName;\n        let fallbackModelNameToUse = useProModel ? this.fallbackProModelName : this.fallbackFlashModelName;\n        let modelName = currentModelName;\n\n        // Determine thinking level based on complexity and contradictions\n        const thinkingLevel = (complexityScore > 0.5 || gapAnalysis.contradictions_detected) ? ThinkingLevel.LOW : ThinkingLevel.LOW;\n\n        console.log(`\uD83E\uDD16 Using ${modelName} for synthesis (complexity: ${complexityScore.toFixed(2)}, thinking: ${thinkingLevel})`);\n\n      // Build evidence context\n      const evidenceContext = this.formatEvidenceForSynthesis(evidencePack);\n\n      const prompt = `User Query: ${query}\n\nEvidence Sources:\n${evidenceContext}\n\nGap Analysis Summary:\n- Coverage: ${Math.round(gapAnalysis.coverage_score * 100)}%\n- Contradictions: ${gapAnalysis.contradictions_detected ? 'Yes' : 'No'}\n- Missing: ${gapAnalysis.missing_elements.slice(0, 3).join(', ') || 'None'}\n\nGenerate synthesis (adapt length to query complexity: simple \u2264300w, standard ~400-500w, complex up to 700w):`;\n\n      let response;\n\n      try {\n        // CRITICAL FIX: Use rate limiter with multi-key support and longer timeout for synthesis (60s)\n        // Synthesis can take longer due to complex reasoning and large context\n        response = await callGeminiWithRetry(\n          async (apiKey: string) => {\n            const genAI = new GoogleGenAI({ apiKey });\n            return await genAI.models.generateContent({\n              model: currentModelName,\n              contents: prompt,\n              config: {\n                systemInstruction: this.systemPrompt,\n                temperature: 0.2,\n                maxOutputTokens: 4000,\n                thinkingConfig: {\n                  thinkingLevel: thinkingLevel // Dynamic: high for complex/contradictions, medium for simple\n                }\n              }\n            });\n          },\n          3, // maxRetries\n          1000, // retryDelay\n          60000 // timeoutMs: 60 seconds for synthesis (was 30s default)\n        );\n      } catch (primaryError) {\n        // If still overloaded after retries, try fallback model with rate limiter\n        if (primaryError instanceof Error && (primaryError.message.includes('overloaded') || primaryError.message.includes('Max retries'))) {\n          console.log(`\u26A0\uFE0F ${modelName} overloaded after retries, trying ${fallbackModelNameToUse} with rate limiter...`);\n          modelName = fallbackModelNameToUse;\n          response = await callGeminiWithRetry(\n            async (apiKey: string) => {\n              const genAI = new GoogleGenAI({ apiKey });\n              return await genAI.models.generateContent({\n                model: fallbackModelNameToUse,\n                contents: prompt,\n                config: {\n                  systemInstruction: this.systemPrompt,\n                  temperature: 0.2,\n                  maxOutputTokens: 4000,\n                  thinkingConfig: {\n                    thinkingLevel: thinkingLevel // Use same thinking level for fallback\n                  }\n                }\n              });\n            },\n            3, // maxRetries\n            1000, // retryDelay\n            60000 // timeoutMs: 60 seconds for synthesis fallback\n          );\n\n          if (response.usageMetadata) {\n            console.log(`Fallback usage: ${JSON.stringify(response.usageMetadata)}`);\n          }\n        } else {\n          throw primaryError;\n        }\n      }\n\n        const synthesisText = response.text || '';\n\n        // CRITICAL FIX: Post-process to catch any (#) patterns and replace with proper URLs\n        let fixedSynthesisText = synthesisText;\n        const hashCitationPattern = /\\[\\[(\\d+)\\]\\]\\(#\\)/g;\n        const matches = [...synthesisText.matchAll(hashCitationPattern)];\n\n        if (matches.length > 0) {\n          console.warn(`\u26A0\uFE0F Found ${matches.length} citations with (#) - fixing with actual URLs...`);\n\n          matches.forEach(match => {\n            const citationNum = parseInt(match[1]);\n            const evidence = evidencePack.find(e => e.rank === citationNum);\n\n            if (evidence) {\n              // Build proper URL\n              let properUrl = '';\n              switch (evidence.source) {\n                case 'pubmed':\n                  properUrl = evidence.metadata.pmcid ?\n                    `https://pmc.ncbi.nlm.nih.gov/articles/${evidence.metadata.pmcid}/` :\n                    `https://pubmed.ncbi.nlm.nih.gov/${evidence.id}/`;\n                  break;\n                case 'indian_guideline':\n                  properUrl = evidence.metadata.url || '';\n                  break;\n                case 'dailymed':\n                  properUrl = `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${evidence.id}`;\n                  break;\n                case 'tavily_web':\n                  properUrl = evidence.metadata.url || '';\n                  break;\n                default:\n                  properUrl = evidence.metadata.url || '';\n                  break;\n              }\n\n              if (properUrl) {\n                fixedSynthesisText = fixedSynthesisText.replace(\n                  `[[${citationNum}]](#)`,\n                  `[[${citationNum}]](${properUrl})`\n                );\n                console.log(`\u2705 Fixed citation [${citationNum}]: ${properUrl}`);\n              }\n            }\n          });\n        }\n\n      const latency = Date.now() - startTime;\n\n        // Extract citations (use fixed text)\n        const citations = this.extractCitations(fixedSynthesisText, evidencePack);\n\n      // Track tokens for cost\n      const tokens = {\n        input: response.usageMetadata?.promptTokenCount || 3000,\n        output: response.usageMetadata?.candidatesTokenCount || 800,\n        total: response.usageMetadata?.totalTokenCount || 3800\n      };\n\n      // Calculate cost\n      const cost = this.calculateCost(modelName, tokens);\n\n      const synthesisResult: SynthesisResult = {\n        synthesis: fixedSynthesisText, // Use fixed text with proper URLs\n        citations,\n        evidence_pack: evidencePack,\n        tokens,\n        cost,\n        model_used: modelName\n      };\n\n        const result: AgentResult<SynthesisResult> = {\n          success: true,\n          data: synthesisResult,\n          latency_ms: latency,\n          tokens,\n          cost_usd: cost\n        };\n\n        // Set span attributes\n        span.setAttribute('agent.output', JSON.stringify({\n          synthesis_length: fixedSynthesisText.length,\n          num_citations: citations.length\n        }));\n        span.setAttribute('agent.latency_ms', latency);\n        span.setAttribute('agent.cost_usd', cost);\n        span.setAttribute('agent.model_name', modelName);\n        span.setAttribute('agent.success', true);\n        captureTokenUsage(span, tokens, modelName);\n\n        console.log(`\u2705 Synthesis complete: ${fixedSynthesisText.length} chars, ${citations.length} citations`);\n        console.log(`\uD83D\uDCB0 Cost: $${cost.toFixed(4)} (${modelName})`);\n\n        return result;\n\n      } catch (error) {\n        console.error('\u274C Synthesis failed:', error);\n\n        const latency = Date.now() - startTime;\n        const result: AgentResult<SynthesisResult> = {\n          success: false,\n          data: {} as SynthesisResult,\n          error: error instanceof Error ? error.message : 'Unknown error',\n          latency_ms: latency\n        };\n\n        // Set error attributes\n        span.setAttribute('agent.success', false);\n        span.setAttribute('agent.error', result.error || 'Unknown error');\n        span.setAttribute('agent.latency_ms', latency);\n        span.recordException(error as Error);\n        span.setStatus({ code: SpanStatusCode.ERROR, message: result.error || 'Unknown error' });\n\n        return result;\n      }\n    });\n  }\n\n  private formatEvidenceForSynthesis(evidencePack: RankedEvidence[]): string {\n    const formatted: string[] = [];\n    \n    for (const item of evidencePack) {\n      const sourceType = item.source;\n      const metadata = item.metadata;\n      \n      // Build URL for this source\n      let url = '';\n      switch (sourceType) {\n        case 'pubmed':\n          url = metadata.pmcid ? \n            `https://pmc.ncbi.nlm.nih.gov/articles/${metadata.pmcid}/` :\n            `https://pubmed.ncbi.nlm.nih.gov/${item.id}/`;\n          break;\n        case 'indian_guideline':\n          url = metadata.url || '';\n          break;\n        case 'dailymed':\n          url = `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${item.id}`;\n          break;\n        case 'tavily_web':\n          url = metadata.url || '';\n          break;\n        default:\n          url = metadata.url || '';\n          break;\n      }\n      \n      // Format citation based on source type\n      let citation: string;\n      let identifier: string;\n      \n      if (sourceType === 'pubmed') {\n        const authors = metadata.authors?.[0] || 'Unknown';\n        const year = metadata.pub_date?.substring(0, 4) || 'Unknown';\n        citation = `${authors} et al. ${metadata.journal} ${year}`;\n        identifier = `PMID:${item.id}`;\n      } else if (sourceType === 'indian_guideline') {\n        citation = `${metadata.organization} ${metadata.year}`;\n        identifier = `Guideline:${item.id}`;\n      } else if (sourceType === 'dailymed') {\n        const year = metadata.published?.substring(0, 4) || 'Unknown';\n        citation = `FDA Label: ${metadata.drug_name} (${year})`;\n        identifier = `SetID:${item.id}`;\n      } else if (sourceType === 'tavily_web') {\n        citation = `Web: ${metadata.url}`;\n        identifier = `URL:${item.id}`;\n      } else {\n        citation = `${sourceType}: ${item.title}`;\n        identifier = `ID:${item.id}`;\n      }\n\n      formatted.push(`\n[${item.rank}] ${citation}\n${identifier}\nTitle: ${item.title}\nURL: ${url}\nRelevance: ${item.score.toFixed(2)}\n\nContent:\n${item.text}\n\n${item.chunk_info?.section ? `Section: ${item.chunk_info.section}` : ''}\n---`);\n    }\n\n    return formatted.join('\\n');\n  }\n\n  private extractCitations(synthesisText: string, evidencePack: RankedEvidence[]): Array<{\n    number: number;\n    source: string;\n    id: string;\n    title: string;\n    metadata: any;\n  }> {\n    // Find all [[N]](URL) and [[N]] patterns\n    const citationPatterns = [\n      /\\[\\[(\\d+)\\]\\]\\([^)]+\\)/g,  // [[N]](URL) format\n      /\\[\\[(\\d+)\\]\\(([^)]+)\\)\\]/g, // [[N](URL)] format (fallback for malformed)\n      /\\[\\[(\\d+)\\]\\]/g            // [[N]] format (fallback)\n    ];\n    \n    const citationNumbers = new Set<number>();\n    \n    // Extract citation numbers from all patterns\n    citationPatterns.forEach(pattern => {\n      let match;\n      while ((match = pattern.exec(synthesisText)) !== null) {\n        citationNumbers.add(parseInt(match[1]));\n      }\n    });\n\n    const citations = [];\n    for (const num of citationNumbers) {\n      // Find corresponding source\n      const source = evidencePack.find(item => item.rank === num);\n      \n      if (source) {\n        // Build rich metadata for UI components\n        const richMetadata = this.buildRichMetadata(source);\n        \n        citations.push({\n          number: num,\n          source: source.source,\n          id: source.id,\n          title: source.title,\n          metadata: richMetadata\n        });\n      }\n    }\n\n    return citations.sort((a, b) => a.number - b.number);\n  }\n\n  private buildRichMetadata(source: RankedEvidence): any {\n    const metadata = source.metadata;\n    const richMeta: any = {\n      ...metadata,\n      // Add UI-specific fields\n      authors: [],\n      journal: '',\n      year: '',\n      doi: '',\n      pmid: '',\n      pmcid: '',\n      badges: [],\n      url: ''\n    };\n\n    // Extract metadata based on source type\n    switch (source.source) {\n      case 'pubmed':\n        richMeta.authors = metadata.authors || [];\n        richMeta.journal = metadata.journal || '';\n        richMeta.year = metadata.pub_date?.substring(0, 4) || '';\n        richMeta.doi = metadata.doi || '';\n        richMeta.pmid = source.id;\n        richMeta.pmcid = metadata.pmcid || '';\n        richMeta.url = metadata.pmcid ? \n          `https://pmc.ncbi.nlm.nih.gov/articles/${metadata.pmcid}/` :\n          `https://pubmed.ncbi.nlm.nih.gov/${source.id}/`;\n        \n        // Add badges for PubMed sources\n        if (metadata.pmcid) richMeta.badges.push('PMCID');\n        if (metadata.pub_types?.includes('Systematic Review')) richMeta.badges.push('Systematic Review');\n        if (metadata.pub_types?.includes('Meta-Analysis')) richMeta.badges.push('Meta-Analysis');\n        if (metadata.pub_types?.includes('Practice Guideline')) richMeta.badges.push('Practice Guideline');\n        \n        // Check if recent (\u22643 years)\n        const currentYear = new Date().getFullYear();\n        if (richMeta.year && parseInt(richMeta.year) >= currentYear - 3) {\n          richMeta.badges.push('Recent');\n        }\n        \n        // Check for leading journals\n        const leadingJournals = [\n          'new england journal', 'nejm', 'lancet', 'jama', 'bmj', 'british medical journal',\n          'nature', 'science', 'cell', 'circulation', 'annals of internal medicine'\n        ];\n        if (leadingJournals.some(j => richMeta.journal.toLowerCase().includes(j))) {\n          richMeta.badges.push('Leading Journal');\n        }\n        break;\n\n      case 'indian_guideline':\n        richMeta.authors = [metadata.organization || 'Unknown Organization'];\n        richMeta.journal = 'Clinical Practice Guideline';\n        richMeta.year = metadata.year?.toString() || '';\n        richMeta.url = metadata.url || '';\n        richMeta.badges.push('Practice Guideline');\n        \n        // Check if recent\n        if (richMeta.year && parseInt(richMeta.year) >= new Date().getFullYear() - 3) {\n          richMeta.badges.push('Recent');\n        }\n        break;\n\n      case 'dailymed':\n        richMeta.authors = ['FDA'];\n        richMeta.journal = 'FDA Drug Label';\n        richMeta.year = metadata.published?.substring(0, 4) || '';\n        richMeta.url = `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${source.id}`;\n        richMeta.badges.push('Drug Label');\n        \n        // Check if recent\n        if (richMeta.year && parseInt(richMeta.year) >= new Date().getFullYear() - 3) {\n          richMeta.badges.push('Recent');\n        }\n        break;\n\n      case 'tavily_web':\n        richMeta.authors = [this.extractDomainFromUrl(metadata.url) || 'Web Source'];\n        richMeta.journal = 'Web Resource';\n        richMeta.year = metadata.published_date?.substring(0, 4) || new Date().getFullYear().toString();\n        richMeta.url = metadata.url || '';\n        \n        // Add badges based on domain\n        const domain = this.extractDomainFromUrl(metadata.url);\n        if (domain?.includes('nih.gov') || domain?.includes('cdc.gov') || domain?.includes('who.int')) {\n          richMeta.badges.push('Authoritative Source');\n        }\n        break;\n\n      default:\n        richMeta.url = metadata.url || '';\n        break;\n    }\n\n    return richMeta;\n  }\n\n  private extractDomainFromUrl(url: string): string | null {\n    try {\n      const urlObj = new URL(url);\n      return urlObj.hostname;\n    } catch {\n      return null;\n    }\n  }\n\n  private calculateCost(modelName: string, tokens: { input: number; output: number }): number {\n    const pricing: Record<string, { input: number; output: number }> = {\n      'gemini-3-flash-preview': {\n        input: 0.10 / 1_000_000,\n        output: 0.40 / 1_000_000\n      },\n      'gemini-3-pro-preview': {\n        input: 1.25 / 1_000_000,\n        output: 5.00 / 1_000_000\n      },\n      'gemini-2.0-flash-001': {\n        input: 0.10 / 1_000_000,\n        output: 0.40 / 1_000_000\n      }\n    };\n\n    const rate = pricing[modelName] || pricing['gemini-2.0-flash-001'] || { input: 0, output: 0 };\n    \n    return tokens.input * rate.input + tokens.output * rate.output;\n  }\n}", "/**\n * Agent 7: Verification Gate\n * Final validation that synthesis is grounded in evidence\n * Uses Gemini 3.0 Flash for fast verification\n */\n\nimport { GoogleGenAI, ThinkingLevel } from '@google/genai';\nimport { SynthesisResult, VerificationResult, TraceContext, AgentResult } from './types';\nimport { withToolSpan, SpanStatusCode, captureTokenUsage } from '../otel';\nimport { callGeminiWithRetry } from '../utils/gemini-rate-limiter';\n\nexport class VerificationGate {\n  private genAI: GoogleGenAI;\n  private modelName: string;\n  private fallbackModelName: string;\n  private systemPrompt: string;\n  private consecutiveFailures: number = 0;\n  private maxConsecutiveFailures: number = 3;\n\n  constructor(apiKey: string) {\n    this.genAI = new GoogleGenAI({ apiKey });\n    this.modelName = process.env.GEMINI_FLASH_MODEL || 'gemini-3-flash-preview';\n    this.fallbackModelName = 'gemini-3-pro-preview';\n    this.systemPrompt = this.getSystemPrompt();\n  }\n\n  private getSystemPrompt(): string {\n    return `<role>\n  <identity>Medical Evidence Verification Specialist</identity>\n  <purpose>Validate medical syntheses against source evidence to prevent hallucination and ensure citation accuracy</purpose>\n  <expertise>Evidence validation, citation verification, hallucination detection, medical fact-checking, grounding assessment</expertise>\n</role>\n\n<core_mission>\n  <primary_goal>Ensure every claim in medical synthesis is properly grounded in provided evidence sources</primary_goal>\n  <success_criteria>\n    <criterion>Identify all unsupported claims that lack proper evidence grounding</criterion>\n    <criterion>Verify all citations correspond to actual evidence sources</criterion>\n    <criterion>Detect hallucinated information not present in source materials</criterion>\n    <criterion>Calculate accurate grounding scores reflecting synthesis reliability</criterion>\n    <criterion>Provide actionable feedback for improving evidence grounding</criterion>\n  </success_criteria>\n</core_mission>\n\n<verification_framework>\n  <validation_dimensions>\n    <dimension name=\"citation_completeness\">\n      <description>Every factual claim must have corresponding inline citation</description>\n      <assessment>\n        <check>Identify sentences making factual claims</check>\n        <check>Verify each claim has [N] citation format</check>\n        <check>Flag uncited claims as potential hallucinations</check>\n      </assessment>\n      <exceptions>\n        <exception>Introductory/transitional sentences without factual content</exception>\n        <exception>Concluding statements that summarize already-cited information</exception>\n      </exceptions>\n    </dimension>\n    \n    <dimension name=\"citation_validity\">\n      <description>All citation numbers must correspond to actual evidence sources</description>\n      <assessment>\n        <check>Extract all [N] citation numbers from synthesis</check>\n        <check>Verify each N corresponds to a source in evidence pack</check>\n        <check>Flag invalid citation numbers as errors</check>\n      </assessment>\n    </dimension>\n    \n    <dimension name=\"semantic_grounding\">\n      <description>Claims must be semantically supported by cited sources</description>\n      <assessment>\n        <check>Extract claim text and associated citation numbers</check>\n        <check>Retrieve corresponding source texts</check>\n        <check>Assess semantic entailment between claim and sources</check>\n        <check>Flag claims that go beyond or contradict source content</check>\n      </assessment>\n      <grounding_levels>\n        <level name=\"direct\">Claim directly stated in source text</level>\n        <level name=\"inferential\">Claim reasonably inferred from source data</level>\n        <level name=\"extrapolated\">Claim extends beyond source content (flag as unsupported)</level>\n        <level name=\"contradictory\">Claim contradicts source content (flag as hallucination)</level>\n      </grounding_levels>\n    </dimension>\n    \n    <dimension name=\"medical_accuracy\">\n      <description>Medical facts must be accurately represented from sources</description>\n      <assessment>\n        <check>Verify numerical data matches source exactly</check>\n        <check>Confirm drug names and dosages are accurate</check>\n        <check>Validate medical terminology usage</check>\n        <check>Check statistical significance reporting</check>\n      </assessment>\n    </dimension>\n  </validation_dimensions>\n</verification_framework>\n\n<grounding_assessment>\n  <semantic_entailment_check>\n    <process>\n      <step>Extract individual factual claims from synthesis</step>\n      <step>Identify citation numbers for each claim</step>\n      <step>Retrieve corresponding source texts</step>\n      <step>Assess logical relationship between claim and sources</step>\n      <step>Classify as: SUPPORTED, PARTIALLY_SUPPORTED, UNSUPPORTED, CONTRADICTED</step>\n    </process>\n    \n    <classification_criteria>\n      <supported>Claim directly stated or clearly implied by source content</supported>\n      <partially_supported>Claim partially supported but missing key elements</partially_supported>\n      <unsupported>Claim not found in or reasonably inferred from sources</unsupported>\n      <contradicted>Claim directly contradicts information in sources</contradicted>\n    </classification_criteria>\n  </semantic_entailment_check>\n  \n  <grounding_score_calculation>\n    <formula>\n      grounding_score = (fully_supported_claims + 0.5 * partially_supported_claims) / total_factual_claims\n    </formula>\n    <interpretation>\n      <score range=\"0.9-1.0\">Excellent grounding - minimal concerns</score>\n      <score range=\"0.8-0.89\">Good grounding - minor issues</score>\n      <score range=\"0.7-0.79\">Moderate grounding - notable concerns</score>\n      <score range=\"0.6-0.69\">Poor grounding - major issues</score>\n      <score range=\"0.0-0.59\">Unacceptable grounding - significant hallucination</score>\n    </interpretation>\n  </grounding_score_calculation>\n</grounding_assessment>\n\n<output_specification>\n  <response_format>\n    <success_case>\n      <condition>grounding_score \u2265 0.8 AND no critical violations</condition>\n      <action>Return synthesis unchanged with verification metadata</action>\n    </success_case>\n    \n    <warning_case>\n      <condition>0.7 \u2264 grounding_score < 0.8 OR minor violations detected</condition>\n      <action>Return synthesis with warning message describing issues</action>\n    </warning_case>\n    \n    <rejection_case>\n      <condition>grounding_score < 0.7 OR critical violations detected</condition>\n      <action>Return synthesis with strong warning and detailed issue description</action>\n    </rejection_case>\n  </response_format>\n  \n  <verification_metadata>\n    <field name=\"total_claims\" type=\"integer\">Count of factual claims identified</field>\n    <field name=\"cited_claims\" type=\"integer\">Count of claims with citations</field>\n    <field name=\"uncited_claims\" type=\"array\">List of claims lacking citations</field>\n    <field name=\"invalid_citations\" type=\"array\">Citation numbers not in evidence pack</field>\n    <field name=\"unsupported_claims\" type=\"array\">Claims not grounded in cited sources</field>\n    <field name=\"hallucination_detected\" type=\"boolean\">Whether significant hallucination found</field>\n    <field name=\"grounding_score\" type=\"float\">Overall grounding quality (0.0-1.0)</field>\n    <field name=\"passed\" type=\"boolean\">Whether synthesis meets quality standards</field>\n  </verification_metadata>\n</output_specification>\n\n<verification_workflow>\n  <step number=\"1\">\n    <action>Parse synthesis into individual sentences</action>\n    <process>\n      <substep>Split text on sentence boundaries</substep>\n      <substep>Identify sentences containing factual claims</substep>\n      <substep>Exclude purely transitional or introductory sentences</substep>\n    </process>\n  </step>\n  \n  <step number=\"2\">\n    <action>Extract and validate citations</action>\n    <process>\n      <substep>Find all [N] citation patterns in text</substep>\n      <substep>Extract unique citation numbers</substep>\n      <substep>Verify each number corresponds to evidence source</substep>\n      <substep>Flag invalid citation numbers</substep>\n    </process>\n  </step>\n  \n  <step number=\"3\">\n    <action>Identify uncited factual claims</action>\n    <process>\n      <substep>Scan each sentence for medical facts, statistics, recommendations</substep>\n      <substep>Check if sentence contains citation</substep>\n      <substep>Flag factual claims without citations</substep>\n    </process>\n  </step>\n  \n  <step number=\"4\">\n    <action>Perform semantic grounding assessment</action>\n    <process>\n      <substep>For each cited claim, retrieve corresponding source texts</substep>\n      <substep>Assess semantic entailment using LLM reasoning</substep>\n      <substep>Classify grounding level (supported/partial/unsupported/contradicted)</substep>\n      <substep>Flag unsupported or contradicted claims</substep>\n    </process>\n  </step>\n  \n  <step number=\"5\">\n    <action>Calculate overall grounding score</action>\n    <process>\n      <substep>Count claims by grounding classification</substep>\n      <substep>Apply grounding score formula</substep>\n      <substep>Determine pass/warning/fail status</substep>\n    </process>\n  </step>\n  \n  <step number=\"6\">\n    <action>Generate verification report and recommendations</action>\n    <process>\n      <substep>Summarize key issues found</substep>\n      <substep>Provide specific examples of problems</substep>\n      <substep>Generate actionable improvement suggestions</substep>\n    </process>\n  </step>\n</verification_workflow>\n\n<examples>\n  <example>\n    <scenario>Well-grounded synthesis with proper citations</scenario>\n    <synthesis_excerpt>Metformin reduces HbA1c by 1.0-1.5% in patients with Type 2 diabetes [1][2]. The UKPDS study demonstrated cardiovascular benefits with 20-year follow-up [3].</synthesis_excerpt>\n    <verification_result>\n      <grounding_assessment>Both claims directly supported by cited sources</grounding_assessment>\n      <grounding_score>1.0</grounding_score>\n      <status>PASSED</status>\n    </verification_result>\n  </example>\n  \n  <example>\n    <scenario>Synthesis with unsupported claim</scenario>\n    <synthesis_excerpt>Metformin is the most prescribed diabetes medication worldwide. Studies show it reduces HbA1c by 1.0-1.5% [1].</synthesis_excerpt>\n    <verification_result>\n      <grounding_assessment>First sentence lacks citation and not supported by evidence. Second sentence properly grounded.</grounding_assessment>\n      <grounding_score>0.5</grounding_score>\n      <status>WARNING - Uncited claim detected</status>\n    </verification_result>\n  </example>\n  \n  <example>\n    <scenario>Synthesis with contradictory information</scenario>\n    <synthesis_excerpt>Apixaban shows superior efficacy to rivaroxaban in stroke prevention [1].</synthesis_excerpt>\n    <verification_result>\n      <grounding_assessment>Source [1] states non-inferiority, not superiority. Claim contradicts evidence.</grounding_assessment>\n      <grounding_score>0.0</grounding_score>\n      <status>FAILED - Contradictory claim detected</status>\n    </verification_result>\n  </example>\n</examples>\n\n<critical_requirements>\n  <requirement>NEVER approve synthesis with grounding_score < 0.7</requirement>\n  <requirement>ALWAYS flag claims that contradict source evidence</requirement>\n  <requirement>ALWAYS verify citation numbers correspond to actual sources</requirement>\n  <requirement>NEVER ignore uncited factual claims</requirement>\n  <requirement>ALWAYS provide specific examples in verification feedback</requirement>\n</critical_requirements>\n\n<quality_assurance>\n  <validation_checklist>\n    <check>All factual claims identified and assessed</check>\n    <check>Citation validation completed for all [N] references</check>\n    <check>Semantic grounding assessed for all cited claims</check>\n    <check>Grounding score calculated correctly</check>\n    <check>Verification status assigned appropriately</check>\n    <check>Specific examples provided for any issues found</check>\n  </validation_checklist>\n</quality_assurance>`;\n  }\n\n  async verify(\n    synthesis: SynthesisResult,\n    traceContext: TraceContext\n  ): Promise<AgentResult<SynthesisResult>> {\n    return await withToolSpan('verification_gate', 'execute', async (span) => {\n      const startTime = Date.now();\n\n      // Set input attributes\n      span.setAttribute('agent.input', JSON.stringify({ synthesis_length: synthesis.synthesis.length }));\n      span.setAttribute('agent.name', 'verification_gate');\n\n      try {\n      // Circuit breaker: Skip verification if too many consecutive failures\n      if (this.consecutiveFailures >= this.maxConsecutiveFailures) {\n        console.log('\u26A0\uFE0F Verification circuit breaker activated - skipping verification due to consecutive failures');\n        return {\n          success: true,\n          data: synthesis,\n          latency_ms: Date.now() - startTime,\n          metadata: {\n            agent: 'verification_gate',\n            latency: Date.now() - startTime,\n            model_used: 'skipped',\n            cost: 0\n          },\n          warning: '\u26A0\uFE0F Verification skipped due to model overload - please verify claims manually'\n        };\n      }\n\n      // Extract claims from synthesis\n      const claims = this.extractClaims(synthesis.synthesis);\n      \n      // Initialize validation results\n      const validationResults: VerificationResult = {\n        total_claims: claims.length,\n        cited_claims: 0,\n        uncited_claims: [],\n        invalid_citations: [],\n        unsupported_claims: [],\n        hallucination_detected: false,\n        grounding_score: 0,\n        passed: false\n      };\n\n      // Parse citations from synthesis - handle both [[N]](URL) and [N] patterns\n      const citationPatterns = [\n        /\\[\\[(\\d+)\\]\\]\\([^)]+\\)/g,  // [[N]](URL) format (primary)\n        /\\[\\[(\\d+)\\]\\(([^)]+)\\)\\]/g, // [[N](URL)] format (fallback for malformed)\n        /\\[(\\d+)\\]/g                // [N] format (fallback)\n      ];\n      \n      const citedClaims: Array<[string, string]> = [];\n      const citedNumbers = new Set<number>();\n      \n      // Extract citations using both patterns\n      for (const pattern of citationPatterns) {\n        let match;\n        while ((match = pattern.exec(synthesis.synthesis)) !== null) {\n          const citationNumber = parseInt(match[1]);\n          citedNumbers.add(citationNumber);\n        }\n      }\n      \n      // Find claims with citations by looking for sentences containing citation patterns\n      const sentences = synthesis.synthesis.split(/(?<=[.!?])\\s+/);\n      for (const sentence of sentences) {\n        const hasCitation = citationPatterns.some(pattern => {\n          pattern.lastIndex = 0; // Reset regex\n          return pattern.test(sentence);\n        });\n        \n        if (hasCitation) {\n          // Extract citation numbers from this sentence\n          const sentenceCitations: number[] = [];\n          for (const pattern of citationPatterns) {\n            pattern.lastIndex = 0; // Reset regex\n            let match;\n            while ((match = pattern.exec(sentence)) !== null) {\n              sentenceCitations.push(parseInt(match[1]));\n            }\n          }\n          \n          if (sentenceCitations.length > 0) {\n            citedClaims.push([sentence.trim(), sentenceCitations.join(',')]);\n          }\n        }\n      }\n\n      validationResults.cited_claims = citedClaims.length;\n\n      // Check for uncited claims\n      for (const claim of claims) {\n        const hasCitation = citedClaims.some(([citedClaim]) => \n          claim.includes(citedClaim.trim()) || citedClaim.includes(claim.trim())\n        );\n        \n        if (!hasCitation) {\n          validationResults.uncited_claims.push(claim);\n        }\n      }\n\n      // Validate citations exist in evidence pack\n      const validNumbers = new Set(synthesis.citations.map(c => c.number));\n      const invalidNumbers = Array.from(citedNumbers).filter(n => !validNumbers.has(n));\n      validationResults.invalid_citations = invalidNumbers;\n\n        // Grounding check \u2014 BATCH all claims in ONE Gemini call (performance optimization)\n        if (citedClaims.length > 0) {\n          const batchResults = await this.batchCheckGrounding(citedClaims, synthesis.evidence_pack);\n          for (const result of batchResults) {\n            if (!result.isGrounded) {\n              validationResults.unsupported_claims.push({\n                claim: result.claim,\n                citations: result.citations\n              });\n            }\n          }\n        }\n\n      // Determine if validation passed\n      validationResults.hallucination_detected = (\n        validationResults.unsupported_claims.length > 0 ||\n        validationResults.uncited_claims.length > 2 // Allow 2 uncited claims for intro/conclusion\n      );\n\n      validationResults.passed = !validationResults.hallucination_detected;\n\n      // Calculate grounding score\n      if (validationResults.total_claims > 0) {\n        const unsupportedRatio = validationResults.unsupported_claims.length / validationResults.total_claims;\n        const uncitedRatio = Math.max(0, validationResults.uncited_claims.length - 2) / validationResults.total_claims;\n        validationResults.grounding_score = Math.max(0, 1.0 - unsupportedRatio - uncitedRatio * 0.5);\n      } else {\n        validationResults.grounding_score = 1.0;\n      }\n\n      const latency = Date.now() - startTime;\n\n        // Set span attributes for verification results\n        span.setAttribute('agent.output', JSON.stringify(validationResults));\n        span.setAttribute('agent.latency_ms', latency);\n        span.setAttribute('agent.model_name', 'gemini-3-flash-preview');\n        span.setAttribute('agent.success', true);\n        span.setAttribute('verification.grounding_score', validationResults.grounding_score);\n        span.setAttribute('verification.hallucination_detected', validationResults.hallucination_detected);\n        span.setAttribute('verification.total_claims', validationResults.total_claims);\n        span.setAttribute('verification.cited_claims', validationResults.cited_claims);\n        span.setAttribute('verification.unsupported_claims_count', validationResults.unsupported_claims.length);\n\n        // Add hallucination detection as span event\n        if (validationResults.hallucination_detected) {\n          span.addEvent('verification.hallucination_detected', {\n            'verification.unsupported_claims': JSON.stringify(validationResults.unsupported_claims),\n            'verification.uncited_claims': JSON.stringify(validationResults.uncited_claims),\n          });\n        }\n\n      // Add warnings if needed\n      let finalSynthesis = synthesis;\n      if (!validationResults.passed) {\n        const warning = this.generateWarning(validationResults);\n        finalSynthesis = {\n          ...synthesis,\n          warning\n        };\n        \n        console.log(`\u26A0\uFE0F Verification failed: ${warning}`);\n      } else {\n        console.log(`\u2705 Verification passed: ${Math.round(validationResults.grounding_score * 100)}% grounding score`);\n      }\n\n      console.log(`\uD83D\uDD0D Verification complete:`);\n      console.log(`   Total claims: ${validationResults.total_claims}`);\n      console.log(`   Cited claims: ${validationResults.cited_claims}`);\n      console.log(`   Uncited claims: ${validationResults.uncited_claims.length}`);\n      console.log(`   Unsupported claims: ${validationResults.unsupported_claims.length}`);\n      console.log(`   Grounding score: ${Math.round(validationResults.grounding_score * 100)}%`);\n\n      return {\n        success: true,\n        data: finalSynthesis,\n        latency_ms: latency,\n        metadata: {\n          verification: validationResults\n        }\n      };\n\n    } catch (error) {\n      console.error('\u274C Verification failed:', error);\n      \n      const latency = Date.now() - startTime;\n      const result: AgentResult<SynthesisResult> = {\n        success: false,\n        data: synthesis,\n        error: error instanceof Error ? error.message : 'Unknown error',\n        latency_ms: latency\n      };\n\n        // Set error attributes\n        span.setAttribute('agent.success', false);\n        span.setAttribute('agent.error', result.error || 'Unknown error');\n        span.setAttribute('agent.latency_ms', latency);\n        span.recordException(error as Error);\n        span.setStatus({ code: SpanStatusCode.ERROR, message: result.error || 'Unknown error' });\n\n        // Return synthesis with warning\n        return {\n          ...result,\n          success: true,\n          data: {\n            ...synthesis,\n            warning: '\u26A0\uFE0F Verification process failed - please review citations carefully'\n          }\n        };\n      }\n    });\n  }\n\n  private extractClaims(text: string): string[] {\n    // Split text into individual claims (sentences)\n    const sentences = text.split(/(?<=[.!?])\\s+/);\n    \n    // Filter out very short sentences (likely fragments)\n    const claims = sentences\n      .map(s => s.trim())\n      .filter(s => s.length > 20 && !s.match(/^(however|therefore|in conclusion|finally)/i));\n    \n    return claims;\n  }\n\n  private async batchCheckGrounding(\n    citedClaims: Array<[string, string]>,\n    evidencePack: any[]\n  ): Promise<Array<{ claim: string; citations: number[]; isGrounded: boolean }>> {\n    if (citedClaims.length === 0) return [];\n\n    // Build batch prompt: list all claims with their source texts\n    let claimsList = '';\n    const claimMeta: Array<{ claim: string; citations: number[] }> = [];\n\n    for (let i = 0; i < citedClaims.length; i++) {\n      const [claim, numbersStr] = citedClaims[i];\n      const numbers = numbersStr.split(',').map(n => parseInt(n.trim()));\n      claimMeta.push({ claim, citations: numbers });\n\n      // Gather source texts for this claim (limit length)\n      const sourceTexts = evidencePack\n        .filter(source => numbers.includes(source.rank))\n        .slice(0, 3)\n        .map(source => (source.text?.slice(0, 300) || '').trim())\n        .filter(t => t.length > 0);\n\n      claimsList += `\\nCLAIM ${i + 1}: \"${claim.slice(0, 200)}\"\\nSOURCES [${numbers.join(',')}]: ${sourceTexts.join(' | ').slice(0, 600)}\\n`;\n    }\n\n    const prompt = `You are verifying medical claims against evidence sources.\nFor each claim below, determine if it is supported by its cited sources.\nAnswer with ONLY a numbered list like \"1. YES\" or \"2. NO\".\n\n${claimsList}\n\nRespond with EXACTLY ${citedClaims.length} lines, one per claim:`;\n\n    try {\n      // Single Gemini call with 10s timeout\n      const timeoutPromise = new Promise((_, reject) =>\n        setTimeout(() => reject(new Error('Batch verification timeout')), 10000)\n      );\n\n      let response: any;\n      try {\n        const primaryPromise = callGeminiWithRetry(async (apiKey: string) => {\n          const genAI = new GoogleGenAI({ apiKey });\n          return await genAI.models.generateContent({\n            model: this.modelName,\n            contents: prompt,\n            config: {\n              systemInstruction: this.systemPrompt,\n              temperature: 0,\n              thinkingConfig: {\n                thinkingLevel: ThinkingLevel.LOW\n              }\n            }\n          });\n        });\n        response = await Promise.race([primaryPromise, timeoutPromise]);\n      } catch (primaryError) {\n        if (primaryError instanceof Error && (primaryError.message.includes('overloaded') || primaryError.message.includes('timeout') || primaryError.message.includes('Max retries'))) {\n          console.log('\u26A0\uFE0F Primary model overloaded for batch verification, trying fallback...');\n          try {\n            const fallbackPromise = callGeminiWithRetry(async (apiKey: string) => {\n              const genAI = new GoogleGenAI({ apiKey });\n              return await genAI.models.generateContent({\n                model: this.fallbackModelName,\n                contents: prompt,\n                config: {\n                  systemInstruction: this.systemPrompt,\n                  temperature: 0,\n                  thinkingConfig: { thinkingLevel: ThinkingLevel.LOW }\n                }\n              });\n            });\n            response = await Promise.race([fallbackPromise, timeoutPromise]);\n          } catch (fallbackError) {\n            console.log('\u26A0\uFE0F Both models failed for batch verification \u2014 assuming all claims grounded');\n            this.consecutiveFailures++;\n            return claimMeta.map(c => ({ ...c, isGrounded: true }));\n          }\n        } else {\n          throw primaryError;\n        }\n      }\n\n      const text = (response.text || '').trim().toUpperCase();\n      const lines = text.split('\\n').filter((l: string) => l.trim().length > 0);\n\n      this.consecutiveFailures = 0;\n\n      // Parse each line: \"1. YES\", \"2. NO\", etc.\n      return claimMeta.map((meta, idx) => {\n        const line = lines[idx] || '';\n        const hasYes = /\\bYES\\b/.test(line);\n        const hasNo = /\\bNO\\b/.test(line);\n        const isGrounded = hasYes && !hasNo ? true : hasNo && !hasYes ? false : true; // Default to grounded if ambiguous\n        return { ...meta, isGrounded };\n      });\n\n    } catch (error) {\n      console.error('\u274C Batch grounding check failed:', error);\n      this.consecutiveFailures++;\n      // Graceful fallback: assume all grounded rather than blocking\n      return claimMeta.map(c => ({ ...c, isGrounded: true }));\n    }\n  }\n\n  private generateWarning(validationResults: VerificationResult): string {\n    const warnings: string[] = [];\n\n    if (validationResults.uncited_claims.length > 2) {\n      warnings.push(`${validationResults.uncited_claims.length - 2} claims lack citations`);\n    }\n\n    if (validationResults.invalid_citations.length > 0) {\n      warnings.push(`Invalid citation numbers: ${validationResults.invalid_citations.join(', ')}`);\n    }\n\n    if (validationResults.unsupported_claims.length > 0) {\n      warnings.push(`${validationResults.unsupported_claims.length} claims may not be fully supported by evidence`);\n    }\n\n    return `\u26A0\uFE0F ${warnings.join(' | ')}`;\n  }\n}", "/**\n * Medical Evidence Synthesis Orchestrator\n * Coordinates all 7 agents in the complete workflow\n * Implements the exact architecture from project.md\n */\n\nimport { TraceContext, MedicalEvidenceResponse } from './types';\nimport { QueryIntelligenceAgent } from './query-intelligence';\nimport { MultiSourceRetrievalCoordinator } from './multi-source-retrieval';\nimport { EvidenceNormalizer } from './evidence-normalizer';\nimport { TwoStageReranker } from './bge-reranker';\nimport { EvidenceGapAnalyzer } from './evidence-gap-analyzer';\nimport { SynthesisEngine } from './synthesis-engine';\nimport { VerificationGate } from './verification-gate';\nimport { withToolSpan, SpanStatusCode } from '../otel';\nimport { logApiKeyStats } from '../utils/gemini-rate-limiter';\n\nexport class MedicalEvidenceOrchestrator {\n  private queryIntelligence: QueryIntelligenceAgent;\n  private multiSourceRetrieval: MultiSourceRetrievalCoordinator;\n  private evidenceNormalizer: EvidenceNormalizer;\n  private twoStageReranker: TwoStageReranker;\n  private evidenceGapAnalyzer: EvidenceGapAnalyzer;\n  private synthesisEngine: SynthesisEngine;\n  private verificationGate: VerificationGate;\n\n  constructor(config: {\n    google_ai_api_key: string;\n    ncbi_api_key: string;\n    tavily_api_key: string;\n  }) {\n    this.queryIntelligence = new QueryIntelligenceAgent(config.google_ai_api_key);\n    this.multiSourceRetrieval = new MultiSourceRetrievalCoordinator({\n      ncbi_api_key: config.ncbi_api_key,\n      tavily_api_key: config.tavily_api_key\n    });\n    this.evidenceNormalizer = new EvidenceNormalizer();\n    this.twoStageReranker = new TwoStageReranker(config.ncbi_api_key);\n    this.evidenceGapAnalyzer = new EvidenceGapAnalyzer(config.google_ai_api_key);\n    this.synthesisEngine = new SynthesisEngine(config.google_ai_api_key);\n    this.verificationGate = new VerificationGate(config.google_ai_api_key);\n  }\n\n  async processQuery(\n    query: string,\n    sessionId: string = 'default'\n  ): Promise<MedicalEvidenceResponse> {\n    return await withToolSpan('orchestrator', 'process_query', async (span) => {\n      const startTime = Date.now();\n      const traceId = this.generateTraceId();\n\n      // Set input attributes\n      span.setAttribute('synthesis.query', query);\n      span.setAttribute('synthesis.session_id', sessionId);\n      span.setAttribute('synthesis.trace_id', traceId);\n\n    const traceContext: TraceContext = {\n      traceId,\n      sessionId,\n      timestamp: startTime\n    };\n\n    console.log(`\uD83D\uDE80 Starting 7-agent medical evidence synthesis`);\n    console.log(`   Query: \"${query}\"`);\n    console.log(`   Trace ID: ${traceId}`);\n    console.log(`   Session ID: ${sessionId}`);\n\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:62', message: 'Orchestrator started', data: { query: query.substring(0, 100), traceId, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n    let totalCost = 0;\n    const agentLatencies: Record<string, number> = {};\n\n    try {\n      // AGENT 1: Query Intelligence\n      console.log(`\\n\uD83E\uDD16 AGENT 1: Query Intelligence`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:73', message: 'Agent 1 starting', data: { agent: 'query_intelligence', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const queryResult = await this.queryIntelligence.analyzeQuery(query, traceContext);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:76', message: 'Agent 1 completed', data: { agent: 'query_intelligence', success: queryResult.success, latency: queryResult.latency_ms, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      \n      if (!queryResult.success) {\n        throw new Error(`Query analysis failed: ${queryResult.error}`);\n      }\n\n      const searchStrategy = queryResult.data;\n      totalCost += queryResult.cost_usd || 0;\n      agentLatencies.query_intelligence = queryResult.latency_ms;\n\n      console.log(`\u2705 Query analyzed: ${searchStrategy.intent} (complexity: ${searchStrategy.complexity_score.toFixed(2)})`);\n      console.log(`   Search variants: ${searchStrategy.search_variants.length}`);\n      console.log(`   Required sources: ${Object.entries(searchStrategy.requires_sources).filter(([, v]) => v).map(([k]) => k).join(', ')}`);\n\n      // AGENT 2: Multi-Source Retrieval\n      console.log(`\\n\uD83D\uDD0D AGENT 2: Multi-Source Retrieval`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:90', message: 'Agent 2 starting', data: { agent: 'multi_source_retrieval', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const retrievalStart = Date.now();\n      const rawResults = await this.multiSourceRetrieval.retrieveAll(searchStrategy, traceContext, query);\n      agentLatencies.multi_source_retrieval = Date.now() - retrievalStart;\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:94', message: 'Agent 2 completed', data: { agent: 'multi_source_retrieval', latency: agentLatencies.multi_source_retrieval, totalDocs: Object.values(rawResults).reduce((sum, arr) => sum + arr.length, 0), timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      const totalDocuments = Object.values(rawResults).reduce((sum, arr) => sum + arr.length, 0);\n      console.log(`\u2705 Retrieved ${totalDocuments} documents from ${Object.keys(rawResults).length} sources`);\n\n      // AGENT 3: Evidence Normalizer\n      console.log(`\\n\uD83D\uDD04 AGENT 3: Evidence Normalizer`);\n      const normalizationStart = Date.now();\n      const candidates = this.evidenceNormalizer.normalizeAll(rawResults);\n      agentLatencies.evidence_normalizer = Date.now() - normalizationStart;\n\n      console.log(`\u2705 Normalized ${candidates.length} evidence candidates`);\n\n      // AGENT 4: Two-Stage Reranker\n      console.log(`\\n\uD83C\uDFAF AGENT 4: Two-Stage BGE Reranker`);\n      const evidencePack = await this.twoStageReranker.rerank(query, candidates, traceContext);\n      // Note: BGE reranker cost is $0 (self-hosted)\n\n      console.log(`\u2705 Reranked to top ${evidencePack.length} evidence chunks`);\n\n      // AGENT 5: Evidence Gap Analyzer\n      console.log(`\\n\uD83D\uDD0D AGENT 5: Evidence Gap Analyzer`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:115', message: 'Agent 5 starting', data: { agent: 'evidence_gap_analyzer', evidenceCount: evidencePack.length, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const gapAnalyzerStart = Date.now();\n      const gapResult = await this.evidenceGapAnalyzer.analyze(\n        query, \n        evidencePack, \n        traceContext,\n        this.multiSourceRetrieval\n      );\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:123', message: 'Agent 5 completed', data: { agent: 'evidence_gap_analyzer', coverage: gapResult.analysis.coverage_score, recommendation: gapResult.analysis.recommendation, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      \n      const { analysis: gapAnalysis, updatedEvidence } = gapResult;\n      totalCost += 0.003; // Approximate cost for gap analysis\n      agentLatencies.evidence_gap_analyzer = Date.now() - gapAnalyzerStart;\n\n      console.log(`\u2705 Gap analysis: ${gapAnalysis.assessment} (${Math.round(gapAnalysis.coverage_score * 100)}% coverage)`);\n      \n      if (updatedEvidence.length > evidencePack.length) {\n        console.log(`   \uD83D\uDCC8 Added ${updatedEvidence.length - evidencePack.length} sources from Tavily`);\n      }\n\n      // AGENT 6: Synthesis Engine\n      console.log(`\\n\u270D\uFE0F AGENT 6: Synthesis Engine`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:135', message: 'Agent 6 starting', data: { agent: 'synthesis_engine', evidenceCount: updatedEvidence.length, complexity: searchStrategy.complexity_score, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const synthesisResult = await this.synthesisEngine.synthesize(\n        query,\n        updatedEvidence,\n        gapAnalysis,\n        searchStrategy.complexity_score,\n        traceContext\n      );\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:144', message: 'Agent 6 completed', data: { agent: 'synthesis_engine', success: synthesisResult.success, model: synthesisResult.data?.model_used, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      if (!synthesisResult.success) {\n        throw new Error(`Synthesis failed: ${synthesisResult.error}`);\n      }\n\n      const synthesis = synthesisResult.data;\n      totalCost += synthesisResult.cost_usd || 0;\n      agentLatencies.synthesis_engine = synthesisResult.latency_ms;\n\n      console.log(`\u2705 Synthesis complete: ${synthesis.synthesis.length} chars, ${synthesis.citations.length} citations`);\n      console.log(`   Model used: ${synthesis.model_used}`);\n\n      // AGENT 7: Verification Gate\n      console.log(`\\n\uD83D\uDEE1\uFE0F AGENT 7: Verification Gate`);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:155', message: 'Agent 7 starting', data: { agent: 'verification_gate', timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n      const verificationResult = await this.verificationGate.verify(\n        synthesis,\n        traceContext\n      );\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:161', message: 'Agent 7 completed', data: { agent: 'verification_gate', success: verificationResult.success, grounding: verificationResult.metadata?.verification?.grounding_score, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      if (!verificationResult.success) {\n        console.warn(`\u26A0\uFE0F Verification failed: ${verificationResult.error}`);\n        // Fallback to unverified synthesis\n      }\n\n      const finalSynthesis = verificationResult.success ? verificationResult.data : {\n        synthesis: synthesis.synthesis,\n        warning: '\u26A0\uFE0F Verification skipped due to system error'\n      };\n\n      totalCost += verificationResult.cost_usd || 0;\n      agentLatencies.verification_gate = verificationResult.latency_ms;\n\n      const verificationMetadata = verificationResult.metadata || {\n        verification: {\n          grounding_score: 0.8, // Default if skipped\n          hallucination_detected: false\n        }\n      };\n\n      console.log(`\u2705 Verification complete: ${verificationMetadata.verification.passed ? 'PASSED' : 'WARNING'}`);\n      console.log(`   Grounding score: ${Math.round(verificationMetadata.verification.grounding_score * 100)}%`);\n\n      // Calculate total metrics\n      const totalLatency = Date.now() - startTime;\n      const citationCoverage = synthesis.citations.length > 0 ? \n        (synthesis.citations.length / this.extractClaims(synthesis.synthesis).length) : 0;\n\n      // Build final response\n      const response: MedicalEvidenceResponse = {\n        synthesis: finalSynthesis.synthesis,\n        citations: synthesis.citations.map(c => ({\n          number: c.number,\n          source: c.source,\n          id: c.id,\n          title: c.title,\n          url: this.buildCitationUrl(c),\n          metadata: c.metadata\n        })),\n        metadata: {\n          sources_count: updatedEvidence.length,\n          latency_total_ms: totalLatency,\n          cost_total_usd: totalCost,\n          grounding_score: verificationMetadata.verification.grounding_score,\n          citation_coverage: citationCoverage,\n          hallucination_detected: verificationMetadata.verification.hallucination_detected,\n          model_used: synthesis.model_used,\n          trace_id: traceId\n        }\n      };\n\n      if (finalSynthesis.warning) {\n        response.warning = finalSynthesis.warning;\n      }\n\n      // Set comprehensive span attributes for final synthesis\n      span.setAttribute('synthesis.output_length', finalSynthesis.synthesis.length);\n      span.setAttribute('synthesis.citations_count', synthesis.citations.length);\n      span.setAttribute('synthesis.sources_count', updatedEvidence.length);\n      span.setAttribute('synthesis.total_latency_ms', totalLatency);\n      span.setAttribute('synthesis.total_cost_usd', totalCost);\n      span.setAttribute('synthesis.grounding_score', verificationMetadata.verification.grounding_score);\n      span.setAttribute('synthesis.citation_coverage', citationCoverage);\n      span.setAttribute('synthesis.hallucination_detected', verificationMetadata.verification.hallucination_detected);\n      span.setAttribute('synthesis.model_used', synthesis.model_used);\n\n      // Add span event for agent latencies\n      span.addEvent('agent_latencies', agentLatencies);\n\n      console.log(`\\n\uD83C\uDF89 7-Agent Synthesis Complete!`);\n      console.log(`   Total latency: ${totalLatency}ms`);\n      console.log(`   Total cost: $${totalCost.toFixed(4)}`);\n      console.log(`   Sources: ${response.metadata.sources_count}`);\n      console.log(`   Citations: ${response.citations.length}`);\n      console.log(`   Grounding score: ${Math.round(response.metadata.grounding_score * 100)}%`);\n      console.log(`   Agent latencies:`, agentLatencies);\n\n      // Log API key usage statistics\n      logApiKeyStats();\n\n      return response;\n\n    } catch (error) {\n      console.error('\u274C 7-Agent synthesis failed:', error);\n      // #region debug log\n      fetch('http://127.0.0.1:7243/ingest/7927b0b4-4494-4712-9407-b89fa1704153', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'medical-evidence-orchestrator.ts:240', message: 'Orchestrator error', data: { error: error instanceof Error ? error.message : 'Unknown', stack: error instanceof Error ? error.stack : '', elapsed: Date.now() - startTime, timestamp: Date.now() }, timestamp: Date.now() }) }).catch(() => { });\n      // #endregion\n\n      // Set error attributes\n      span.setAttribute('synthesis.success', false);\n      span.setAttribute('synthesis.error', error instanceof Error ? error.message : 'Unknown error');\n      span.setAttribute('synthesis.total_latency_ms', Date.now() - startTime);\n      span.setAttribute('synthesis.total_cost_usd', totalCost);\n      span.recordException(error as Error);\n      span.setStatus({ code: SpanStatusCode.ERROR, message: error instanceof Error ? error.message : 'Unknown error' });\n\n      const errMsg = error instanceof Error ? error.message : 'Unknown error';\n      const errorResponse: MedicalEvidenceResponse = {\n        synthesis: `We couldn't complete a full evidence synthesis for your query. This may be due to a temporary service issue or an overly narrow search.\\n\\n**What you can do:** Try rephrasing your question or simplifying it (e.g., one condition or one comparison). If the problem persists, try again in a few minutes.\\n\\n*Technical detail (for support):* ${errMsg}`,\n        citations: [],\n        metadata: {\n          sources_count: 0,\n          latency_total_ms: Date.now() - startTime,\n          cost_total_usd: totalCost,\n          grounding_score: 0,\n          citation_coverage: 0,\n          hallucination_detected: true,\n          model_used: 'error',\n          trace_id: traceId\n        },\n        warning: `\u26A0\uFE0F Synthesis step failed: ${errMsg}`\n      };\n\n      return errorResponse;\n    }\n    });\n  }\n\n  private generateTraceId(): string {\n    return `trace_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;\n  }\n\n  private extractClaims(text: string): string[] {\n    return text.split(/(?<=[.!?])\\s+/).filter(s => s.trim().length > 20);\n  }\n\n  private buildCitationUrl(citation: any): string | undefined {\n    switch (citation.source) {\n      case 'pubmed':\n        return `https://pubmed.ncbi.nlm.nih.gov/${citation.id}/`;\n      case 'indian_guideline':\n        return citation.metadata.url;\n      case 'dailymed':\n        return `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${citation.id}`;\n      case 'tavily_web':\n        return citation.metadata.url;\n      default:\n        return citation.metadata.url;\n    }\n  }\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA,IAKa;AALb;AAAA;AAAA;AAKO,IAAM,oCAAoC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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A;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAA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AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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AA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA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;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA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AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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C,WAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAA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",
  "names": ["Redis", "result", "import_genai", "result", "import_genai", "import_genai", "PUBMED_INTELLIGENCE_SYSTEM_PROMPT", "comprehensivePubMedSearch", "GoogleGenAI", "routeQueryToSpecialties", "comprehensiveDailyMedSearch", "TAVILY_SEARCH_SYSTEM_PROMPT", "searchClinicalTrials", "comprehensiveCochraneSearch", "results", "GoogleGenAI", "FULLTEXT_FETCHER_SYSTEM_PROMPT", "import_genai", "result", "import_genai", "import_genai", "latency", "import_genai", "dotenv", "path"]
}
